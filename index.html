<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EZY: Cyber — Идеальный чарник</title>
    <meta name="description" content="Интерактивный лист персонажа для настольной ролевой игры EZY: Cyber">
    
    <style>
        /* CSS переменные и базовые стили будут добавлены в следующих шагах */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: "Segoe UI", "Roboto", "Ubuntu", "Helvetica Neue", sans-serif;
            background: #0a0712;
            color: #f3e8ff;
            overflow-x: hidden;
        }
        
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            transition: opacity 0.5s ease-out;
            font-family: "Courier New", monospace;
        }
        
        .loading-screen.hidden {
            opacity: 0;
            pointer-events: none;
        }
        
        .loading-logo {
            font-family: "Courier New", monospace;
            font-size: 2rem;
            font-weight: bold;
            color: #00ffff;
            text-align: center;
            margin-bottom: 3rem;
            text-shadow: 0 0 10px rgba(0, 255, 255, 0.5);
        }
        
        .loading-log {
            width: 600px;
            max-width: 90%;
            margin-bottom: 2rem;
        }
        
        .loading-log-item {
            margin-bottom: 0.5rem;
            font-size: 1rem;
            color: #00ffff;
            min-height: 1.2em;
            display: flex;
            align-items: center;
        }
        
        .loading-log-item.typing {
            position: relative;
        }
        
        .loading-log-item.typing::after {
            content: '▮';
            color: #00ffff;
            animation: blink 1s infinite;
            margin-left: 2px;
        }
        
        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }
        
        .loading-log-code {
            color: #00ffff;
            font-weight: bold;
        }
        
        .loading-log-text {
            color: #00ffff;
            flex: 1;
            margin-left: 0.5rem;
        }
        
        .loading-log-ok {
            color: #00ff00;
            font-weight: bold;
            text-shadow: 0 0 5px rgba(0, 255, 0, 0.5);
        }
        
        .loading-progress {
            width: 400px;
            max-width: 90%;
            height: 30px;
            background: #000000;
            border: 2px solid #00ffff;
            position: relative;
            overflow: hidden;
        }
        
        .loading-progress-bar {
            height: 100%;
            background: #00ff00;
            width: 0%;
            transition: width 0.3s ease;
            position: relative;
            box-shadow: 0 0 10px rgba(0, 255, 0, 0.5);
        }
        
        .loading-progress-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #00ff00;
            font-weight: bold;
            font-size: 1rem;
            text-shadow: 0 0 5px rgba(0, 255, 0, 0.5);
            z-index: 1;
            display: none;
        }
        
        .main-interface {
            display: none;
            min-height: 100vh;
        }
        
        .main-interface.loaded {
            display: block;
        }
        
        .header {
            background: linear-gradient(135deg, #171125, #211630);
            padding: 1rem 2rem;
            border-bottom: 1px solid rgba(182, 103, 255, 0.38);
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(182, 103, 255, 0.1);
        }
        
        .header-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: #b667ff;
            text-transform: uppercase;
            letter-spacing: 0.08em;
        }
        
        .header-controls {
            display: flex;
            gap: 1rem;
        }
        
        .main-content {
            padding: 1rem;
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .sections-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 1rem;
        }
        
        .right-panel {
            background: linear-gradient(135deg, #171125, #211630);
            border-radius: 18px;
            padding: 1rem;
            border: 1px solid rgba(182, 103, 255, 0.38);
            box-shadow: 0 0 22px rgba(182, 103, 255, 0.28);
            height: fit-content;
        }
        
        .section {
            background: linear-gradient(135deg, #171125, #211630);
            border-radius: 18px;
            padding: 1.5rem;
            border: 1px solid rgba(182, 103, 255, 0.38);
            box-shadow: 0 0 22px rgba(182, 103, 255, 0.28);
            transition: all 0.3s ease;
        }
        
        .section:hover {
            box-shadow: 0 0 30px rgba(182, 103, 255, 0.4);
        }
        
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid rgba(182, 103, 255, 0.2);
        }
        
        .section-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: #b667ff;
            text-transform: uppercase;
            letter-spacing: 0.08em;
        }
        
        .section-content {
            display: none;
        }
        
        .section-content.expanded {
            display: block;
        }
        
        .collapsed-section {
            background: linear-gradient(135deg, #171125, #211630);
            border-radius: 18px;
            padding: 0.5rem 1rem;
            margin-bottom: 0.5rem;
            border: 1px solid rgba(182, 103, 255, 0.38);
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .collapsed-section:hover {
            background: linear-gradient(135deg, #211630, #2a1a3a);
        }
        
        .collapsed-title {
            font-size: 0.9rem;
            font-weight: 600;
            color: #a394c4;
            text-transform: uppercase;
            letter-spacing: 0.08em;
        }
        
        /* CSS переменные */
        :root {
            --bg: #0a0712;                    /* Основной фон - темно-фиолетовый */
            --panel: #171125;                 /* Фон панелей - темно-фиолетовый */
            --panel-alt: #211630;             /* Альтернативный фон панелей */
            --accent: #b667ff;                /* Основной акцент - ярко-фиолетовый */
            --accent-2: #ff6acb;              /* Вторичный акцент - розовый */
            --text: #f3e8ff;                  /* Основной текст - светло-фиолетовый */
            --muted: #a394c4;                 /* Приглушенный текст - серо-фиолетовый */
            --danger: #ff5b87;                /* Опасность - красновато-розовый */
            --success: #7df4c6;               /* Успех - светло-зеленый */
            --border: rgba(182, 103, 255, 0.38); /* Границы - полупрозрачный фиолетовый */
            --shadow: 0 0 22px rgba(182, 103, 255, 0.28); /* Тени - фиолетовое свечение */
        }

        /* Стили для кнопок */
        .pill-button {
            background: linear-gradient(135deg, var(--panel), var(--panel-alt));
            border: 1px solid var(--border);
            border-radius: 25px;
            padding: 0.5rem 1rem;
            color: var(--text);
            font-family: inherit;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            box-shadow: var(--shadow);
        }

        .pill-button:hover {
            background: linear-gradient(135deg, var(--panel-alt), var(--accent));
            border-color: var(--accent);
            box-shadow: 0 0 30px rgba(182, 103, 255, 0.4);
            transform: translateY(-2px);
        }

        .pill-button:active {
            transform: translateY(0);
        }

        .pill-button.primary-button {
            background: linear-gradient(135deg, var(--accent), var(--accent-2));
            border-color: var(--accent);
            color: var(--bg);
            font-weight: 600;
        }

        .pill-button.primary-button:hover {
            background: linear-gradient(135deg, var(--accent-2), var(--accent));
            box-shadow: 0 0 35px rgba(182, 103, 255, 0.6);
        }

        .pill-button.danger-button {
            background: linear-gradient(135deg, var(--danger), #ff3d6b);
            border-color: var(--danger);
            color: white;
        }

        .pill-button.danger-button:hover {
            background: linear-gradient(135deg, #ff3d6b, var(--danger));
            box-shadow: 0 0 30px rgba(255, 91, 135, 0.5);
        }

        .pill-button.muted-button {
            background: linear-gradient(135deg, rgba(163, 148, 196, 0.1), rgba(163, 148, 196, 0.05));
            border-color: rgba(163, 148, 196, 0.3);
            color: var(--muted);
        }

        .pill-button.muted-button:hover {
            background: linear-gradient(135deg, rgba(163, 148, 196, 0.2), rgba(163, 148, 196, 0.1));
            border-color: var(--muted);
            color: var(--text);
        }

        .pill-button.success-button {
            background: linear-gradient(135deg, var(--success), #5dd4a8);
            border-color: var(--success);
            color: var(--bg);
        }

        .pill-button.success-button:hover {
            background: linear-gradient(135deg, #5dd4a8, var(--success));
            box-shadow: 0 0 30px rgba(125, 244, 198, 0.5);
        }

        /* Стили для полей ввода */
        .input-field {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 0.75rem;
            color: var(--text);
            font-family: inherit;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            width: 100%;
        }

        .input-field:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 15px rgba(182, 103, 255, 0.3);
            background: rgba(0, 0, 0, 0.5);
        }

        .input-field::placeholder {
            color: var(--muted);
        }

        .input-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .input-label {
            color: var(--accent);
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.08em;
        }

        .input-row {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .input-row .input-field {
            flex: 1;
        }

        .stat-input {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 0.5rem;
            color: var(--text);
            font-family: inherit;
            font-size: 1rem;
            font-weight: 600;
            text-align: center;
            width: 60px;
            transition: all 0.3s ease;
        }

        .stat-input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 15px rgba(182, 103, 255, 0.3);
        }

        /* Стили для числовых полей (spinner) */
        input[type="number"] {
            text-align: center !important;
            padding-left: 0.5rem !important;
            padding-right: 0.5rem !important;
            text-indent: 0 !important;
            direction: ltr !important;
            unicode-bidi: bidi-override !important;
        }
        
        /* Специальные стили для .stat-value */
        .stat-value {
            text-align: center !important;
            padding-left: 0.5rem !important;
            padding-right: 0.5rem !important;
            text-indent: 0 !important;
            margin-left: auto !important;
            margin-right: auto !important;
            direction: ltr !important;
            unicode-bidi: bidi-override !important;
        }
        
        /* Принудительное центрирование для всех числовых полей */
        input[type="number"].stat-value {
            text-align: center !important;
            padding: 0.5rem !important;
            text-indent: 0 !important;
            direction: ltr !important;
        }
        
        /* Принудительное центрирование для .input-field числовых полей */
        input[type="number"].input-field {
            text-align: center !important;
            padding-left: 0.75rem !important;
            padding-right: 0.75rem !important;
            text-indent: 0 !important;
            direction: ltr !important;
        }
        
        /* Принудительное центрирование для профессиональных навыков */
        .professional-skill-level {
            text-align: center !important;
            padding-left: 0.3rem !important;
            padding-right: 0.3rem !important;
            text-indent: 0 !important;
            direction: ltr !important;
        }
        
        /* Дополнительные стили для принудительного центрирования */
        .stat-value::-webkit-input-placeholder {
            text-align: center !important;
        }
        
        .stat-value::-moz-placeholder {
            text-align: center !important;
        }
        
        .stat-value:-ms-input-placeholder {
            text-align: center !important;
        }
        
        .stat-value::placeholder {
            text-align: center !important;
        }
        
        /* Дополнительные стили для браузерной совместимости */
        input[type="number"]::-webkit-textfield-decoration-container {
            text-align: center !important;
        }
        
        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        
        /* Firefox специфичные стили */
        input[type="number"] {
            -moz-appearance: textfield;
            appearance: textfield;
        }
        
        /* Принудительное центрирование для всех браузеров */
        input[type="number"] {
            text-align: center !important;
            text-align-last: center !important;
        }
        
        /* Дополнительные стили для WebKit браузеров */
        input[type="number"]::-webkit-input-placeholder {
            text-align: center !important;
        }
        
        /* Дополнительные стили для Mozilla */
        input[type="number"]::-moz-placeholder {
            text-align: center !important;
        }
        
        /* Дополнительные стили для IE */
        input[type="number"]:-ms-input-placeholder {
            text-align: center !important;
        }
        
        input[type="number"]::-webkit-outer-spin-button,
        input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border);
            border-radius: 4px;
            width: 20px;
            height: 20px;
            position: relative;
        }

        input[type="number"]::-webkit-outer-spin-button {
            background: linear-gradient(135deg, var(--panel), var(--panel-alt));
            border: 1px solid var(--border);
            border-radius: 4px;
            box-shadow: var(--shadow);
        }

        input[type="number"]::-webkit-inner-spin-button {
            background: transparent;
            border: none;
        }

        input[type="number"]::-webkit-inner-spin-button:before {
            content: "▲";
            color: var(--accent);
            font-size: 10px;
            position: absolute;
            top: 2px;
            left: 50%;
            transform: translateX(-50%);
        }

        input[type="number"]::-webkit-inner-spin-button:after {
            content: "▼";
            color: var(--accent);
            font-size: 10px;
            position: absolute;
            bottom: 2px;
            left: 50%;
            transform: translateX(-50%);
        }

        /* Firefox */
        input[type="number"] {
            appearance: textfield;
            -moz-appearance: textfield;
            text-align: center !important;
        }

        input[type="number"]::-moz-number-spin-box {
            background: linear-gradient(135deg, var(--panel), var(--panel-alt));
            border: 1px solid var(--border);
            border-radius: 4px;
            box-shadow: var(--shadow);
        }

        input[type="number"]::-moz-number-spin-up,
        input[type="number"]::-moz-number-spin-down {
            background: transparent;
            border: none;
            color: var(--accent);
            font-size: 10px;
        }

        .stat-label {
            color: var(--accent);
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            min-width: 60px;
        }

        /* Анимация кубиков */
        .dice {
            width: 40px;
            height: 40px;
            background: var(--accent);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: var(--bg);
            font-size: 1.2rem;
        }

        /* Треугольники d4 */
        .d4-triangle {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.2rem;
            position: relative;
            clip-path: polygon(50% 0%, 0% 100%, 100% 100%);
            border-radius: 4px;
        }

        .d4-penalty {
            background: linear-gradient(135deg, #ff9aa2, #ff5b87);
            color: var(--bg);
        }

        .d4-bonus {
            background: linear-gradient(135deg, #b8f4d0, #7df4c6);
            color: var(--bg);
        }

        .d4-triangle.rolling {
            animation: roll 1.5s ease-in-out;
        }

        .dice.rolling {
            animation: roll 1.5s ease-in-out;
        }

        @keyframes roll {
            0% { transform: rotate(0deg) scale(1); }
            25% { transform: rotate(90deg) scale(1.1); }
            50% { transform: rotate(180deg) scale(0.9); }
            75% { transform: rotate(270deg) scale(1.1); }
            100% { transform: rotate(360deg) scale(1); }
        }

        .dice-result {
            text-align: center;
            margin: 1rem 0;
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--text);
        }

        .dice-special {
            width: 100%;
            text-align: center;
            margin-top: 0.75rem;
            font-size: 1rem;
            font-weight: 600;
            letter-spacing: 0.18em;
            text-transform: uppercase;
        }

        .dice-special.fail {
            color: var(--danger);
            animation: pulse-fail 1s ease-in-out 0s 3;
        }

        .dice-special.crit {
            color: #7bd7ff;
            animation: pulse-crit 1s ease-in-out 0s 3;
        }

        @keyframes pulse-fail {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.7; transform: scale(1.05); }
        }

        @keyframes pulse-crit {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.8; transform: scale(1.1); }
        }

        /* Drag & Drop стили */
        .draggable-module {
            transition: all 0.2s ease;
        }

        .draggable-module:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(182, 103, 255, 0.3);
        }

        .draggable-module:active {
            transform: scale(0.98);
        }

        .drop-zone {
            transition: all 0.3s ease;
        }

        .drop-zone.drag-over {
            background: rgba(125, 244, 198, 0.3) !important;
            border-color: var(--success) !important;
            transform: scale(1.02);
        }

        .implant-slot {
            transition: all 0.2s ease;
        }

        .implant-slot:hover {
            transform: scale(1.1);
            box-shadow: 0 2px 8px rgba(182, 103, 255, 0.4);
        }

        /* Кастомные скроллбары */
        ::-webkit-scrollbar {
            width: 12px;
            height: 12px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(20, 13, 35, 0.8);
            border-radius: 6px;
            border: 1px solid var(--border);
        }

        ::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, var(--accent), rgba(182, 103, 255, 0.8));
            border-radius: 6px;
            border: 1px solid rgba(182, 103, 255, 0.3);
            transition: all 0.2s ease;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, rgba(182, 103, 255, 0.9), var(--accent));
            border-color: rgba(182, 103, 255, 0.5);
        }

        ::-webkit-scrollbar-thumb:active {
            background: linear-gradient(135deg, var(--accent), rgba(182, 103, 255, 1));
        }

        ::-webkit-scrollbar-corner {
            background: rgba(20, 13, 35, 0.8);
        }

        /* Firefox скроллбары */
        * {
            scrollbar-width: thin;
            scrollbar-color: var(--accent) rgba(20, 13, 35, 0.8);
        }

        /* Анимация точек загрузки */
        .loading-dots::after {
            content: '.';
            animation: dotsAnimation 1s ease-in-out infinite;
        }

        @keyframes dotsAnimation {
            0% { content: '.'; }
            25% { content: '..'; }
            50% { content: '...'; }
            75% { content: '....'; }
            100% { content: '.....'; }
        }

        /* Поля ввода для проверки навыков */
        .field {
            display: flex;
            flex-direction: column;
            gap: 0.4rem;
            font-size: 0.75rem;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            color: var(--muted);
        }

        .field input,
        .field select {
            width: 100%;
            background: rgba(20, 13, 35, 0.92);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 0.6rem 0.75rem;
            color: var(--text);
            font-size: 0.95rem;
            transition: border 0.2s ease, box-shadow 0.2s ease;
        }

        .field input:focus,
        .field select:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 14px rgba(182, 103, 255, 0.4);
        }

        /* Стили для слайдеров */
        .slider {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: rgba(182, 103, 255, 0.2);
            outline: none;
            transition: all 0.3s ease;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--accent), var(--accent-2));
            cursor: pointer;
            box-shadow: 0 0 10px rgba(182, 103, 255, 0.5);
            transition: all 0.3s ease;
        }

        .slider::-webkit-slider-thumb:hover {
            transform: scale(1.1);
            box-shadow: 0 0 15px rgba(182, 103, 255, 0.7);
        }

        .slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--accent), var(--accent-2));
            cursor: pointer;
            border: none;
            box-shadow: 0 0 10px rgba(182, 103, 255, 0.5);
        }

        /* Стили для прогресс-баров */
        .progress-bar {
            width: 100%;
            height: 8px;
            background: rgba(182, 103, 255, 0.2);
            border-radius: 4px;
            overflow: hidden;
            position: relative;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent), var(--accent-2));
            border-radius: 4px;
            transition: width 0.3s ease;
            box-shadow: 0 0 10px rgba(182, 103, 255, 0.5);
        }

        /* Стили для списков */
        .list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .list-item {
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(182, 103, 255, 0.2);
            border-radius: 8px;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            transition: all 0.3s ease;
        }

        .list-item:hover {
            background: rgba(0, 0, 0, 0.3);
            border-color: var(--border);
        }

        .list-item:last-child {
            margin-bottom: 0;
        }

        /* Стили для карточек */
        .card {
            background: linear-gradient(135deg, var(--panel), var(--panel-alt));
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1rem;
            box-shadow: var(--shadow);
            transition: all 0.3s ease;
        }

        .card:hover {
            box-shadow: 0 0 30px rgba(182, 103, 255, 0.4);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid rgba(182, 103, 255, 0.2);
        }

        .card-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--accent);
            text-transform: uppercase;
            letter-spacing: 0.08em;
        }

        .card-content {
            color: var(--text);
            line-height: 1.5;
        }

        /* Стили для таблиц */
        .table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 1rem;
        }

        .table th,
        .table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid rgba(182, 103, 255, 0.2);
        }

        .table th {
            background: rgba(182, 103, 255, 0.1);
            color: var(--accent);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            font-size: 0.8rem;
        }

        .table td {
            color: var(--text);
        }

        .table tr:hover {
            background: rgba(182, 103, 255, 0.05);
        }

        /* Стили для анимаций */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes slideIn {
            from { transform: translateX(-100%); }
            to { transform: translateX(0); }
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .fade-in {
            animation: fadeIn 0.5s ease-out;
        }

        .slide-in {
            animation: slideIn 0.3s ease-out;
        }

        .pulse {
            animation: pulse 2s infinite;
        }

        /* Стили для модальных окон */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.85);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            animation: fadeIn 0.3s ease;
        }

        /* Вложенные модальные окна (уведомления о покупке) будут иметь более высокий z-index */
        .modal-overlay + .modal-overlay {
            z-index: 10000;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        .modal {
            background: linear-gradient(135deg, var(--panel), var(--panel-alt));
            border: 1px solid var(--border);
            border-radius: 18px;
            padding: 2rem;
            max-width: 90vw;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow);
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from {
                transform: translateY(50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border);
        }

        .modal-header h3 {
            margin: 0;
            font-size: 1.3rem;
            color: var(--accent);
            text-transform: uppercase;
            letter-spacing: 0.08em;
        }

        .modal-body {
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 0.75rem;
            padding-top: 1rem;
            padding-bottom: 0.5rem;
            border-top: 1px solid var(--border);
            margin-top: 1rem;
        }

        .icon-button {
            background: transparent;
            border: none;
            color: var(--text);
            font-size: 2rem;
            line-height: 1;
            cursor: pointer;
            transition: all 0.2s ease;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .icon-button:hover {
            color: var(--danger);
            transform: rotate(90deg);
        }

        /* Стили для уведомлений */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, var(--panel), var(--panel-alt));
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1rem 1.5rem;
            box-shadow: var(--shadow);
            z-index: 1001;
            transform: translateX(100%);
            transition: transform 0.3s ease;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.success {
            border-color: var(--success);
            background: linear-gradient(135deg, rgba(125, 244, 198, 0.1), var(--panel));
        }

        .notification.error {
            border-color: var(--danger);
            background: linear-gradient(135deg, rgba(255, 91, 135, 0.1), var(--panel));
        }

        /* Стили для лога бросков */
        .roll-entry {
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(182, 103, 255, 0.2);
            border-radius: 8px;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            transition: all 0.3s ease;
        }

        .roll-entry:hover {
            background: rgba(0, 0, 0, 0.3);
            border-color: var(--border);
        }

        .roll-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .roll-skill {
            color: var(--accent);
            font-weight: 600;
            font-size: 0.9rem;
        }

        .roll-time {
            color: var(--muted);
            font-size: 0.8rem;
        }

        .roll-details {
            color: var(--text);
            font-size: 0.9rem;
            line-height: 1.4;
        }

        .roll-critical {
            color: var(--danger);
            font-weight: bold;
            margin-top: 0.5rem;
            text-align: center;
        }

        .roll-log-container {
            max-height: 400px;
            overflow-y: auto;
            padding-right: 0.5rem;
        }

        .roll-log-container::-webkit-scrollbar {
            width: 6px;
        }

        .roll-log-container::-webkit-scrollbar-track {
            background: rgba(182, 103, 255, 0.1);
            border-radius: 3px;
        }

        .roll-log-container::-webkit-scrollbar-thumb {
            background: var(--accent);
            border-radius: 3px;
        }

        .roll-log-container::-webkit-scrollbar-thumb:hover {
            background: var(--accent-2);
        }

        /* Стили для консоли лога бросков */
        .roll-log-console {
            background: linear-gradient(135deg, var(--panel), var(--panel-alt));
            border: 1px solid var(--border);
            border-radius: 12px;
            margin-bottom: 1rem;
            box-shadow: var(--shadow);
            overflow: hidden;
            max-height: 200px;
        }

        .console-header {
            background: rgba(182, 103, 255, 0.1);
            padding: 0.5rem 1rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .console-title {
            color: var(--accent);
            font-size: 0.9rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.08em;
        }

        .console-content {
            max-height: 150px;
            overflow-y: auto;
            padding: 0.75rem;
            font-family: "Courier New", monospace;
            font-size: 0.85rem;
            background: rgba(0, 0, 0, 0.3);
            line-height: 1.4;
        }

        .console-content::-webkit-scrollbar {
            width: 6px;
        }

        .console-content::-webkit-scrollbar-track {
            background: rgba(182, 103, 255, 0.1);
        }

        .console-content::-webkit-scrollbar-thumb {
            background: var(--accent);
            border-radius: 3px;
        }

        .console-content::-webkit-scrollbar-thumb:hover {
            background: var(--accent-2);
        }

        .roll-log-entry {
            margin-bottom: 0.5rem;
            padding: 0.25rem 0;
            border-bottom: 1px solid rgba(182, 103, 255, 0.1);
        }

        .roll-log-entry:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }

        .roll-log-time {
            color: var(--muted);
            font-size: 0.75rem;
            margin-right: 0.5rem;
        }

        .roll-log-text {
            color: var(--text);
        }

        .roll-log-success {
            color: var(--success);
        }

        .roll-log-failure {
            color: var(--danger);
        }

        /* Полноширинная секция */
        .full-width-section {
            width: 100%;
            margin-bottom: 1.5rem;
            background: linear-gradient(135deg, var(--panel), var(--panel-alt));
            border: 1px solid var(--border);
            border-radius: 18px;
            padding: 1.5rem;
            box-shadow: var(--shadow);
        }

        .full-width-section .section-header {
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border);
        }

        .full-width-section .section-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: var(--accent);
            text-transform: uppercase;
            letter-spacing: 0.08em;
            margin: 0;
        }

        .avatar-section {
            text-align: center;
        }

        .avatar-placeholder {
            width: 100%;
            height: 400px;
            background: rgba(0,0,0,0.3);
            border: 2px solid var(--border);
            border-radius: 8px;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--muted);
            font-size: 2rem;
        }

        .avatar-controls {
            display: flex;
            flex-direction: column;
            gap: 0.3rem;
        }

        .avatar-button {
            font-size: 0.8rem;
            padding: 0.3rem 0.6rem;
        }

        /* Стили для секции "Дека" */
        .deck-stats-section {
            margin-bottom: 1.5rem;
        }

        .deck-stats-grid {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .deck-stats-grid .input-group.full-width {
            width: 100%;
        }

        .deck-specs-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 1rem;
        }

        @media (min-width: 768px) {
            .deck-specs-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .deck-programs-section,
        .deck-chips-section {
            margin-bottom: 1.5rem;
        }

        .section-subtitle {
            font-size: 1rem;
            font-weight: 600;
            color: var(--accent);
            text-transform: uppercase;
            letter-spacing: 0.08em;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--border);
        }

        .program-item,
        .chip-item {
            background: rgba(20, 13, 35, 0.92);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 0.75rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .program-info,
        .chip-info {
            flex: 1;
        }

        .program-name,
        .chip-name {
            font-weight: 600;
            color: var(--text);
            margin-bottom: 0.25rem;
        }

        .program-details,
        .chip-details {
            font-size: 0.85rem;
            color: var(--muted);
        }

        .program-actions,
        .chip-actions {
            display: flex;
            gap: 0.5rem;
        }

        /* Стили для секции "Киберимпланты" */
        .implant-item {
            background: rgba(20, 13, 35, 0.92);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 0.75rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .implant-info {
            flex: 1;
        }

        .implant-name {
            font-weight: 600;
            color: var(--text);
            margin-bottom: 0.25rem;
        }

        .implant-category {
            font-size: 0.8rem;
            color: var(--accent);
            margin-bottom: 0.25rem;
        }

        .implant-details {
            font-size: 0.85rem;
            color: var(--muted);
        }

        .implant-actions {
            display: flex;
            gap: 0.5rem;
        }

        .category-section {
            margin-bottom: 1.5rem;
        }

        .category-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--accent);
            margin-bottom: 0.75rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--border);
        }

        /* Стили для секции "Оружие" */
        .weapon-item {
            background: rgba(20, 13, 35, 0.92);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 0.75rem;
        }

        .weapon-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
        }

        .weapon-name {
            font-weight: 600;
            color: var(--text);
            font-size: 1.1rem;
        }

        .weapon-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 0.75rem;
            margin-bottom: 0.75rem;
        }

        .weapon-stat {
            font-size: 0.85rem;
            color: var(--muted);
        }

        .weapon-stat strong {
            color: var(--accent);
        }

        .weapon-notes {
            font-size: 0.85rem;
            color: var(--muted);
            font-style: italic;
            margin-top: 0.5rem;
        }

        /* Стили для секции "Броня" */
        .armor-zones {
            display: grid;
            gap: 1rem;
        }

        .armor-zone {
            background: rgba(20, 13, 35, 0.92);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1rem;
        }

        .armor-zone-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--accent);
            margin-bottom: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.08em;
        }

        .armor-zone-controls {
            display: flex;
            gap: 1rem;
        }

        /* Стили для секции "Собственность" */
        .property-subsection {
            margin-bottom: 2rem;
        }

        .property-item {
            background: rgba(20, 13, 35, 0.92);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 0.75rem;
        }

        .property-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
        }

        .property-name {
            font-weight: 600;
            color: var(--text);
            font-size: 1.1rem;
        }

        .property-description {
            font-size: 0.9rem;
            color: var(--muted);
            margin-top: 0.5rem;
        }

        .vehicle-image-wrapper {
            margin-top: 0.75rem;
        }

        .vehicle-image {
            width: 100%;
            max-width: 300px;
            height: 150px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border);
            border-radius: 8px;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 0.5rem;
        }

        .vehicle-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .vehicle-image-placeholder {
            color: var(--muted);
            font-size: 2rem;
        }

        .vehicle-image-actions {
            display: flex;
            gap: 0.5rem;
        }

        /* Стили для критических травм */
        .injuries-section {
            margin-top: 1.5rem;
        }

        .injuries-label {
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--accent);
            text-transform: uppercase;
            letter-spacing: 0.08em;
            margin-bottom: 0.75rem;
        }

        .injuries-list {
            margin-top: 1rem;
        }

        .injury-item {
            background: rgba(20, 13, 35, 0.92);
            border: 1px solid rgba(255, 91, 135, 0.3);
            border-radius: 12px;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .injury-text {
            flex: 1;
            color: var(--text);
            font-size: 0.9rem;
        }

        .injury-remove {
            background: var(--danger);
            color: var(--bg);
            border: none;
            border-radius: 6px;
            padding: 0.25rem 0.5rem;
            font-size: 0.8rem;
            cursor: pointer;
            transition: opacity 0.2s;
        }

        .injury-remove:hover {
            opacity: 0.8;
        }

        .basic-info-section {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .experience-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .stats-section {
            margin-bottom: 1.5rem;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1rem;
        }

        .stat-box {
            background: rgba(0,0,0,0.2);
            border: 1px solid rgba(182, 103, 255, 0.2);
            border-radius: 8px;
            padding: 0.75rem;
            text-align: center;
        }

        .stat-label {
            color: var(--accent);
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            margin-bottom: 0.5rem;
        }

        .stat-value {
            background: rgba(0,0,0,0.3);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 0.5rem;
            color: var(--text);
            font-family: inherit;
            font-size: 1rem;
            font-weight: 600;
            text-align: center !important;
            width: 100%;
            transition: all 0.3s ease;
        }

        .stat-value:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 15px rgba(182, 103, 255, 0.3);
        }

        .luck-box {
            grid-column: span 2;
        }

        .luck-values {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .luck-separator {
            color: var(--muted);
            font-weight: bold;
        }

        .derived-stats-section {
            margin-bottom: 1.5rem;
        }

        .derived-stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr) 120px;
            gap: 1rem;
        }

        .derived-stat-box {
            background: rgba(0,0,0,0.2);
            border: 1px solid rgba(182, 103, 255, 0.2);
            border-radius: 8px;
            padding: 0.75rem;
            text-align: center;
        }

        .derived-stat-label {
            color: var(--accent);
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            margin-bottom: 0.5rem;
        }

        .derived-stat-value {
            color: var(--accent);
            font-weight: bold;
            font-size: 1.2rem;
        }

        .derived-stat-input {
            background: rgba(0,0,0,0.3);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 0.5rem;
            color: var(--text);
            font-family: inherit;
            font-size: 1rem;
            font-weight: 600;
            text-align: center;
            width: 100%;
            transition: all 0.3s ease;
        }

        .derived-stat-input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 15px rgba(182, 103, 255, 0.3);
        }

        .health-money-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .health-box, .money-box {
            background: rgba(0,0,0,0.2);
            border: 1px solid rgba(182, 103, 255, 0.2);
            border-radius: 8px;
            padding: 1rem;
            text-align: center;
        }

        .health-icon, .money-icon {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
        }

        .health-label, .money-label {
            color: var(--accent);
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            margin-bottom: 0.5rem;
        }

        .health-values {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .health-input {
            background: rgba(0,0,0,0.3);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 0.5rem;
            color: var(--text);
            font-family: inherit;
            font-size: 1rem;
            font-weight: 600;
            text-align: center;
            width: 60px;
            transition: all 0.3s ease;
        }

        .health-input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 15px rgba(182, 103, 255, 0.3);
        }

        .health-separator {
            color: var(--muted);
            font-weight: bold;
        }

        .money-input {
            background: rgba(0,0,0,0.3);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 0.5rem;
            color: var(--text);
            font-family: inherit;
            font-size: 1rem;
            font-weight: 600;
            text-align: center;
            width: 100px;
            transition: all 0.3s ease;
        }

        .money-input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 15px rgba(182, 103, 255, 0.3);
        }

        .money-unit {
            color: var(--muted);
            font-size: 0.9rem;
            margin-left: 0.5rem;
        }

        .reputation-section {
            margin-bottom: 1.5rem;
        }

        .reputation-label {
            color: var(--accent);
            font-size: 0.9rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            margin-bottom: 0.5rem;
        }

        /* Градиентный слайдер репутации */
        .reputation-slider {
            -webkit-appearance: none;
            appearance: none;
            height: 8px;
            border-radius: 4px;
            background: linear-gradient(to right, 
                #ff0000 0%, 
                #ff8000 25%, 
                #ffff00 50%, 
                #80ff00 75%, 
                #0000ff 100%);
            outline: none;
            cursor: pointer;
        }

        .reputation-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: white;
            border: 2px solid var(--accent);
            cursor: pointer;
            box-shadow: 0 0 10px rgba(182, 103, 255, 0.5);
        }

        .reputation-slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: white;
            border: 2px solid var(--accent);
            cursor: pointer;
            box-shadow: 0 0 10px rgba(182, 103, 255, 0.5);
        }

        .reputation-controls {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .reputation-min, .reputation-max {
            color: var(--muted);
            font-size: 0.8rem;
            min-width: 30px;
        }

        .reputation-value {
            color: var(--accent);
            font-weight: bold;
            font-size: 1.2rem;
            min-width: 30px;
            text-align: center;
        }

        /* Стили для лога бросков и универсальной бросалки */
        .roll-log-console {
            background: linear-gradient(135deg, var(--panel), var(--panel-alt));
            border: 1px solid var(--border);
            border-radius: 18px;
            padding: 1.5rem;
            box-shadow: var(--shadow);
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .console-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--border);
        }

        .console-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--accent);
            text-transform: uppercase;
            letter-spacing: 0.08em;
        }

        .console-content {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            line-height: 1.4;
        }

        .injuries-section {
            margin-bottom: 1.5rem;
        }

        .injuries-label {
            color: var(--accent);
            font-size: 0.9rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            margin-bottom: 0.5rem;
        }

        .injuries-list {
            margin-top: 0.5rem;
        }

        .backstory-section {
            margin-bottom: 1.5rem;
        }

        .backstory-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .backstory-icon {
            font-size: 1.2rem;
        }

        .backstory-label {
            color: var(--accent);
            font-size: 0.9rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            flex: 1;
        }

        .expand-button {
            font-size: 0.8rem;
            padding: 0.3rem 0.6rem;
        }

        .backstory-textarea {
            width: 100%;
            min-height: 100px;
            background: rgba(0,0,0,0.3);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 0.75rem;
            color: var(--text);
            font-family: inherit;
            font-size: 0.9rem;
            resize: vertical;
            transition: all 0.3s ease;
        }

        .backstory-textarea:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 15px rgba(182, 103, 255, 0.3);
        }

        .backstory-textarea::placeholder {
            color: var(--muted);
        }

        /* Заглушка для мобильных устройств */
        .mobile-warning {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem;
        }
        
        .mobile-warning-content {
            text-align: center;
            max-width: 500px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 2rem;
        }
        
        .mobile-warning-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
        }
        
        .mobile-warning-title {
            color: var(--accent);
            font-size: 1.5rem;
            margin-bottom: 1rem;
            font-weight: 600;
        }
        
        .mobile-warning-text {
            color: var(--text);
            line-height: 1.6;
            margin-bottom: 1.5rem;
        }
        
        .mobile-warning-specs {
            background: rgba(255, 91, 135, 0.1);
            border: 1px solid var(--danger);
            border-radius: 8px;
            padding: 1rem;
            display: grid;
            gap: 0.5rem;
            font-family: monospace;
            font-size: 0.9rem;
        }
        
        .mobile-warning-specs div:first-child {
            color: var(--danger);
            font-weight: 600;
        }
        
        .mobile-warning-specs div:last-child {
            color: var(--success);
            font-weight: 600;
        }

        /* Улучшенная адаптивная верстка для планшетов */
        @media (max-width: 1200px) and (min-width: 1024px) {
            .container {
                padding: 1rem;
            }
            
            .main-content {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
            
            .sections-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 1rem;
            }
            
            .modal {
                max-width: 90vw !important;
                max-height: 90vh !important;
                margin: 1rem;
                overflow-y: auto;
            }
            
            .section {
                min-height: auto;
            }
            
            /* Улучшаем отображение основной информации на планшетах */
            .main-content > div:first-child {
                grid-template-columns: auto 1fr !important;
                gap: 1rem;
            }
            
            .avatar-section {
                width: 200px;
            }
            
            .avatar-placeholder {
                height: 250px !important;
            }
            
            /* Компактные кнопки для планшетов */
            .pill-button {
                font-size: 0.85rem;
                padding: 0.5rem 1rem;
            }
            
            /* Компактные input поля */
            .input-field, .stat-value {
                padding: 0.6rem;
                font-size: 0.9rem;
            }
            
            /* Улучшаем отображение характеристик */
            .stats-grid {
                grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)) !important;
                gap: 0.75rem;
            }
            
            .stat-box {
                padding: 0.75rem;
            }
            
            /* Компактный header */
            .header {
                padding: 1rem;
                gap: 1rem;
            }
            
            .header-title {
                font-size: 1.3rem;
            }
            
            /* Компактные секции */
            .section-header {
                padding: 0.75rem 1rem;
            }
            
            .section-content {
                padding: 1rem;
            }
        }

        @media (max-width: 1023px) {
            /* Скрываем основной контент на экранах меньше 1024px */
            .container {
                display: none !important;
            }
            
            .loading-screen {
                display: none !important;
            }
            
            .mobile-warning {
                display: flex !important;
            }
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .sections-grid {
                grid-template-columns: 1fr;
            }
            
            /* Верхняя панель на мобильных устройствах */
            .main-content > div:first-child {
                grid-template-columns: 1fr !important;
            }
            
            .header {
                padding: 1rem;
                flex-direction: column;
                gap: 1rem;
            }
            
            .header-title {
                font-size: 1.2rem;
            }
            
            .header-controls {
                flex-wrap: wrap;
                justify-content: center;
            }
            
            .pill-button {
                font-size: 0.8rem;
                padding: 0.4rem 0.8rem;
            }
            
            .modal {
                margin: 1rem;
                padding: 1.5rem;
            }
            
            .input-row {
                flex-direction: column;
                gap: 0.5rem;
            }
            
            .input-row .input-field {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <!-- Заглушка для мобильных устройств -->
    <div class="mobile-warning" id="mobileWarning" style="display: none;">
        <div class="mobile-warning-content">
            <div class="mobile-warning-icon">&#x1F4F1;</div>
            <h2 class="mobile-warning-title">Экран слишком мал</h2>
            <p class="mobile-warning-text">
                Данное приложение предназначено для использования на устройствах с большим экраном.
                <br><br>
                Пожалуйста, откройте страницу на компьютере, ноутбуке или планшете с экраном шириной от 1024px.
            </p>
            <div class="mobile-warning-specs">
                <div>Ваш экран: <span id="screenWidth">0</span>px</div>
                <div>Минимум: 1024px</div>
            </div>
        </div>
    </div>

    <!-- Загрузочный экран -->
    <div class="loading-screen" id="loadingScreen">
        <div class="loading-logo">EZY: CYBER // HUMAN_DESIGN [OPEN BETA v0.69.101]</div>
        <div class="loading-log" id="loadingLog">
            <div class="loading-log-item" id="logItem1"></div>
            <div class="loading-log-item" id="logItem2"></div>
            <div class="loading-log-item" id="logItem3"></div>
            <div class="loading-log-item" id="logItem4"></div>
            <div class="loading-log-item" id="logItem5"></div>
            <div class="loading-log-item" id="logItem6"></div>
        </div>
        <div class="loading-progress">
            <div class="loading-progress-bar" id="progressBar"></div>
            <div class="loading-progress-text" id="progressText">0%</div>
        </div>
    </div>

    <!-- Основной интерфейс -->
    <div class="main-interface" id="mainInterface">
        <!-- Заголовок -->
        <header class="header">
            <div class="header-title">&#x1F9EC; EZY: Cyber — Лист персонажа</div>
            <div class="header-controls">
                <button class="pill-button primary-button" onclick="exportData()">&#x1F4BE; Экспорт JSON</button>
                <button class="pill-button muted-button" onclick="importData()">&#x27F2; Импорт JSON</button>
                <button class="pill-button danger-button" onclick="clearAllData()">Очистить данные</button>
            </div>
        </header>

        <!-- Основной контент -->
        <main class="main-content">
            <!-- Лог бросков - на всю ширину -->
            <div class="roll-log-console" id="rollLogConsole" style="margin-bottom: 1.5rem;">
                <div class="console-header">
                    <span class="console-title">&#x1F4E1; ЛОГ БРОСКОВ</span>
                    <button class="pill-button danger-button" onclick="clearRollLog()" style="font-size: 0.7rem; padding: 0.2rem 0.5rem;">Очистить</button>
                </div>
                <div class="console-content" id="rollLogContainer">
                    <p style="color: var(--muted); text-align: center; padding: 1rem;">Лог бросков пуст</p>
                </div>
            </div>

            <!-- Общая информация - полноширинный блок -->
            <div class="section full-width-section" id="generalInfoSection">
                <div class="section-header">
                    <h3 class="section-title">&#x1F9E0; Общая информация</h3>
                </div>
                <div class="section-content expanded">
                    <!-- Главная сетка: Аватар слева, информация в центре -->
                    <div style="display: grid; grid-template-columns: auto 1fr; gap: 2rem; margin-bottom: 1.5rem;">
                        <!-- Аватар, кнопки, здоровье и деньги -->
                        <div class="avatar-section">
                            <div id="avatarDisplay" class="avatar-placeholder" style="width: 100%; height: 400px;">
                                &#x1F916;
                            </div>
                            <div class="avatar-controls">
                                <label class="pill-button muted-button avatar-button">
                                    &#x1F4F7; Загрузить фото
                                    <input type="file" id="avatarInput" accept="image/*" style="display: none;" />
                                </label>
                                <button class="pill-button muted-button avatar-button" id="removeAvatarButton">&#x1F5D1;&#xFE0F; Удалить</button>
                            </div>
                            
                            <!-- Пункты здоровья -->
                            <div class="health-box" style="margin-top: 1rem; width: 100%;">
                                <div class="health-icon">&#x2764;&#xFE0F;</div>
                                <div class="health-label" style="font-size: 0.7rem;">ПУНКТЫ ЗДОРОВЬЯ</div>
                                <div class="health-values">
                                    <input type="number" class="health-input" id="healthCurrent" value="25" min="0" onchange="state.health.current = parseInt(this.value); scheduleSave();" style="width: 60px;">
                                    <span class="health-separator">/</span>
                                    <input type="number" class="health-input" id="healthMax" value="38" readonly style="width: 60px;">
                                </div>
                            </div>
                            
                            <!-- уе -->
                            <div class="money-box" style="margin-top: 0.75rem; width: 100%;">
                                <div class="money-icon">&#x1F4B0;</div>
                                <div class="money-label" style="font-size: 0.7rem;">УЕ</div>
                                <input type="text" class="money-input" id="money" value="0" onchange="state.money = parseInt(this.value.replace(/\\s+/g, '')) || 0; this.value = formatMoney(state.money); scheduleSave();" style="width: 100%; font-size: 1rem; padding: 0.5rem; text-align: center;">
                                <span class="money-unit" style="margin-top: 0.25rem; display: block; text-align: center;">уе</span>
                            </div>
                            
                            <!-- Репутация -->
                            <div class="reputation-section" style="margin-top: 0.75rem; width: 100%;">
                                <div class="reputation-label" style="font-size: 0.7rem; color: var(--accent); font-weight: 600; margin-bottom: 0.5rem; text-transform: uppercase; text-align: center;">РЕПУТАЦИЯ</div>
                                <div class="reputation-controls" style="display: flex; flex-direction: column; align-items: center; gap: 0.5rem;">
                                    <input type="range" class="reputation-slider" id="reputationSlider" min="-10" max="10" value="0" oninput="state.reputation = parseInt(this.value); document.getElementById('reputationValue').textContent = this.value; updateReputationColor(); scheduleSave();" style="width: 100%;">
                                    <div class="reputation-value" id="reputationValue" style="text-align: center; font-weight: 600; font-size: 1.2rem; color: white;">0</div>
                                </div>
                            </div>
                            
                            <!-- Профессиональные навыки -->
                            <div class="professional-skills-section" style="margin-top: 0.75rem; width: 100%;">
                                <div class="professional-skills-label" style="font-size: 0.7rem; color: var(--accent); font-weight: 600; margin-bottom: 0.5rem; text-transform: uppercase; text-align: center;">ПРОФЕССИОНАЛЬНЫЕ НАВЫКИ</div>
                                <div class="professional-skills-content" style="background: rgba(0,0,0,0.2); border: 1px solid rgba(182, 103, 255, 0.2); border-radius: 8px; padding: 0.75rem;">
                                    <div class="professional-skills-header" style="display: grid; grid-template-columns: 1fr 80px; gap: 0.5rem; margin-bottom: 0.5rem; font-size: 0.7rem; color: var(--muted); text-transform: uppercase; font-weight: 600;">
                                        <div>НАЗВАНИЕ</div>
                                        <div style="text-align: center;">УРОВЕНЬ</div>
                                    </div>
                                    <div class="professional-skills-rows">
                                        <div class="professional-skill-row" style="display: grid; grid-template-columns: 1fr 80px; gap: 0.5rem; margin-bottom: 0.5rem;">
                                            <input type="text" class="professional-skill-name" id="professionalSkillName0" placeholder="Название навыка" onchange="updateProfessionalSkill(0, this.value, document.getElementById('professionalSkillLevel0').value);" style="background: rgba(0,0,0,0.3); border: 1px solid var(--border); border-radius: 4px; padding: 0.3rem; color: var(--text); font-size: 0.8rem;">
                                            <input type="text" class="professional-skill-level" id="professionalSkillLevel0" value="0" min="0" max="10" onchange="updateProfessionalSkill(0, document.getElementById('professionalSkillName0').value, this.value);" style="background: rgba(0,0,0,0.3); border: 1px solid var(--border); border-radius: 4px; padding: 0.3rem; color: var(--text); font-size: 0.8rem; text-align: center;">
                                        </div>
                                        <div class="professional-skill-row" style="display: grid; grid-template-columns: 1fr 80px; gap: 0.5rem; margin-bottom: 0.5rem;">
                                            <input type="text" class="professional-skill-name" id="professionalSkillName1" placeholder="Название навыка" onchange="updateProfessionalSkill(1, this.value, document.getElementById('professionalSkillLevel1').value);" style="background: rgba(0,0,0,0.3); border: 1px solid var(--border); border-radius: 4px; padding: 0.3rem; color: var(--text); font-size: 0.8rem;">
                                            <input type="text" class="professional-skill-level" id="professionalSkillLevel1" value="0" min="0" max="10" onchange="updateProfessionalSkill(1, document.getElementById('professionalSkillName1').value, this.value);" style="background: rgba(0,0,0,0.3); border: 1px solid var(--border); border-radius: 4px; padding: 0.3rem; color: var(--text); font-size: 0.8rem; text-align: center;">
                                        </div>
                                        <div class="professional-skill-row" style="display: grid; grid-template-columns: 1fr 80px; gap: 0.5rem; margin-bottom: 0.5rem;">
                                            <input type="text" class="professional-skill-name" id="professionalSkillName2" placeholder="Название навыка" onchange="updateProfessionalSkill(2, this.value, document.getElementById('professionalSkillLevel2').value);" style="background: rgba(0,0,0,0.3); border: 1px solid var(--border); border-radius: 4px; padding: 0.3rem; color: var(--text); font-size: 0.8rem;">
                                            <input type="text" class="professional-skill-level" id="professionalSkillLevel2" value="0" min="0" max="10" onchange="updateProfessionalSkill(2, document.getElementById('professionalSkillName2').value, this.value);" style="background: rgba(0,0,0,0.3); border: 1px solid var(--border); border-radius: 4px; padding: 0.3rem; color: var(--text); font-size: 0.8rem; text-align: center;">
                                        </div>
                                        <div class="professional-skill-row" style="display: grid; grid-template-columns: 1fr 80px; gap: 0.5rem;">
                                            <input type="text" class="professional-skill-name" id="professionalSkillName3" placeholder="Название навыка" onchange="updateProfessionalSkill(3, this.value, document.getElementById('professionalSkillLevel3').value);" style="background: rgba(0,0,0,0.3); border: 1px solid var(--border); border-radius: 4px; padding: 0.3rem; color: var(--text); font-size: 0.8rem;">
                                            <input type="text" class="professional-skill-level" id="professionalSkillLevel3" value="0" min="0" max="10" onchange="updateProfessionalSkill(3, document.getElementById('professionalSkillName3').value, this.value);" style="background: rgba(0,0,0,0.3); border: 1px solid var(--border); border-radius: 4px; padding: 0.3rem; color: var(--text); font-size: 0.8rem; text-align: center;">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Центральная секция с характеристиками -->
                        <div style="display: flex; flex-direction: column; gap: 1rem;">
                            <!-- Имя персонажа -->
                            <div class="input-group">
                                <label class="input-label">ИМЯ ПЕРСОНАЖА</label>
                                <input type="text" class="input-field" id="characterName" placeholder="Введите имя" onchange="state.characterName = this.value; scheduleSave();">
                            </div>
                            
                            <!-- Очки опыта и ролевые очки -->
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                <div class="input-group">
                                    <label class="input-label">ОЧКИ ОПЫТА</label>
                                    <input type="text" class="input-field" id="experiencePoints" value="0" data-numeric="true" min="0" max="9999" onchange="state.experiencePoints = parseInt(this.value); scheduleSave();">
                                </div>
                                <div class="input-group">
                                    <label class="input-label">РОЛЕВЫЕ ОЧКИ</label>
                                    <input type="text" class="input-field" id="roleplayPoints" value="0" data-numeric="true" min="0" max="9999" onchange="state.roleplayPoints = parseInt(this.value); scheduleSave();">
                                </div>
                            </div>
                            
                            <!-- Строка: УМ, ЛВК, ТЕЛО -->
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 0.75rem;">
                                <div class="stat-box">
                                    <div class="stat-label">УМ</div>
                                    <input type="text" class="stat-value" id="statINT" value="5" min="1" max="20" onchange="state.stats.INT = parseInt(this.value); updateAwarenessMax(); scheduleSave();">
                                </div>
                                <div class="stat-box">
                                    <div class="stat-label">ЛВК</div>
                                    <input type="text" class="stat-value" id="statDEX" value="5" min="1" max="20" onchange="state.stats.DEX = parseInt(this.value); updateDerivedStats(); scheduleSave();">
                                </div>
                                <div class="stat-box">
                                    <div class="stat-label">ТЕЛО</div>
                                    <input type="text" class="stat-value" id="statBODY" value="5" min="1" max="20" onchange="state.stats.BODY = parseInt(this.value); calculateAndUpdateHealth(); updateDerivedStats(); scheduleSave();">
                                </div>
                            </div>
                            
                            <!-- Строка: ТЕХ, ХАР, РЕА -->
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 0.75rem;">
                                <div class="stat-box">
                                    <div class="stat-label">ТЕХ</div>
                                    <input type="text" class="stat-value" id="statTECH" value="5" min="1" max="20" onchange="state.stats.TECH = parseInt(this.value); scheduleSave();">
                                </div>
                                <div class="stat-box">
                                    <div class="stat-label">ХАР</div>
                                    <input type="text" class="stat-value" id="statCHA" value="5" min="1" max="20" onchange="state.stats.CHA = parseInt(this.value); scheduleSave();">
                                </div>
                                <div class="stat-box">
                                    <div class="stat-label">РЕА</div>
                                    <input type="text" class="stat-value" id="statREA" value="5" min="1" max="20" onchange="state.stats.REA = parseInt(this.value); scheduleSave();">
                                </div>
                            </div>
                            
                            <!-- Строка: ВОЛЯ, ВОС, СКОР. ПЕР., ОСОЗНАННОСТЬ -->
                            <!-- Строка: ВОЛЯ, ВОС, СКОР. ПЕР., СКОР. АТ., УДАЧА, ОСОЗНАННОСТЬ -->
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 0.75rem;">
                                <div class="stat-box">
                                    <div class="stat-label">ВОЛЯ</div>
                                    <input type="text" class="stat-value" id="statWILL" value="5" min="1" max="20" onchange="state.stats.WILL = parseInt(this.value); calculateAndUpdateHealth(); updateDerivedStats(); scheduleSave();">
                                </div>
                                <div class="derived-stat-box">
                                    <div class="derived-stat-label">ВОС</div>
                                    <div class="derived-stat-value" id="derivedArmor">2</div>
                                </div>
                                <div class="derived-stat-box">
                                    <div class="derived-stat-label" style="font-size: 0.7rem;">СКОРОСТЬ ПЕРЕМЕЩЕНИЯ</div>
                                    <div class="derived-stat-value" id="derivedSpeed">5</div>
                                    <div id="speedWarning" style="display: none;"></div>
                                </div>
                                <div class="derived-stat-box">
                                    <div class="derived-stat-label" style="font-size: 0.65rem;">СКОРОСТЬ РУКОПАШНОЙ АТАКИ</div>
                                    <div class="derived-stat-value" id="derivedAttackSpeed">2</div>
                                </div>
                                <div class="stat-box luck-box">
                                    <div class="stat-label">УДАЧА</div>                           
                                    <div class="luck-values">
                                        <input type="text" class="stat-value" id="luckCurrent" value="1" min="0" max="99" onchange="state.luck.current = parseInt(this.value); scheduleSave();" style="width: 100px;">
                                        <span class="luck-separator">/</span>
                                        <input type="text" class="stat-value" id="luckMax" value="1" min="1" max="99" onchange="state.luck.max = parseInt(this.value); scheduleSave();" style="width: 100px;">
                                    </div>
                                </div>
                                <div class="stat-box luck-box">
                                    <div class="stat-label">ОСОЗНАННОСТЬ</div>
                                    <div class="luck-values">
                                        <input type="text" class="stat-value" id="awarenessCurrent" value="50" min="0" max="999" onchange="state.awareness.current = parseInt(this.value); scheduleSave();" style="width: 100px;">
                                        <span class="luck-separator">/</span>
                                        <input type="text" class="stat-value" id="awarenessMax" value="50" min="1" max="999" onchange="state.awareness.max = parseInt(this.value); scheduleSave();" style="width: 100px;">
                                    </div>
                                    <div style="font-size: 0.7rem; color: var(--muted); font-style: italic; margin-top: 0.25rem; text-align: center;">Максимальная Осознанность = УМ*10</div>
                                </div>
                            </div>
                            
                            <!-- Критические травмы -->
                            <div class="injuries-section" style="margin-top: 1rem;">
                                <div class="injuries-label">КРИТИЧЕСКИЕ ТРАВМЫ</div>
                                <button class="pill-button primary-button" onclick="addCriticalInjury()">+ Добавить травму</button>
                                <div id="injuriesList" class="injuries-list">
                                    <p style="color: var(--muted); font-size: 0.9rem; margin-top: 0.5rem;">Травмы не добавлены</p>
                                </div>
                            </div>

                            <!-- Предыстория -->
                            <div class="backstory-section" style="margin-top: 1rem;">
                                <div class="backstory-header">
                                    <div class="backstory-icon">&#x1F4C4;</div>
                                    <div class="backstory-label">Предыстория персонажа</div>
                                    <button class="pill-button primary-button" onclick="generateBackstory()">&#x1F3B2; Сгенерировать</button>
                                </div>
                                <textarea class="backstory-textarea" id="backstoryText" placeholder="Ну и как ты сюда попал?" onchange="state.backstory = this.value; scheduleSave();" style="height: 200px;"></textarea>
                            </div>
                            
                        </div>
                    </div>
                </div>
            </div>

            <!-- Навыки - полноширинный блок -->
            <div class="section full-width-section" id="skillsSection">
                <div class="section-header">
                    <h3 class="section-title">&#x1F52B; Навыки</h3>
                    <button class="pill-button primary-button" onclick="showAddSkillModal()" style="font-size: 0.8rem; padding: 0.3rem 0.6rem;">Добавить навык</button>
                </div>
                <div class="section-content expanded">
                    <div id="skillsContainer">
                        <p style="color: var(--muted); text-align: center; padding: 2rem;">Навыки не добавлены. Добавьте навыки из библиотеки или создайте свои.</p>
                    </div>
                </div>
            </div>

            <!-- Сетка секций -->
            <div class="sections-grid" id="sectionsGrid" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1.5rem;">


                <!-- Оружие -->
                <div class="section" id="weaponSection">
                    <div class="section-header">
                        <h3 class="section-title">&#x1F52B; Оружие</h3>
                    </div>
                    <div class="section-content expanded">
                        <div style="display: flex; gap: 0.5rem; justify-content: center; margin-bottom: 1rem;">
                            <button class="pill-button primary-button" onclick="showWeaponShop()" style="font-size: 0.8rem; padding: 0.3rem 0.6rem;">Купить оружие</button>
                            <button class="pill-button success-button" onclick="showWeaponModulesShop()" style="font-size: 0.8rem; padding: 0.3rem 0.6rem;">Купить модули</button>
                        </div>
                        <div id="weaponsContainer">
                            <p style="color: var(--muted); text-align: center; padding: 2rem;">Оружие не добавлено</p>
                        </div>
                    </div>
                </div>

                <!-- Боеприпасы -->
                <div class="section" id="ammoSection">
                    <div class="section-header">
                        <h3 class="section-title">&#x1F52B; Боеприпасы</h3>
                        <div style="display: flex; gap: 0.5rem;">
                            <button class="pill-button primary-button" onclick="showAmmoShop()" style="font-size: 0.8rem; padding: 0.3rem 0.6rem;">Купить боеприпасы</button>
                        </div>
                    </div>
                    <div class="section-content expanded">
                        <div id="ammoContainer">
                            <p style="color: var(--muted); text-align: center; padding: 2rem;">Боеприпасы не добавлены</p>
                        </div>
                    </div>
                </div>

                <!-- Броня -->
                <div class="section" id="armorSection">
                    <div class="section-header">
                        <h3 class="section-title">&#x1F6E1;&#xFE0F; Броня</h3>
                    </div>
                    <div class="section-content expanded">
                        <div style="display: grid; gap: 0.5rem;">
                            <!-- Голова -->
                            <div style="display: grid; grid-template-columns: 80px 1fr 1.5fr; gap: 0.75rem; align-items: center;">
                                <span style="color: var(--accent); font-weight: 600; font-size: 0.9rem;">Голова:</span>
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <span style="color: var(--muted); font-size: 0.8rem;">ОС:</span>
                                    <input type="text" class="input-field" id="armorHeadOS" value="0" min="0" max="99" data-numeric="true" onchange="state.armor.head.os = parseInt(this.value); scheduleSave(); updateArmorPenalty();" style="width: 60px; padding: 0.4rem; text-align: center;">
                                    <button onclick="decreaseArmorOS('head')" style="background: transparent; border: none; color: var(--text); cursor: pointer; font-size: 0.8rem;">▼</button>
                                </div>
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <span style="color: var(--muted); font-size: 0.8rem;">Тип:</span>
                                    <select class="input-field" id="armorHeadType" onchange="state.armor.head.type = this.value; scheduleSave(); updateArmorPenalty();" style="padding: 0.4rem;">
                                        <option value="Лёгкая">Лёгкая 10 ОС</option>
                                        <option value="Средняя">Средняя 15 ОС</option>
                                        <option value="Тяжёлая">Тяжёлая 18 ОС</option>
                                        <option value="Титаническая">Титаническая 25 ОС</option>
                                    </select>
                                </div>
                            </div>
                            
                            <!-- Тело -->
                            <div style="display: grid; grid-template-columns: 80px 1fr 1.5fr; gap: 0.75rem; align-items: center;">
                                <span style="color: var(--accent); font-weight: 600; font-size: 0.9rem;">Тело:</span>
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <span style="color: var(--muted); font-size: 0.8rem;">ОС:</span>
                                    <input type="text" class="input-field" id="armorBodyOS" value="0" min="0" max="99" data-numeric="true" onchange="state.armor.body.os = parseInt(this.value); scheduleSave(); updateArmorPenalty();" style="width: 60px; padding: 0.4rem; text-align: center;">
                                    <button onclick="decreaseArmorOS('body')" style="background: transparent; border: none; color: var(--text); cursor: pointer; font-size: 0.8rem;">▼</button>
                                </div>
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <span style="color: var(--muted); font-size: 0.8rem;">Тип:</span>
                                    <select class="input-field" id="armorBodyType" onchange="state.armor.body.type = this.value; scheduleSave(); updateArmorPenalty();" style="padding: 0.4rem;">
                                        <option value="Лёгкая">Лёгкая 10 ОС</option>
                                        <option value="Средняя">Средняя 15 ОС</option>
                                        <option value="Тяжёлая">Тяжёлая 18 ОС</option>
                                        <option value="Титаническая">Титаническая 25 ОС</option>
                                    </select>
                                </div>
                            </div>
                            
                            <!-- Руки -->
                            <div style="display: grid; grid-template-columns: 80px 1fr 1.5fr; gap: 0.75rem; align-items: center;">
                                <span style="color: var(--accent); font-weight: 600; font-size: 0.9rem;">Руки:</span>
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <span style="color: var(--muted); font-size: 0.8rem;">ОС:</span>
                                    <input type="text" class="input-field" id="armorArmsOS" value="0" min="0" max="99" data-numeric="true" onchange="state.armor.arms.os = parseInt(this.value); scheduleSave(); updateArmorPenalty();" style="width: 60px; padding: 0.4rem; text-align: center;">
                                    <button onclick="decreaseArmorOS('arms')" style="background: transparent; border: none; color: var(--text); cursor: pointer; font-size: 0.8rem;">▼</button>
                                </div>
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <span style="color: var(--muted); font-size: 0.8rem;">Тип:</span>
                                    <select class="input-field" id="armorArmsType" onchange="state.armor.arms.type = this.value; scheduleSave(); updateArmorPenalty();" style="padding: 0.4rem;">
                                        <option value="Лёгкая">Лёгкая 10 ОС</option>
                                        <option value="Средняя">Средняя 15 ОС</option>
                                        <option value="Тяжёлая">Тяжёлая 18 ОС</option>
                                        <option value="Титаническая">Титаническая 25 ОС</option>
                                    </select>
                                </div>
                            </div>
                            
                            <!-- Ноги -->
                            <div style="display: grid; grid-template-columns: 80px 1fr 1.5fr; gap: 0.75rem; align-items: center;">
                                <span style="color: var(--accent); font-weight: 600; font-size: 0.9rem;">Ноги:</span>
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <span style="color: var(--muted); font-size: 0.8rem;">ОС:</span>
                                    <input type="text" class="input-field" id="armorLegsOS" value="0" min="0" max="99" data-numeric="true" onchange="state.armor.legs.os = parseInt(this.value); scheduleSave(); updateArmorPenalty();" style="width: 60px; padding: 0.4rem; text-align: center;">
                                    <button onclick="decreaseArmorOS('legs')" style="background: transparent; border: none; color: var(--text); cursor: pointer; font-size: 0.8rem;">▼</button>
                                </div>
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <span style="color: var(--muted); font-size: 0.8rem;">Тип:</span>
                                    <select class="input-field" id="armorLegsType" onchange="state.armor.legs.type = this.value; scheduleSave(); updateArmorPenalty();" style="padding: 0.4rem;">
                                        <option value="Лёгкая">Лёгкая 10 ОС</option>
                                        <option value="Средняя">Средняя 15 ОС</option>
                                        <option value="Тяжёлая">Тяжёлая 18 ОС</option>
                                        <option value="Титаническая">Титаническая 25 ОС</option>
                                    </select>
                                </div>
                            </div>
                            
                            <!-- Штраф от брони -->
                            <div style="margin-top: 1rem; padding: 0.75rem; background: rgba(255, 91, 135, 0.1); border: 1px solid var(--danger); border-radius: 8px;">
                                <div style="color: var(--danger); font-size: 0.8rem; font-weight: 600; margin-bottom: 0.5rem;">Штраф от брони:</div>
                                <div id="armorPenaltyText" style="color: var(--text); font-family: monospace; font-size: 0.75rem; line-height: 1.4;">Без штрафа</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Дека -->
                <div class="section" id="deckSection">
                    <div class="section-header">
                        <h3 class="section-title">&#x1F4BE; Дека</h3>
                        <button class="pill-button primary-button" onclick="showProgramShop()" style="font-size: 0.8rem; padding: 0.3rem 0.6rem;">Купить программу</button>
                    </div>
                    <div class="section-content expanded">
                        <!-- Компактные характеристики деки -->
                        <div style="display: grid; gap: 0.5rem; margin-bottom: 1rem;">
                            <!-- Название деки -->
                            <div style="display: grid; grid-template-columns: 80px 1fr; gap: 0.75rem; align-items: center;">
                                <span style="color: var(--accent); font-weight: 600; font-size: 0.9rem;">Название:</span>
                                <input type="text" class="input-field" id="deckName" onchange="state.deck.name = this.value; scheduleSave();" placeholder="Pro Super 2007" style="padding: 0.4rem; font-size: 0.9rem;">
                            </div>
                            
                            <!-- Оперативка и Сетка -->
                            <div style="display: grid; grid-template-columns: 80px 1fr 1fr; gap: 0.75rem; align-items: center;">
                                <span style="color: var(--accent); font-weight: 600; font-size: 0.9rem;">Система:</span>
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <span style="color: var(--muted); font-size: 0.8rem;">ОЗУ:</span>
                                    <input type="text" class="input-field" id="deckOperative" onchange="state.deck.operative = this.value; scheduleSave();" placeholder="ОЗУ" style="padding: 0.4rem; text-align: center;">
                                </div>
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <span style="color: var(--muted); font-size: 0.8rem;">Сетка:</span>
                                    <input type="text" class="input-field" id="deckGrid" onchange="state.deck.grid = this.value; scheduleSave();" placeholder="Сетка" style="padding: 0.4rem; text-align: center;">
                                </div>
                            </div>
                            
                            <!-- Память и Версия -->
                            <div style="display: grid; grid-template-columns: 80px 1fr 1fr; gap: 0.75rem; align-items: center;">
                                <span style="color: var(--accent); font-weight: 600; font-size: 0.9rem;">Данные:</span>
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <span style="color: var(--muted); font-size: 0.8rem;">Память:</span>
                                    <input type="text" class="input-field" id="deckMemory" onchange="state.deck.memory = this.value; scheduleSave();" placeholder="Память" style="padding: 0.4rem; text-align: center;">
                                </div>
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <span style="color: var(--muted); font-size: 0.8rem;">Версия:</span>
                                    <input type="text" class="input-field" id="deckVersion" onchange="state.deck.version = this.value; scheduleSave();" placeholder="ПО" style="padding: 0.4rem; text-align: center;">
                                </div>
                            </div>
                        </div>

                        <!-- Программы деки - сворачиваемая секция -->
                        <div style="margin-bottom: 1rem;">
                            <div style="display: flex; align-items: center; justify-content: space-between; padding: 0.5rem; background: rgba(125, 244, 198, 0.1); border: 1px solid var(--success); border-radius: 8px; cursor: pointer;" onclick="toggleDeckSection('programs')">
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <span id="deckProgramsToggle" style="color: var(--success); font-size: 0.8rem;">▼</span>
                                    <span style="color: var(--success); font-weight: 600; font-size: 0.9rem;">Программы деки</span>
                                    <span id="deckProgramsCount" style="color: var(--muted); font-size: 0.8rem;">(0)</span>
                                </div>
                            </div>
                            <div id="deckProgramsContainer" style="margin-top: 0.5rem;">
                                <p style="color: var(--muted); text-align: center; padding: 1rem; font-size: 0.8rem;">Программы не установлены</p>
                            </div>
                        </div>

                        <!-- Щепки памяти - сворачиваемая секция -->
                        <div>
                            <div style="display: flex; align-items: center; justify-content: space-between; padding: 0.5rem; background: rgba(182, 103, 255, 0.1); border: 1px solid var(--accent); border-radius: 8px; cursor: pointer;" onclick="toggleDeckSection('chips')">
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <span id="deckChipsToggle" style="color: var(--accent); font-size: 0.8rem;">▼</span>
                                    <span style="color: var(--accent); font-weight: 600; font-size: 0.9rem;">Щепки памяти</span>
                                    <span id="deckChipsCount" style="color: var(--muted); font-size: 0.8rem;">(0)</span>
                                </div>
                                <button class="pill-button" onclick="event.stopPropagation(); addMemoryChip()" style="font-size: 0.7rem; padding: 0.2rem 0.5rem;">Добавить щепку</button>
                            </div>
                            <div id="deckChipsContainer" style="margin-top: 0.5rem;">
                                <p style="color: var(--muted); text-align: center; padding: 1rem; font-size: 0.8rem;">Щепки памяти не добавлены</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Снаряжение -->
                <div class="section" id="gearSection">
                    <div class="section-header">
                        <h3 class="section-title">&#x1F392; Снаряжение</h3>
                        <div style="display: flex; gap: 0.5rem;">
                            <button class="pill-button primary-button" onclick="showGearShop()" style="font-size: 0.8rem; padding: 0.3rem 0.6rem;">Купить снаряжение</button>
                            <button class="pill-button success-button" onclick="pickupGear()" style="font-size: 0.8rem; padding: 0.3rem 0.6rem;">Подобрать с пола</button>
                        </div>
                    </div>
                    <div class="section-content expanded">
                        <div style="background: rgba(91, 155, 255, 0.1); border: 1px solid #5b9bff; border-radius: 8px; padding: 0.75rem; margin-bottom: 1rem;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                <span style="color: var(--text);">Нагрузка:</span>
                                <span style="color: var(--accent); font-weight: 600;"><span id="currentLoad">25</span> / <span id="maxLoad">25</span></span>
                            </div>
                            <div style="display: flex; justify-content: center; margin-bottom: 0.5rem;">
                                <button class="pill-button muted-button" onclick="resetLoad()" style="font-size: 0.8rem; padding: 0.3rem 0.6rem;">Сбросить нагрузку</button>
                            </div>
                            <div id="loadWarning" style="color: var(--danger); font-size: 0.9rem; margin-top: 0.5rem; display: none;"></div>
                        </div>
                        <div id="gearContainer">
                            <p style="color: var(--muted); text-align: center; padding: 2rem;">Снаряжение не добавлено</p>
                        </div>
                    </div>
                </div>

                <!-- Препараты -->
                <div class="section" id="drugsSection">
                    <div class="section-header">
                        <h3 class="section-title">&#x1F48A; Препараты</h3>
                        <button class="pill-button primary-button" onclick="showDrugsShop()" style="font-size: 0.8rem; padding: 0.3rem 0.6rem;">Купить препараты</button>
                    </div>
                    <div class="section-content expanded">
                        <div id="drugsContainer">
                            <p style="color: var(--muted); text-align: center; padding: 2rem;">Препараты не добавлены</p>
                        </div>
                    </div>
                </div>

                <!-- Киберимпланты -->
                <div class="section" id="implantsSection">
                    <div class="section-header">
                        <h3 class="section-title">&#x1F9BE; Киберимпланты</h3>
                    </div>
                    <div class="section-content expanded">
                        <div id="implantsContainer">
                            <p style="color: var(--muted); text-align: center; padding: 2rem;">Киберимпланты не установлены</p>
                        </div>
                        <div style="display: flex; gap: 0.5rem; justify-content: center; margin-top: 1rem;">
                            <button class="pill-button primary-button" onclick="showImplantShop()" style="font-size: 0.8rem; padding: 0.3rem 0.6rem;">Купить модуль</button>
                            <button class="pill-button" onclick="showImplantPartsShop()" style="font-size: 0.8rem; padding: 0.3rem 0.6rem;">Купить часть импланта</button>
                            <button class="pill-button" onclick="showImplantsManagement()" style="font-size: 0.8rem; padding: 0.3rem 0.6rem;">Управление имплантами</button>
                        </div>
                    </div>
                </div>


                <!-- Собственность -->
                <div class="section" id="propertySection">
                    <div class="section-header">
                        <h3 class="section-title">&#x1F3E0; Собственность</h3>
                    </div>
                    <div class="section-content expanded">
                        <!-- Жилье -->
                        <div class="property-subsection">
                            <div class="section-subtitle">Жилье</div>
                            <div id="housingContainer">
                                <p style="color: var(--muted); text-align: center; padding: 1rem;">Жилье не добавлено</p>
                            </div>
                            <button class="pill-button" onclick="addHousing()">Добавить жилье</button>
                        </div>

                        <!-- Транспорт -->
                        <div class="property-subsection">
                            <div class="section-subtitle">Транспорт</div>
                            <div style="display: flex; gap: 0.5rem; justify-content: center; margin-bottom: 1rem;">
                                <button class="pill-button primary-button" onclick="showVehicleShop()" style="font-size: 0.8rem; padding: 0.3rem 0.6rem;">Купить транспорт</button>
                                <button class="pill-button success-button" onclick="showVehicleModulesShop()" style="font-size: 0.8rem; padding: 0.3rem 0.6rem;">Купить модули</button>
                            </div>
                            <div id="vehiclesContainer">
                                <p style="color: var(--muted); text-align: center; padding: 1rem;">Транспорт не добавлен</p>
                            </div>
                        </div>
                    </div>
                </div>

            </div>

        </main>
    </div>

    <!-- Плавающая кнопка бросалки кубов -->
    <div class="dice-button" id="diceButton" onclick="showUniversalDiceModal()" style="position: fixed; bottom: 100px; left: 20px; width: 60px; height: 60px; background: linear-gradient(135deg, #131f2a, #1a2633); border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 4px 20px rgba(19, 31, 42, 0.6); z-index: 1000; transition: all 0.3s ease; border: 2px solid #2a3d4f;">
        <img src="https://static.tildacdn.com/tild6461-3139-4934-a463-333563633064/dice.png" alt="&#x1F3B2;" style="width: 32px; height: 32px;">
    </div>

    <!-- Плавающая кнопка заметок -->
    <div class="notes-button" id="notesButton" onclick="showNotesModal()" style="position: fixed; bottom: 20px; left: 20px; width: 60px; height: 60px; background: linear-gradient(135deg, #131f2a, #1a2633); border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 4px 20px rgba(19, 31, 42, 0.6); z-index: 1000; transition: all 0.3s ease; border: 2px solid #2a3d4f;">
        <span style="font-size: 1.5rem; color: var(--bg); font-weight: bold;">&#x1F4DD;</span>
    </div>

    <script>
        // Библиотека стандартных навыков (38 навыков)
        const STANDARD_SKILLS = [
            { name: 'Азартные игры', stat: 'INT', level: 0 },
            { name: 'Акробатика', stat: 'BODY', level: 0 },
            { name: 'Артистизм', stat: 'CHA', level: 0 },
            { name: 'Атлетика', stat: 'BODY', level: 0 },
            { name: 'Ближний бой', stat: 'DEX', level: 0 },
            { name: 'Боевые искусства', stat: 'DEX', level: 0, special: true },
            { name: 'Бюрократия', stat: 'INT', level: 0 },
            { name: 'Внешний вид', stat: 'CHA', level: 0 },
            { name: 'Внимательность', stat: 'INT', level: 0 },
            { name: 'Вождение', stat: 'REA', level: 0 },
            { name: 'Выживание', stat: 'WILL', level: 0 },
            { name: 'Дальний бой', stat: 'REA', level: 0 },
            { name: 'Допрос', stat: 'CHA', level: 0 },
            { name: 'Естествознание', stat: 'INT', level: 0 },
            { name: 'Знание местности', stat: 'INT', level: 0 },
            { name: 'Игра на инструменте', stat: 'TECH', level: 0 },
            { name: 'Интуиция', stat: 'INT', level: 0, multiplier: 2 },
            { name: 'Кражи', stat: 'DEX', level: 0 },
            { name: 'Кибер-безопасность', stat: 'TECH', level: 0 },
            { name: 'Обаяние', stat: 'CHA', level: 0 },
            { name: 'Обман', stat: 'CHA', level: 0 },
            { name: 'Общие знания', stat: 'INT', level: 0 },
            { name: 'Оружейник', stat: 'TECH', level: 0 },
            { name: 'Первая помощь', stat: 'INT', level: 0 },
            { name: 'Плавание', stat: 'BODY', level: 0 },
            { name: 'Подрывник', stat: 'TECH', level: 0 },
            { name: 'Поиск', stat: 'INT', level: 0, multiplier: 2 },
            { name: 'Проницательность', stat: 'CHA', level: 0 },
            { name: 'Простая техника', stat: 'TECH', level: 0 },
            { name: 'Рисунок', stat: 'CHA', level: 0 },
            { name: 'Сетевые технологии', stat: 'TECH', level: 0 },
            { name: 'Скрытность', stat: 'REA', level: 0 },
            { name: 'Сопротивление пыткам', stat: 'WILL', level: 0 },
            { name: 'Сопротивление ядам', stat: 'WILL', level: 0 },
            { name: 'Техническое чудо', stat: 'TECH', level: 0 },
            { name: 'Транспорт', stat: 'TECH', level: 0 },
            { name: 'Убеждение', stat: 'INT', level: 0 },
            { name: 'Уклонение', stat: 'DEX', level: 0 },
            { name: 'Язык', stat: 'INT', level: 0, special: true }
        ];

        // Библиотека стандартных программ деки (23 программы)
        const STANDARD_PROGRAMS = [
            {
                name: 'Актуальная версия ПО',
                price: 1000,
                ram: 0,
                lethal: false,
                description: 'Актуальная на сегодняшний день версия ледокола для файрволла. Да — дорого. Тебя предупреждали. Очень часто заказчики дают Сёрферам актуальное ПО на момент выдачи заказа в качестве аванса за работу.'
            },
            {
                name: 'ИИ',
                price: 500,
                ram: 2,
                lethal: false,
                description: 'Искусственный интеллект, который ты можешь подселить куда-либо. Свободно продаются в интернете. Занимает 2 Памяти (ОЗУ), но помещается на обычную щепку памяти. Ты сам обучаешь его действиям.'
            },
            {
                name: 'Боньк',
                price: 500,
                ram: 2,
                lethal: false,
                description: 'Заставляет цель ударить себя по голове ближайшим предметом. Наносит 2d4 урона по голове цели. Цель теряет своё действие в своём следующем ходу, может только перемещаться.'
            },
            {
                name: 'Визг',
                price: 1000,
                ram: 1,
                lethal: true,
                description: 'Симулирует визг в ушах. Ошеломляет цель, заставляя её схватиться за уши. Не наносит урона, действует 1 ход цели. Цель может пройти проверку Сопротивления Пыткам СЛ 18.'
            },
            {
                name: 'Волнограф',
                price: 100,
                ram: 1,
                lethal: false,
                description: 'Позволяет Сёрферу увидеть устройства на своей сетке. Проверка: 2d6 + Версия деки = максимальное количество устройств. Без Волнографа Сёрфер воздействует только на то, что физически видит.'
            },
            {
                name: 'Луговая собачка',
                price: 100,
                ram: 1,
                lethal: false,
                description: 'Программа-паразит, раздражающая нервную систему пищеварения через ЦНС, что заставляет цель сильно хотеть в туалет. Не имеет вредных эффектов, кроме нарративных.'
            },
            {
                name: 'Марионетка',
                price: 500,
                ram: 2,
                lethal: false,
                description: 'Позволяет взять устройство под свой контроль до тех пор, пока ты не решишь отключиться. Может выключить одну конкретную опцию киберимпланта на 1 ход цели.'
            },
            {
                name: 'Миша, давай по новой',
                price: 1000,
                ram: 2,
                lethal: true,
                description: 'В своём следующем ходу цель будет вынуждена действовать точь-в-точь наоборот, чем в свой прошлый ход, как в обратной перемотке. Если это сделать невозможно, цель остаётся на месте и ничего не делает.'
            },
            {
                name: 'Мозготрах',
                price: 1000,
                ram: 0,
                lethal: true,
                description: 'Разгоняет ЦНС-процессор цели, нанося урон непосредственно в мозг. Каждые вложенные 1 очко ОЗУ наносят 1d6 урона прямо в мозг цели. ОЗУ на выбор Сёрфера.'
            },
            {
                name: 'Нормально же общались',
                price: 1000,
                ram: 2,
                lethal: false,
                description: 'Удаляет случайную программу на деке целевого Сёрфера.'
            },
            {
                name: 'Обнулатор',
                price: 5000,
                ram: 3,
                lethal: true,
                description: 'Заставляет человека потратить ход на одну атаку самого себя, против своей воли. Если он вооружён ОДБ, он стреляет себе в голову один раз. Если вооружён ОББ, то он атакует себя, а потом уклоняется сам от себя.'
            },
            {
                name: 'Открывашка',
                price: 500,
                ram: 1,
                lethal: false,
                description: 'Открывает все отсеки в киберимплантах цели, заставляя выпасть всё содержимое.'
            },
            {
                name: 'Паутинка',
                price: 500,
                ram: 1,
                lethal: false,
                description: 'Дублирует действие следующей отправленной программы (с ОЗУ не более 2) в этом ходу на все цели в радиусе 3 пространств от исходной цели программы.'
            },
            {
                name: 'Поводок',
                price: 1000,
                ram: 2,
                lethal: false,
                description: 'Позволяет сбить с ног подвижную живую цель или дрона (имитация рывка или удара волной по ногам цели).'
            },
            {
                name: 'Поросёнок с яблочком',
                price: 500,
                ram: 1,
                lethal: true,
                description: 'Разгоняет процессоры в импланте цели, заставляя её слабо гореть. Каждая повторная отправка этой программы увеличивает требуемое ОЗУ на +1 и усиливает горение на один шаг (слабо → средне → смертельно).'
            },
            {
                name: 'Рефанд',
                price: 500,
                ram: 1,
                lethal: false,
                description: 'Возвращает отправителю программы его же «выстрел» – при успешном взломе отражает полученную программу обратно в атакующего. Нужно активировать в свой ход, действует до следующего хода активировавшего.'
            },
            {
                name: 'Сделать Бум',
                price: 1000,
                ram: 2,
                lethal: true,
                description: 'Программа против транспортных средств (если у них есть подключение к Сети). Наносит 2d6 повреждений сразу по ОСП транспорта. Может вместо урона: заставить барахлить системы, дёрнуть руль, заглушить двигатель.'
            },
            {
                name: 'Сканер',
                price: 500,
                ram: 1,
                lethal: false,
                description: 'Показывает информацию об устройстве в Волновой сети. Если цель – живое существо, выводит список его киберимплантов; если предмет – его условное обозначение и примерный функционал. Игрок может задать 1 уточняющий вопрос Мастеру об устройстве (да/нет).'
            },
            {
                name: 'Топфхельм',
                price: 500,
                ram: 1,
                lethal: false,
                description: 'Усилитель ЦНС-импланта, нивелирующий урон, наносимый мозгу, до следующего хода Сёрфера: уменьшает урон на 1d6 за каждое ОЗУ, вложенное в активацию программы.'
            },
            {
                name: 'Тушите свет',
                price: 2000,
                ram: 0,
                lethal: false,
                description: 'Программа из режима Полного погружения. Если Сёрфер потратит минуту и преодолеет взлом СЛ 20, он способен отключить объект размером с небольшое здание от электричества на сутки. Затрачивает всё доступное ОЗУ на 1 минуту.'
            },
            {
                name: 'Ультра-разгон',
                price: 500,
                ram: 1,
                lethal: false,
                description: 'Разгоняет мощность процессора устройства, заставляя его взорваться для отвлечения внимания. Не наносит взрывной урон. Не действует на живых существ и импланты (только на электронику).'
            },
            {
                name: 'Утопить',
                price: 1000,
                ram: 2,
                lethal: true,
                description: 'Насильно накрывает цель Волной Сети, погружая её в «Океан». Наносит 1d4 урона Осознанности цели (по шкале психики/нейропсихоза).'
            },
            {
                name: 'Чёрная метка',
                price: 200,
                ram: 1,
                lethal: false,
                description: 'Помечает цель сетевой меткой на количество часов, равное вложенному ОЗУ. Сёрфер может отслеживать цель в Океане, зная её местонахождение и к чему она подключена. Метку можно снять только полностью отключившись от сети либо погрузившись «под воду».'
            }
        ];

        // Библиотека киберимплантов (6 категорий)
        const CYBERIMPLANTS_LIBRARY = {
            "Внутренние органы": [
                {
                    name: "Второе сердце",
                    price: 500,
                    awarenessLoss: "2d6",
                    description: "Дублирует «родное» сердце — при остановке работает как резерв; можно активировать без действия, даёт +5 ПЗ или +1 к Инициативе перед боем или +1 к РЕА."
                },
                {
                    name: "Зацикленный воздухообмен",
                    price: 500,
                    awarenessLoss: "1d6",
                    description: "Обеспечивает циркуляцию кислорода из внутреннего баллончика (требуется «Малое хранилище» с баллончиком воздуха); позволяет не дышать носом."
                },
                {
                    name: "Кибер-регенерация",
                    price: 1000,
                    awarenessLoss: "1d6",
                    description: "Наноботы ускоряют естественное восстановление в 2 раза (ускоренное исцеление)."
                },
                {
                    name: "Модуль экстренного жизнеобеспечения",
                    price: 5000,
                    awarenessLoss: "1d20",
                    description: "Поддерживает жизнь при критическом состоянии (функционирует, пока жив мозг); при активации полностью истощает Заряд на ближайшие сутки и автоматически стабилизирует пользователя при падении ПЗ < 1 (пользователь теряет сознание)."
                },
                {
                    name: "Ускоритель обмена веществ",
                    price: 500,
                    awarenessLoss: "1d6",
                    description: "Ускоряет и усиливает эффект внутривенных препаратов в 2 раза (как позитивный, так и негативный)."
                },
                {
                    name: "Фильтр токсинов",
                    price: 1000,
                    awarenessLoss: "1d6",
                    description: "Повышенная устойчивость к ядам/токсинам через пищу, воду или воздух; можно отключать."
                }
            ],
            "Нейронные": [
                {
                    name: "Банковский чип",
                    price: 50,
                    awarenessLoss: "нет",
                    description: "Хранит запись банковского аккаунта и даёт доступ к операциям (может быть запаролен/привязан по ДНК)."
                },
                {
                    name: "Замедлитель",
                    price: 500,
                    awarenessLoss: "1d6",
                    description: "Замедляет субъективное время до 8× — для пользователя 1 ход равен 8 минутам внешнего времени; облегчает перенос болезней и долгих ожиданий; регулируется."
                },
                {
                    name: "Крипто-щепка",
                    price: 50,
                    awarenessLoss: "нет",
                    description: "Чип для анонимных/защищённых платежей или хранения крипты/данных (может содержать вредоносное ПО)."
                },
                {
                    name: "Кибер-сон",
                    price: 500,
                    awarenessLoss: "1d6",
                    description: "Управление сном и сновидениями; позволяет высыпаться в любых условиях; в режиме сна пользователь полностью отключён."
                },
                {
                    name: "Нейро-конденсаторы",
                    price: 1000,
                    awarenessLoss: "2d6",
                    description: "Впитывают лишнюю нейронную энергию; восстанавливают 2 заряда за раунд вместо 1."
                },
                {
                    name: "Нейро-порты",
                    price: 100,
                    awarenessLoss: "1d4",
                    description: "Порты/штекеры для подключения устройств; минимум 1 порт требуется для подключения, к одному порту — только одно устройство. Цена за каждый порт."
                },
                {
                    name: "Разъём для щепок",
                    price: 100,
                    awarenessLoss: "1d4",
                    description: "Разъём для установки одной щепки (чипа). Цена за каждый разъём."
                },
                {
                    name: "Усилитель мозговой активности",
                    price: 500,
                    awarenessLoss: "1d20",
                    description: "Ускоряет обучение; уменьшает затраты Очков Опыта на улучшение навыков на 25%."
                },
                {
                    name: "Ускоритель",
                    price: 5000,
                    awarenessLoss: "4d6",
                    description: "Замедляет для пользователя время в 2 раза. Буквально позволяет ходить ему два раза в свой ход. ."
                },
                {
                    name: "ЦНС-модуль",
                    price: 0,
                    awarenessLoss: "0",
                    description: "Базовый нейронный имплант, необходимый для подключения остальных имплантов к нервной системе (есть у всех по умолчанию)."
                },
                {
                    name: "ЦНС-сервер",
                    price: 1000,
                    awarenessLoss: "2d6",
                    description: "Управление устройствами «силой мысли» через Волновую сеть; позволяет одновременно без штрафа подключать до 3 устройств; при активации подключаемых устройств наносит по 1d4 ПО."
                },
                {
                    name: "Щепка навыка",
                    price: 100,
                    awarenessLoss: "1d4",
                    description: "Чип, обучающий навыку (не для профессиональных навыков); при вставке вызывает ПО. Цена за уровень 1, уровни 2-5: 150/300/1000/5000."
                }
            ],
            "Оружие": [
                {
                    name: "Баллистический щит",
                    price: 100,
                    awarenessLoss: "1d6",
                    description: "Встроенный твёрдый щит с 20 ПЗ; активируется без действия, не мешает стрельбе."
                },
                {
                    name: "Внешняя мини-станина",
                    price: 100,
                    awarenessLoss: "1d6",
                    description: "Крепление для оружия или крупного предмета (скрытое хранение); извлечь/убрать — действие."
                },
                {
                    name: "Встроенное оружие",
                    price: 1000,
                    awarenessLoss: "4d6",
                    description: "Встроенное в тело оружие класса ПП (с приёмником боеприпасов); стреляет из места установки (например, ладони)."
                },
                {
                    name: "Генератор атмосферы",
                    price: 1000,
                    awarenessLoss: "2d6",
                    description: "Выпускает облако 5×5 (дым/огонь/токсичность) вокруг пользователя; пользователь также подвержен эффектам; боеприпасы покупаются по цене гранат."
                },
                {
                    name: "Интегрированный гранатомёт",
                    price: 2000,
                    awarenessLoss: "3d4",
                    description: "Встроенный гранатомёт с магазином на одну гранату."
                },
                {
                    name: "Лазерная кромка",
                    price: 250,
                    awarenessLoss: "1d4",
                    description: "Лазерные «ногти»/микросетка на ногтях. Очень лёгкое ОББ, но за каждый ноготь. Если вы устанавливаете их по 5 штук (все 5 занимают 1 слот) на руку, то это 5d6/2 урона за раз. Можно бить двумя руками одновременно. Цена за 1 штуку"
                },
                {
                    name: "Микроракеты",
                    price: 5000,
                    awarenessLoss: "4d6",
                    description: "Пусковая установка с магазином на 6 микроракет (урон 6d6 1 пространство); требует ЦНС-Сервер и оптического целеуказателя для корректного применения; одна ракета даёт мощный взрыв."
                },
                {
                    name: "Моноструна",
                    price: 1000,
                    awarenessLoss: "2d6",
                    description: "Нано-нить с грузиком для бесшумного устранения целей. Это Тяжелое ОББ, которое при соприкосновении с целью (пройдя броню) дополнительно наносит 1d6 урона от огня. Моноструну можно использовать для захвата, постоянно нанося её урон и урон от ожога каждый ход, пока твоя цель в захвате." 
                },
                {
                    name: "Пневматический длинный клинок",
                    price: 1000,
                    awarenessLoss: "4d6",
                    description: "Занимает 1 руку, не позволяя что-либо держать ей. Имеет 3 варианта использования: Стандартное использование — атака цели в соседнем пространстве, как Тяжелым ОББ. Клинки статичны, заряд не расходуется. Удлинённые клинки — выдвигает клинки на максимум, позволяя атаковать цели на расстоянии в 2 пространства, в т.ч. за углом, считается как Среднее ОББ. Расходует заряд. Пневматическое усиление — пневмоприводы клинков ускоряют клинки при атаке в соседнее пространство. Полностью игнорируют броню ниже 15. Если пользователь попал по цели 2 раза за ход, он может пройти проверку Атлетики со СЛ, равной утроенному Телосложению цели, при успехе, он пронзил цель и поднял её над землёй, нанеся еще 2d6, игнорируя броню. Пользователь и цель не могут совершать никаких Действий (у одного руки заняты, другой в агонии) до тех пор, пока цель не опустят на землю или пользователя не Собьют с ног. Если установлены парно и используются одновременно, это добавляет 1d6 к их урону, но расходуют в 2 раза больше заряда."
                },
                {
                    name: "Складной клинок",
                    price: 500,
                    awarenessLoss: "1d6",
                    description: "Скрываемый в теле тяжёлый клинок; требует действие для достать/убрать."
                },
                {
                    name: "Скрытый нож",
                    price: 100,
                    awarenessLoss: "1d4",
                    description: "Скрытое среднее оружие; требует действие для достать/убрать."
                },
                {
                    name: "Электропроводка",
                    price: 500,
                    awarenessLoss: "4d6",
                    description: "Контактная электропроводящая проволока — наносит ЭМИ/электроурон; наносит урон электричеством (5d6), при 1ПЗ цель теряет сознание на 1d6 раундов.."
                }
            ],
            "Перемещение": [
                {
                    name: "Гребные винты",
                    price: 500,
                    awarenessLoss: "1d6",
                    description: "Винты для передвижения в жидкостных средах; ускорение в воде тратит больше Заряда."
                },
                {
                    name: "Крылья для планирования",
                    price: 5000,
                    awarenessLoss: "4d6",
                    description: "Парашют/крылья для планирования — уменьшают урон от падения свыше 30 м; не позволяют зависать."
                },
                {
                    name: "Модуль для точечного давления",
                    price: 500,
                    awarenessLoss: "2d6",
                    description: "Заменяет конечность острым имплантом; превращает её в необычное тяжёлое ближнее оружие; снижает ЛВК на 1 при установке в ноги."
                },
                {
                    name: "Плавники",
                    price: 100,
                    awarenessLoss: "1d4",
                    description: "Ласты/плавник для повышения скорости в воде (+1 к СКО, максимум +10)."
                },
                {
                    name: "Прыжковый ускоритель",
                    price: 3000,
                    awarenessLoss: "2d6",
                    description: "Реактивный ускоритель для подъёма на большие высоты (до ~100 м за короткое время); при активации раскрываются сопла."
                },
                {
                    name: "Реактивные стабилизаторы",
                    price: 1000,
                    awarenessLoss: "2d6",
                    description: "Стабилизируют положение при падении/сбивании с ног; могут работать в безвоздушном пространстве при подключении баллончика воздуха."
                },
                {
                    name: "Ролик",
                    price: 100,
                    awarenessLoss: "1d4",
                    description: "Скрытые колёсики в импланте — удваивают скорость на подходящей поверхности; ограничения на повороты и сложную местность."
                }
            ],
            "Слух, зрение, голос": [
                {
                    name: "Анализатор голоса и стресса",
                    price: 500,
                    awarenessLoss: "1d6",
                    description: "Распознавание лжи/стресса по аудио/визуальным признакам с ~80% шансом при попытке."
                },
                {
                    name: "Аудио-фильтр",
                    price: 500,
                    awarenessLoss: "1d6",
                    description: "Активное шумоподавление; полное нивелирование эффектов резкого шума; позволяет отключать конкретные звуки."
                },
                {
                    name: "Детектор/анализатор",
                    price: 500,
                    awarenessLoss: "1d6",
                    description: "Специализированный сенсор для обнаружения выбранного вещества/волны/субстанции (радиация, токсины и т.д.); при активации снижает некоторый максимум на 1."
                },
                {
                    name: "Зрительный 3D-сканер",
                    price: 5000,
                    awarenessLoss: "4d6",
                    description: "Сложный сканер, позволяющий видеть «сквозь» разрушимые преграды до ~4 м; большая видимая площадь, используется для разведки."
                },
                {
                    name: "Ищейка",
                    price: 500,
                    awarenessLoss: "1d6",
                    description: "Усиление обоняния; бонус +3 к проверкам Поиск, связанным с обонянием."
                },
                {
                    name: "Камера для кибер-оптики",
                    price: 500,
                    awarenessLoss: "1d6",
                    description: "Запись и трансляция видео; при подключении к ЦНС может служить зрением. 0 ПО если установлена как глазной имплант."
                },
                {
                    name: "Крепление для камеры",
                    price: 500,
                    awarenessLoss: "0",
                    description: "Фиксированное крепление для малой/средней камеры; позволяет развернуть камеру действием."
                },
                {
                    name: "Оптическое приближение",
                    price: 500,
                    awarenessLoss: "1d6",
                    description: "Оптический зум до 200× без потери качества (не влияет на прицеливание напрямую)."
                },
                {
                    name: "Оптический целеуказатель",
                    price: 2000,
                    awarenessLoss: "3d6",
                    description: "Модуль для зрительных имплантов и оружия с самонаведением; помечает цель через сеть, даёт бонус −2 к сложности стрельбы и даёт трек на 20 минут в радиусе 1 км."
                },
                {
                    name: "ПНВ и тепловизионное зрение",
                    price: 1000,
                    awarenessLoss: "2d6",
                    description: "Ночные режимы и тепловизор, переключаемые в любой момент; выявляет тепловые подписи."
                },
                {
                    name: "Регулятор интенсивности света",
                    price: 500,
                    awarenessLoss: "1d6",
                    description: "Адаптация к ярким вспышкам и изменению освещённости; даёт иммунитет к ослепляющим эффектам."
                }
            ],
            "Дополнительная всячина": [
                {
                    name: "Сетевое зрение",
                    price: 1000,
                    awarenessLoss: "4d6",
                    description: "Визуализация Волновой сети поверх реального мира; важен для Сёрферов для взаимодействия с серверами и кильватерами."
                },
                {
                    name: "Тюнер",
                    price: 500,
                    awarenessLoss: "1d4",
                    description: "Меняет голос; воспроизводит записанные звуки с щепки."
                },
                {
                    name: "Фасеточное зрение",
                    price: 5000,
                    awarenessLoss: "4d6",
                    description: "Набор «множества глаз» (до 12 отдельных глаз), расширяет слоты зрения и возможности сенсоров."
                },
                {
                    name: "Экран для хронотома",
                    price: 500,
                    awarenessLoss: "1d4",
                    description: "Выводит Хрона (интерфейс) прямо в зрение пользователя (AR-окно)."
                },
                {
                    name: "Эндоскоп",
                    price: 500,
                    awarenessLoss: "1d4",
                    description: "Выдвижной визуальный модуль до 50 см с 2 слотами опций — для исследований/ремонта/медпроцедур."
                },
                {
                    name: "Батарейка",
                    price: 100,
                    awarenessLoss: "0",
                    description: "Восстанавливает 2 единицы Заряда; можно подключать к Нейро-порту или активировать; требует перезарядки."
                },
                {
                    name: "Кошка (магнитно-пневматическая)",
                    price: 500,
                    awarenessLoss: "1d6",
                    description: "Гибкий шнур/манипулятор длиной 40 м для захвата/доставки/стрельбы по таблице попадания гранатомёта."
                },
                {
                    name: "Мультитул",
                    price: 500,
                    awarenessLoss: "1d4",
                    description: "Инструменты (гаечные ключи, паяльник и т.п.) в импланте; +2 ко всем проверкам технических навыков (кроме работы с киберимплантами)."
                },
                {
                    name: "Оптический камуфляж",
                    price: 5000,
                    awarenessLoss: "6d6",
                    description: "Активная маскировка (военный уровень) — даёт −5СЛ к проверкам Скрытности; ограничен по использованию и снятию; снижает максимум Заряда на 5 при активации."
                },
                {
                    name: "Подушка",
                    price: 100,
                    awarenessLoss: "0",
                    description: "Надувающийся модуль-подушка; предотвращает утопление и улучшает сон (мелкие бонусы)."
                },
                {
                    name: "Внутреннее укрепление полимером",
                    price: 250,
                    awarenessLoss: "1d4",
                    description: "Полимерная прослойка под кожей, даёт +15 ОС в месте установки; самовосстанавливается 2 ОС в сутки. Цена за штуку."
                },
                {
                    name: "Внутреннее укрепление полиметаллом",
                    price: 500,
                    awarenessLoss: "1d4",
                    description: "Прослойка из полиметалла под кожей, даёт +18 ОС в месте установки; самовосстанавливается 1 ОС в сутки. Цена за штуку."
                },
                {
                    name: "Экзоскелет",
                    price: 2000,
                    awarenessLoss: "0",
                    description: "Внешняя рама с сервоприводами — повышает фиктивные Телосложение, Ловкость, Скорость на +5; требует нейро-портов; работает ~12 часов."
                },
                {
                    name: "Экранированная защита",
                    price: 150,
                    awarenessLoss: "1d4",
                    description: "Сетка под кожей, даёт полную стойкость к ЭМИ в установленной области; модуль устанавливается по частям. Цена за штуку."
                },
                {
                    name: "Эндоскелет",
                    price: 5000,
                    awarenessLoss: "0",
                    description: "Встроенная скрытая рама — повышает Телосложение, Ловкость, Скорость на +5; требует постоянного подключения к ЦНС-Серверу; работает ~10 часов."
                },
                {
                    name: "Духовка (мини-духовка)",
                    price: 500,
                    awarenessLoss: "1d4",
                    description: "Маленькая встроенная духовка для подогрева пищи; может использоваться как импровизированное оружие (описан шутливый эффект)."
                },
                {
                    name: "Малое хранилище",
                    price: 100,
                    awarenessLoss: "1d4",
                    description: "Хранилище 1×1 с 2 слотами для подключения (например, баллончики, батарейки)."
                },
                {
                    name: "Микроволновка",
                    price: 500,
                    awarenessLoss: "1d4",
                    description: "Маленькая микроволновка для подогрева; при использовании наносит ЭМИ-урон дополнительно."
                },
                {
                    name: "Отсек для дрона",
                    price: 500,
                    awarenessLoss: "1d4",
                    description: "Скрытое хранилище для одного дрона (или преобразование части тела в дрона — по согласованию с мастером)."
                },
                {
                    name: "Отсек для ОББ",
                    price: 500,
                    awarenessLoss: "1d4",
                    description: "Хранилище для одного ОББ до средних размеров (скрытое хранение оружия)."
                },
                {
                    name: "Отсек для ОДБ",
                    price: 500,
                    awarenessLoss: "1d4",
                    description: "Хранилище для одного ОДБ до средних размеров (скрытое хранение оружия дальнего боя)."
                },
                {
                    name: "Отсек для патронов",
                    price: 500,
                    awarenessLoss: "1d4",
                    description: "Хранилище патронов; можно перезаряжать магазины или питать кибер-оружие изнутри."
                },
                {
                    name: "Отсек для щепок",
                    price: 100,
                    awarenessLoss: "0",
                    description: "Хранилище для щепок (вмещает до 10 штук); не позволяет подключать их, но защищает от потери/поломки."
                },
                {
                    name: "Средний отсек",
                    price: 500,
                    awarenessLoss: "2d6",
                    description: "Хранилище 10×5 с 4 слотами подключения для снаряжения (баллончики, батарейки и т.п.)."
                },
                {
                    name: "Холодильная камера",
                    price: 500,
                    awarenessLoss: "1d4",
                    description: "Хранилище 2×2 для хранения еды/напитков; можно объединять и использовать как морозилку."
                },
                {
                    name: "Экранированная камера",
                    price: 500,
                    awarenessLoss: "0",
                    description: "Встраиваемая камера внутри хранилища, полностью защищающая содержимое от ЭМИ (заполняет 1×1 объёма внутри хранилища)."
                }
            ]
        };

        // Библиотека снаряжения (60 предметов)
        const GEAR_LIBRARY = [
            { name: '3D-ПРИНТЕР', price: 1000, load: 81, description: 'Принтер, печатающий из полимеров. Заправляется материалом за 10 уе. Не печатает оружие и броню, но может сделать костюм солдата. Требует электричества. Создание предмета — Простая техника (ТЕХ).' },
            { name: 'АНАЛИЗАТОР', price: 100, load: 1, description: 'Прибор с встроенной щепкой для анализа конкретного параметра среды. Пищит при обнаружении цели на 1 метр или по мере увеличения концентрации вещества.' },
            { name: 'АНТИВИБРАЦИОННЫЕ ЭЛЕМЕНТЫ', price: 10, load: 1, description: 'Фибронейлоновые накладки, глушащие вибрации. Позволяют нивелировать игнорирование брони виброклинками, но выглядят нелепо.' },
            { name: 'АНТИРАДИАЦИОННЫЙ КОСТЮМ', price: 500, load: 25, description: 'Костюм, защищающий от радиации и ножевых ударов. Надевается поверх Средней и легче брони. Даёт 10 ОС, теряет защиту при первом повреждении. Можно заклеивать дыры заплатками (100 уе за 10).' },
            { name: 'АПТЕЧКА', price: 200, load: 1, description: 'Даёт +5 к Первой помощи. Выпитый спирт восстанавливает 10 ПЗ на 10 минут, затем они исчезают (при уходе в отрицательные — обморок на 30 минут).' },
            { name: 'БЫТОВОЙ ТЕПЛОВИЗОР', price: 500, load: 1, description: 'Дальность 6 м. Показывает тепловую картину окружения. Полезен для поиска людей, проводки и скрытых вентиляций.' },
            { name: 'ВИДЕОЭНДОСКОП', price: 100, load: 1, description: 'Камера на гибком шнуре 1 м для осмотра под дверями и в механизмах. Запись до 6 часов ч/б видео на чип.' },
            { name: 'ВИНГСЬЮТ', price: 5000, load: 50, description: 'Костюм для планирования (с парашютом). 10 м высоты = 50 м полёта. Минимум 100 м. Совместим с Прыжковыми ускорителями.' },
            { name: 'ДРОН НА КОЛЁСАХ', price: 100, load: 2, description: 'Радиоуправляемая машинка с камерой. Дальность — 1 км через Сеть или 50 м по радио.' },
            { name: 'ЛЕТАЮЩИЙ ДРОН', price: 100, load: 2, description: 'Летающий дрон с камерой. Дальность 5 км по Сети или 100 м по радио. Может зависать в воздухе.' },
            { name: 'ГЕЙМЕРСКИЙ КОМПЛЕКТ', price: 999, load: 0, description: 'Декоративное улучшение любого предмета (RGB, углы, подсветка). Не даёт эффектов, только визуальный блеск.' },
            { name: 'ДЕТЕКТОР ЖУЧКОВ', price: 500, load: 1, description: 'Пищит при приближении к жучкам на 2 м. Не указывает точное место.' },
            { name: 'ДЕТЕКТОР РАДИАЦИИ', price: 500, load: 1, description: 'Показывает уровень радиации и максимальное время нахождения в зоне.' },
            { name: 'ЗАЖИГАЛКА', price: 10, load: 0.1, description: 'Обычная зажигалка. Ничего особенного.' },
            { name: 'ЗОНТ', price: 10, load: 0.1, description: 'Защищает от дождя голову и плечи.' },
            { name: 'ИЗОЛЕНТА', price: 10, load: 0.1, description: 'Клейкая лента для изоляции и склейки. Бывает светящейся.' },
            { name: 'КОМПЕНСАТОР ПАДЕНИЯ', price: 200, load: 2, description: 'Реактивные подошвы, смягчающие падение до 100 м (при Акробатике СЛ 13).' },
            { name: 'КОМПЛЕКТ ИЗМЕНЕНИЯ ВКУСА', price: 50, load: 0.1, description: 'Приправы, маскирующие вкус еды (даже яда).' },
            { name: 'КОМПЛЕКТ ПРОВОДОВ И ПЕРЕХОДНИКОВ', price: 100, load: 2, description: 'Универсальные переходники для соединения техники. Для всего нужны навыки ТЕХ.' },
            { name: 'МАРКЕР С ПРОГРАММИРУЕМОЙ КРАСКОЙ', price: 100, load: 1, description: 'Краска видна только через настроенные импланты или визоры. Хватает на 100 м линии.' },
            { name: 'МАСКА ДЛЯ 3D-ВИДЕО', price: 1000, load: 2, description: 'Маска, превращающая видео в 3D. Позволяет менять точку обзора.' },
            { name: 'МУЛЬТИТУЛ', price: 100, load: 1, description: 'Универсальный инструмент. Даёт +2 к проверкам ремонта и создания (ТЕХ).' },
            { name: 'НАБОР ВЫЖИВАЛЬЩИКА', price: 1000, load: 50, description: 'Всё для долгосрочного выживания — печь, вода, еда, палатка, инструменты и т.д.' },
            { name: 'НАБОР ТУРИСТА', price: 2000, load: 25, description: 'Лёгкий набор для комфортного отдыха на природе. Палатка, горелка, пайки и аксессуары.' },
            { name: 'НАБОР ДЛЯ ЕДЫ', price: 100, load: 1, description: 'Ложка, вилка, нож, палочки. Для еды и угроз вилкой в глаз.' },
            { name: 'НАБОР ЧИСТЫХ ФЛЕШЕК ИЛИ ЧИПОВ', price: 50, load: 1, description: '5 флешек по 6 ч записи. Совместимы с биоразъёмами.' },
            { name: 'НАНОФОН', price: 100, load: 0.1, description: '5 микрофонов для скрытой записи (радиус 50 м, 6 ч работы).' },
            { name: 'НАПРАВЛЕННЫЙ МИКРОФОН', price: 1000, load: 8, description: 'Дальность 200 м, слышит через открытые пространства, но не через преграды.' },
            { name: 'НАРУЧНИКИ', price: 500, load: 1, description: 'Сковывают руки. Можно сломать (ТЕЛО ≥ 10) или выскользнуть (ЛВК ≥ 8, ТЕЛО ≤ 4).' },
            { name: 'НАУШНИКИ С ШУМОПОДАВЛЕНИЕМ', price: 500, load: 1, description: 'Беспроводные. Дают иммунитет к оглушению при 75 %+ подавлении. Можно глохнуть на выбор.' },
            { name: 'НИЖНЕЕ БЕЛЬЁ С НЕОНОВЫМИ НИТЯМИ', price: 100, load: 1, description: 'Светится в темноте. Освещает до 5 пространств. Для вечеринок и экстрима.' },
            { name: 'НОУТБУК', price: 500, load: 9, description: 'Компактный компьютер. Работает 12 ч без зарядки. Можно управлять дроном, писать, монтировать.' },
            { name: 'ОЧКИ С ОПТИЧЕСКИМИ СЛОТАМИ', price: 500, load: 1, description: 'Вмещают 1 модуль (ПНВ, Целеуказатель и др.). Активируется жестом или словом.' },
            { name: 'ПАЁК АВАРИЙНЫЙ (СУТОЧНЫЙ)', price: 50, load: 0.1, description: 'Прямоугольная таблетка с питательными веществами. Отвратителен на вкус, но спасает.' },
            { name: 'ПАЁК ГРАЖДАНСКИЙ (12 ЧАСОВ)', price: 100, load: 1, description: 'Две порции соевой еды для походов. Нужно 2 в день для сытости.' },
            { name: 'ПАЁК ТУРИСТИЧЕСКИЙ (СУТОЧНЫЙ)', price: 100, load: 2, description: 'Суточный набор еды, приборов, печка и обеззараживатель воды.' },
            { name: 'ПАЛАТКА БОЛЬШАЯ', price: 1000, load: 15, description: 'Для 5 человек, с солнечной панелью (зарядка 2 хронотомов или 1 ноутбука).' },
            { name: 'ПАЛАТКА МАЛАЯ', price: 500, load: 3, description: 'На одного. Солнечная панель заряжает 1 устройство. Служит 6 мес.' },
            { name: 'ПИСТОЛЕТ-КОШКА', price: 500, load: 2, description: 'Стреляет крюком с кабелем на 40 м. Требует шнур и Акробатику СЛ 15 для лазания.' },
            { name: 'ПЛАЩ-ПАЛАТКА (ДОЖДЕВИК)', price: 100, load: 2, description: 'Защищает от дождя, снижает ЛВК на 1. Можно спать в ней 1 ночь без штрафа.' },
            { name: 'ПРЕЗЕРВАТИВЫ', price: 50, load: 0.1, description: '10 штук, разные вкусы и цвета. Можно хранить сигареты сухими.' },
            { name: 'ПРОТИВОГАЗ', price: 100, load: 2, description: 'Защищает от токсинов и газа, но не от радиации.' },
            { name: 'ПРОТИВОУДАРНЫЙ КЕЙС', price: 100, load: 16, description: 'Прочный кейс с внутренним объёмом 3×3. 10 ОС, 10 ПЗ. Для хрупких вещей.' },
            { name: 'ПРЫЖКОВЫЕ УСКОРИТЕЛИ', price: 2000, load: 9, description: 'Поднимают на 100 м за 3 сек. Требуют топливо (Канистра 100 уе).' },
            { name: 'РАЦИЯ', price: 100, load: 1, description: 'Дальность 2 км. Работает на общих волнах. Не подключается к сетям военных.' },
            { name: 'РЕБРИЗЕР И ЛАСТЫ', price: 100, load: 8, description: 'Позволяет дышать под водой 30 мин. Ласты снимают штраф на скорость.' },
            { name: 'РЕДАКТОР RFID', price: 100, load: 2, description: 'Перепрограммирует или печатает карточки. Копирование занимает секунды, создание — 3 часа.' },
            { name: 'РЮКЗАК', price: 100, load: 8, description: 'Даёт -2 ЛВК. Можно надеть спереди (-4 ЛВК). Требует действия для снятия и извлечения.' },
            { name: 'СИГАРЕТЫ ИЗ ЗАМЕНИТЕЛЯ ТАБАКА', price: 50, load: 0.1, description: 'Без эффектов, просто вид курильщика.' },
            { name: 'СИГАРЕТЫ ИЗ ТАБАКА', price: 1000, load: 0.1, description: 'Настоящие сигареты. Могут вызвать зависимость (СЛ 12). Урон 2 по ПЗ при курении.' },
            { name: 'СКАФАНДР С ЗАМКНУТОЙ АТМОСФЕРОЙ', price: 5000, load: 80, description: 'Тяжёлая броня. Выдерживает экстремальные условия. Питание на 12 ч.' },
            { name: 'СКЛАДНОЙ ВЕЛОСИПЕД', price: 500, load: 36, description: 'Складной транспорт. Скорость = Атлетика ×2. Одноместный.' },
            { name: 'СМАЗКА ЛИЧНАЯ', price: 50, load: 1, description: 'Безопасная, ароматная. Для живых существ.' },
            { name: 'СМАЗКА ТЕХНИЧЕСКАЯ', price: 100, load: 1, description: 'Устраняет трение, добавляет +10% скорости технике на 1 час.' },
            { name: 'СТЕКЛОРЕЗ', price: 50, load: 1, description: 'Лазерный резак стекла (до 15 см). Работает час, батарейки по 10 уе.' },
            { name: 'СУМКА', price: 50, load: 2, description: 'Вмещает 1 крупный предмет (например, оружие). Маскирует переноску.' },
            { name: 'ТЕЛЕФОН (АРХАИЧНЫЙ)', price: 100, load: 1, description: 'Одноразовый смартфон или раскладушка. Используется для связи без ID.' },
            { name: 'УНИВЕРСАЛЬНАЯ МЕХАНИЧЕСКАЯ ОТМЫЧКА', price: 50, load: 1, description: 'Для вскрытия механических замков. 3 заряда, после чего ломается.' },
            { name: 'УСТРОЙСТВО ДЛЯ ПОДЪЁМА ПО ШНУРАМ', price: 100, load: 8, description: 'Перемещение по проводам и тросам. Используется для перемещения между зданиями.' },
            { name: 'ФАЛЬШФЕЙЕР', price: 100, load: 1, description: 'Освещает 10 пространств на 5 минут.' },
            { name: 'ФОНАРИК', price: 50, load: 1, description: 'Светит на 50 пространств вперёд. Работает на батарейках.' },
            { name: 'ХРОНОТОМ (ДЕШЁВЫЙ)', price: 0, load: 0, description: 'Устройство с AR-режимом, встроенной рекламой и базовым функционалом связи.' },
            { name: 'ХРОНОТОМ (ДОРОГОЙ)', price: 0, load: 0, description: 'Улучшенная версия без рекламы, с голографическим экраном и тихим режимом.' },
            { name: 'ЦИНКОВЫЙ ЯЩИК', price: 50, load: 4, description: 'Экранированный контейнер, блокирующий сигналы. Используется для перевозки техники и людей с имплантами. За 0.25 м².' },
            { name: 'ЧИП ДЛЯ ВЗЛОМА Э-ЗАМКОВ', price: 500, load: 1, description: 'Электронная отмычка. 3 заряда. Для вскрытия электронных замков.' },
            { name: 'ШЛЕМ ДЛЯ ПРОСМОТРА РЕАЛЬНИЗАЦИИ', price: 5000, load: 4, description: 'Шлем и костюм для полного погружения в Реальнизацию. Можно использовать только шлем.' },
            { name: 'ШНУР / ВЕРЁВКА', price: 10, load: 1, description: 'Прочная верёвка, выдерживает вес трёх человек. За 50 м.' }
        ];

        // Библиотека оружия ближнего боя
        const MELEE_WEAPONS = [
            {
                type: 'Очень лёгкое',
                examples: 'Заточка, опасная бритва, перочинный нож, офисная кружка с горячим шоколадом, шило',
                damage: '1d3',
                concealable: true,
                stealthPenalty: '+1',
                price: 10,
                load: 1
            },
            {
                type: 'Лёгкое',
                examples: 'Кухонный нож, маленький молоток, отвёртка, ножка от стула',
                damage: '1d6',
                concealable: true,
                stealthPenalty: '0',
                price: 50,
                load: 2
            },
            {
                type: 'Среднее',
                examples: 'Бейсбольная бита, мачете, фомка',
                damage: '2d6',
                concealable: false,
                stealthPenalty: '-1',
                price: 50,
                load: 4
            },
            {
                type: 'Тяжёлое',
                examples: 'Кусок трубы, арматура, меч, катана, бейсбольная бита с гвоздями',
                damage: '3d6',
                concealable: false,
                stealthPenalty: '-2',
                price: 100,
                load: 6
            },
            {
                type: 'Очень тяжёлое',
                examples: 'Кувалда, бензопила, лопасть вертолёта',
                damage: '4d6',
                concealable: false,
                stealthPenalty: '-2',
                price: 500,
                load: 8
            },
            {
                type: 'Сверхтяжёлое',
                examples: 'Опора ЛЭП, малая корабельная торпеда, кусок стены, кусок автомобиля, железнодорожный буфер',
                damage: '5d6',
                concealable: 'Тебя за ним можно скрыть',
                stealthPenalty: '-3, и требует ТЕЛО 12 и более',
                price: 1000,
                load: 10
            }
        ];

        // Библиотека оружия дальнего боя
        const RANGED_WEAPONS = [
            {
                type: 'Лёгкие пистолеты',
                primaryDamage: '4d4',
                altDamage: '2d6',
                concealable: true,
                hands: 1,
                stealth: 2,
                magazine: 6,
                price: 100,
                load: 2
            },
            {
                type: 'Обычные пистолеты',
                primaryDamage: '5d4',
                altDamage: '3d6',
                concealable: true,
                hands: 1,
                stealth: 2,
                magazine: 9,
                price: 200,
                load: 3
            },
            {
                type: 'Крупнокалиберные пистолеты',
                primaryDamage: '6d4',
                altDamage: '4d6',
                concealable: true,
                hands: 1,
                stealth: 2,
                magazine: 5,
                price: 500,
                load: 4
            },
            {
                type: 'Пистолеты-пулемёты',
                primaryDamage: '5d4',
                altDamage: '3d6',
                concealable: true,
                hands: 1,
                stealth: 2,
                magazine: 20,
                price: 200,
                load: 4
            },
            {
                type: 'Тяжёлые пистолеты-пулемёты',
                primaryDamage: '6d4',
                altDamage: '4d6',
                concealable: true,
                hands: 2,
                stealth: 2,
                magazine: 10,
                price: 500,
                load: 5
            },
            {
                type: 'Штурмовые винтовки',
                primaryDamage: '8d4',
                altDamage: '5d6',
                concealable: false,
                hands: 2,
                stealth: 1,
                magazine: 30,
                price: 1000,
                load: 6
            },
            {
                type: 'Снайперские винтовки',
                primaryDamage: '8d4',
                altDamage: '3d10',
                concealable: false,
                hands: 2,
                stealth: 1,
                magazine: 5,
                price: 1000,
                load: 8
            },
            {
                type: 'Пулемёты',
                primaryDamage: '8d4',
                altDamage: '6d6',
                concealable: false,
                hands: 2,
                stealth: 1,
                magazine: 100,
                price: 5000,
                load: 9
            },
            {
                type: 'Дробовики',
                primaryDamage: '3d10',
                altDamage: '—',
                concealable: false,
                hands: 2,
                stealth: 1,
                magazine: '2x3',
                price: 500,
                load: 5
            },
            {
                type: 'Гранатомёты',
                primaryDamage: '2d20',
                altDamage: '—',
                concealable: false,
                hands: 1,
                stealth: 1,
                magazine: 2,
                price: 2000,
                load: 7
            },
            {
                type: 'Ракетомёты',
                primaryDamage: '5d10',
                altDamage: '—',
                concealable: false,
                hands: 2,
                stealth: 1,
                magazine: 1,
                price: 5000,
                load: 11
            },
            {
                type: 'Оружие с самонаведением',
                primaryDamage: '5d4',
                altDamage: '3d6',
                concealable: 'обычно да',
                hands: '1-0',
                stealth: 1,
                magazine: 1,
                price: 5000,
                load: 2
            }
        ];

        // Библиотека модулей оружия
        const WEAPON_MODULES = {
            melee: [
                {
                    name: 'Баллистическая рукоять',
                    compatible: 'Клинковое оружие',
                    description: 'Встраивает в рукоять пиропатрон. Действием можно выстрелить клинком на 5 пространств перед собой. Проверка попадания стандартная: Ближний бой атакующего против Уклонения защищающегося.',
                    price: 1000,
                    load: 1
                },
                {
                    name: 'Вибропривод для клинка',
                    compatible: 'Любое оружие',
                    description: 'ОББ теперь полностью игнорирует ОС ниже или равную 15. ОС выше снижается вдвое как обычно.',
                    price: 5000,
                    load: 1
                },
                {
                    name: 'Зазубренное лезвие',
                    compatible: 'Клинковое оружие',
                    description: 'Лезвие имеет зазубрины для рвания плоти, нанося травмы. Если хотя бы 1 урон достиг ПЗ цели при атаке таким оружием, цель получает эффект Кровотечение: раз в раунд перед своим ходом цель получает 1 урон. Если цель получает этот урон после того, как её ПЗ стало равно 0, то цель безвозвратно умирает. Кровотечение можно остановить проверкой навыка «Первая помощь» СЛ 18 (например, прижечь рану). Эффекты от нескольких кровотечений суммируются.',
                    price: 500,
                    load: 1
                },
                {
                    name: 'Рукоять с горелкой',
                    compatible: 'Неклинковое оружие',
                    description: 'Дубина превращается в паяльник — при попадании одновременно поджигает цель. Цель начинает Слабо гореть; если хотя бы 1 урон достиг ПЗ цели, она немедленно получает 1d6 урона от огня.',
                    price: 1000,
                    load: 1
                },
                {
                    name: 'Телескопичность',
                    compatible: 'Неклинковое оружие',
                    description: 'Дубина/рукоять кувалды/опора ЛЭП становится телескопической — можно спрятать своё ОББ без проверки. Если владелец не пожелает показывать оружие, найти его проверкой навыка «Внимательность» невозможно; обнаружение возможно только техническими средствами.',
                    price: 500,
                    load: 1
                },
                {
                    name: 'Цепной привод',
                    compatible: 'Любое оружие',
                    description: 'По периметру оружия вращается цепь бензопилы. Оружие получает дополнительную +1 к СКА и может вызвать эффект Кровотечение, если наносит урон.',
                    price: 5000,
                    load: 1
                },
                {
                    name: 'Электрический конденсатор',
                    compatible: 'Оружие с металлической ударной частью',
                    description: 'Конденсатор подсоединяется к металлу в ударной части оружия. Расходует батарейку (10уе) с зарядом на 1 удар. Помимо основного урона оружие теперь наносит электрический урон (5d6; броня может защитить). Замена батарейки — полное действие.',
                    price: 1500,
                    load: 1
                }
            ],
            ranged: [
                {
                    name: 'Барабанный магазин',
                    compatible: 'ПП, ТПП, ШВ, ПУЛ, ГМ',
                    description: 'В 4 раза больше патронов. Перезарядка — 2 действия или весь ход.',
                    price: 500,
                    load: 1
                },
                {
                    name: 'Увеличенный магазин',
                    compatible: 'ПП, ТПП, ШВ, ПУЛ, ГМ',
                    description: 'В 2 раза больше патронов.',
                    price: 100,
                    load: 1
                },
                {
                    name: 'Глушитель (крупнокалиберный)',
                    compatible: 'СВ, ПУЛ, КП',
                    description: 'Не слышно далее 25 метров. Ресурс — 50 выстрелов.',
                    price: 500,
                    load: 1
                },
                {
                    name: 'Глушитель (мелкокалиберный)',
                    compatible: 'ТПП, ШВ, ДР, ЛП, ОП, ПП',
                    description: 'Не слышно далее 16 метров. Ресурс — 50 выстрелов.',
                    price: 250,
                    load: 1
                },
                {
                    name: 'Глушитель (мембранный)',
                    compatible: 'ТПП, ШВ, ДР, ЛП, ОП, ПП',
                    description: 'Совершенно бесшумный. Ресурс — 10 выстрелов.',
                    price: 250,
                    load: 1
                },
                {
                    name: 'Замена всех деталей на полимерные',
                    compatible: 'ЛП, ОП, КП, ПП, ТПП, ГМ',
                    description: 'Невидим для детекторов. Ресурс — 50 выстрелов.',
                    price: 1000,
                    load: 1
                },
                {
                    name: 'Коллиматорный прицел',
                    compatible: 'любое оружие',
                    description: '(оригинал) сл близкой стрельбы = пистолет. Пистолет — -2 сл стрельбы.',
                    price: 500,
                    load: 1
                },
                {
                    name: 'Тепловизионный прицел с ПНВ',
                    compatible: 'любое оружие',
                    description: '(оригинал) сл близкой стрельбы = пистолет. Пистолет — -2 сл стрельбы. Видно в темноте.',
                    price: 1000,
                    load: 1
                },
                {
                    name: 'Лазерный целеуказатель',
                    compatible: 'ЛП, ОП, ПП, ТПП, ШВ, СВ, ПУЛ',
                    description: 'Даёт −1 к сл стрельбы.',
                    price: 500,
                    load: 1
                },
                {
                    name: 'Модуль «Умного оружия»',
                    compatible: 'ПП, ТПП, ШП, СВ, ПУЛ, ДР, РМ',
                    description: 'Не требует проверок попадания, СЛ 18 для Уклонения. Дробовики — 2 цели в радиусе 5 пространств друг от друга СЛ 16 для Уклонения.',
                    price: 5000,
                    load: 1
                },
                {
                    name: 'Оптический прицел',
                    compatible: 'ТПП, ШВ, СВ, ПУЛ, А-ОДБ',
                    description: 'Стрельба на очень дальнюю дистанцию со сложностью как у снайперской винтовки.',
                    price: 500,
                    load: 1
                },
                {
                    name: 'Оптический тепловизионный прицел с ПНВ',
                    compatible: 'ТПП, ШВ, СВ, ПУЛ, А-ОДБ',
                    description: 'Стрельба на очень дальнюю дистанцию со сложностью как у снайперской винтовки. Видно в темноте.',
                    price: 1000,
                    load: 1
                },
                {
                    name: 'Особый УСМ (облегчённый)',
                    compatible: 'ЛП, ОП, ПП, ТПП, ШВ, СВ',
                    description: '+1 СКА, +5 сл на попадание. Требует два слота.',
                    price: 1000,
                    load: 1,
                    slotsRequired: 2
                },
                {
                    name: 'Особый УСМ (длинноходный)',
                    compatible: 'ЛП, ОП, ПП, ТПП',
                    description: '−1 СКА, −2 сл на попадание. Требует два слота.',
                    price: 1000,
                    load: 1,
                    slotsRequired: 2
                },
                {
                    name: 'Пламегаситель / компенсатор',
                    compatible: 'ОП, КП, ПП, ТПП, ШВ, ПУЛ, ДР',
                    description: '−2 к сл автоогня.',
                    price: 100,
                    load: 1
                },
                {
                    name: 'Подствольный гранатомёт',
                    compatible: 'ШВ, СВ',
                    description: 'Гранатомёт на 1 гранату. Сложность — как у гранатомёта. Ресурс — 20 выстрелов.',
                    price: 500,
                    load: 1
                },
                {
                    name: 'Подствольный дробовик',
                    compatible: 'ШВ, СВ',
                    description: 'Дробовик на 2 патрона по всем правилам дробовика. Ресурс — 30 выстрелов.',
                    price: 500,
                    load: 1
                },
                {
                    name: 'Сошки',
                    compatible: 'ШВ, СВ, ПУЛ',
                    description: 'Установить/снять — 1 действие. Установлено — −2 СЛ. Не убраны и с рук — +2 СЛ.',
                    price: 500,
                    load: 1
                },
                {
                    name: 'Тактическая рукоять',
                    compatible: 'ТПП, ШВ, ПУЛ, СВ, ДР, ГМ',
                    description: '−1 к сл на попадание.',
                    price: 100,
                    load: 1
                },
                {
                    name: 'Тактический фонарик',
                    compatible: 'любое',
                    description: 'Позволяет светить прямо туда, куда он направлен.',
                    price: 100,
                    load: 1
                },
                {
                    name: 'Цевьё с дополнительными планками',
                    compatible: 'любое',
                    description: '+3 слота для опций. «Клей-стикеры» на любое свободное место.',
                    price: 1000,
                    load: 1
                },
                {
                    name: 'Штык-нож',
                    compatible: 'любое',
                    description: 'Считается разным оружием ближнего боя в зависимости от того, куда установлен ЛП, ОП, КП, ПП — лёгкое ОББ; ТПП, ШВ, ДР, ГМ — среднее ОББ; СВ, ПУЛ, РМ — тяжёлое ОББ. Нужно выбрать нужный.',
                    price: 100,
                    load: 1
                }
            ]
        };

        // Данные боеприпасов
        const AMMO_DATA = {
            types: [
                'Стандартные',
                'Бронебойные',
                'Дозвуковые',
                'Жаканы',
                'Зажигательные',
                'Разрывные',
                'Резиновые',
                'Экспансивные',
                'Эми',
                'Дымовые',
                'Лазерные',
                'Оглушающие',
                'Токсичные'
            ],
            weaponTypes: {
                'Лёгкий пистолет': 'ЛП',
                'Обычный пистолет': 'ОП',
                'Пистолет-пулемёт': 'ПП',
                'Тяжёлый пистолет-пулемёт': 'ТПП',
                'Штурмовая винтовка': 'ШВ',
                'Крупнокалиберный пистолет': 'КП',
                'Пулемёт': 'ПУЛ',
                'Снайперская винтовка': 'СВ',
                'Дробовик': 'ДР',
                'Оружие с самонаведением': 'ОСМ',
                'Гранаты': 'Гранаты',
                'Ракеты': 'Ракеты'
            },
            prices: {
                'Стандартные': { 'ЛП': 20, 'ОП': 20, 'ПП': 20, 'ТПП': 30, 'ШВ': 30, 'КП': 40, 'ПУЛ': 40, 'СВ': 100, 'ДР': 30, 'ОСМ': 100, 'Гранаты': null, 'Ракеты': null },
                'Бронебойные': { 'ЛП': 200, 'ОП': 200, 'ПП': 200, 'ТПП': 300, 'ШВ': 300, 'КП': 300, 'ПУЛ': 300, 'СВ': 500, 'ДР': null, 'ОСМ': null, 'Гранаты': 250, 'Ракеты': 500 },
                'Дозвуковые': { 'ЛП': 100, 'ОП': 100, 'ПП': 100, 'ТПП': 100, 'ШВ': 100, 'КП': 100, 'ПУЛ': 100, 'СВ': 200, 'ДР': 100, 'ОСМ': null, 'Гранаты': null, 'Ракеты': null },
                'Жаканы': { 'ЛП': null, 'ОП': null, 'ПП': null, 'ТПП': null, 'ШВ': null, 'КП': null, 'ПУЛ': null, 'СВ': null, 'ДР': 30, 'ОСМ': null, 'Гранаты': null, 'Ракеты': null },
                'Зажигательные': { 'ЛП': 150, 'ОП': 150, 'ПП': 150, 'ТПП': 200, 'ШВ': 200, 'КП': 200, 'ПУЛ': 200, 'СВ': 500, 'ДР': 200, 'ОСМ': null, 'Гранаты': 500, 'Ракеты': 500 },
                'Разрывные': { 'ЛП': null, 'ОП': null, 'ПП': null, 'ТПП': 300, 'ШВ': 300, 'КП': 500, 'ПУЛ': 500, 'СВ': 500, 'ДР': 500, 'ОСМ': null, 'Гранаты': null, 'Ракеты': null },
                'Резиновые': { 'ЛП': 20, 'ОП': 20, 'ПП': 20, 'ТПП': 30, 'ШВ': 30, 'КП': 40, 'ПУЛ': 40, 'СВ': null, 'ДР': null, 'ОСМ': null, 'Гранаты': 10, 'Ракеты': 50 },
                'Экспансивные': { 'ЛП': 300, 'ОП': 300, 'ПП': 300, 'ТПП': 400, 'ШВ': 400, 'КП': 500, 'ПУЛ': 500, 'СВ': 500, 'ДР': 500, 'ОСМ': null, 'Гранаты': null, 'Ракеты': 500 },
                'Эми': { 'ЛП': 100, 'ОП': 100, 'ПП': 100, 'ТПП': 100, 'ШВ': 100, 'КП': 100, 'ПУЛ': 100, 'СВ': null, 'ДР': 500, 'ОСМ': 100, 'Гранаты': 500, 'Ракеты': 500 },
                'Дымовые': { 'ЛП': null, 'ОП': null, 'ПП': null, 'ТПП': null, 'ШВ': null, 'КП': null, 'ПУЛ': null, 'СВ': null, 'ДР': 1000, 'ОСМ': null, 'Гранаты': 250, 'Ракеты': 250 },
                'Лазерные': { 'ЛП': null, 'ОП': null, 'ПП': null, 'ТПП': null, 'ШВ': null, 'КП': null, 'ПУЛ': null, 'СВ': null, 'ДР': null, 'ОСМ': null, 'Гранаты': 1000, 'Ракеты': 1000 },
                'Оглушающие': { 'ЛП': null, 'ОП': null, 'ПП': null, 'ТПП': null, 'ШВ': null, 'КП': null, 'ПУЛ': null, 'СВ': null, 'ДР': null, 'ОСМ': null, 'Гранаты': 250, 'Ракеты': null },
                'Токсичные': { 'ЛП': null, 'ОП': null, 'ПП': null, 'ТПП': null, 'ШВ': null, 'КП': null, 'ПУЛ': null, 'СВ': 500, 'ДР': 500, 'ОСМ': null, 'Гранаты': 250, 'Ракеты': 250 }
            }
        };

        // Библиотека препаратов
        const DRUGS_LIBRARY = {
            "Уличные препараты": [
                {
                    name: "КаЙо",
                    description: "Таблетки, выводящие радиацию — усовершенствованный Йодид Калия. Достать их не проблема, они на каждом углу. Есть даже жвачка с активным компонентом КаЙо. Желательно пить их раз в неделю, чтобы нейтрализовать общий негативный фон. В пачке обычно 10 таблеток.",
                    effect: "Если не пить эти таблетки в течение месяца, то на человека начнёт влиять слабая радиация из-за накопительного эффекта от общего фона. Если ты точно знаешь, что идёшь в место с радиацией, то запасись ими. Одна выпитая таблетка устраняет действие слабой радиации на 15 минут",
                    price: 10,
                    category: "street"
                },
                {
                    name: "ТетраБлю",
                    description: "Порошок в жестяной банке для разведения с водой. При разведении немного нагревается и газируется. Жидкость имеет синеватый оттенок и на вкус как энергетик без сахара. Есть люди, которые пьют его просто так. Продаётся штучно.",
                    effect: "Помогает от разных лёгких простудных эффектов. По крайней мере, теперь не страшно попасть под дождь осенью, посидеть под кондиционером летом или выйти зимой на улицу без шапки. Это нарративное лекарство.",
                    price: 10,
                    category: "street"
                },
                {
                    name: "Кибернетин",
                    description: "Ингалятор для вдыхания сразу после установки киберимплантов. Был создан в военное время, помогал солдатам легче переносить психические проблемы при установки новых киберов. Продаётся штучно.",
                    effect: "Нивелирует ПО при установке киберимпланта. Вызывает привыкание. Сделай проверку Сопротивления ядам СЛ15. Если ты провалил, то твой Мастер периодически будет сообщать, когда тебе хочется еще. Без него ты начинаешь нервничать и психовать. Если игнорировать Кибернетин больше месяца, то каждая неделя начнёт приносить 1d6 ПО. Поэтому ветераны войн такие сумасшедшие.",
                    price: 500,
                    category: "street"
                },
                {
                    name: "Криогель",
                    description: "Тюбик с гелем на 10 применений. Устраняет эффекты ожогов и расстройства желудка, если проглотить.",
                    effect: "Если нанести на мясную конечность, можно трогать раскалённые предметы в течение минуты. Помимо этого, Криогель помогает справиться с эффектом перелома руки или ноги на 10 минут, снижая боль от перелома. Повторное нанесение не даст эффекта.",
                    price: 100,
                    category: "street"
                },
                {
                    name: "Нанорегенерин",
                    description: "Красные капсулы с жидкостью внутри. В пачке 2 штуки.",
                    effect: "Ускоряют естественное заживление ран человека в 2 раза, если он отдыхает.",
                    price: 100,
                    category: "street"
                },
                {
                    name: "Нейрокодин",
                    description: "Гематогенки для детей. Делают их спокойными, и те лучше делают домашние задания. Основная целевая аудитория — дети корпоратов. Продаётся штучно.",
                    effect: "Обожаем Сёрферами, т.к. охлаждает их мозг и увеличивает УМ на 2. Также снижая урон по мозгу в Сети на 1d6 (минимум 0). Оба эффекта действуют в течение 20 минут. Эффект появляется только два раза в сутки.",
                    price: 500,
                    category: "street"
                },
                {
                    name: "Адреналинекс",
                    description: "Возбудитель для мужчин. Продаётся в пачках по 5 ампул с надписью \"СТРОГО ЗАПРЕЩЕНО ПРИНИМАТЬ ЗА РАЗ БОЛЕЕ 1 ШТУКИ!\".",
                    effect: "Если принять более 1 таблетки за раз, то увеличит РЕА на 1, у мужчин вызывает лютый стояк. Каждая таблетка увеличивает срок действия бонуса к РЕА на 1 минуту. Не действует на биологических женщин.",
                    price: 100,
                    category: "street"
                },
                {
                    name: "Феминардор",
                    description: "Увеличивает выработку женских половых гормонов и повышает сексуальное влечение. Используется в основном девушками, которым предстоит не самое приятное свидание. Обычно это эскортницы престарелых корпоратов. Продаётся в пачках по 5 ампул с надписью \"СТРОГО ЗАПРЕЩЕНО ПРИНИМАТЬ ЗА РАЗ БОЛЕЕ 1 ШТУКИ!\".",
                    effect: "Если принять более 1 таблетки за раз, то увеличит РЕА на 1, у женщин вызывает сильно возбуждение со всеми сопутствующими эффектами. Объекты сексуального влечения становятся действительно желанны. Каждая таблетка увеличивает срок действия бонуса к РЕА на 1 минуту. Не действует на биологических мужчин.",
                    price: 100,
                    category: "street"
                }
            ],
            "Клинические препараты": [
                {
                    name: "ЛайфСтим",
                    description: "Укольчик, продлевающий жизнь.",
                    effect: "Немедленно восстанавливает ПЗ равное ТЕЛ+ВОЛЯ пациента. Можно использовать не чаще раза в сутки. Если медик затыкает человека этим лекарством более 3х раз, то он станет вялый, необщительный. И скорее всего, уйдёт в запой. Короче, депрессия, братишка.",
                    price: 10,
                    category: "clinical"
                },
                {
                    name: "Электросеротонин",
                    description: "Подавляет боль, улучшает настроение, избавляет ото сна.",
                    effect: "Этот нейромедиатор позволяет пациенту не спать еще сутки без штрафов. Помимо этого, снимает боль от критических повреждений на 1d100 минут. Передозировки нет, не имеет эффекта более чем за 1 применение в неделю.",
                    price: 10,
                    category: "clinical"
                },
                {
                    name: "Нейростим",
                    description: "Ускоряет мозговую активность. Некоторые Сёрферы пр деньгах покупают лицензию Медика (взятка 5000уе), но учат только один препарат — Нейростим. Еще его можно найти в подпольных магазинах в виде готовых ампул для пневмошприца по двойной стоимости. Улучшает кровообращение головного мозга, укрепляет синоптические связи, позволяя Сёрфить без страха за жизнь.",
                    effect: "Увеличивает УМ на 2 на час, уменьшает урон в головной мозг на 2d6 до нуля на 20 минут. Можно применять раз в сутки. При повторном введении не имеет эффекта, при третьем использовании за сутки удваивает эффект, но вызывает жуткие головные боли, делая сёрфинг невозможным на неделю после окончания действия.",
                    price: 500,
                    category: "clinical"
                },
                {
                    name: "Кибердопамин",
                    description: "Снижает угрозу ПО при установке киберимплантов.",
                    effect: "Лёгкая и более доступная версия Кибернетина. Уменьшает ПО при установке киберимплантов в 2 раза (округляется вверх), не имеет побочных эффектов, ограничений и передозировок. Просто делает психику человека более спокойной и эластичной для проведения операции. На каждую установку импланта нужна 1 доза Кибердопамина.",
                    price: 100,
                    category: "clinical"
                },
                {
                    name: "Адреназон",
                    description: "Военный стимулятор. Увеличивает скорость реакции солдат, снимает сонливость, улучшает зрение и слух. Имеет жесткие побочки. Может вызвать привыкание",
                    effect: "На сутки повышает ЛВК, СКО, РЕА и ВОЛЮ (влияет на ПЗ) +2, а также все проверки внимательности на слух и зрение еще на +2. Сделай проверку Сопротивления ядам СЛ 18. Если ты провалил, то твой Мастер периодически будет сообщать, когда тебе хочется еще. Без него ты начинаешь нервничать и психовать. Если игнорировать Адреназон больше недели, то каждая неделя начнёт приносить 1d6 ПО.",
                    price: 100,
                    category: "clinical"
                },
                {
                    name: "Некрозон",
                    description: "Лекарство, способное вытащить мёртвого с того света. Адовая смесь лекарств, которая разгоняет сердце, повышает температуру тела и ускоряет выработку крови, не давая пациенту истечь ей. Зачем переливание, когда можно заставить организм выделять её самостоятельно?",
                    effect: "Снимает штраф Спасброска с человека со смертельным ранением, восстанавливая человека до 1 ПЗ. Его раны открываются, и он истекает кровью. Ближайшие три раунда он не делает спасброски, не теряет сознание, но не может совершать никакие действия, кроме перемещения со штрафом х2 к СКО. По окончании действия, пациент теряет сознание на 5 минут и оказывается в стабилизированном состоянии. Благодаря тому, что у него есть \"отверстия\" для выхода крови, он не получает урона от переизбытка давления. Если вколоть такое здоровому человеку, в течение трёх ходов он будет получать 1d6 непосредственно в ПЗ из-за переизбытка крови. К слову, она начнёт вытекать через капилляры в носу, рту и слезные каналы глаз. Стрёмное зрелище, никому не советую, может вызвать проверку ВОЛИ у неподготовленных.",
                    price: 500,
                    category: "clinical"
                },
                {
                    name: "Бэнц",
                    description: "Улучшает интуицию. У тебя есть ощущение, что ты знаешь, что произойдёт и можешь повлиять на ситуацию. Официально медицинский эффект не доказан, но всякие инфо-дивы постоянно его принимают, считая, что он добавляет им капельку удачи. В интервью актриса Йонди Сайфер даже заявила, что у нее появляется ощущение, что за неё кто-то где-то там за столом сам решает, что ей делать, а она просто поддаётся.",
                    effect: "Можно применять раз в неделю или раз в игровую сессию (если за 1 сессию прошло несколько недель). Добавляет 2 невосполнимых очка УДЧ.",
                    price: 100,
                    category: "clinical"
                },
                {
                    name: "Преднибутероферон",
                    description: "Просто лекарство для терапии. Вводится людям, чтобы те ненадолго почувствовали себя увереннее и вернулись к нормальной жизни.",
                    effect: "На сутки повышает выбранное медиком Врожденное качество на единицу. Одновременно может действовать только 1 препарат. Каждый последующий препарат заменяет предыдущий.",
                    price: 100,
                    category: "clinical"
                }
            ],
            "Уличные наркотики": [
                {
                    name: "Медвежонок",
                    description: "На 4 часа увеличивает УМ на 2",
                    difficulty: 19,
                    secondaryEffect: "Понижает твой УМ на 4. Если он падает до 0 — ты мёртв.",
                    price: 10,
                    category: "drugs"
                },
                {
                    name: "Белый снег",
                    description: "В течение 4 часов ты испытываешь счастье и радость.",
                    difficulty: 16,
                    secondaryEffect: "Ты нерадостен и несчастен. Ты хочешь еще белого снега.",
                    price: 10,
                    category: "drugs"
                },
                {
                    name: "Золотинка",
                    description: "Время от времени, в течение 1 часа, ты видишь галлюцинации, во время которых не можешь ничего, кроме как смотреть \"мультики\" наяву. Мастер скажет тебе когда.",
                    difficulty: 16,
                    secondaryEffect: "Теперь ты видишь время от времени \"мультики\" без приёма Золотинки. Чтобы избавиться от эффекта, тебе нужно еще Золотинки. Мастер скажет, когда тебя накрывает.",
                    price: 500,
                    category: "drugs"
                },
                {
                    name: "Блёстки",
                    description: "Ты король вечера, ты звезда! +4 ко всем коммуникативным проверкам, связанным с общением на усмотрение Мастера в течение 4 часов.",
                    difficulty: 18,
                    secondaryEffect: "Депрессия заставляет тебя думать, что ты урод и никому не нужен. -4 ко всем коммуникативным проверкам, связанным с общением на усмотрение Мастера, за исключением попыток вызвать жалость.",
                    price: 100,
                    category: "drugs"
                },
                {
                    name: "Зелёная Корова",
                    description: "Газированный напиток в жестяной банке. Сильно бодрит. Позволяет не спать сутки, не суммируется с другими эффектами, снимающими усталость. Можно использовать каждый день, но СЛ проверки будет увеличиваться каждый раз на +2",
                    difficulty: 18,
                    secondaryEffect: "Твоей нервной системе нанесён большой урон. Теперь ты не можешь уснуть без баночки \"Зелёной коровы\". Если ты долго не спишь, на тебя влияет отсутствие отдыха.",
                    price: 100,
                    category: "drugs"
                },
                {
                    name: "Тройной Экспрессо",
                    description: "На 1 час Повышает РЕА на 2. Ты становишься дёрганым, тебя одолевает паранойя.",
                    difficulty: 16,
                    secondaryEffect: "Ты теперь \"кофейный\" наркоман. Тебе постоянно хочет любого кофе, но ты прекрасно знаешь, что Экспрессо — это не кофе. Твоя РЕА снижается на 2 пункта. Более того, у тебя от кофе развивается жуткая диарея. Вторичный эффект пропадает только при \"Тройном Экспрессо\"",
                    price: 50,
                    category: "drugs"
                },
                {
                    name: "Грандмастер",
                    description: "Военный наркотик в виде крекера. Стоит тебе его съесть, как ты получаешь 2d6 ПО, которые возвращаются после прекращения Первичного Эффекта. На 24 часа ты игнорирует все эффекты критических травм и ранений (даже смертельных), исключением являются оторванные части тела, нельзя пользоваться тем, что оторвано. Ты не можешь потерять сознание. Твои ПЗ могут достигать орицательных значений, но помни, что если твои ПЗ в отрицательном значении равны цифре в максимальном положительном значении, ты автоматически мёртв. Нарративно — ты груда костей и разбросанного мяса, спасать нечего. Если по окончании Первичного действия у тебя нет хотя бы 1 ПЗ, ты умираешь. Выглядишь в эти моменты ты как зомби с оторванными кусками мяса. Пугающее зрелище. Наркотик настоящей легенды. Доведи дело до конца!",
                    difficulty: 25,
                    secondaryEffect: "Твои РЕА и СКО падают на 4 пункта навсегда. Малая плата за такую силу, да? Нельзя заставить кого-то съесть крекер, если он того не хочет. Он подействует только после полного психологического принятия последствий. Любимая пропагандистская игрушка командования в любую бессмысленную войну.",
                    price: 1000,
                    category: "drugs"
                }
            ]
        };

        // Библиотека транспорта
        const VEHICLES_LIBRARY = {
            "Воздушный транспорт": [
                {
                    name: "Персональный ЛА",
                    description: "Одноместный Летательный Аппарат для передвижения в пределах города. Выглядит как капсула с микроверсией двигателя от СВВП. В основном используют корпораты, чтобы облетать пробки. Есть \"багажный крюк\" на 1 портфель или сумку. Особо архаичные версии выглядят как рюкзак с 2 ядро-баллонами и 2 соплами на спине. Управляется одной рукояткой или через Порт, если установлен разъём.",
                    hp: 15,
                    seats: 1,
                    mechanicalSpeed: 15,
                    narrativeSpeed: "80 км/ч",
                    price: 10000,
                    category: "air"
                },
                {
                    name: "Гирокоптер",
                    description: "Двухместный гирокоптер, приводимый в движение маленьким винтом позади, вместо крыла использующий винт, как у вертолёта. Из-за такой конструкции он не может зависать на месте и ему необходима маленькая ВПП. Используется в качестве патрульной-разведывательной машины. Пригоден для длительных перелётов.",
                    hp: 35,
                    seats: 2,
                    mechanicalSpeed: 20,
                    narrativeSpeed: "160 км/ч",
                    price: 15000,
                    category: "air"
                },
                {
                    name: "Вертолёт",
                    description: "Стандартная винтокрылая машина. С 2035 года люди отказались от хвостовых винтов в пользу фенестронов, либо соосной конструкции винтов. Поэтому задний винт больше не угрожает твоей жизни. Позволяет летать между континентами.",
                    hp: 70,
                    seats: 4,
                    mechanicalSpeed: 40,
                    narrativeSpeed: "320 км/ч",
                    price: 40000,
                    category: "air"
                },
                {
                    name: "Гражданский СВВП",
                    description: "Передовые технологии авиации на службы у обычного человека. Они встречаются везде, от корпоративных \"VIP-фургонов\" до обычных маршруток. В некоторых странах, в т.ч. Чернграде обычным людям запрещено иметь СВВП во избежание страшных катастроф в воздухе. Лицензия на СВВП стоит огромных денег. Поэтому на них летают экстренные службы, скорая помощь, общественный транспорт и большие шишки. А ты на своём драндулете стой в пробке.",
                    hp: 100,
                    seats: "4-18",
                    mechanicalSpeed: 40,
                    narrativeSpeed: "320 км/ч",
                    price: "60000-120000",
                    category: "air"
                },
                {
                    name: "Боевой СВВП",
                    description: "Военизированная десантная версия гражданского СВВП. Внутри склад с оружием и патронами, на корпусе турели и ракетометы. Панк, видишь такой над твоей головой — тикай с селу.",
                    hp: 150,
                    seats: 12,
                    mechanicalSpeed: 50,
                    narrativeSpeed: "400 км/ч",
                    price: 100000,
                    category: "air"
                },
                {
                    name: "Спортивный СВВП",
                    description: "Настоящий гиперкар среди СВВП. Богачи и шейхи летают на таких, когда всё остальное уже надоело. Развивает огромную скорость. Поговаривают, что они морально удлиняют пенис своим владельцам.",
                    hp: 60,
                    seats: 2,
                    mechanicalSpeed: 60,
                    narrativeSpeed: "480 км/ч",
                    price: 200000,
                    category: "air"
                },
                {
                    name: "Скайлинер",
                    description: "Тяжелый гибрид самолёта и дирижабля. Используется вольниками при перевозке больших партий груза. Для некоторых они служат домом. Есть люди в стаях вольников, которые видели полмира, но ни разу не сходили с них. Из-за возможности зависать на месте и летать практически бесконечно, их объединяют в настоящие летучие города над нейтральными водами. А если грозит опасность, они разлетаются в разные стороны, что концов не найдёшь.",
                    hp: 200,
                    seats: "2 на каюту",
                    mechanicalSpeed: 20,
                    narrativeSpeed: "160 км/ч",
                    price: "10000 за каюту, минимум 3",
                    category: "air"
                }
            ],
            "Водный транспорт": [
                {
                    name: "Гидроцикл",
                    description: "Самый обычный гидроцикл.",
                    hp: 35,
                    seats: 2,
                    mechanicalSpeed: 20,
                    narrativeSpeed: "100 км/ч",
                    price: 20000,
                    category: "water"
                },
                {
                    name: "Рыбацкий катер",
                    description: "Медлительный катер, предназначенный для ловли рыбы либо перевозки групп туристов по красивым местам.",
                    hp: 50,
                    seats: 6,
                    mechanicalSpeed: 8,
                    narrativeSpeed: "40 км/ч",
                    price: 25000,
                    category: "water"
                },
                {
                    name: "Скоростной Катер",
                    description: "Скоростной катер для преодоления больших расстояний по рекам, озерам и морю. Оснащён закрытой кабиной.",
                    hp: 40,
                    seats: 4,
                    mechanicalSpeed: 20,
                    narrativeSpeed: "100 км/ч",
                    price: 30000,
                    category: "water"
                },
                {
                    name: "Круизная Яхта",
                    description: "Роскошная круизная яхта с каютами. Чем больше кают, тем больше яхта. На таких загорают бледные миллиардеры, а служители церквей ходят по водной глади.",
                    hp: 70,
                    seats: "4 на каюту",
                    mechanicalSpeed: 15,
                    narrativeSpeed: "75 км/ч",
                    price: "20000 за каюту, минимум 2",
                    category: "water"
                },
                {
                    name: "Баржа",
                    description: "Большая, неповоротливая, медлительная баржа для перевоза большого объёма груза, автомобилей или людей. Бывают разных размеров. Морские сухогрузы в эту категорию не входят, это скорее среднего размеров паромы. Хорошее вложение для бизнеса.",
                    hp: 100,
                    seats: 32,
                    mechanicalSpeed: 10,
                    narrativeSpeed: "50 км/ч",
                    price: 100000,
                    category: "water"
                }
            ],
            "Наземный транспорт": [
                {
                    name: "Компактный Микромобиль",
                    description: "Обычный городской автомобиль для одинокого человека на обычном двигателе.",
                    hp: 50,
                    seats: 1,
                    mechanicalSpeed: 20,
                    narrativeSpeed: "160 км/ч",
                    price: 15000,
                    category: "ground",
                    isDefault: true
                },
                {
                    name: "Обычный Автомобиль (2 места)",
                    description: "Городской автомобиль, универсал или минивен, в него можно посадить тёщу и мешок карточки.",
                    hp: 60,
                    seats: 2,
                    mechanicalSpeed: 20,
                    narrativeSpeed: "160 км/ч",
                    price: 35000,
                    category: "ground"
                },
                {
                    name: "Обычный Автомобиль (4 места)",
                    description: "Городской автомобиль, универсал или минивен, в него можно посадить тёщу и мешок карточки.",
                    hp: 60,
                    seats: 4,
                    mechanicalSpeed: 20,
                    narrativeSpeed: "160 км/ч",
                    price: 40000,
                    category: "ground"
                },
                {
                    name: "Обычный Автомобиль (6 мест)",
                    description: "Городской автомобиль, универсал или минивен, в него можно посадить тёщу и мешок карточки.",
                    hp: 60,
                    seats: 6,
                    mechanicalSpeed: 20,
                    narrativeSpeed: "160 км/ч",
                    price: 50000,
                    category: "ground"
                },
                {
                    name: "Спорткар",
                    description: "Спортивная машина на токо-двигателе, позволяет развивать большую скорость.",
                    hp: 40,
                    seats: 2,
                    mechanicalSpeed: 40,
                    narrativeSpeed: "320 км/ч",
                    price: 50000,
                    category: "ground"
                },
                {
                    name: "Суперкар",
                    description: "Самые шикарные автомобили, на каждую ось отдельный токо-двигатель. Разгоняются до сумасшедших скоростей, на которых практически неуправляемы. Такие часто встречаются на Транс-германских автобанах, где нет скоростных лимитов.",
                    hp: 40,
                    seats: 2,
                    mechanicalSpeed: 60,
                    narrativeSpeed: "480 км/ч",
                    price: 100000,
                    category: "ground"
                },
                {
                    name: "Шоссейный байк",
                    description: "Обычный воин дорог, чоппер или шоссейный мото-лайнер, на котором не спеша и с пафосом можно пересечь страну и не устать.",
                    hp: 35,
                    seats: 2,
                    mechanicalSpeed: 20,
                    narrativeSpeed: "160 км/ч",
                    price: 15000,
                    category: "ground"
                },
                {
                    name: "Спортивный байк",
                    description: "Спортивный байк, позволяющий развивать большую скорость. Не забудь шлем, панк, стыдно сдохнуть в канаве из-за того, что твою черепушку пробил шмель на скорости. В движение приводит токо-двигатель.",
                    hp: 35,
                    seats: 2,
                    mechanicalSpeed: 40,
                    narrativeSpeed: "320 км/ч",
                    price: 30000,
                    category: "ground"
                },
                {
                    name: "Супербайк",
                    description: "Такие байки покупают только сумасшедшие и отбитые люди. Они настолько быстры и манёвренны, что требуют управления через Порт водителя. К каждому предоставляется специальный шлем, который передаёт состояние дороги и байка прямо в визор, а сопроцессор в голове водителя реагирует ещё до того, как водитель поймет, что происходит. Эти байки не заведутся без присоединённого Порта, при отключении байк сам замедлится и аккуратно остановится. На каждом колесе стоит отдельный токо-двигатель. Если на полной скорости влететь в отбойник где-то в Варшаве, то можно долететь до Парижа. Шутка. Не проверяй.",
                    hp: 25,
                    seats: 2,
                    mechanicalSpeed: 70,
                    narrativeSpeed: "540 км/ч",
                    price: 120000,
                    category: "ground"
                },
                {
                    name: "Фура",
                    description: "Любимый транспорт наземных вольников. Это может быть что угодно в виде грузовика. Фура или большой самосвал и подобное.",
                    hp: 70,
                    seats: 4,
                    mechanicalSpeed: 25,
                    narrativeSpeed: "200 км/ч",
                    price: 50000,
                    category: "ground"
                },
                {
                    name: "Автопоезд",
                    description: "Это фура, к которой прицеплено несколько секций. Секции могут быть жилые или грузовые, либо комбинированные. Вольники часто делают целые дорожные броне-автопоезда с кучей турелей и гаражом для своих байков и даже тачек. Вот так видишь автопоезд, достаёшь свой Армхарт т1000, а из него выскакивает 4 броневика с пулемётами. Ты не такое планировал?",
                    hp: "70 у каждой секции",
                    seats: "4 за секцию",
                    mechanicalSpeed: 20,
                    narrativeSpeed: "160 км/ч",
                    price: "50000 за секцию, максимум 4",
                    category: "ground"
                }
            ]
        };

        // Библиотека модификаций транспорта
        const VEHICLE_MODULES_LIBRARY = {
            "ground": [
                {
                    name: "Укрепленное шасси",
                    description: "Шасси, утяжеляющее и укрепляющее транспорт. Позволяет ставить большие тяжелые детали, которые превращают обычную машину в дрифтящий танк с реактивными турбинами. Добавляет транспорту 20 ПЗ.",
                    price: 500,
                    category: "ground",
                    requirements: []
                },
                {
                    name: "Облегчённое шасси",
                    description: "Шасси, облегчающее и уменьшающее транспорт в габаритах и весе, позволяя ставить модули левитации и скрытности. Добавляет транспорту + 10 СКО (50 км/ч).",
                    price: 500,
                    category: "ground",
                    requirements: []
                },
                {
                    name: "3D-голопроектор",
                    description: "Линза проектора, установленная где-то на корпусе транспорта. Позволяет создавать фотореалистичные 3D-модели объектов в радиусе 10 метров от машины, но из-за бликов и некоторой прозрачности всегда понятно, что это не реальный объект. Пользуется популярностью у стрит-рейсеров для обратного отсчета и обозначения маршрута, а также для общения, не выходя из машины.",
                    price: 1500,
                    category: "ground",
                    requirements: []
                },
                {
                    name: "Активная защита",
                    description: "Аналог носимой активной брони, но для транспорта. Вмещает 10 магазинов с 10 зарядами каждый. Можно перезарядить сидя в машине.",
                    price: 1500,
                    category: "ground",
                    requirements: []
                },
                {
                    name: "БИО-горючее",
                    description: "Установка, которая использует не типичное топливо, а био-органику. Подходит любая органика и её продукты жизнедеятельности, но имеет очень большой расход. Например, если вы решите справить нужду в бак, то это хватит буквально на 20 минут.",
                    price: 1000,
                    category: "ground",
                    requirements: []
                },
                {
                    name: "Бортовой компьютер",
                    description: "Позволяет установить в транспорт ИИ, который будет управлять транспортом вместо пилота по заданному маршруту. Если ИИ \"будет напуган\" погоней или перестрелкой, то он сможет бесперебойно управлять транспортом 5 раундов, а затем выключится и остановиться, если не перехватить управление. ИИ всегда находится в начале очереди инициативы.",
                    price: 5000,
                    category: "ground",
                    requirements: []
                },
                {
                    name: "Бронестёкла",
                    description: "Замены обычных стёкол на бронированные. Теперь они являются укрытиями с 20 ПЗ.",
                    price: 500,
                    category: "ground",
                    requirements: []
                },
                {
                    name: "Бронирование корпуса",
                    description: "Требует укреплённое шасси. Тяжелое бронирование корпуса, добавляющее транспорту 18 ОС. Снижает СКО на 10 (80 км/ч).",
                    price: 2000,
                    category: "ground",
                    requirements: ["Укрепленное шасси"]
                },
                {
                    name: "Герметизация корпуса",
                    description: "Герметизирует корпус транспорта. Если транспорт не получил урон, он может перейти в состояние полной герметичности и не впускать внешнюю атмосферу внутрь.",
                    price: 500,
                    category: "ground",
                    requirements: []
                },
                {
                    name: "Гусеничная платформа",
                    description: "Меняет колеса на гусеничную платформу. Позволяет без потери скорости ездить по пересечённой местности, беспрепятственно пересекать невысокие преграды (до 1 метра высотой). Если гусеничная платформа врезается в колёсную, колёсная всегда проигрывает и получает импульс от гусеничной.",
                    price: 1000,
                    category: "ground",
                    requirements: []
                },
                {
                    name: "Кингурятник",
                    description: "Транспорт не получает урона от сбитых пешеходов и предметов, если урона хватило, чтобы их уничтожить и продолжить движение.",
                    price: 1000,
                    category: "ground",
                    requirements: []
                },
                {
                    name: "Ковш",
                    description: "Требует укреплённое шасси. Транспорт не получает никакого урона от своего тарана, а также от таранящих атак в ковш. Может быть установлен только 1 ковш.",
                    price: 2500,
                    category: "ground",
                    requirements: ["Укрепленное шасси"]
                },
                {
                    name: "Контрабандное отделение",
                    description: "Потайной отсек, объемом 10х10, в котором можно провозить запрещённые вещи. Обнаружить контрабандный отсек можно только при осмотре транспорта специализированным облучающим оборудованием, которое обычно стоит на границах государств, если таковые там нужны. Вольный народ давно умеет проезжать мимо них, везя очередную партию палёных хронотомов.",
                    price: 500,
                    category: "ground",
                    requirements: []
                },
                {
                    name: "Крепление для тяжелого оружия",
                    description: "Требует укреплённое шасси. Крепление, которое позволяет установить оружие на \"башенку\" снаружи транспорта. Это может быть как пулемёт, так и ракетомёт. Можно установить максимум 1 такую модификацию на транспорт. Стрельба из такого оружия полностью убирает штрафы на стрельбу за качку транспорта во время езды.",
                    price: 2000,
                    category: "ground",
                    requirements: ["Укрепленное шасси"]
                },
                {
                    name: "Курсовое вооружение",
                    description: "Позволяет установить 1 любое оружие, которое ведёт огонь по курсу езды транспорта. Управляет им водитель/пилот. Не водитель может перезарядить его, находясь внутри транспорта.",
                    price: 1000,
                    category: "ground",
                    requirements: []
                },
                {
                    name: "Оптический камуфляж",
                    description: "Требует облегчённое шасси. Позволяет делать транспорт полностью незаметным на скоростях до 3 СКО (10 км/ч). Любой резкий манёвр или выстрел из транспорта снимает камуфляж на 30 секунд. Если транспорт был повреждён во время активного оптического камуфляжа, он становится неактивным на 5 минут. Дождь, дым, случайно упавший кирпич не демаскируют транспорт.",
                    price: 5000,
                    category: "ground",
                    requirements: ["Облегчённое шасси"]
                },
                {
                    name: "Пуленепробиваемые покрышки",
                    description: "Модификация для колёсной базы. Не позволяет пробить, прострелить или иным способом повредить покрышки транспорта. Тот самый случай, когда после взрыва мины от машины остаются только колёса.",
                    price: 500,
                    category: "ground",
                    requirements: []
                },
                {
                    name: "Реактивный ускоритель",
                    description: "Требует укреплённое шасси. Позволяет увеличить максимальное СКО транспорта на 5 раундов (15 секунд) в три раза от изначальных. Охлаждение и перезарядка реактивных ускорителей занимает 1 минуту. Думал, тебе хватит спорт-кара, чтобы сбежать от танка? Ха-ха.",
                    price: 5000,
                    category: "ground",
                    requirements: ["Укрепленное шасси"]
                },
                {
                    name: "Форсированный двигатель (Стадия 1)",
                    description: "Меняет стандартный двигатель транспорта на форсированный, увеличивая скорость транспорта на 5 СКО (40 км/ч). Новая скорость становится основной скоростью транспорта для других улучшений.",
                    price: 1000,
                    category: "ground",
                    requirements: []
                },
                {
                    name: "Форсированный двигатель (Стадия 2)",
                    description: "Дополнительно увеличивает скорость транспорта на 10 СКО (80 км/ч). Требует установленную Стадию 1.",
                    price: 2500,
                    category: "ground",
                    requirements: ["Форсированный двигатель (Стадия 1)"]
                },
                {
                    name: "Форсированный двигатель (Стадия 3)",
                    description: "Максимальное улучшение двигателя, увеличивает скорость на 13 СКО (102 км/ч). Требует установленную Стадию 2.",
                    price: 5000,
                    category: "ground",
                    requirements: ["Форсированный двигатель (Стадия 2)"]
                },
                {
                    name: "Усиление корпуса",
                    description: "Лёгкое бронирование корпуса, добавляющее транспорту 10 ОС.",
                    price: 1000,
                    category: "ground",
                    requirements: []
                },
                {
                    name: "ЭМ-платформа",
                    description: "Требует облегчённое шасси. Заменяет колесную платформу, на электромагнитную подушку, которая позволяет ездить по любой поверхности без штрафов и преодолевать любые препятствия до 3 метров высотой. Не давит на поверхность под собой, не оставляет следов, гудит со слышимостью на 10 метров.",
                    price: 5000,
                    category: "ground",
                    requirements: ["Облегчённое шасси"]
                },
                {
                    name: "Шагающая платформа",
                    description: "Заменяет платформу на 4 шагающие ноги. Транспорт теперь имеет 2 режима — колёсная и шагающая. Колесная не имеет никаких бонусов. При активации шагающей, транспорт поднимается на 2 метра над землёй на 4 острых \"ногах\". Такое шасси не может нормально перемещаться по зыбучим поверхностям (пустынные барханы, толстый снег), но может карабкаться по отвесным поверхностям с уклоном до 80°. Шагающую платформу невозможно сдвинуть с места при таране, т.к. она под своим весом укрепляется в земле/бетоне/асфальте и пр. Множественная установка не даёт никаких бонусов, кроме визуального увеличения количества ног.",
                    price: 5000,
                    category: "ground",
                    requirements: []
                },
                {
                    name: "Дополнительные сиденья",
                    description: "Машину пилят пополам и вставляют в неё кусок с сиденьями. Можно устанавливать не более 3х раз. Увеличивает количество мест в транспорте на 2. Создай свой лимузин.",
                    price: 500,
                    category: "ground",
                    requirements: []
                }
            ],
            "air": [
                {
                    name: "Активная защита",
                    description: "Система защиты летающего транспорта от приближающихся угроз, вроде ракет. Так как ИК-ловушки стали неэффективны, летящие ракеты теперь сбивают еще на подлёте. Радиус активной защиты воздушного транспорта не 5х5, как у наземного, а 10х10.",
                    price: 1500,
                    category: "air",
                    requirements: []
                },
                {
                    name: "БИО-горючее",
                    description: "Установка, которая использует не типичное топливо, а био-органику. Подходит любая органика и её продукты жизнедеятельности, но имеет очень большой расход. Например, если ты решишь справить нужду в бак, то это хватит буквально на 1 минуту. Мясорубка в комплекте.",
                    price: 1000,
                    category: "air",
                    requirements: []
                },
                {
                    name: "Подвесы или бомбовый отсек",
                    description: "Позволяет сбрасывать заранее установленные или размещенные в бомбовый отсек грузы. Вмещает до 6 гранат. Гранаты (или другой размещённый груз) всегда попадают в то пространство, над которым были сброшены.",
                    price: 500,
                    category: "air",
                    requirements: []
                },
                {
                    name: "Бортовой компьютер",
                    description: "Позволяет установить в транспорт ИИ, который будет управлять транспортом вместо пилота по заданному маршруту. ИИ не может участвовать в боях и совершать маневры, кроме взлёта и посадки. Он будет просто следовать заданному маршруту, несмотря ни на что. Ты можешь вызвать свой транспорт звонком ИИ через хронотом.",
                    price: 5000,
                    category: "air",
                    requirements: []
                },
                {
                    name: "Бронестёкла",
                    description: "Замена обычных стёкол на бронированные. Теперь они являются укрытиями с 20 ПЗ. Также все вешние турели имеют блистер из бронестёкол",
                    price: 500,
                    category: "air",
                    requirements: []
                },
                {
                    name: "Герметизация корпуса",
                    description: "Герметизирует корпус транспорта. Если транспорт не получил урон, он может перейти в состояние полной герметичности и не впускать внешнюю атмосферу внутрь. Позволяет подниматься на высоты, граничащие с космосом.",
                    price: 500,
                    category: "air",
                    requirements: []
                },
                {
                    name: "Контрабандное отделение",
                    description: "Потайной отсек, объемом 10х10, в котором можно провозить запрещённые вещи. Обнаружить контрабандный отсек можно только при осмотре транспорта специализированным облучающим оборудованием.",
                    price: 500,
                    category: "air",
                    requirements: []
                },
                {
                    name: "Крепление для тяжелого оружия",
                    description: "Крепление, которое позволяет установить оружие на открытое крепление снаружи транспорта. Это может быть как пулемёт, так и ракетомёт. Можно установить максимум 2 таких модификации, по 1 с каждой стороны транспорта. Стрельба из такого оружия не убирает штрафы на стрельбу из-за качки транспорта во время полёта.",
                    price: 2000,
                    category: "air",
                    requirements: []
                },
                {
                    name: "Курсовое вооружение",
                    description: "Позволяет установить 1 любое оружие, которое ведёт огонь по курсу езды транспорта. Управляет им пилот. Не водитель может перезарядить его, находясь внутри транспорта.",
                    price: 1000,
                    category: "air",
                    requirements: []
                },
                {
                    name: "Оптический камуфляж",
                    description: "Позволяет делать воздушный транспорт полностью незаметным на скоростях до 5 СКО (40 км/ч). Любой резкий манёвр или выстрел из транспорта снимает камуфляж на 30 секунд. Если транспорт был повреждён, во время активного оптического камуфляжа, он становится неактивным на 5 минут. Дождь, дым, случайно кинутый кирпич не демаскируют транспорт.",
                    price: 10000,
                    category: "air",
                    requirements: []
                },
                {
                    name: "Турельное вооружение",
                    description: "Крепление для любых двух (спаренных) оружий, которые крепятся снаружи транспорта и управляются вторым пилотом/бортстрелком. Одновременно можно стрелять только из 1 оружия за ход.",
                    price: 2500,
                    category: "air",
                    requirements: []
                },
                {
                    name: "Усиление корпуса",
                    description: "Лёгкое бронирование корпуса, добавляющее корпусу транспорта 10 ОС.",
                    price: 1000,
                    category: "air",
                    requirements: []
                },
                {
                    name: "Форсажная камера",
                    description: "Позволяет увеличить максимальное СКО транспорта на 5 раундов (15 секунд) в три раза от изначальных. Охлаждение и перезарядка форсажной камеры занимает 5 минут.",
                    price: 5000,
                    category: "air",
                    requirements: []
                }
            ],
            "water": [
                {
                    name: "Абордажные крюки",
                    description: "Стреляет гарпунами, которые притягивают вражескую лодку и позволяют вступить с ней в ближний бой. Дальность стрельбы и сложность, как у гранатомёта.",
                    price: 1000,
                    category: "water",
                    requirements: []
                },
                {
                    name: "Активная защита",
                    description: "Аналог носимой активной брони, но для транспорта. Имеет 10 магазинов с 10 зарядами. Можно перезарядить сидя в транспорте. В подводном положении микро-ракеты заменяются микро-торпедами.",
                    price: 1500,
                    category: "water",
                    requirements: []
                },
                {
                    name: "БИО-горючее",
                    description: "Установка, которая использует не типичное топливо, а био-органику. Подходит любая органика и её продукты жизнедеятельности, но имеет очень большой расход. Например, если вы решите справить нужду в бак, то этого хватит буквально на 1 минуту.",
                    price: 1000,
                    category: "water",
                    requirements: []
                },
                {
                    name: "Герметизация корпуса",
                    description: "Герметизирует корпус транспорта. Полностью герметизирует водный транспорт, предотвращая попадание внешней атмосферы внутрь, что превращает судно в подводную лодку. Максимальная глубина погружения 500 метров для любого водного транспорта, если это не изначально подводная лодка на усмотрение Мастера.",
                    price: 10000,
                    category: "water",
                    requirements: []
                },
                {
                    name: "Ракетный аппарат",
                    description: "Установка из 4 ракетомётов для ведения одновременной стрельбы из всех 2х труб. Требует стрелка. Максимум можно установить 2 таких штуки. В подводном положении ракеты используются, как торпеды.",
                    price: 15000,
                    category: "water",
                    requirements: []
                },
                {
                    name: "Бронестёкла",
                    description: "Замена обычных стёкол на бронированные. Теперь они являются укрытиями с 20 ПЗ.",
                    price: 500,
                    category: "water",
                    requirements: []
                },
                {
                    name: "Бронирование корпуса",
                    description: "Тяжелое бронирование корпуса, добавляющее транспорту 18 ОС.",
                    price: 2000,
                    category: "water",
                    requirements: []
                },
                {
                    name: "Бортовой компьютер",
                    description: "Позволяет установить в транспорт ИИ, который будет управлять транспортом вместо пилота по заданному маршруту. ИИ не может участвовать в боях и совершать маневры, кроме взлёта и посадки. Он будет просто следовать заданному маршруту, несмотря ни на что.",
                    price: 5000,
                    category: "water",
                    requirements: []
                },
                {
                    name: "Крепление для тяжелого оружия",
                    description: "Крепление, которое позволяет установить оружие в виде башенки со стрелком. Это может быть как пулемёт, так и ракетомёт. Можно установить максимум 1 такую модификацию. Нельзя устанавливать вместе с Ракетным аппаратом. Стрельба из такого оружия не убирает штрафы на стрельбу из-за качки транспорта во время движения по волнам.",
                    price: 2000,
                    category: "water",
                    requirements: []
                },
                {
                    name: "Эхолокатор",
                    description: "Позволяет \"видеть\" дно и всё, до него. Ты можешь обнаруживать лодки, китов, затонувшие корабли.",
                    price: 500,
                    category: "water",
                    requirements: []
                },
                {
                    name: "Преобразование в амфибию",
                    description: "Добавляет к лодке, яхте или любому другому водному транспорту колеса, на которых он может перемещаться по суше, имея 4 СКО (32 км/ч). Транспорт не становится наземным и не приобретает его модулей.",
                    price: 20000,
                    category: "water",
                    requirements: []
                }
            ]
        };

        // Глобальное состояние персонажа
        const state = {
            // Общая информация персонажа
            characterName: '',
            characterClass: '',
            characterLevel: 1,
            experiencePoints: 0,
            roleplayPoints: 0,
            avatar: '',
            
            // Основные характеристики (1-20)
            stats: {
                WILL: 5,    // Воля
                INT: 5,     // Ум
                DEX: 5,     // Ловкость
                BODY: 5,    // Телосложение
                REA: 5,     // Реакция
                TECH: 5,    // Техника
                CHA: 5      // Харизма
            },
            
            // Удача
            luck: {
                current: 1,  // Текущая удача
                max: 1       // Максимальная удача
            },
            
            // Производные характеристики
            awareness: {
                current: 50,      // Текущая осознанность
                max: 50          // Максимальная осознанность (УМ * 10)
            },
            reputation: 0,      // Репутация
            
            // Здоровье и ресурсы
            health: {
                current: 25,      // Текущее здоровье
                max: 25          // Максимальное здоровье
            },
            money: 1000,        // Деньги в уе
            
            // Аватар персонажа
            avatar: '',         // Фотография персонажа (Base64)
            
            // Критические травмы
            criticalInjuries: [],
            
            // Предыстория
            backstory: '',
            
            // Навыки
            skills: [],                    // Обычные навыки
            professionalSkills: [],        // Профессиональные навыки
            
            // Дека (кибердека)
            deck: {
                name: '',         // Название деки
                operative: '',    // Оперативка
                grid: '',         // Сетка
                memory: '',       // Память
                version: ''       // Версия
            },
            deckPrograms: [],   // Программы деки
            deckChips: [],      // Щепки памяти
            
            // Импланты (6 основных имплантов с частями и слотами)
            implants: {
                head: {
                    installed: false,
                    parts: {
                        main: null           // голова - не куплена
                    }
                },
                arms: {
                    installed: false,
                    parts: {
                        wristLeft: null,      // кисть левая - не куплено
                        wristRight: null,     // кисть правая - не куплено
                        forearmLeft: null,    // предплечье левое - не куплено
                        forearmRight: null,   // предплечье правое - не куплено
                        shoulderLeft: null,   // плечо левое - не куплено
                        shoulderRight: null   // плечо правое - не куплено
                    }
                },
                legs: {
                    installed: false,
                    parts: {
                        footLeft: null,      // стопа левая - не куплено
                        footRight: null,      // стопа правая - не куплено
                        shinLeft: null,       // голень левая - не куплено
                        shinRight: null,      // голень правая - не куплено
                        thighLeft: null,      // бедро левое - не куплено
                        thighRight: null      // бедро правое - не куплено
                    }
                },
                spine: {
                    installed: false,
                    parts: {
                        cervical: null,      // шейная - не куплено
                        thoracicLeft: null,   // грудная левая - не куплено
                        thoracicRight: null,  // грудная правая - не куплено
                        lumbar: null,        // поясничная - не куплено
                        sacral: null         // крестцовая - не куплено
                    }
                },
                organs: {
                    installed: false,
                    parts: {
                        main: null           // внутренние органы - не куплено
                    }
                },
                neuromodule: {
                    installed: false,
                    parts: {
                        main: null           // нейромодуль - не куплено
                    }
                }
            },
            
            // Установленные модули имплантов (для отображения на основном листе)
            installedModules: [],
            
            // Оружие
            weapons: [],
            
            // Боеприпасы
            ammo: [],
            
            // Броня (по зонам)
            armor: {
                head: { os: 0, type: 'Лёгкая', activeDefense: false, activeDefenseType: 'Микроракеты' },
                body: { os: 0, type: 'Лёгкая', activeDefense: false, activeDefenseType: 'Микроракеты' },
                arms: { os: 0, type: 'Лёгкая', activeDefense: false, activeDefenseType: 'Микроракеты' },
                legs: { os: 0, type: 'Лёгкая', activeDefense: false, activeDefenseType: 'Микроракеты' }
            },
            
            // Снаряжение
            gear: [],
            
            // Препараты
            drugs: [],
            
            // Нагрузка
            load: {
                current: 25,      // Текущая нагрузка (начинается с максимума)
                max: 25          // Максимальная нагрузка
            },
            
            // Собственность
            property: {
                housing: [],      // Жилье
                vehicles: [       // Транспорт
                    // Стартовый транспорт - Компактный Микромобиль
                    {
                        id: 'default-vehicle',
                        name: "Компактный Микромобиль",
                        description: "Обычный городской автомобиль для одинокого человека на обычном двигателе.",
                        hp: 50,
                        currentHp: 50,
                        seats: 1,
                        mechanicalSpeed: 20,
                        narrativeSpeed: "160 км/ч",
                        price: 15000,
                        category: "ground",
                        modules: [],
                        isDefault: true
                    }
                ]
            },
            
            // Лог бросков
            rollLog: [],
            
            // Графы предыстории
            backstoryGraphs: {
                born: { text: '', completed: false },
                grewUp: { text: '', completed: false },
                adolescence: { text: '', completed: false },
                loveStory: { text: '', completed: false },
                enmity: { text: '', completed: false },
                enmityBlame: { text: '', completed: false },
                revenge: { text: '', completed: false },
                whyHere: { text: '', completed: false },
                howMet: { text: '', completed: false },
                moneyAttitude: { text: '', completed: false },
                peopleAttitude: { text: '', completed: false },
                lastWeekEvent: { text: '', completed: false }
            },
            
            // Настройки интерфейса
            uiSettings: {
                compactSkills: false
            },
            
            // Размеры и порядок секций
            sectionSizes: {},
            layoutOrder: []
        };

        // Функции сохранения и загрузки
        function saveState() {
            try {
                localStorage.setItem('ezyCyberCharacter', JSON.stringify(state));
            } catch (error) {
                console.error('Ошибка сохранения:', error);
            }
        }

        function loadState() {
            try {
                const saved = localStorage.getItem('ezyCyberCharacter');
                if (saved) {
                    const loadedState = JSON.parse(saved);
                    
                    // Глубокое слияние: сохраняем avatar отдельно
                    const avatarBackup = loadedState.avatar;
                    Object.assign(state, loadedState);
                    
                    // Принудительно восстанавливаем avatar
                    if (avatarBackup) {
                        state.avatar = avatarBackup;
                        console.log('Avatar loaded from localStorage:', avatarBackup.substring(0, 50) + '...');
                    } else {
                        console.log('No avatar found in localStorage');
                    }
                }
                updateUIFromState();
                
                // Загружаем профессиональные навыки и заметки
                loadProfessionalSkills();
                loadNotes();
            } catch (error) {
                console.error('Ошибка загрузки:', error);
            }
        }

        function updateUIFromState() {
            // Обновляем все поля из state
            const characterName = document.getElementById('characterName');
            const experiencePoints = document.getElementById('experiencePoints');
            const roleplayPoints = document.getElementById('roleplayPoints');
            const awareness = document.getElementById('awareness');
            const reputationSlider = document.getElementById('reputationSlider');
            const reputationValue = document.getElementById('reputationValue');
            
            if (characterName) characterName.value = state.characterName || '';
            if (experiencePoints) experiencePoints.value = state.experiencePoints || 0;
            if (roleplayPoints) roleplayPoints.value = state.roleplayPoints || 0;
            if (reputationSlider) reputationSlider.value = state.reputation || 0;
            if (reputationValue) reputationValue.textContent = state.reputation || 0;
            
            // Обновляем осознанность
            const awarenessCurrent = document.getElementById('awarenessCurrent');
            const awarenessMax = document.getElementById('awarenessMax');
            if (awarenessCurrent) awarenessCurrent.value = state.awareness.current || 50;
            if (awarenessMax) awarenessMax.value = state.awareness.max || 50;
            
            // Обновляем характеристики
            const statWILL = document.getElementById('statWILL');
            const statINT = document.getElementById('statINT');
            const statDEX = document.getElementById('statDEX');
            const statBODY = document.getElementById('statBODY');
            const statREA = document.getElementById('statREA');
            const statTECH = document.getElementById('statTECH');
            const statCHA = document.getElementById('statCHA');
            
            if (statWILL) statWILL.value = state.stats.WILL || 5;
            if (statINT) statINT.value = state.stats.INT || 5;
            if (statDEX) statDEX.value = state.stats.DEX || 5;
            if (statBODY) statBODY.value = state.stats.BODY || 5;
            if (statREA) statREA.value = state.stats.REA || 5;
            if (statTECH) statTECH.value = state.stats.TECH || 5;
            if (statCHA) statCHA.value = state.stats.CHA || 5;
            
            // Обновляем удачу
            const luckCurrent = document.getElementById('luckCurrent');
            const luckMax = document.getElementById('luckMax');
            if (luckCurrent) luckCurrent.value = state.luck.current || 1;
            if (luckMax) luckMax.value = state.luck.max || 1;
            
            // Обновляем здоровье
            const healthCurrent = document.getElementById('healthCurrent');
            const healthMax = document.getElementById('healthMax');
            if (healthCurrent) healthCurrent.value = state.health.current || 25;
            if (healthMax) healthMax.value = state.health.max || 38;
            
            // Обновляем деку
            const deckName = document.getElementById('deckName');
            const deckOperative = document.getElementById('deckOperative');
            const deckGrid = document.getElementById('deckGrid');
            const deckMemory = document.getElementById('deckMemory');
            const deckVersion = document.getElementById('deckVersion');
            
            if (deckName) deckName.value = state.deck.name || '';
            if (deckOperative) deckOperative.value = state.deck.operative || '';
            if (deckGrid) deckGrid.value = state.deck.grid || '';
            if (deckMemory) deckMemory.value = state.deck.memory || '';
            if (deckVersion) deckVersion.value = state.deck.version || '';
            
            // Обновляем предысторию
            const backstoryText = document.getElementById('backstoryText');
            if (backstoryText) backstoryText.value = state.backstory || '';
            
            // Обновляем броню
            const armorHeadOS = document.getElementById('armorHeadOS');
            const armorHeadType = document.getElementById('armorHeadType');
            const armorBodyOS = document.getElementById('armorBodyOS');
            const armorBodyType = document.getElementById('armorBodyType');
            const armorArmsOS = document.getElementById('armorArmsOS');
            const armorArmsType = document.getElementById('armorArmsType');
            const armorLegsOS = document.getElementById('armorLegsOS');
            const armorLegsType = document.getElementById('armorLegsType');
            
            if (armorHeadOS) armorHeadOS.value = state.armor.head.os || 0;
            if (armorHeadType) armorHeadType.value = state.armor.head.type || 'Лёгкая';
            if (armorBodyOS) armorBodyOS.value = state.armor.body.os || 0;
            if (armorBodyType) armorBodyType.value = state.armor.body.type || 'Лёгкая';
            if (armorArmsOS) armorArmsOS.value = state.armor.arms.os || 0;
            if (armorArmsType) armorArmsType.value = state.armor.arms.type || 'Лёгкая';
            if (armorLegsOS) armorLegsOS.value = state.armor.legs.os || 0;
            if (armorLegsType) armorLegsType.value = state.armor.legs.type || 'Лёгкая';
            
            // Обновляем штраф от брони
            updateArmorPenalty();
            
            // Обновляем критические травмы
            renderInjuries();
        }

        // Автосохранение с debounce
        let saveTimeout;
        function scheduleSave() {
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(saveState, 300);
        }

        // Экспорт и импорт данных
        function exportData() {
            const dataStr = JSON.stringify(state, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `ezy-cyber-character-${Date.now()}.json`;
            link.click();
            URL.revokeObjectURL(url);
        }

        function importData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const importedState = JSON.parse(e.target.result);
                            Object.assign(state, importedState);
                            saveState();
                            location.reload();
                        } catch (error) {
                            alert('Ошибка при импорте файла');
                        }
                    };
                    reader.readAsText(file);
                }
            };
            input.click();
        }

        function clearAllData() {
            if (confirm('Вы уверены, что хотите очистить все данные?')) {
                localStorage.removeItem('ezyCyberCharacter');
                location.reload();
            }
        }

        // Функции управления секциями
        function collapseAllSections() {
            const sections = document.querySelectorAll('.section:not(.full-width-section)');
            sections.forEach(section => {
                const content = section.querySelector('.section-content');
                
                if (content && content.classList.contains('expanded')) {
                    content.classList.remove('expanded');
                    content.style.display = 'none';
                }
            });
        }

        function expandSection(section) {
            const content = section.querySelector('.section-content');
            if (content) {
                content.classList.add('expanded');
                content.style.display = 'block';
            }
        }

        function toggleSection(sectionId) {
            const section = document.getElementById(sectionId);
            if (!section) return;
            
            const content = section.querySelector('.section-content');
            if (!content) return;
            
            if (content.classList.contains('expanded')) {
                content.classList.remove('expanded');
                content.style.display = 'none';
            } else {
                content.classList.add('expanded');
                content.style.display = 'block';
            }
        }

        // Загрузочный экран с синхронизацией текста и прогресса
        function initLoadingScreen() {
            const progressBar = document.getElementById('progressBar');
            const progressText = document.getElementById('progressText');
            const loadingScreen = document.getElementById('loadingScreen');
            const mainInterface = document.getElementById('mainInterface');
            let currentProgress = 0;
            let currentItem = 0;
            let typingInProgress = false;
            
            const logMessages = [
                '[SYS] Инициализация системы управления персонажем... OK',
                '[MEM] Выделение памяти для данных персонажа... OK',
                '[SEC] Проверка целостности протоколов безопасности... OK',
                '[NET] Подключение к базе данных навыков... OK',
                '[GFX] Инициализация графического интерфейса... OK',
                '[UX] Подготовка пользовательского интерфейса... OK'
            ];
            
            function typeText(element, text, callback) {
                element.classList.add('typing');
                typingInProgress = true;
                let index = 0;
                
                const typeInterval = setInterval(() => {
                    if (index < text.length) {
                        element.textContent = text.substring(0, index + 1);
                        index++;
                    } else {
                        clearInterval(typeInterval);
                        element.classList.remove('typing');
                        typingInProgress = false;
                        if (callback) callback();
                    }
                }, 5); // Очень быстрая печать для гарантии успеть
            }
            
            function updateProgressBar() {
                // Получаем реальный прогресс загрузки
                let realProgress = 0;
                
                if (document.readyState === 'loading') {
                    realProgress = 20;
                } else if (document.readyState === 'interactive') {
                    realProgress = 60;
                } else if (document.readyState === 'complete') {
                    realProgress = 100;
                }
                
                // Плавно движемся к реальному прогрессу
                if (currentProgress < realProgress) {
                    currentProgress = Math.min(currentProgress + 1, realProgress);
                }
                
                progressBar.style.width = currentProgress + '%';
                progressText.textContent = Math.round(currentProgress) + '%';
                
                // Рассчитываем какая строка должна быть напечатана при текущем прогрессе
                const targetLine = Math.floor((currentProgress / 95) * logMessages.length);
                
                // Если нужно напечатать новую строку и не идет печать
                if (targetLine > currentItem && currentItem < logMessages.length && !typingInProgress) {
                    const item = document.getElementById(`logItem${currentItem + 1}`);
                    if (item && item.textContent === '') {
                        const currentIdx = currentItem;
                        typeText(item, logMessages[currentIdx], () => {
                            currentItem = currentIdx + 1;
                        });
                    }
                }
                
                return currentProgress;
            }
            
            // Обновляем прогресс каждые 20мс для более частой проверки
            const progressInterval = setInterval(() => {
                const progress = updateProgressBar();
                
                // Если достигли 95% - форсируем печать оставшихся строк
                if (progress >= 95 && currentItem < logMessages.length) {
                    for (let i = currentItem; i < logMessages.length; i++) {
                        const item = document.getElementById(`logItem${i + 1}`);
                        if (item && item.textContent === '') {
                            item.textContent = logMessages[i];
                            item.classList.remove('typing');
                        }
                    }
                    currentItem = logMessages.length;
                }
                
                if (progress >= 100) {
                    clearInterval(progressInterval);
                    // Дополнительная секунда перед открытием
                    setTimeout(() => {
                        loadingScreen.classList.add('hidden');
                        mainInterface.classList.add('loaded');
                        loadState();
                        initAvatarUpload();
                        updateUIFromState();
                        renderRollLog();
                        updateMoneyDisplay();
                        calculateAndUpdateHealth();
                        updateDerivedStats();
                        renderSkills();
                        renderProfessionalSkills();
                        renderCriticalInjuries();
                        renderDeckPrograms();
                        renderDeckChips();
                        renderImplants();
                        renderWeapons();
                        renderAmmo();
                        renderHousing();
                        renderVehicles();
                        renderGear();
                    }, 1000); // +1 секунда после 100%
                }
            }, 20); // Чаще обновляем для лучшей синхронизации
        }

        // Математические расчеты
        function calculateDerivedStats() {
            const body = parseInt(state.stats.BODY) || 0;
            const dex = parseInt(state.stats.DEX) || 0;
            
            // Врождённая ОС = Телосложение / 3, округление вверх
            const armor = Math.ceil(body / 3);
            
            // Скорость перемещения = ЛВК
            const speed = dex;
            
            // Скорость атаки = ЛВК / 3 с округлением в большую сторону
            const attackSpeed = Math.ceil(dex / 3);
            
            // Максимальная нагрузка = ТЕЛО * Атлетика (минимум 25, максимум 100)
            const athletics = state.skills.find(s => s.name === 'Атлетика')?.level || 0;
            const maxLoad = Math.min(100, Math.max(25, body * athletics));
            
            return { armor, speed, attackSpeed, maxLoad };
        }

        function calculateAndUpdateHealth() {
            const will = Number(state.stats.WILL || 0);
            const body = Number(state.stats.BODY || 0);
            const maxHp = Math.ceil(((will + 10) * body) / 2);
            state.health.max = maxHp;
            
            // Проверяем, не превышает ли текущее здоровье максимум
            let current = Number(state.health.current || 0);
            if (current > maxHp) current = maxHp;
            state.health.current = current;
            
            // Обновляем отображение
            const maxEl = document.getElementById('healthMax');
            const curEl = document.getElementById('healthCurrent');
            if (maxEl) maxEl.value = maxHp;
            if (curEl) curEl.value = current;
        }

        function updateDerivedStats() {
            const derived = calculateDerivedStats();
            
            // Обновляем все производные характеристики
            const derivedArmorEl = document.getElementById('derivedArmor');
            const derivedSpeedEl = document.getElementById('derivedSpeed');
            const derivedAttackSpeedEl = document.getElementById('derivedAttackSpeed');
            const maxLoadEl = document.getElementById('maxLoad');
            
            if (derivedArmorEl) derivedArmorEl.textContent = derived.armor;
            if (derivedSpeedEl) derivedSpeedEl.textContent = derived.speed;
            if (derivedAttackSpeedEl) derivedAttackSpeedEl.textContent = derived.attackSpeed;
            if (maxLoadEl) maxLoadEl.textContent = derived.maxLoad;
            
            state.load.max = derived.maxLoad;
            updateLoadDisplay();
        }

        function updateAwarenessMax() {
            const int = Number(state.stats.INT || 5);
            const newMax = int * 10;
            
            // Обновляем максимальную осознанность
            state.awareness.max = newMax;
            
            // Проверяем, не превышает ли текущая осознанность максимум
            let current = Number(state.awareness.current || 50);
            if (current > newMax) current = newMax;
            state.awareness.current = current;
            
            // Обновляем отображение
            const maxEl = document.getElementById('awarenessMax');
            const curEl = document.getElementById('awarenessCurrent');
            if (maxEl) maxEl.value = newMax;
            if (curEl) curEl.value = current;
        }

        function updateLoadWarning() {
            const currentLoad = state.load.current;
            const maxLoad = state.load.max;
            
            const warningEl = document.getElementById('loadWarning');
            if (warningEl) {
                if (currentLoad > maxLoad) {
                    const excess = currentLoad - maxLoad;
                    const penalty = Math.ceil(excess / 5);
                    warningEl.textContent = `Штраф ${penalty} от нагрузки!`;
                    warningEl.style.color = 'var(--danger)';
                } else {
                    warningEl.textContent = `Нагрузка: ${currentLoad}/${maxLoad}`;
                    warningEl.style.color = 'var(--text)';
                }
            }
        }

        // Система бросков кубиков
        function rollDice(count, sides) {
            const rolls = [];
            for (let i = 0; i < count; i++) {
                rolls.push(Math.floor(Math.random() * sides) + 1);
            }
            return rolls;
        }

        function rollSkillCheck(skillIndex) {
            const index = typeof skillIndex === 'string' ? parseInt(skillIndex) : skillIndex;
            const skillData = state.skills[index];
            if (!skillData) return;
            
            const selectedStat = document.getElementById('skillCheckStat').value;
            const modifier = parseInt(document.getElementById('skillCheckModifier').value) || 0;
            const statValue = state.stats[selectedStat] || 5;
            const skillLevel = skillData.level || 0;
            const skillName = skillData.customName || skillData.name;
            
            // Бросаем 2d6
            const dice = rollDice(2, 6);
            let total = statValue + skillLevel + modifier + dice[0] + dice[1];
            let criticalText = '';
            let d4Value = null;
            let d4Type = null; // 'penalty' или 'bonus'
            
            // Специальные правила:
            if (dice[0] === 1 && dice[1] === 1) {
                criticalText = 'ЭКСТРЕМАЛЬНЫЙ ПРОВАЛ!';
                total = 'ПРОВАЛ';
            } else if (dice[0] === 6 && dice[1] === 6) {
                criticalText = 'ЭКСТРЕМАЛЬНЫЙ УСПЕХ!';
                total = 'УСПЕХ';
            } else if (dice.includes(1) && dice.includes(6)) {
                // 1 и 6 одновременно - ничего не происходит
            } else if (dice[0] === 1 || dice[1] === 1) {
                // Есть единица на одном из D6 - вычитаем 1d4
                d4Value = rollDice(1, 4)[0];
                d4Type = 'penalty';
                total -= d4Value;
            } else if (dice[0] === 6 || dice[1] === 6) {
                // Есть шестерка на одном из D6 - добавляем 1d4
                d4Value = rollDice(1, 4)[0];
                d4Type = 'bonus';
                total += d4Value;
            }
            
            const formula = `${statValue}+${skillLevel}+${modifier}+${dice[0]}+${dice[1]}${d4Value ? (d4Type === 'penalty' ? '-' + d4Value : '+' + d4Value) : ''} = ${total}`;
            
            // Анимация броска
            showDiceAnimation(dice, total, criticalText, formula, skillName, d4Value, d4Type);
            
            // Добавляем в лог
            addToRollLog('skill', {
                skill: skillName,
                formula: formula,
                total: total,
                critical: criticalText
            });
        }

        function rollUniversalDice() {
            const count = parseInt(document.getElementById('diceCount')?.value) || 1;
            const sides = parseInt(document.getElementById('diceSides')?.value) || 6;
            const modifier = parseInt(document.getElementById('diceModifier')?.value) || 0;
            
            const dice = rollDice(count, sides);
            const total = dice.reduce((sum, roll) => sum + roll, 0) + modifier;
            
            // Добавляем в лог
            addToRollLog('universal', {
                count: count,
                sides: sides,
                modifier: modifier,
                dice: dice,
                total: total
            });
            
            // Показываем результат
            showUniversalResult(dice, total, modifier);
        }

        // Новая система лога бросков
        function addToRollLog(type, data) {
            const entry = {
                type: type,
                timestamp: new Date().toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit', second: '2-digit' }),
                ...data
            };
            
            state.rollLog.push(entry);
            
            // Ограничиваем лог 100 записями
            if (state.rollLog.length > 100) {
                state.rollLog = state.rollLog.slice(-100);
            }
            
            scheduleSave();
            renderRollLog();
        }

        function renderRollLog() {
            const logContainer = document.getElementById('rollLogContainer');
            if (!logContainer) return;
            
            if (state.rollLog.length === 0) {
                logContainer.innerHTML = '<div style="color: var(--muted); text-align: center; padding: 2rem; font-size: 0.9rem;">Лог бросков пуст</div>';
                return;
            }
            
            // Формируем HTML для каждой записи
            const logsHTML = state.rollLog.map(entry => {
                let text = '';
                
                switch(entry.type) {
                    case 'skill':
                        text = `<strong>${entry.skill}</strong>: ${entry.formula} = <strong>${entry.total}</strong>${entry.critical ? ` <span style="color: var(--danger);">${entry.critical}</span>` : ''}`;
                        break;
                    
                    case 'weapon_damage':
                        text = `<strong>${entry.weaponName}</strong>: ${entry.formula} = <strong>${entry.total}</strong>${entry.ammoType ? ` (${entry.ammoType})` : ''}${entry.fireMode ? ` [${entry.fireMode}]` : ''}${entry.isCritical ? ' <span style="color: var(--danger); font-weight: 600;">КРИТИЧЕСКАЯ ТРАВМА!</span>' : ''}`;
                        break;
                    
                    case 'universal':
                        text = `<strong>${entry.count}d${entry.sides}</strong>${entry.modifier !== 0 ? `+${entry.modifier}` : ''}: ${entry.dice.join(', ')} = <strong>${entry.total}</strong>`;
                        break;
                    
                    default:
                        text = entry.text || JSON.stringify(entry);
                }
                
                return `
                    <div style="padding: 0.4rem 0.75rem; border-bottom: 1px solid rgba(182, 103, 255, 0.05); font-size: 0.85rem; line-height: 1.4;">
                        <span style="color: var(--muted); font-family: monospace; font-size: 0.75rem; margin-right: 0.5rem;">${entry.timestamp}</span>
                        <span style="color: var(--text);">${text}</span>
                    </div>
                `;
            }).join('');
            
            logContainer.innerHTML = logsHTML;
            
            // Прокручиваем к последней записи
            setTimeout(() => {
                logContainer.scrollTop = logContainer.scrollHeight;
            }, 10);
        }

        function showDiceAnimation(dice, total, criticalText, formula, skillName, d4Value, d4Type) {
            const diceAnimation = document.getElementById('skillCheckDiceAnimation');
            const dice1 = document.getElementById('skillCheckDice1');
            const dice2 = document.getElementById('skillCheckDice2');
            const d4Left = document.getElementById('skillCheckD4Left');
            const d4Right = document.getElementById('skillCheckD4Right');
            const result = document.getElementById('skillCheckResult');
            const critical = document.getElementById('skillCheckCritical');
            const formulaDiv = document.getElementById('skillCheckFormula');
            
            if (diceAnimation) diceAnimation.style.display = 'flex';
            if (result) {
                result.textContent = 'Рассчитываем';
                result.classList.add('loading-dots');
            }
            
            // Скрываем формулу сначала
            if (formulaDiv) {
                formulaDiv.style.display = 'none';
            }
            
            // Скрываем d4 сначала
            if (d4Left) {
                d4Left.style.display = 'none';
                d4Left.classList.remove('rolling');
            }
            if (d4Right) {
                d4Right.style.display = 'none';
                d4Right.classList.remove('rolling');
            }
            
            // Основная анимация d6 - 1.2 секунды
            const mainDuration = 1200;
            const interval = 80;
            const mainIterations = Math.ceil(mainDuration / interval);
            let step = 0;
            
            const mainAnimation = setInterval(() => {
                if (dice1) dice1.textContent = Math.floor(Math.random() * 6) + 1;
                if (dice2) dice2.textContent = Math.floor(Math.random() * 6) + 1;
                
                step++;
                
                if (step >= mainIterations) {
                    clearInterval(mainAnimation);
                    
                    // Показываем финальные значения d6
                    if (dice1) {
                        dice1.textContent = dice[0];
                        dice1.classList.remove('rolling');
                    }
                    if (dice2) {
                        dice2.textContent = dice[1];
                        dice2.classList.remove('rolling');
                    }
                    
                    // Запускаем анимацию d4 ПОСЛЕ основного броска
                    if (d4Value && d4Type) {
                        animateD4(d4Value, d4Type, d4Left, d4Right, () => {
                            // Показываем результат после анимации d4
                            showFinalResult();
                        });
                    } else {
                        // Если нет d4, сразу показываем результат
                        showFinalResult();
                    }
                }
            }, interval);
            
            function animateD4(d4Value, d4Type, d4Left, d4Right, callback) {
                const d4El = d4Type === 'penalty' ? d4Left : d4Right;
                if (!d4El) {
                    callback();
                    return;
                }
                
                // Показываем и начинаем анимацию d4
                d4El.style.display = 'flex';
                d4El.classList.add('rolling');
                
                const d4Duration = 500; // 0.5 секунды для d4
                const d4Iterations = Math.ceil(d4Duration / interval);
                let d4Step = 0;
                
                const d4Animation = setInterval(() => {
                    d4El.textContent = Math.floor(Math.random() * 4) + 1;
                    d4Step++;
                    
                    if (d4Step >= d4Iterations) {
                        clearInterval(d4Animation);
                        d4El.textContent = d4Value;
                        d4El.classList.remove('rolling');
                        callback();
                    }
                }, interval);
            }
            
            function showFinalResult() {
                // Показываем формулу
                if (formulaDiv && formula) {
                    formulaDiv.textContent = formula;
                    formulaDiv.style.display = 'block';
                }
                
                if (result) {
                    result.classList.remove('loading-dots');
                    result.textContent = total;
                }
                if (criticalText && critical) {
                    critical.textContent = criticalText;
                    critical.style.display = 'block';
                    critical.style.color = criticalText.includes('ПРОВАЛ') ? 'var(--danger)' : '#7bd7ff';
                    critical.style.fontSize = '1.5rem';
                    critical.style.fontWeight = 'bold';
                    critical.style.marginTop = '1rem';
                    critical.style.textAlign = 'center';
                }
            }
        }

        function showSkillCheckModal(skillIndex) {
            const index = typeof skillIndex === 'string' ? parseInt(skillIndex) : skillIndex;
            const skillData = state.skills[index];
            if (!skillData) return;
            
            const skillName = skillData.customName || skillData.name;
            const skillStat = skillData.stat;
            const skillLevel = skillData.level || 0;
            const statValue = state.stats[skillStat] || 5;
            
            // Маппинг английских названий характеристик на русские
            const statNames = {
                'WILL': 'Воля',
                'INT': 'Ум',
                'DEX': 'Ловкость',
                'BODY': 'Телосложение',
                'REA': 'Реакция',
                'TECH': 'Техника',
                'CHA': 'Харизма'
            };
            
            const statName = statNames[skillStat] || skillStat;
            
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            const existingModals = document.querySelectorAll('.modal-overlay');
            modal.style.zIndex = 1000 + (existingModals.length * 100);
            modal.innerHTML = `
                <div class="modal" style="max-width: 500px;">
                    <div class="modal-header">
                        <h3>Проверка навыка: ${skillName}</h3>
                        <button class="icon-button" onclick="closeModal(this)">×</button>
                    </div>
                    <div class="modal-body">
                        <div style="margin-bottom: 1rem;">
                            <p style="margin-bottom: 0.75rem;"><strong>${skillName}</strong></p>
                            <p style="color: var(--muted); font-size: 0.9rem; margin-bottom: 1rem;">
                                Характеристика: <strong style="color: var(--accent);">${statName}</strong> (${statValue}) | 
                                Навык: <strong style="color: var(--success);">${skillLevel}</strong>
                            </p>
                        </div>
                        
                        <div style="display: grid; gap: 0.75rem; margin-bottom: 1.5rem;">
                            <label class="field">
                                Характеристика
                                <select id="skillCheckStat" style="width: 100%;">
                                    <option value="WILL" ${skillStat === 'WILL' ? 'selected' : ''}>Воля (${state.stats.WILL || 0})</option>
                                    <option value="INT" ${skillStat === 'INT' ? 'selected' : ''}>Ум (${state.stats.INT || 0})</option>
                                    <option value="DEX" ${skillStat === 'DEX' ? 'selected' : ''}>Ловкость (${state.stats.DEX || 0})</option>
                                    <option value="BODY" ${skillStat === 'BODY' ? 'selected' : ''}>Телосложение (${state.stats.BODY || 0})</option>
                                    <option value="REA" ${skillStat === 'REA' ? 'selected' : ''}>Реакция (${state.stats.REA || 0})</option>
                                    <option value="TECH" ${skillStat === 'TECH' ? 'selected' : ''}>Техника (${state.stats.TECH || 0})</option>
                                    <option value="CHA" ${skillStat === 'CHA' ? 'selected' : ''}>Харизма (${state.stats.CHA || 0})</option>
                                </select>
                            </label>
                            
                            <label class="field">
                                Модификатор
                                <input type="number" id="skillCheckModifier" value="0" placeholder="Например: +2 или -1" />
                            </label>
                        </div>
                        
                        <div id="skillCheckDiceAnimation" style="display: none; flex-direction: column; align-items: center; gap: 1rem;">
                            <div style="display: flex; gap: 0.75rem; align-items: center;">
                                <div id="skillCheckD4Left" class="d4-triangle d4-penalty" style="display: none;">?</div>
                                <div id="skillCheckDice1" class="dice rolling" style="animation: roll 1.5s ease-in-out;">?</div>
                                <div id="skillCheckDice2" class="dice rolling" style="animation: roll 1.5s ease-in-out;">?</div>
                                <div id="skillCheckD4Right" class="d4-triangle d4-bonus" style="display: none;">?</div>
                            </div>
                            <div id="skillCheckFormula" style="color: var(--muted); font-size: 0.9rem; text-align: center; margin-top: 0.5rem; display: none;"></div>
                            <div id="skillCheckResult" class="dice-result loading-dots">Рассчитываем</div>
                            <div id="skillCheckCritical" class="dice-special" style="display: none;"></div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="pill-button primary-button" onclick="rollSkillCheck(${index})">
                            🎲 Бросить кубики
                        </button>
                        <button class="pill-button" onclick="closeModal(this)">
                            Отмена
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closeModal(modal.querySelector('.icon-button'));
                }
            });
        }

        function closeModal(button) {
            // Находим ближайший modal-overlay к кнопке
            const modal = button ? button.closest('.modal-overlay') : null;
            if (modal) {
                modal.remove();
            }
        }

        function showModal(title, content) {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            
            // Увеличиваем z-index для каждого нового модала
            const existingModals = document.querySelectorAll('.modal-overlay');
            const baseZIndex = 1000;
            modal.style.zIndex = baseZIndex + (existingModals.length * 100);
            
            modal.innerHTML = `
                <div class="modal" style="max-width: 500px;">
                    <div class="modal-header">
                        <h3>${title}</h3>
                        <button class="icon-button" onclick="closeModal(this)">×</button>
                    </div>
                    <div class="modal-body">
                        ${content}
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closeModal(modal.querySelector('.icon-button'));
                }
            });
        }

        // Функции для работы с деньгами
        function updateMoneyDisplay() {
            const moneyEl = document.getElementById('money');
            if (moneyEl) {
                moneyEl.value = formatMoney(state.money);
            }
        }

        // Функция для обновления цвета репутации (цифра всегда белая)
        function updateReputationColor() {
            const reputationValue = document.getElementById('reputationValue');
            if (!reputationValue) return;
            
            // Цифра всегда остается белой
            reputationValue.style.color = 'white';
        }

        function formatMoney(value) {
            const num = parseInt(String(value).replace(/\s+/g, '').replace(/[^0-9]/g, '')) || 0;
            return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ' ');
        }

        // Функции для генерации ID
        function generateId(prefix) {
            return prefix + '_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        // Функции управления секциями
        function toggleSection(sectionId) {
            const section = document.getElementById(sectionId);
            if (!section) return;
            
            const content = section.querySelector('.section-content');
            const button = section.querySelector('.pill-button');
            const collapsedSections = document.getElementById('collapsedSections');
            
            if (content.classList.contains('expanded')) {
                // Сворачиваем
                content.classList.remove('expanded');
                content.style.display = 'none';
                button.textContent = 'Развернуть';
                
                // Добавляем в свернутые
                const collapsedDiv = document.createElement('div');
                collapsedDiv.className = 'collapsed-section';
                collapsedDiv.innerHTML = `<div class="collapsed-title">${section.querySelector('.section-title').textContent}</div>`;
                collapsedDiv.onclick = () => expandSection(sectionId);
                collapsedSections.appendChild(collapsedDiv);
            } else {
                // Разворачиваем
                expandSection(sectionId);
            }
        }

        function expandSection(sectionId) {
            const section = document.getElementById(sectionId);
            if (!section) return;
            
            const content = section.querySelector('.section-content');
            const button = section.querySelector('.pill-button');
            const collapsedSections = document.getElementById('collapsedSections');
            
            content.classList.add('expanded');
            content.style.display = 'block';
            button.textContent = 'Свернуть';
            
            // Удаляем из свернутых
            const collapsedItems = collapsedSections.querySelectorAll('.collapsed-section');
            collapsedItems.forEach(item => {
                if (item.textContent.includes(section.querySelector('.section-title').textContent)) {
                    item.remove();
                }
            });
        }

        function clearRollLog() {
            if (confirm('Вы уверены, что хотите очистить лог бросков?')) {
                state.rollLog = [];
                renderRollLog();
                scheduleSave();
            }
        }

        // Универсальная бросалка
        function showUniversalDiceModal() {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            const existingModals = document.querySelectorAll('.modal-overlay');
            modal.style.zIndex = 1000 + (existingModals.length * 100);
            modal.innerHTML = `
                <div class="modal" style="max-width: 600px;">
                    <div class="modal-header">
                        <h3>🎲 Универсальная бросалка</h3>
                        <button class="icon-button" onclick="closeModal(this)">×</button>
                    </div>
                    <div class="modal-body">
                        <div style="display: flex; gap: 1rem; align-items: end;">
                            <div class="input-group" style="flex: 1;">
                                <label class="input-label">Количество кубиков</label>
                                <input type="number" class="input-field" id="universalDiceCount" value="5" min="1" max="20">
                            </div>
                            <div class="input-group" style="flex: 1;">
                                <label class="input-label">Тип кубика</label>
                                <select class="input-field" id="universalDiceSides">
                                    <option value="4">d4</option>
                                    <option value="6" selected>d6</option>
                                    <option value="8">d8</option>
                                    <option value="10">d10</option>
                                    <option value="12">d12</option>
                                    <option value="20">d20</option>
                                    <option value="100">d100</option>
                                </select>
                            </div>
                            <div class="input-group" style="flex: 1;">
                                <label class="input-label">Модификатор</label>
                                <input type="number" class="input-field" id="universalDiceModifier" value="0" placeholder="Например: +2">
                            </div>
                        </div>
                        
                        <div id="universalDiceAnimation" style="display: none; margin-top: 2rem;">
                            <div style="text-align: center; margin-bottom: 1.5rem;">
                                <h4 style="color: var(--accent); margin-bottom: 1rem;">СВОБОДНЫЙ БРОСОК 5D6</h4>
                                <div id="universalDiceDisplay" style="display: flex; justify-content: center; gap: 0.75rem; flex-wrap: wrap; margin-bottom: 1.5rem;">
                                    <!-- Кубики будут добавлены динамически -->
                                </div>
                            </div>
                            
                            <div style="background: rgba(0,0,0,0.3); border: 1px solid var(--border); border-radius: 12px; padding: 1.5rem; text-align: center;">
                                <div id="universalDiceTotal" style="font-size: 2rem; font-weight: bold; color: var(--text); margin-bottom: 0.5rem;">Σ 0</div>
                                <div id="universalDiceFormula" style="font-size: 1rem; color: var(--muted);">Бросков: 0</div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="pill-button primary-button" onclick="rollUniversalDice()" id="universalRollButton">
                            🎲 Бросить!
                        </button>
                        <button class="pill-button" onclick="closeModal(this)">
                            Закрыть
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closeModal(modal.querySelector('.icon-button'));
                }
            });
        }

        function rollUniversalDice() {
            const count = parseInt(document.getElementById('universalDiceCount').value) || 1;
            const sides = parseInt(document.getElementById('universalDiceSides').value) || 6;
            const modifier = parseInt(document.getElementById('universalDiceModifier').value) || 0;
            
            const animationDiv = document.getElementById('universalDiceAnimation');
            const diceDisplay = document.getElementById('universalDiceDisplay');
            const totalDiv = document.getElementById('universalDiceTotal');
            const formulaDiv = document.getElementById('universalDiceFormula');
            const rollButton = document.getElementById('universalRollButton');
            
            if (!animationDiv || !diceDisplay) return;
            
            // Показываем секцию анимации
            animationDiv.style.display = 'block';
            if (rollButton) rollButton.disabled = true;
            
            // Обновляем заголовок
            const header = animationDiv.querySelector('h4');
            if (header) header.textContent = `СВОБОДНЫЙ БРОСОК ${count}D${sides}`;
            
            // Создаем кубики
            diceDisplay.innerHTML = '';
            const diceElements = [];
            for (let i = 0; i < count; i++) {
                const wrapper = document.createElement('div');
                wrapper.style.display = 'flex';
                wrapper.style.flexDirection = 'column';
                wrapper.style.alignItems = 'center';
                wrapper.style.gap = '0.5rem';
                
                const diceEl = document.createElement('div');
                diceEl.className = 'dice rolling';
                diceEl.style.width = '60px';
                diceEl.style.height = '60px';
                diceEl.style.fontSize = '1.5rem';
                diceEl.textContent = '?';
                
                const label = document.createElement('div');
                label.style.color = 'var(--muted)';
                label.style.fontSize = '0.8rem';
                label.textContent = `D${sides}`;
                
                wrapper.appendChild(diceEl);
                wrapper.appendChild(label);
                diceDisplay.appendChild(wrapper);
                diceElements.push(diceEl);
            }
            
            // Анимация броска (2 секунды)
            const duration = 2000;
            const interval = 80;
            const iterations = Math.ceil(duration / interval);
            let step = 0;
            const finalResults = [];
            
            // Генерируем финальные результаты
            for (let i = 0; i < count; i++) {
                finalResults.push(Math.floor(Math.random() * sides) + 1);
            }
            
            const animationInterval = setInterval(() => {
                // Показываем случайные числа
                diceElements.forEach((diceEl) => {
                    diceEl.textContent = Math.floor(Math.random() * sides) + 1;
                });
                
                step++;
                
                if (step >= iterations) {
                    clearInterval(animationInterval);
                    
                    // Показываем финальные результаты
                    diceElements.forEach((diceEl, index) => {
                        diceEl.textContent = finalResults[index];
                        diceEl.classList.remove('rolling');
                    });
                    
                    // Рассчитываем сумму
                    const sum = finalResults.reduce((a, b) => a + b, 0);
                    const total = sum + modifier;
                    
                    // Отображаем результаты
                    totalDiv.textContent = `Σ ${total}`;
                    formulaDiv.textContent = `Кости: ${finalResults.join(' + ')}${modifier !== 0 ? ` + ${modifier}` : ''} = ${total}`;
                    
                    // Добавляем в лог
                    state.rollLog.push({
                        type: 'universal',
                        timestamp: new Date().toLocaleTimeString(),
                        count: count,
                        sides: sides,
                        dice: finalResults,
                        modifier: modifier,
                        total: total
                    });
                    
                    if (state.rollLog.length > 50) {
                        state.rollLog = state.rollLog.slice(-50);
                    }
                    
                    renderRollLog();
                    scheduleSave();
                    
                    if (rollButton) rollButton.disabled = false;
                }
            }, interval);
        }

        // Функции для работы с критическими травмами
        function addCriticalInjury() {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            const existingModals = document.querySelectorAll('.modal-overlay');
            modal.style.zIndex = 1000 + (existingModals.length * 100);
            modal.innerHTML = `
                <div class="modal" style="max-width: 500px;">
                    <div class="modal-header">
                        <h3>💔 Добавить критическую травму</h3>
                        <button class="icon-button" onclick="closeModal(this)">×</button>
                    </div>
                    <div class="modal-body">
                        <div class="input-group">
                            <label class="input-label">Описание травмы</label>
                            <textarea class="input-field" id="injuryDescription" rows="3" placeholder="Опишите критическую травму..."></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="pill-button primary-button" onclick="saveCriticalInjury()">Добавить</button>
                        <button class="pill-button" onclick="closeModal(this)">Отмена</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closeModal(modal.querySelector('.icon-button'));
                }
            });
            
            // Фокусируемся на поле ввода
            setTimeout(() => {
                const input = document.getElementById('injuryDescription');
                if (input) input.focus();
            }, 100);
        }

        function saveCriticalInjury() {
            const description = document.getElementById('injuryDescription').value.trim();
            
            if (!description) {
                showModal('Ошибка', `
                    <div style="text-align: center; padding: 1rem;">
                        <p style="color: var(--danger);">Введите описание травмы!</p>
                        <button class="pill-button" onclick="closeModal(this)">Закрыть</button>
                    </div>
                `);
                return;
            }
            
            const newInjury = {
                id: generateId('injury'),
                description: description,
                timestamp: new Date().toLocaleDateString('ru-RU')
            };
            
            state.criticalInjuries.push(newInjury);
            renderInjuries();
            scheduleSave();
            
            closeModal(document.querySelector('.modal-overlay .icon-button'));
        }

        function removeCriticalInjury(injuryId) {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            const existingModals = document.querySelectorAll('.modal-overlay');
            modal.style.zIndex = 1000 + (existingModals.length * 100);
            modal.innerHTML = `
                <div class="modal" style="max-width: 400px;">
                    <div class="modal-header">
                        <h3>Подтверждение</h3>
                        <button class="icon-button" onclick="closeModal(this)">×</button>
                    </div>
                    <div class="modal-body">
                        <p style="text-align: center; color: var(--text); font-size: 1rem;">Удалить эту критическую травму?</p>
                    </div>
                    <div class="modal-footer">
                        <button class="pill-button danger-button" onclick="confirmRemoveCriticalInjury('${injuryId}')">Удалить</button>
                        <button class="pill-button" onclick="closeModal(this)">Отмена</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closeModal(modal.querySelector('.icon-button'));
                }
            });
        }

        function confirmRemoveCriticalInjury(injuryId) {
            state.criticalInjuries = state.criticalInjuries.filter(injury => injury.id !== injuryId);
            renderInjuries();
            scheduleSave();
            closeModal(document.querySelector('.modal-overlay .icon-button'));
        }

        function renderInjuries() {
            const container = document.getElementById('injuriesList');
            if (!container) return;
            
            if (state.criticalInjuries.length === 0) {
                container.innerHTML = '<p style="color: var(--muted); font-size: 0.9rem; margin-top: 0.5rem;">Травмы не добавлены</p>';
                return;
            }
            
            container.innerHTML = state.criticalInjuries.map(injury => `
                <div style="background: rgba(255, 91, 135, 0.1); border: 1px solid var(--danger); border-radius: 8px; padding: 0.75rem; margin-top: 0.5rem; position: relative;">
                    <button onclick="removeCriticalInjury('${injury.id}')" style="position: absolute; top: 0.5rem; right: 0.5rem; font-size: 1rem; background: transparent; border: none; color: var(--text); cursor: pointer;">×</button>
                    <div style="color: var(--text); font-size: 0.9rem; padding-right: 1.5rem;">${injury.description}</div>
                    <div style="color: var(--muted); font-size: 0.75rem; margin-top: 0.25rem;">${injury.timestamp}</div>
                </div>
            `).join('');
        }

        // Вспомогательная функция для форматирования да/нет
        function formatYesNo(value) {
            return value ? 'да' : 'нет';
        }

        // Функции для работы с навыками
        function addStandardSkill(skillName) {
            const skill = STANDARD_SKILLS.find(s => s.name === skillName);
            if (!skill) return;
            
            // Проверяем, можно ли добавить этот навык
            // "Язык" и "Боевые искусства" можно добавлять несколько раз
            const canAddMultiple = skillName === "Язык" || skillName.startsWith("Боевые искусства");
            
            if (!canAddMultiple && state.skills.find(s => s.name === skillName)) {
                showModal('Ошибка', 'Этот навык уже добавлен!');
                return;
            }
            
            // Если навык можно добавлять несколько раз, запрашиваем кастомное имя
            if (canAddMultiple) {
                promptSkillCustomName(skill);
            } else {
                const newSkill = {
                    id: generateId('skill'),
                    name: skill.name,
                    stat: skill.stat,
                    level: skill.level || 0,
                    special: skill.special || false,
                    multiplier: skill.multiplier || 1
                };
                
                state.skills.push(newSkill);
                renderSkills();
                scheduleSave();
                
                // Обновляем модал, чтобы скрыть добавленный навык
                refreshAddSkillModal();
            }
        }
        
        function promptSkillCustomName(skill) {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            const existingModals = document.querySelectorAll('.modal-overlay');
            modal.style.zIndex = 1000 + (existingModals.length * 100);
            
            const placeholder = skill.name === "Язык" ? "Например: Английский, Японский, Фурьский" : "Например: Ганката, Кендо, Капоэйра, Сумо";
            
            modal.innerHTML = `
                <div class="modal" style="max-width: 500px;">
                    <div class="modal-header">
                        <h3>Укажите название</h3>
                        <button class="icon-button" onclick="closeModal(this)">×</button>
                    </div>
                    <div class="modal-body">
                        <div class="input-group">
                            <label class="input-label">${skill.name === "Язык" ? "Какой язык?" : "Какое боевое искусство?"}</label>
                            <input type="text" class="input-field" id="skillCustomNameInput" placeholder="${placeholder}">
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="pill-button primary-button" onclick="saveSkillWithCustomName('${skill.name}', '${skill.stat}', ${skill.level || 0}, ${skill.special || false}, ${skill.multiplier || 1})">Добавить</button>
                        <button class="pill-button" onclick="closeModal(this)">Отмена</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closeModal(modal.querySelector('.icon-button'));
                }
            });
            
            // Фокус на input
            setTimeout(() => {
                const input = document.getElementById('skillCustomNameInput');
                if (input) input.focus();
            }, 100);
        }
        
        function saveSkillWithCustomName(baseName, stat, level, special, multiplier) {
            const customName = document.getElementById('skillCustomNameInput').value.trim();
            
            if (!customName) {
                showModal('Ошибка', `
                    <div style="text-align: center; padding: 1rem;">
                        <p style="color: var(--danger);">Введите название!</p>
                        <button class="pill-button" onclick="closeModal(this)">Закрыть</button>
                    </div>
                `);
                return;
            }
            
            const fullName = `${baseName} (${customName})`;
            
            // Проверяем, не добавлен ли уже такой вариант
            if (state.skills.find(s => s.customName === fullName)) {
                showModal('Ошибка', `
                    <div style="text-align: center; padding: 1rem;">
                        <p style="color: var(--danger);">Этот вариант навыка уже добавлен!</p>
                        <button class="pill-button" onclick="closeModal(this)">Закрыть</button>
                    </div>
                `);
                return;
            }
            
            const newSkill = {
                id: generateId('skill'),
                name: baseName,
                customName: fullName,
                stat: stat,
                level: level,
                special: special,
                multiplier: multiplier
            };
            
            state.skills.push(newSkill);
            renderSkills();
            scheduleSave();
            
            closeModal(document.querySelector('.modal-overlay .icon-button'));
            
            // Обновляем основной модал добавления навыков, если он открыт
            refreshAddSkillModal();
        }
        
        function refreshAddSkillModal() {
            // Ищем открытый модал добавления навыков
            const existingModal = document.querySelector('.modal-overlay');
            if (existingModal && existingModal.querySelector('h3').textContent.includes('Добавить навык')) {
                // Обновляем содержимое модала
                const modalBody = existingModal.querySelector('.modal-body');
                if (modalBody) {
                    // Пересоздаем содержимое модала
                    const statNames = {
                        'WILL': 'Воля',
                        'INT': 'Ум',
                        'DEX': 'Ловкость',
                        'BODY': 'Телосложение',
                        'REA': 'Реакция',
                        'TECH': 'Техника',
                        'CHA': 'Харизма'
                    };
                    
                    const availableSkills = STANDARD_SKILLS.filter(skill => {
                        const canAddMultiple = skill.name === "Язык" || skill.name.startsWith("Боевые искусства");
                        if (canAddMultiple) return true;
                        return !state.skills.find(s => s.name === skill.name);
                    });
                    
                    modalBody.innerHTML = `
                        <div style="margin-bottom: 1.5rem;">
                            <h4 style="color: var(--accent); margin-bottom: 0.75rem;">Стандартные навыки</h4>
                            ${availableSkills.length > 0 ? `
                                <div style="max-height: 400px; overflow-y: auto; border: 1px solid var(--border); border-radius: 12px; padding: 0.75rem;">
                                    ${availableSkills.map(skill => `
                                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; border-bottom: 1px solid rgba(182, 103, 255, 0.15); margin-bottom: 0.5rem;">
                                            <div>
                                                <span style="color: var(--text); font-weight: 500;">${skill.name}</span>
                                                <span style="color: var(--muted); font-size: 0.85rem;"> (${statNames[skill.stat] || skill.stat})</span>
                                                ${skill.special ? '<span style="color: var(--success); font-size: 0.8rem;"> ★</span>' : ''}
                                                ${skill.multiplier > 1 ? `<span style="color: var(--accent-2); font-size: 0.8rem;"> ×${skill.multiplier}</span>` : ''}
                                            </div>
                                            <button class="pill-button primary-button" onclick="addStandardSkill('${skill.name}');" style="font-size: 0.8rem; padding: 0.3rem 0.6rem;">Добавить</button>
                                        </div>
                                    `).join('')}
                                </div>
                            ` : '<p style="color: var(--muted); text-align: center; padding: 2rem;">Все стандартные навыки добавлены</p>'}
                        </div>
                    `;
                }
            }
        }

        function addCustomSkill() {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            const existingModals = document.querySelectorAll('.modal-overlay');
            modal.style.zIndex = 1000 + (existingModals.length * 100);
            modal.innerHTML = `
                <div class="modal" style="max-width: 500px;">
                    <div class="modal-header">
                        <h3>✨ Создать кастомный навык</h3>
                        <button class="icon-button" onclick="closeModal(this)">×</button>
                    </div>
                    <div class="modal-body">
                        <div style="display: grid; gap: 1rem;">
                            <div class="input-group">
                                <label class="input-label">Название навыка</label>
                                <input type="text" class="input-field" id="customSkillName" placeholder="Например: «Язык (Английский)»">
                            </div>
                            <div class="input-group">
                                <label class="input-label">Характеристика</label>
                                <select class="input-field" id="customSkillStat">
                                    <option value="WILL">Воля</option>
                                    <option value="INT" selected>Ум</option>
                                    <option value="DEX">Ловкость</option>
                                    <option value="BODY">Телосложение</option>
                                    <option value="REA">Реакция</option>
                                    <option value="TECH">Техника</option>
                                    <option value="CHA">Харизма</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="pill-button primary-button" onclick="saveCustomSkill()">Создать</button>
                        <button class="pill-button" onclick="closeModal(this)">Отмена</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closeModal(modal.querySelector('.icon-button'));
                }
            });
        }

        function saveCustomSkill() {
            const name = document.getElementById('customSkillName').value;
            const stat = document.getElementById('customSkillStat').value;
            
            if (!name) {
                showModal('Ошибка', `
                    <div style="text-align: center; padding: 1rem;">
                        <p style="color: var(--danger);">Введите название навыка!</p>
                        <button class="pill-button" onclick="closeModal(this)">Закрыть</button>
                    </div>
                `);
                return;
            }
            
            // Проверяем, не добавлен ли уже этот навык
            if (state.skills.find(s => s.name === name)) {
                showModal('Ошибка', `
                    <div style="text-align: center; padding: 1rem;">
                        <p style="color: var(--danger);">Этот навык уже добавлен!</p>
                        <button class="pill-button" onclick="closeModal(this)">Закрыть</button>
                    </div>
                `);
                return;
            }
            
            const newSkill = {
                id: generateId('skill'),
                name: name,
                stat: stat,
                level: 0,
                special: false,
                multiplier: 1,
                customName: name
            };
            
            state.skills.push(newSkill);
            renderSkills();
            scheduleSave();
            
            closeModal(document.querySelector('.modal-overlay .icon-button'));
            
            showModal('Навык добавлен', `
                <div style="text-align: center; padding: 1rem;">
                    <p style="color: var(--success); font-size: 1.1rem; margin-bottom: 1rem;">✅ ${name} добавлен!</p>
                    <button class="pill-button" onclick="closeModal(this)">Закрыть</button>
                </div>
            `);
        }

        function updateSkillLevel(skillId, newLevel) {
            const skill = state.skills.find(s => s.id === skillId);
            if (skill) {
                skill.level = Math.max(0, Math.min(10, parseInt(newLevel)));
                renderSkills();
                updateDerivedStats(); // Обновляем нагрузку если изменилась Атлетика
                scheduleSave();
            }
        }

        function removeSkill(skillId) {
            state.skills = state.skills.filter(s => s.id !== skillId);
            renderSkills();
            updateDerivedStats();
            scheduleSave();
        }

        function renderSkills() {
            const container = document.getElementById('skillsContainer');
            if (!container) return;
            
            if (state.skills.length === 0) {
                container.innerHTML = '<p style="color: var(--muted); text-align: center; padding: 2rem;">Навыки не добавлены</p>';
                return;
            }
            
            // Маппинг английских названий характеристик на русские
            const statNames = {
                'WILL': 'Воля',
                'INT': 'Ум',
                'DEX': 'Ловкость',
                'BODY': 'Телосложение',
                'REA': 'Реакция',
                'TECH': 'Техника',
                'CHA': 'Харизма'
            };
            
            // Отображаем навыки в виде сетки (как характеристики)
            container.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 0.75rem;">
                    ${state.skills.map(skill => `
                        <div class="stat-box" style="position: relative; padding: 1rem; background: rgba(0,0,0,0.2); border: 1px solid rgba(182, 103, 255, 0.2); border-radius: 8px;">
                            <button onclick="removeSkill('${skill.id}')" style="position: absolute; top: 0.5rem; right: 0.5rem; font-size: 1rem; background: transparent; border: none; color: var(--text); cursor: pointer;">×</button>
                            <div class="stat-label" style="font-size: 0.75rem; margin-bottom: 0.5rem; padding-right: 2rem;">${skill.customName || skill.name}</div>
                            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                <input type="text" class="stat-value" value="${skill.level}" min="0" max="10" onchange="updateSkillLevel('${skill.id}', this.value)" style="flex: 1; text-align: center; padding: 0.5rem; background: rgba(0,0,0,0.3); border: 1px solid var(--border); border-radius: 8px; color: var(--text); font-size: 1rem; font-weight: 600;">
                                <button class="pill-button primary-button" onclick="showSkillCheckModal(${state.skills.indexOf(skill)})" style="font-size: 0.8rem; padding: 0.3rem 0.6rem;">🎲</button>
                            </div>
                            <div style="color: var(--muted); font-size: 0.7rem; text-align: center;">
                                ${statNames[skill.stat] || skill.stat}${skill.special ? ' ' : ''}${skill.multiplier > 1 ? ` ×${skill.multiplier}` : ''}
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
            
            // Применяем валидацию к новым полям навыков
            setTimeout(() => {
                const newInputs = container.querySelectorAll('.stat-value');
                newInputs.forEach(input => {
                    input.type = 'text';
                    input.inputMode = 'numeric';
                    input.style.textAlign = 'center';
                    setupNumericValidation(input);
                });
            }, 0);
        }

        function showAddSkillModal() {
            // Маппинг английских названий характеристик на русские
            const statNames = {
                'WILL': 'Воля',
                'INT': 'Ум',
                'DEX': 'Ловкость',
                'BODY': 'Телосложение',
                'REA': 'Реакция',
                'TECH': 'Техника',
                'CHA': 'Харизма'
            };
            
            // Фильтруем навыки: скрываем уже добавленные (кроме "Язык" и "Боевые искусства")
            const availableSkills = STANDARD_SKILLS.filter(skill => {
                const canAddMultiple = skill.name === "Язык" || skill.name.startsWith("Боевые искусства");
                if (canAddMultiple) return true; // Всегда показываем
                
                // Проверяем, добавлен ли уже этот навык
                return !state.skills.find(s => s.name === skill.name);
            });
            
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            const existingModals = document.querySelectorAll('.modal-overlay');
            modal.style.zIndex = 1000 + (existingModals.length * 100);
            modal.innerHTML = `
                <div class="modal" style="max-width: 600px; max-height: 90vh; overflow-y: auto;">
                    <div class="modal-header">
                        <h3>🔫 Добавить навык</h3>
                        <button class="icon-button" onclick="closeModal(this)">×</button>
                    </div>
                    <div class="modal-body">
                        <div style="margin-bottom: 1.5rem;">
                            <h4 style="color: var(--accent); margin-bottom: 0.75rem;">Стандартные навыки</h4>
                            ${availableSkills.length > 0 ? `
                                <div style="max-height: 400px; overflow-y: auto; border: 1px solid var(--border); border-radius: 12px; padding: 0.75rem;">
                                    ${availableSkills.map(skill => `
                                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; border-bottom: 1px solid rgba(182, 103, 255, 0.15); margin-bottom: 0.5rem;">
                                            <div>
                                                <span style="color: var(--text); font-weight: 500;">${skill.name}</span>
                                                <span style="color: var(--muted); font-size: 0.85rem;"> (${statNames[skill.stat] || skill.stat})</span>
                                                ${skill.special ? '<span style="color: var(--success); font-size: 0.8rem;"> </span>' : ''}
                                                ${skill.multiplier > 1 ? `<span style="color: var(--accent-2); font-size: 0.8rem;"> ×${skill.multiplier}</span>` : ''}
                                            </div>
                                            <button class="pill-button primary-button" onclick="addStandardSkill('${skill.name}');" style="font-size: 0.8rem; padding: 0.3rem 0.6rem;">Добавить</button>
                                        </div>
                                    `).join('')}
                                </div>
                            ` : '<p style="color: var(--muted); text-align: center; padding: 2rem;">Все стандартные навыки добавлены</p>'}
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="pill-button success-button" onclick="addCustomSkill();">Создать кастомный навык</button>
                        <button class="pill-button" onclick="closeModal(this)">Закрыть</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closeModal(modal.querySelector('.icon-button'));
                }
            });
        }

        // Функции для работы с секцией "Дека"
        function toggleDeckSection(sectionType) {
            const container = document.getElementById(sectionType === 'programs' ? 'deckProgramsContainer' : 'deckChipsContainer');
            const toggle = document.getElementById(sectionType === 'programs' ? 'deckProgramsToggle' : 'deckChipsToggle');
            
            if (!container || !toggle) return;
            
            const isVisible = container.style.display !== 'none';
            
            if (isVisible) {
                // Сворачиваем
                container.style.display = 'none';
                toggle.textContent = '▶';
            } else {
                // Разворачиваем
                container.style.display = 'block';
                toggle.textContent = '▼';
            }
        }

        function renderDeckPrograms() {
            const container = document.getElementById('deckProgramsContainer');
            if (!container) return;
            
            if (state.deckPrograms.length === 0) {
                container.innerHTML = '<p style="color: var(--muted); text-align: center; padding: 1rem; font-size: 0.8rem;">Программы не установлены</p>';
                return;
            }
            
            container.innerHTML = state.deckPrograms.map((program, index) => `
                <div style="background: rgba(125, 244, 198, 0.1); border: 1px solid var(--success); border-radius: 6px; padding: 0.75rem; margin-bottom: 0.5rem; position: relative;">
                    <button onclick="removeDeckProgram(${index})" style="position: absolute; top: 0.5rem; right: 0.5rem; font-size: 1rem; background: transparent; border: none; color: var(--text); cursor: pointer;">×</button>
                    <div style="padding-right: 1.5rem;">
                        <div style="color: var(--success); font-weight: 600; font-size: 0.9rem; margin-bottom: 0.25rem;">${program.name}</div>
                        <div style="color: var(--muted); font-size: 0.75rem; margin-bottom: 0.25rem;">
                            Цена: ${program.price} уе | ОЗУ: ${program.ram} | ${program.lethal ? 'Смертельная' : 'Несмертельная'}
                        </div>
                        <div style="color: var(--muted); font-size: 0.7rem; line-height: 1.3;">
                            ${program.description}
                        </div>
                    </div>
                </div>
            `).join('');
            
            // Обновляем счетчик в заголовке
            updateDeckCounters();
        }

        function renderDeckChips() {
            const container = document.getElementById('deckChipsContainer');
            if (!container) return;
            
            if (state.deckChips.length === 0) {
                container.innerHTML = '<p style="color: var(--muted); text-align: center; padding: 1rem; font-size: 0.8rem;">Щепки памяти не добавлены</p>';
                return;
            }
            
            container.innerHTML = state.deckChips.map((chip, index) => `
                <div style="background: rgba(182, 103, 255, 0.1); border: 1px solid var(--accent); border-radius: 6px; padding: 0.75rem; margin-bottom: 0.5rem; position: relative;">
                    <div style="display: flex; gap: 0.5rem; padding-right: 3rem;">
                        <button onclick="editMemoryChip(${index})" style="background: transparent; border: none; color: var(--text); cursor: pointer; font-size: 0.8rem;" title="Редактировать">✏️</button>
                        <button onclick="removeMemoryChip(${index})" style="position: absolute; top: 0.5rem; right: 0.5rem; font-size: 1rem; background: transparent; border: none; color: var(--text); cursor: pointer;">×</button>
                    </div>
                    <div>
                        <div style="color: var(--accent); font-weight: 600; font-size: 0.9rem; margin-bottom: 0.25rem;">${chip.name}</div>
                        <div style="color: var(--muted); font-size: 0.75rem;">
                            ${chip.program ? `Программа: ${chip.program.name}` : 'Пустая щепка'}
                        </div>
                    </div>
                </div>
            `).join('');
            
            // Обновляем счетчик в заголовке
            updateDeckCounters();
        }

        function updateDeckCounters() {
            // Обновляем счетчики в заголовках секций
            const programsCount = document.getElementById('deckProgramsCount');
            const chipsCount = document.getElementById('deckChipsCount');
            
            if (programsCount) {
                programsCount.textContent = `(${state.deckPrograms.length})`;
            }
            
            if (chipsCount) {
                chipsCount.textContent = `(${state.deckChips.length})`;
            }
        }

        function showProgramShop() {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            const existingModals = document.querySelectorAll('.modal-overlay');
            modal.style.zIndex = 1000 + (existingModals.length * 100);
            modal.innerHTML = `
                <div class="modal" style="max-width: 800px;">
                    <div class="modal-header">
                        <h3>💾 Магазин программ</h3>
                        <button class="icon-button" onclick="closeModal(this)">×</button>
                    </div>
                    <div class="modal-body">
                        <div style="display: grid; gap: 1rem;">
                            ${STANDARD_PROGRAMS.map((program, index) => `
                                <div class="program-item">
                                    <div class="program-info">
                                        <div class="program-name">${program.name}</div>
                                        <div class="program-details">
                                            Цена: ${program.price} уе | RAM: ${program.ram} | ${program.lethal ? 'Смертельная' : 'Несмертельная'}
                                        </div>
                                        <div class="program-description" style="font-size: 0.8rem; color: var(--muted); margin-top: 0.25rem;">
                                            ${program.description}
                                        </div>
                                    </div>
                                    <div class="program-actions">
                                        <button class="pill-button primary-button" onclick="buyProgram('${program.name}', ${program.price}, ${program.ram}, ${program.lethal}, '${program.description.replace(/'/g, "\\'")}')" style="font-size: 0.8rem; padding: 0.3rem 0.6rem;">Купить</button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="pill-button" onclick="closeModal(this)">Закрыть</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closeModal(modal.querySelector('.icon-button'));
                }
            });
        }

        function buyProgram(name, price, ram, lethal, description) {
            const currentMoney = parseInt(state.money) || 0;
            
            if (currentMoney < price) {
                showModal('Недостаточно денег', `
                    <div style="text-align: center; padding: 1rem;">
                        <p style="color: var(--danger); font-size: 1.1rem; margin-bottom: 1rem;">Не хватает Еши, мабой</p>
                        <div style="display: flex; gap: 0.5rem; justify-content: center;">
                            <button class="pill-button" onclick="closeModal(this); setTimeout(() => showProgramInstallModal('${name}', 0, ${ram}, ${lethal}, '${description.replace(/'/g, "\\'")}'), 100)">
                                Игнорировать
                            </button>
                            <button class="pill-button primary-button" onclick="closeModal(this); setTimeout(() => showCustomPriceModal('${name}', ${price}, ${ram}, ${lethal}, '${description.replace(/'/g, "\\'")}'), 100)">
                                Ввести сумму
                            </button>
                        </div>
                    </div>
                `);
                return;
            }
            
            // Списываем деньги
            state.money = currentMoney - price;
            updateMoneyDisplay();
            
            // Показываем модал выбора установки
            showProgramInstallModal(name, price, ram, lethal, description);
        }

        function showCustomPriceModal(name, originalPrice, ram, lethal, description) {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            const existingModals = document.querySelectorAll('.modal-overlay');
            modal.style.zIndex = 1000 + (existingModals.length * 100);
            modal.innerHTML = `
                <div class="modal" style="max-width: 500px;">
                    <div class="modal-header">
                        <h3>💰 Ввести свою цену</h3>
                        <button class="icon-button" onclick="closeModal(this)">×</button>
                    </div>
                    <div class="modal-body">
                        <div style="margin-bottom: 1rem;">
                            <p><strong>${name}</strong></p>
                            <p style="color: var(--muted); font-size: 0.9rem; margin-bottom: 1rem;">
                                Оригинальная цена: <strong style="color: var(--danger);">${originalPrice} уе</strong>
                            </p>
                        </div>
                        
                        <div class="input-group">
                            <label class="input-label">Ваша цена</label>
                            <input type="number" class="input-field" id="customProgramPrice" value="${originalPrice}" min="0" placeholder="Введите цену">
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="pill-button primary-button" onclick="buyProgramWithCustomPrice('${name}', ${ram}, ${lethal}, '${description.replace(/'/g, "\\'")}')">Купить</button>
                        <button class="pill-button" onclick="closeModal(this)">Отмена</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closeModal(modal.querySelector('.icon-button'));
                }
            });
            
            // Фокусируемся на поле ввода
            setTimeout(() => {
                const input = document.getElementById('customProgramPrice');
                if (input) input.focus();
            }, 100);
        }

        function buyProgramWithCustomPrice(name, ram, lethal, description) {
            const customPrice = parseInt(document.getElementById('customProgramPrice').value) || 0;
            const currentMoney = parseInt(state.money) || 0;
            
            if (currentMoney < customPrice) {
                showModal('Недостаточно денег', `
                    <div style="text-align: center; padding: 1rem;">
                        <p style="color: var(--danger);">Даже на эту сумму не хватает денег!</p>
                        <button class="pill-button" onclick="closeModal(this)">Закрыть</button>
                    </div>
                `);
                return;
            }
            
            // Списываем деньги
            state.money = currentMoney - customPrice;
            updateMoneyDisplay();
            
            closeModal(document.querySelector('.modal-overlay .icon-button'));
            
            // Показываем модал установки
            showProgramInstallModal(name, customPrice, ram, lethal, description);
        }

        function showProgramInstallModal(name, price, ram, lethal, description) {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            const existingModals = document.querySelectorAll('.modal-overlay');
            modal.style.zIndex = 1000 + (existingModals.length * 100);
            modal.innerHTML = `
                <div class="modal" style="max-width: 500px;">
                    <div class="modal-header">
                        <h3>Установка программы: ${name}</h3>
                        <button class="icon-button" onclick="closeModal(this)">×</button>
                    </div>
                    <div class="modal-body">
                        <div style="margin-bottom: 1rem;">
                            <p><strong>${name}</strong></p>
                            <p style="color: var(--muted); font-size: 0.9rem; margin-bottom: 1rem;">
                                Цена: <strong style="color: var(--accent);">${price} уе</strong> | 
                                RAM: <strong style="color: var(--success);">${ram}</strong> |
                                ${lethal ? '<strong style="color: var(--danger);">Смертельная</strong>' : '<strong style="color: var(--success);">Несмертельная</strong>'}
                            </p>
                            <p style="font-size: 0.9rem; color: var(--muted); margin-bottom: 1rem;">
                                ${description}
                            </p>
                        </div>
                        
                        <div style="display: grid; gap: 0.75rem;">
                            <label class="field">
                                Установить на
                                <select id="programInstallTarget" style="width: 100%;">
                                    <option value="deck">Дека</option>
                                    <option value="chip">Щепку памяти</option>
                                </select>
                            </label>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="pill-button primary-button" onclick="installProgram('${name}', ${price}, ${ram}, ${lethal}, '${description.replace(/'/g, "\\'")}')">
                            Установить
                        </button>
                        <button class="pill-button" onclick="closeModal(this)">
                            Отмена
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closeModal(modal.querySelector('.icon-button'));
                }
            });
        }

        function installProgram(name, price, ram, lethal, description) {
            const target = document.getElementById('programInstallTarget').value;
            
            if (target === 'deck') {
                const newProgram = {
                    id: generateId('program'),
                    name: name,
                    price: price,
                    ram: ram,
                    lethal: lethal,
                    description: description,
                    installedOn: 'deck'
                };
                
                state.deckPrograms.push(newProgram);
                renderDeckPrograms();
                
                closeModal(document.querySelector('.modal-overlay .icon-button'));
                scheduleSave();
                
                showModal('Программа установлена', `✅ ${name} установлена на Деку!`);
            } else {
                // Установка на щепку - создаем новую щепку
                const currentMoney = parseInt(state.money) || 0;
                const chipCost = 10; // Стоимость создания щепки
                
                if (currentMoney < chipCost) {
                    showModal('Недостаточно денег', `
                        <div style="text-align: center; padding: 1rem;">
                            <p style="color: var(--danger); font-size: 1.1rem; margin-bottom: 1rem;">Не хватает Еши для создания щепки!</p>
                            <p style="color: var(--muted); margin-bottom: 1rem;">Создание щепки стоит ${chipCost} уе</p>
                            <button class="pill-button" onclick="closeModal(this)">Понятно</button>
                        </div>
                    `);
                    return;
                }
                
                // Списываем деньги за щепку
                state.money = currentMoney - chipCost;
                updateMoneyDisplay();
                
                // Создаем новую щепку с программой
                const newChip = {
                    id: generateId('chip'),
                    name: 'Сам купил',
                    program: {
                        name: name,
                        price: price,
                        ram: ram,
                        lethal: lethal,
                        description: description
                    }
                };
                
                state.deckChips.push(newChip);
                renderDeckChips();
                
                closeModal(document.querySelector('.modal-overlay .icon-button'));
                scheduleSave();
                
                showModal('Щепка создана', `✅ Создана щепка "Сам купил" с программой ${name}!<br>Списано ${chipCost} уе за создание щепки.`);
            }
        }

        function removeDeckProgram(index) {
            if (confirm('Удалить программу?')) {
                state.deckPrograms.splice(index, 1);
                renderDeckPrograms();
                scheduleSave();
            }
        }

        function addMemoryChip() {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            const existingModals = document.querySelectorAll('.modal-overlay');
            modal.style.zIndex = 1000 + (existingModals.length * 100);
            modal.innerHTML = `
                <div class="modal" style="max-width: 500px;">
                    <div class="modal-header">
                        <h3>💾 Добавить щепку памяти</h3>
                        <button class="icon-button" onclick="closeModal(this)">×</button>
                    </div>
                    <div class="modal-body">
                        <div style="margin-bottom: 1rem;">
                            <p style="color: var(--muted); font-size: 0.9rem; margin-bottom: 1rem;">
                                Стоимость создания щепки: <strong style="color: var(--accent);">10 уе</strong>
                            </p>
                        </div>
                        
                        <div class="input-group">
                            <label class="input-label">Название щепки</label>
                            <input type="text" class="input-field" id="chipName" placeholder="Например: Рабочая щепка">
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="pill-button primary-button" onclick="saveMemoryChip()">Создать</button>
                        <button class="pill-button" onclick="closeModal(this)">Отмена</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closeModal(modal.querySelector('.icon-button'));
                }
            });
            
            // Фокусируемся на поле ввода
            setTimeout(() => {
                const input = document.getElementById('chipName');
                if (input) input.focus();
            }, 100);
        }

        function saveMemoryChip() {
            const name = document.getElementById('chipName').value.trim();
            
            if (!name) {
                showModal('Ошибка', `
                    <div style="text-align: center; padding: 1rem;">
                        <p style="color: var(--danger);">Введите название щепки!</p>
                        <button class="pill-button" onclick="closeModal(this)">Закрыть</button>
                    </div>
                `);
                return;
            }
            
            const currentMoney = parseInt(state.money) || 0;
            const chipCost = 10; // Стоимость создания щепки
            
            if (currentMoney < chipCost) {
                showModal('Недостаточно денег', `
                    <div style="text-align: center; padding: 1rem;">
                        <p style="color: var(--danger); font-size: 1.1rem; margin-bottom: 1rem;">Не хватает Еши для создания щепки!</p>
                        <p style="color: var(--muted); margin-bottom: 1rem;">Создание щепки стоит ${chipCost} уе</p>
                        <button class="pill-button" onclick="closeModal(this)">Закрыть</button>
                    </div>
                `);
                return;
            }
            
            // Списываем деньги за щепку
            state.money = currentMoney - chipCost;
            updateMoneyDisplay();
            
            const newChip = {
                id: generateId('chip'),
                name: name,
                program: null // Пустая щепка
            };
            
            state.deckChips.push(newChip);
            renderDeckChips();
            scheduleSave();
            
            closeModal(document.querySelector('.modal-overlay .icon-button'));
            
            showModal('Щепка создана', `✅ Создана пустая щепка "${name}"!<br>Списано ${chipCost} уе за создание щепки.`);
        }

        function editMemoryChip(index) {
            const chip = state.deckChips[index];
            
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            const existingModals = document.querySelectorAll('.modal-overlay');
            modal.style.zIndex = 1000 + (existingModals.length * 100);
            modal.innerHTML = `
                <div class="modal" style="max-width: 500px;">
                    <div class="modal-header">
                        <h3>✏️ Редактировать щепку</h3>
                        <button class="icon-button" onclick="closeModal(this)">×</button>
                    </div>
                    <div class="modal-body">
                        <div class="input-group">
                            <label class="input-label">Название щепки</label>
                            <input type="text" class="input-field" id="editChipName" value="${chip.name}" placeholder="Введите название">
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="pill-button primary-button" onclick="saveEditedChip(${index})">Сохранить</button>
                        <button class="pill-button" onclick="closeModal(this)">Отмена</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closeModal(modal.querySelector('.icon-button'));
                }
            });
            
            // Фокусируемся на поле ввода и выделяем текст
            setTimeout(() => {
                const input = document.getElementById('editChipName');
                if (input) {
                    input.focus();
                    input.select();
                }
            }, 100);
        }

        function saveEditedChip(index) {
            const newName = document.getElementById('editChipName').value.trim();
            
            if (!newName) {
                showModal('Ошибка', `
                    <div style="text-align: center; padding: 1rem;">
                        <p style="color: var(--danger);">Введите название щепки!</p>
                        <button class="pill-button" onclick="closeModal(this)">Закрыть</button>
                    </div>
                `);
                return;
            }
            
            state.deckChips[index].name = newName;
            renderDeckChips();
            scheduleSave();
            
            closeModal(document.querySelector('.modal-overlay .icon-button'));
        }

        function removeMemoryChip(index) {
            if (confirm('Удалить щепку памяти?')) {
                state.deckChips.splice(index, 1);
                renderDeckChips();
                scheduleSave();
            }
        }

        // Функции для работы с киберимплантами
        function renderImplants() {
            const container = document.getElementById('implantsContainer');
            if (!container) return;
            
            // Собираем все установленные модули из всех имплантов
            const installedModules = [];
            
            for (const [implantType, implant] of Object.entries(state.implants)) {
                if (!implant.parts) continue;
                
                for (const [partName, part] of Object.entries(implant.parts)) {
                    if (!part || !part.modules) continue;
                    
                    for (const module of part.modules) {
                        if (module) {
                            installedModules.push({
                                ...module,
                                implantType: implantType,
                                partName: partName,
                                implantName: getImplantName(implantType),
                                partDisplayName: getPartDisplayName(implantType, partName)
                            });
                        }
                    }
                }
            }
            
            if (installedModules.length === 0) {
                container.innerHTML = '<p style="color: var(--muted); text-align: center; padding: 2rem;">Киберимпланты не установлены</p>';
                // Показываем кнопки управления
                const buttonContainer = container.parentElement.querySelector('div[style*="display: flex"]');
                if (buttonContainer) buttonContainer.style.display = 'flex';
                return;
            }
            
            // Скрываем кнопки управления когда есть установленные модули
            const buttonContainer = container.parentElement.querySelector('div[style*="display: flex"]');
            if (buttonContainer) buttonContainer.style.display = 'none';
            
            container.innerHTML = installedModules.map((module, index) => `
                <div class="implant-item" style="background: rgba(182, 103, 255, 0.1); border: 1px solid var(--border); border-radius: 12px; padding: 1rem; margin-bottom: 1rem;">
                    <div class="implant-info">
                        <div class="implant-name" style="color: var(--accent); font-size: 1.1rem; font-weight: bold; margin-bottom: 0.5rem;">${module.name}</div>
                        <div class="implant-category" style="color: var(--success); font-size: 0.9rem; margin-bottom: 0.5rem;">
                            📍 Место установки: ${module.implantName} → ${module.partDisplayName}
                        </div>
                        <div class="implant-details" style="color: var(--text); font-size: 0.9rem; margin-bottom: 0.5rem;">
                            ⚠️ Потеря осознанности: ${module.awarenessLoss}
                        </div>
                        <div class="implant-description" style="font-size: 0.9rem; color: var(--muted); line-height: 1.4;">
                            ${module.description}
                        </div>
                    </div>
                    <div class="implant-actions" style="margin-top: 1rem;">
                        <button class="pill-button" onclick="showImplantsManagement()" style="font-size: 0.8rem; padding: 0.3rem 0.6rem;">Управление</button>
                    </div>
                </div>
            `).join('') + `
                <div style="display: flex; gap: 0.5rem; justify-content: center; margin-top: 1rem;">
                    <button class="pill-button primary-button" onclick="showImplantShop()" style="font-size: 0.8rem; padding: 0.3rem 0.6rem;">Купить модуль</button>
                    <button class="pill-button" onclick="showImplantPartsShop()" style="font-size: 0.8rem; padding: 0.3rem 0.6rem;">Купить часть импланта</button>
                    <button class="pill-button" onclick="showImplantsManagement()" style="font-size: 0.8rem; padding: 0.3rem 0.6rem;">Управление имплантами</button>
                </div>
            `;
        }

        function showImplantShop() {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            const existingModals = document.querySelectorAll('.modal-overlay');
            modal.style.zIndex = 1000 + (existingModals.length * 100);
            
            let shopHTML = `
                <div class="modal" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
                    <div class="modal-header">
                        <h3>🦾 Магазин киберимплантов</h3>
                        <button class="icon-button" onclick="closeModal(this)">×</button>
                    </div>
                    <div class="modal-body">
                        <div style="margin-bottom: 1rem;">
                            <input type="text" id="implantSearchInput" placeholder="🔍 Поиск по названию..." style="width: 100%; padding: 0.75rem; background: var(--panel); border: 1px solid var(--border); border-radius: 8px; color: var(--text); font-size: 1rem;" onkeyup="filterImplants(this.value)">
                        </div>
            `;
            
            // Проходим по всем категориям
            for (const [category, implants] of Object.entries(CYBERIMPLANTS_LIBRARY)) {
                shopHTML += `
                    <div class="category-section" data-category="${category}">
                        <div class="category-title">${category}</div>
                        <div style="display: grid; gap: 1rem;">
                            ${implants.map((implant) => `
                                <div class="implant-item" data-name="${implant.name.toLowerCase()}" data-description="${implant.description.toLowerCase()}">
                                    <div class="implant-info">
                                        <div class="implant-name">${implant.name}</div>
                                        <div class="implant-details">
                                            Цена: ${implant.price} уе | Потеря осознанности: ${implant.awarenessLoss}
                                        </div>
                                        <div class="implant-description" style="font-size: 0.8rem; color: var(--muted); margin-top: 0.25rem;">
                                            ${implant.description}
                                        </div>
                                    </div>
                                    <div class="implant-actions" style="display: flex; flex-direction: column; gap: 0.5rem;">
                                        <button class="pill-button primary-button" onclick="buyAndInstallImplant('${category}', '${implant.name}', ${implant.price}, '${implant.awarenessLoss}', '${implant.description.replace(/'/g, "\\'")}')" style="font-size: 0.8rem; padding: 0.3rem 0.6rem;">Купить (Потеря Осознанности)</button>
                                        <button class="pill-button" onclick="giftImplant('${category}', '${implant.name}', ${implant.price}, '${implant.awarenessLoss}', '${implant.description.replace(/'/g, "\\'")}')" style="font-size: 0.8rem; padding: 0.3rem 0.6rem;">Мне подарили</button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
            
            shopHTML += `
                    </div>
                    <div class="modal-footer">
                        <button class="pill-button" onclick="closeModal(this)">Закрыть</button>
                    </div>
                </div>
            `;
            
            modal.innerHTML = shopHTML;
            document.body.appendChild(modal);
            
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closeModal(modal.querySelector('.icon-button'));
                }
            });
        }

        function filterImplants(searchTerm) {
            const searchLower = searchTerm.toLowerCase();
            const implantItems = document.querySelectorAll('.implant-item');
            const categorySections = document.querySelectorAll('.category-section');
            
            let visibleItems = 0;
            
            implantItems.forEach(item => {
                const name = item.dataset.name || '';
                const description = item.dataset.description || '';
                
                if (name.includes(searchLower) || description.includes(searchLower)) {
                    item.style.display = 'block';
                    visibleItems++;
                } else {
                    item.style.display = 'none';
                }
            });
            
            // Скрываем категории без видимых элементов
            categorySections.forEach(section => {
                const visibleInSection = section.querySelectorAll('.implant-item[style*="block"], .implant-item:not([style*="none"])');
                if (visibleInSection.length === 0) {
                    section.style.display = 'none';
                } else {
                    section.style.display = 'block';
                }
            });
        }

        function buyAndInstallImplant(category, name, price, awarenessLoss, description) {
            const currentMoney = parseInt(state.money) || 0;
            
            if (currentMoney < price) {
                showModal('Недостаточно денег', `
                    <div style="text-align: center; padding: 1rem;">
                        <p style="color: var(--danger); font-size: 1.1rem; margin-bottom: 1rem;">Ха-ха, не так быстро, нищюк!</p>
                        <button class="pill-button" onclick="closeModal(this)">
                            Закрыть
                        </button>
                    </div>
                `);
                return;
            }
            
            // Бросаем кубики для потери осознанности
            const lossRoll = rollDiceForAwarenessLoss(awarenessLoss);
            
            // Списываем деньги
            state.money = currentMoney - price;
            updateMoneyDisplay();
            
            // Вычитаем из текущей осознанности
            const currentAwareness = parseInt(state.awareness.current) || 50;
            state.awareness.current = Math.max(0, currentAwareness - lossRoll);
            const awarenessEl = document.getElementById('awarenessCurrent');
            if (awarenessEl) awarenessEl.value = state.awareness.current;
            
            // Добавляем модуль в снаряжение
            const newGear = {
                name: name,
                description: `${description} | Потеря осознанности: ${awarenessLoss}`,
                price: price,
                load: 1,
                type: 'implant',
                implantData: {
                    category: category,
                    name: name,
                    price: price,
                    awarenessLoss: awarenessLoss,
                    description: description
                }
            };
            
            state.gear.push(newGear);
            renderGear();
            scheduleSave();
            
            closeModal(document.querySelector('.modal-overlay .icon-button'));
            
            showModal('Модуль куплен и готов к установке', `
                <div style="text-align: center; padding: 1rem;">
                    <p style="color: var(--success); font-size: 1.1rem; margin-bottom: 1rem;">✅ ${name} куплен и добавлен в снаряжение!</p>
                    <p style="color: var(--danger); margin-bottom: 1rem;">Потеря осознанности: ${lossRoll}</p>
                    <p style="color: var(--muted);">Текущая осознанность: ${state.awareness.current}</p>
                    <p style="color: var(--muted);">Теперь установите его через "Управление имплантами"</p>
                    <button class="pill-button" onclick="closeModal(this)">
                        Закрыть
                    </button>
                </div>
            `);
        }

        function renderImplants() {
            const container = document.getElementById('implantsContainer');
            if (!container) return;
            
            // Собираем все установленные модули из всех имплантов
            const installedModules = [];
            
            for (const [implantType, implant] of Object.entries(state.implants)) {
                for (const [partName, partData] of Object.entries(implant.parts)) {
                    if (partData && partData.modules) {
                        partData.modules.forEach((module, slotIndex) => {
                            if (module) {
                                const partDisplayName = getPartDisplayName(implantType, partName);
                                installedModules.push({
                                    ...module,
                                    location: `${getImplantTypeDisplayName(implantType)} → ${partDisplayName} → Слот ${slotIndex + 1}`
                                });
                            }
                        });
                    }
                }
            }
            
            if (installedModules.length === 0) {
                container.innerHTML = '<p style="color: var(--muted); text-align: center; padding: 2rem;">Киберимпланты не установлены</p>';
                return;
            }
            
            container.innerHTML = installedModules.map((implant, index) => `
                <div class="implant-item" style="display: flex; align-items: center; gap: 1rem; padding: 0.75rem; background: rgba(0,0,0,0.2); border: 1px solid rgba(182, 103, 255, 0.2); border-radius: 8px; margin-bottom: 0.5rem;">
                    <div style="flex: 1;">
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <span style="color: var(--accent); font-weight: 600;">${implant.name}</span>
                        </div>
                        <div style="color: white; font-weight: bold; font-size: 0.8rem; margin-top: 0.25rem;">${implant.location}</div>
                        ${implant.description ? `<div style="color: var(--muted); font-size: 0.8rem; margin-top: 0.25rem;">${implant.description}</div>` : ''}
                    </div>
                </div>
            `).join('');
        }

        function getImplantTypeDisplayName(implantType) {
            const typeNames = {
                'head': 'Кибер-голова',
                'arms': 'Кибер-рука',
                'legs': 'Кибер-нога',
                'spine': 'Кибер-спина',
                'organs': 'Кибер-внутренности',
                'neuromodule': 'Нейро-модуль'
            };
            return typeNames[implantType] || implantType;
        }


        function rollDiceForAwarenessLoss(awarenessLoss) {
            if (awarenessLoss === '0') return 0;
            
            const match = awarenessLoss.match(/(\d+)d(\d+)/);
            if (match) {
                const count = parseInt(match[1]);
                const sides = parseInt(match[2]);
                let total = 0;
                for (let i = 0; i < count; i++) {
                    total += Math.floor(Math.random() * sides) + 1;
                }
                return total;
            }
            
            return 0;
        }


        function giftImplant(category, name, price, awarenessLoss, description) {
            // Бросаем кубики для потери осознанности
            const lossRoll = rollDiceForAwarenessLoss(awarenessLoss);
            
            // Вычитаем из текущей осознанности
            const currentAwareness = parseInt(state.awareness.current) || 50;
            state.awareness.current = Math.max(0, currentAwareness - lossRoll);
            const awarenessEl = document.getElementById('awarenessCurrent');
            if (awarenessEl) awarenessEl.value = state.awareness.current;
            
            // Добавляем модуль в снаряжение
            const newGear = {
                name: name,
                description: `${description} | Потеря осознанности: ${awarenessLoss}`,
                price: price,
                load: 1,
                type: 'implant',
                implantData: {
                    category: category,
                    name: name,
                    price: price,
                    awarenessLoss: awarenessLoss,
                    description: description
                }
            };
            
            state.gear.push(newGear);
            renderGear();
            scheduleSave();
            
            closeModal(document.querySelector('.modal-overlay .icon-button'));
            
            showModal('Модуль получен', `
                <div style="text-align: center; padding: 1rem;">
                    <p style="color: var(--success); font-size: 1.1rem; margin-bottom: 1rem;">✅ ${name} добавлен в снаряжение!</p>
                    <p style="color: var(--danger); margin-bottom: 1rem;">Потеря осознанности: ${lossRoll}</p>
                    <p style="color: var(--muted);">Текущая осознанность: ${state.awareness.current}</p>
                    <p style="color: var(--muted);">Теперь вы можете установить его через "Управление имплантами"</p>
                    <button class="pill-button" onclick="closeModal(this)">
                        Закрыть
                    </button>
                </div>
            `);
        }

        function addGiftedImplant() {
            // Показываем модал магазина, но без списания денег
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            const existingModals = document.querySelectorAll('.modal-overlay');
            modal.style.zIndex = 1000 + (existingModals.length * 100);
            
            let shopHTML = `
                <div class="modal" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
                    <div class="modal-header">
                        <h3>🎁 Выберите подаренный имплант</h3>
                        <button class="icon-button" onclick="closeModal(this)">×</button>
                    </div>
                    <div class="modal-body">
            `;
            
            // Проходим по всем категориям
            for (const [category, implants] of Object.entries(CYBERIMPLANTS_LIBRARY)) {
                shopHTML += `
                    <div class="category-section">
                        <div class="category-title">${category}</div>
                        <div style="display: grid; gap: 1rem;">
                            ${implants.map((implant) => `
                                <div class="implant-item">
                                    <div class="implant-info">
                                        <div class="implant-name">${implant.name}</div>
                                        <div class="implant-details">
                                            Потеря осознанности: ${implant.awarenessLoss}
                                        </div>
                                        <div class="implant-description" style="font-size: 0.8rem; color: var(--muted); margin-top: 0.25rem;">
                                            ${implant.description}
                                        </div>
                                    </div>
                                    <div class="implant-actions">
                                        <button class="pill-button success-button" onclick="installGiftedImplant('${category}', '${implant.name}', ${implant.price}, '${implant.awarenessLoss}', '${implant.description.replace(/'/g, "\\'")}')" style="font-size: 0.8rem; padding: 0.3rem 0.6rem;">Установить</button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
            
            shopHTML += `
                    </div>
                    <div class="modal-footer">
                        <button class="pill-button" onclick="closeModal(this)">Закрыть</button>
                    </div>
                </div>
            `;
            
            modal.innerHTML = shopHTML;
            document.body.appendChild(modal);
            
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closeModal(modal.querySelector('.icon-button'));
                }
            });
        }

        function installGiftedImplant(category, name, price, awarenessLoss, description) {
            // Бросаем кубики для потери осознанности
            const lossRoll = rollDiceForAwarenessLoss(awarenessLoss);
            
            // Вычитаем из текущей осознанности
            const currentAwareness = parseInt(state.awareness.current) || 50;
            state.awareness.current = Math.max(0, currentAwareness - lossRoll);
            const awarenessEl = document.getElementById('awarenessCurrent');
            if (awarenessEl) awarenessEl.value = state.awareness.current;
            
            // Добавляем модуль в снаряжение
            const newGear = {
                name: name,
                description: `${description} | Потеря осознанности: ${awarenessLoss}`,
                price: price,
                load: 1,
                type: 'implant',
                implantData: {
                    category: category,
                    name: name,
                    price: price,
                    awarenessLoss: awarenessLoss,
                    description: description
                }
            };
            
            state.gear.push(newGear);
            renderGear();
            scheduleSave();
            
            closeModal(document.querySelector('.modal-overlay .icon-button'));
            
            showModal('Модуль получен', `
                <div style="text-align: center; padding: 1rem;">
                    <p style="color: var(--success); font-size: 1.1rem; margin-bottom: 1rem;">✅ ${name} добавлен в снаряжение!</p>
                    <p style="color: var(--danger); margin-bottom: 1rem;">Потеря осознанности: ${lossRoll}</p>
                    <p style="color: var(--muted);">Текущая осознанность: ${state.awareness.current}</p>
                    <p style="color: var(--muted);">Теперь вы можете установить его через "Управление имплантами"</p>
                    <button class="pill-button" onclick="closeModal(this)">
                        Закрыть
                    </button>
                </div>
            `);
        }

        // Функция для управления имплантами (полная схема)
        function showImplantsManagement() {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            const existingModals = document.querySelectorAll('.modal-overlay');
            modal.style.zIndex = 1000 + (existingModals.length * 100);
            
            let managementHTML = `
                <div class="modal" style="max-width: 95vw; max-height: 95vh; overflow-y: auto;">
                    <div class="modal-header">
                        <h3>🦾 Управление имплантами</h3>
                        <button class="icon-button" onclick="closeModal(this)">×</button>
                    </div>
                    <div class="modal-body">
                        <div style="display: grid; grid-template-columns: 300px 1fr; gap: 2rem; min-height: 600px;">
                            <!-- Левая панель: Схема тела -->
                            <div style="background: rgba(0,0,0,0.2); border-radius: 12px; padding: 1rem; border: 1px solid var(--border);">
                                <h4 style="color: var(--accent); text-align: center; margin-bottom: 1rem;">Схема тела</h4>
                                <div style="position: relative; height: 500px; background: linear-gradient(135deg, #1a1a2e, #16213e); border-radius: 8px; border: 1px solid var(--border);">
                                    <!-- ГОЛОВА -->
                                    <div style="position: absolute; top: 20px; left: 50%; transform: translateX(-50%); width: 60px; height: 60px; background: ${state.implants.head.parts.main ? 'rgba(125, 244, 198, 0.3)' : 'rgba(255, 91, 135, 0.3)'}; border-radius: 50%; border: 2px solid ${state.implants.head.parts.main ? 'var(--success)' : 'var(--danger)'}; cursor: ${state.implants.head.parts.main ? 'pointer' : 'not-allowed'};" onclick="${state.implants.head.parts.main ? "selectImplant('head', 'main')" : 'showUnpurchasedError()'}" title="Кибер-голова">
                                        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: ${state.implants.head.parts.main ? 'var(--success)' : 'var(--danger)'}; font-size: 0.8rem; font-weight: bold;">ГОЛОВА</div>
                                        ${!state.implants.head.parts.main ? '<div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: var(--danger); font-size: 1.2rem;">✖</div>' : ''}
                                    </div>
                                    
                                    <!-- НЕЙРОМОДУЛЬ -->
                                    <div style="position: absolute; top: 100px; left: 50%; transform: translateX(-50%); width: 40px; height: 40px; background: ${state.implants.neuromodule.parts.main ? 'rgba(125, 244, 198, 0.3)' : 'rgba(255, 91, 135, 0.3)'}; border-radius: 50%; border: 2px solid ${state.implants.neuromodule.parts.main ? 'var(--success)' : 'var(--danger)'}; cursor: ${state.implants.neuromodule.parts.main ? 'pointer' : 'not-allowed'};" onclick="${state.implants.neuromodule.parts.main ? 'selectImplant(\'neuromodule\')' : 'showUnpurchasedError()'}" title="Нейромодуль">
                                        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: ${state.implants.neuromodule.parts.main ? 'var(--success)' : 'var(--danger)'}; font-size: 0.6rem; font-weight: bold;">НЕЙРО</div>
                                        ${!state.implants.neuromodule.parts.main ? '<div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: var(--danger); font-size: 1rem;">✖</div>' : ''}
                                    </div>
                                    
                                    <!-- СПИНА - отдельные части -->
                                    <div style="position: absolute; top: 150px; left: 50%; transform: translateX(-50%); width: 60px; height: 15px; background: ${state.implants.spine.parts.cervical ? 'rgba(125, 244, 198, 0.3)' : 'rgba(255, 91, 135, 0.3)'}; border-radius: 4px; border: 2px solid ${state.implants.spine.parts.cervical ? 'var(--success)' : 'var(--danger)'}; cursor: ${state.implants.spine.parts.cervical ? 'pointer' : 'not-allowed'};" onclick="${state.implants.spine.parts.cervical ? "selectImplant('spine', 'cervical')" : 'showUnpurchasedError()'}" title="Шейная">
                                        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: ${state.implants.spine.parts.cervical ? 'var(--success)' : 'var(--danger)'}; font-size: 0.3rem; font-weight: bold;">ШЕЙНАЯ</div>
                                        ${!state.implants.spine.parts.cervical ? '<div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: var(--danger); font-size: 0.6rem;">✖</div>' : ''}
                                    </div>
                                    
                                    <div style="position: absolute; top: 170px; left: 30%; transform: translateX(-50%); width: 50px; height: 15px; background: ${state.implants.spine.parts.thoracicLeft ? 'rgba(125, 244, 198, 0.3)' : 'rgba(255, 91, 135, 0.3)'}; border-radius: 4px; border: 2px solid ${state.implants.spine.parts.thoracicLeft ? 'var(--success)' : 'var(--danger)'}; cursor: ${state.implants.spine.parts.thoracicLeft ? 'pointer' : 'not-allowed'};" onclick="${state.implants.spine.parts.thoracicLeft ? "selectImplant('spine', 'thoracicLeft')" : 'showUnpurchasedError()'}" title="Грудная левая">
                                        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: ${state.implants.spine.parts.thoracicLeft ? 'var(--success)' : 'var(--danger)'}; font-size: 0.25rem; font-weight: bold;">ГРУД Л</div>
                                        ${!state.implants.spine.parts.thoracicLeft ? '<div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: var(--danger); font-size: 0.6rem;">✖</div>' : ''}
                                    </div>
                                    
                                    <div style="position: absolute; top: 170px; right: 30%; transform: translateX(50%); width: 50px; height: 15px; background: ${state.implants.spine.parts.thoracicRight ? 'rgba(125, 244, 198, 0.3)' : 'rgba(255, 91, 135, 0.3)'}; border-radius: 4px; border: 2px solid ${state.implants.spine.parts.thoracicRight ? 'var(--success)' : 'var(--danger)'}; cursor: ${state.implants.spine.parts.thoracicRight ? 'pointer' : 'not-allowed'};" onclick="${state.implants.spine.parts.thoracicRight ? "selectImplant('spine', 'thoracicRight')" : 'showUnpurchasedError()'}" title="Грудная правая">
                                        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: ${state.implants.spine.parts.thoracicRight ? 'var(--success)' : 'var(--danger)'}; font-size: 0.25rem; font-weight: bold;">ГРУД П</div>
                                        ${!state.implants.spine.parts.thoracicRight ? '<div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: var(--danger); font-size: 0.6rem;">✖</div>' : ''}
                                    </div>
                                    
                                    <div style="position: absolute; top: 190px; left: 50%; transform: translateX(-50%); width: 60px; height: 15px; background: ${state.implants.spine.parts.lumbar ? 'rgba(125, 244, 198, 0.3)' : 'rgba(255, 91, 135, 0.3)'}; border-radius: 4px; border: 2px solid ${state.implants.spine.parts.lumbar ? 'var(--success)' : 'var(--danger)'}; cursor: ${state.implants.spine.parts.lumbar ? 'pointer' : 'not-allowed'};" onclick="${state.implants.spine.parts.lumbar ? "selectImplant('spine', 'lumbar')" : 'showUnpurchasedError()'}" title="Поясничная">
                                        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: ${state.implants.spine.parts.lumbar ? 'var(--success)' : 'var(--danger)'}; font-size: 0.3rem; font-weight: bold;">ПОЯСНИЧ</div>
                                        ${!state.implants.spine.parts.lumbar ? '<div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: var(--danger); font-size: 0.6rem;">✖</div>' : ''}
                                    </div>
                                    
                                    <div style="position: absolute; top: 210px; left: 50%; transform: translateX(-50%); width: 60px; height: 15px; background: ${state.implants.spine.parts.sacral ? 'rgba(125, 244, 198, 0.3)' : 'rgba(255, 91, 135, 0.3)'}; border-radius: 4px; border: 2px solid ${state.implants.spine.parts.sacral ? 'var(--success)' : 'var(--danger)'}; cursor: ${state.implants.spine.parts.sacral ? 'pointer' : 'not-allowed'};" onclick="${state.implants.spine.parts.sacral ? "selectImplant('spine', 'sacral')" : 'showUnpurchasedError()'}" title="Крестцовая">
                                        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: ${state.implants.spine.parts.sacral ? 'var(--success)' : 'var(--danger)'}; font-size: 0.3rem; font-weight: bold;">КРЕСТЦОВ</div>
                                        ${!state.implants.spine.parts.sacral ? '<div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: var(--danger); font-size: 0.6rem;">✖</div>' : ''}
                                    </div>
                                    
                                    <!-- ЛЕВАЯ РУКА - отдельные части -->
                                    <div style="position: absolute; top: 160px; left: 20px; width: 45px; height: 25px; background: ${state.implants.arms.parts.wristLeft ? 'rgba(125, 244, 198, 0.3)' : 'rgba(255, 91, 135, 0.3)'}; border-radius: 4px; border: 2px solid ${state.implants.arms.parts.wristLeft ? 'var(--success)' : 'var(--danger)'}; cursor: ${state.implants.arms.parts.wristLeft ? 'pointer' : 'not-allowed'};" onclick="${state.implants.arms.parts.wristLeft ? "selectImplant('arms', 'wristLeft')" : 'showUnpurchasedError()'}" title="Кисть левая">
                                        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: ${state.implants.arms.parts.wristLeft ? 'var(--success)' : 'var(--danger)'}; font-size: 0.5rem; font-weight: bold;">КИСТЬ</div>
                                        ${!state.implants.arms.parts.wristLeft ? '<div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: var(--danger); font-size: 1rem;">✖</div>' : ''}
                                    </div>
                                    
                                    <div style="position: absolute; top: 190px; left: 20px; width: 45px; height: 25px; background: ${state.implants.arms.parts.forearmLeft ? 'rgba(125, 244, 198, 0.3)' : 'rgba(255, 91, 135, 0.3)'}; border-radius: 4px; border: 2px solid ${state.implants.arms.parts.forearmLeft ? 'var(--success)' : 'var(--danger)'}; cursor: ${state.implants.arms.parts.forearmLeft ? 'pointer' : 'not-allowed'};" onclick="${state.implants.arms.parts.forearmLeft ? "selectImplant('arms', 'forearmLeft')" : 'showUnpurchasedError()'}" title="Предплечье левое">
                                        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: ${state.implants.arms.parts.forearmLeft ? 'var(--success)' : 'var(--danger)'}; font-size: 0.4rem; font-weight: bold;">ПРЕДПЛЕЧЬЕ</div>
                                        ${!state.implants.arms.parts.forearmLeft ? '<div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: var(--danger); font-size: 1rem;">✖</div>' : ''}
                                    </div>
                                    
                                    <div style="position: absolute; top: 220px; left: 20px; width: 45px; height: 25px; background: ${state.implants.arms.parts.shoulderLeft ? 'rgba(125, 244, 198, 0.3)' : 'rgba(255, 91, 135, 0.3)'}; border-radius: 4px; border: 2px solid ${state.implants.arms.parts.shoulderLeft ? 'var(--success)' : 'var(--danger)'}; cursor: ${state.implants.arms.parts.shoulderLeft ? 'pointer' : 'not-allowed'};" onclick="${state.implants.arms.parts.shoulderLeft ? "selectImplant('arms', 'shoulderLeft')" : 'showUnpurchasedError()'}" title="Плечо левое">
                                        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: ${state.implants.arms.parts.shoulderLeft ? 'var(--success)' : 'var(--danger)'}; font-size: 0.5rem; font-weight: bold;">ПЛЕЧО</div>
                                        ${!state.implants.arms.parts.shoulderLeft ? '<div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: var(--danger); font-size: 1rem;">✖</div>' : ''}
                                    </div>
                                    
                                    <!-- ПРАВАЯ РУКА - отдельные части -->
                                    <div style="position: absolute; top: 160px; right: 20px; width: 45px; height: 25px; background: ${state.implants.arms.parts.wristRight ? 'rgba(125, 244, 198, 0.3)' : 'rgba(255, 91, 135, 0.3)'}; border-radius: 4px; border: 2px solid ${state.implants.arms.parts.wristRight ? 'var(--success)' : 'var(--danger)'}; cursor: ${state.implants.arms.parts.wristRight ? 'pointer' : 'not-allowed'};" onclick="${state.implants.arms.parts.wristRight ? "selectImplant('arms', 'wristRight')" : 'showUnpurchasedError()'}" title="Кисть правая">
                                        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: ${state.implants.arms.parts.wristRight ? 'var(--success)' : 'var(--danger)'}; font-size: 0.5rem; font-weight: bold;">КИСТЬ</div>
                                        ${!state.implants.arms.parts.wristRight ? '<div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: var(--danger); font-size: 1rem;">✖</div>' : ''}
                                    </div>
                                    
                                    <div style="position: absolute; top: 190px; right: 20px; width: 45px; height: 25px; background: ${state.implants.arms.parts.forearmRight ? 'rgba(125, 244, 198, 0.3)' : 'rgba(255, 91, 135, 0.3)'}; border-radius: 4px; border: 2px solid ${state.implants.arms.parts.forearmRight ? 'var(--success)' : 'var(--danger)'}; cursor: ${state.implants.arms.parts.forearmRight ? 'pointer' : 'not-allowed'};" onclick="${state.implants.arms.parts.forearmRight ? "selectImplant('arms', 'forearmRight')" : 'showUnpurchasedError()'}" title="Предплечье правое">
                                        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: ${state.implants.arms.parts.forearmRight ? 'var(--success)' : 'var(--danger)'}; font-size: 0.4rem; font-weight: bold;">ПРЕДПЛЕЧЬЕ</div>
                                        ${!state.implants.arms.parts.forearmRight ? '<div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: var(--danger); font-size: 1rem;">✖</div>' : ''}
                                    </div>
                                    
                                    <div style="position: absolute; top: 220px; right: 20px; width: 45px; height: 25px; background: ${state.implants.arms.parts.shoulderRight ? 'rgba(125, 244, 198, 0.3)' : 'rgba(255, 91, 135, 0.3)'}; border-radius: 4px; border: 2px solid ${state.implants.arms.parts.shoulderRight ? 'var(--success)' : 'var(--danger)'}; cursor: ${state.implants.arms.parts.shoulderRight ? 'pointer' : 'not-allowed'};" onclick="${state.implants.arms.parts.shoulderRight ? "selectImplant('arms', 'shoulderRight')" : 'showUnpurchasedError()'}" title="Плечо правое">
                                        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: ${state.implants.arms.parts.shoulderRight ? 'var(--success)' : 'var(--danger)'}; font-size: 0.5rem; font-weight: bold;">ПЛЕЧО</div>
                                        ${!state.implants.arms.parts.shoulderRight ? '<div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: var(--danger); font-size: 1rem;">✖</div>' : ''}
                                    </div>
                                    
                                    <!-- ВНУТРЕННОСТИ -->
                                    <div style="position: absolute; top: 300px; left: 50%; transform: translateX(-50%); width: 60px; height: 60px; background: ${state.implants.organs.parts.main ? 'rgba(125, 244, 198, 0.3)' : 'rgba(255, 91, 135, 0.3)'}; border-radius: 8px; border: 2px solid ${state.implants.organs.parts.main ? 'var(--success)' : 'var(--danger)'}; cursor: ${state.implants.organs.parts.main ? 'pointer' : 'not-allowed'};" onclick="${state.implants.organs.parts.main ? 'selectImplant(\'organs\')' : 'showUnpurchasedError()'}" title="Кибер-внутренности">
                                        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: ${state.implants.organs.parts.main ? 'var(--success)' : 'var(--danger)'}; font-size: 0.6rem; font-weight: bold;">ВНУТРЕННОСТИ</div>
                                        ${!state.implants.organs.parts.main ? '<div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: var(--danger); font-size: 1rem;">✖</div>' : ''}
                                    </div>
                                    
                                    <!-- ЛЕВАЯ НОГА - отдельные части -->
                                    <div style="position: absolute; top: 380px; left: 20px; width: 45px; height: 25px; background: ${state.implants.legs.parts.footLeft ? 'rgba(125, 244, 198, 0.3)' : 'rgba(255, 91, 135, 0.3)'}; border-radius: 4px; border: 2px solid ${state.implants.legs.parts.footLeft ? 'var(--success)' : 'var(--danger)'}; cursor: ${state.implants.legs.parts.footLeft ? 'pointer' : 'not-allowed'};" onclick="${state.implants.legs.parts.footLeft ? "selectImplant('legs', 'footLeft')" : 'showUnpurchasedError()'}" title="Стопа левая">
                                        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: ${state.implants.legs.parts.footLeft ? 'var(--success)' : 'var(--danger)'}; font-size: 0.5rem; font-weight: bold;">СТОПА</div>
                                        ${!state.implants.legs.parts.footLeft ? '<div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: var(--danger); font-size: 1rem;">✖</div>' : ''}
                                    </div>
                                    
                                    <div style="position: absolute; top: 410px; left: 20px; width: 45px; height: 25px; background: ${state.implants.legs.parts.shinLeft ? 'rgba(125, 244, 198, 0.3)' : 'rgba(255, 91, 135, 0.3)'}; border-radius: 4px; border: 2px solid ${state.implants.legs.parts.shinLeft ? 'var(--success)' : 'var(--danger)'}; cursor: ${state.implants.legs.parts.shinLeft ? 'pointer' : 'not-allowed'};" onclick="${state.implants.legs.parts.shinLeft ? "selectImplant('legs', 'shinLeft')" : 'showUnpurchasedError()'}" title="Голень левая">
                                        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: ${state.implants.legs.parts.shinLeft ? 'var(--success)' : 'var(--danger)'}; font-size: 0.5rem; font-weight: bold;">ГОЛЕНЬ</div>
                                        ${!state.implants.legs.parts.shinLeft ? '<div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: var(--danger); font-size: 1rem;">✖</div>' : ''}
                                    </div>
                                    
                                    <div style="position: absolute; top: 440px; left: 20px; width: 45px; height: 25px; background: ${state.implants.legs.parts.thighLeft ? 'rgba(125, 244, 198, 0.3)' : 'rgba(255, 91, 135, 0.3)'}; border-radius: 4px; border: 2px solid ${state.implants.legs.parts.thighLeft ? 'var(--success)' : 'var(--danger)'}; cursor: ${state.implants.legs.parts.thighLeft ? 'pointer' : 'not-allowed'};" onclick="${state.implants.legs.parts.thighLeft ? "selectImplant('legs', 'thighLeft')" : 'showUnpurchasedError()'}" title="Бедро левое">
                                        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: ${state.implants.legs.parts.thighLeft ? 'var(--success)' : 'var(--danger)'}; font-size: 0.5rem; font-weight: bold;">БЕДРО</div>
                                        ${!state.implants.legs.parts.thighLeft ? '<div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: var(--danger); font-size: 1rem;">✖</div>' : ''}
                                    </div>
                                    
                                    <!-- ПРАВАЯ НОГА - отдельные части -->
                                    <div style="position: absolute; top: 380px; right: 20px; width: 45px; height: 25px; background: ${state.implants.legs.parts.footRight ? 'rgba(125, 244, 198, 0.3)' : 'rgba(255, 91, 135, 0.3)'}; border-radius: 4px; border: 2px solid ${state.implants.legs.parts.footRight ? 'var(--success)' : 'var(--danger)'}; cursor: ${state.implants.legs.parts.footRight ? 'pointer' : 'not-allowed'};" onclick="${state.implants.legs.parts.footRight ? "selectImplant('legs', 'footRight')" : 'showUnpurchasedError()'}" title="Стопа правая">
                                        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: ${state.implants.legs.parts.footRight ? 'var(--success)' : 'var(--danger)'}; font-size: 0.5rem; font-weight: bold;">СТОПА</div>
                                        ${!state.implants.legs.parts.footRight ? '<div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: var(--danger); font-size: 1rem;">✖</div>' : ''}
                                    </div>
                                    
                                    <div style="position: absolute; top: 410px; right: 20px; width: 45px; height: 25px; background: ${state.implants.legs.parts.shinRight ? 'rgba(125, 244, 198, 0.3)' : 'rgba(255, 91, 135, 0.3)'}; border-radius: 4px; border: 2px solid ${state.implants.legs.parts.shinRight ? 'var(--success)' : 'var(--danger)'}; cursor: ${state.implants.legs.parts.shinRight ? 'pointer' : 'not-allowed'};" onclick="${state.implants.legs.parts.shinRight ? "selectImplant('legs', 'shinRight')" : 'showUnpurchasedError()'}" title="Голень правая">
                                        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: ${state.implants.legs.parts.shinRight ? 'var(--success)' : 'var(--danger)'}; font-size: 0.5rem; font-weight: bold;">ГОЛЕНЬ</div>
                                        ${!state.implants.legs.parts.shinRight ? '<div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: var(--danger); font-size: 1rem;">✖</div>' : ''}
                                    </div>
                                    
                                    <div style="position: absolute; top: 440px; right: 20px; width: 45px; height: 25px; background: ${state.implants.legs.parts.thighRight ? 'rgba(125, 244, 198, 0.3)' : 'rgba(255, 91, 135, 0.3)'}; border-radius: 4px; border: 2px solid ${state.implants.legs.parts.thighRight ? 'var(--success)' : 'var(--danger)'}; cursor: ${state.implants.legs.parts.thighRight ? 'pointer' : 'not-allowed'};" onclick="${state.implants.legs.parts.thighRight ? "selectImplant('legs', 'thighRight')" : 'showUnpurchasedError()'}" title="Бедро правое">
                                        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: ${state.implants.legs.parts.thighRight ? 'var(--success)' : 'var(--danger)'}; font-size: 0.5rem; font-weight: bold;">БЕДРО</div>
                                        ${!state.implants.legs.parts.thighRight ? '<div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: var(--danger); font-size: 1rem;">✖</div>' : ''}
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Правая панель: Детали импланта -->
                            <div style="background: rgba(0,0,0,0.2); border-radius: 12px; padding: 1rem; border: 1px solid var(--border);">
                                <h4 style="color: var(--accent); text-align: center; margin-bottom: 1rem;">Детали импланта</h4>
                                <div id="implantDetails">
                                    <p style="color: var(--muted); text-align: center; padding: 2rem;">Выберите имплант на схеме тела</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="pill-button" onclick="closeModal(this)">Закрыть</button>
                    </div>
                </div>
            `;
            
            modal.innerHTML = managementHTML;
            document.body.appendChild(modal);
            
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closeModal(modal.querySelector('.icon-button'));
                }
            });
        }

        // Функция для выбора импланта
        function selectImplant(implantType, partName = null) {
            const detailsContainer = document.getElementById('implantDetails');
            if (!detailsContainer) return;
            
            const implant = state.implants[implantType];
            if (!implant || !implant.installed) {
                detailsContainer.innerHTML = `
                    <p style="color: var(--muted); text-align: center; padding: 2rem;">
                        Имплант не установлен. Купите части импланта в магазине.
                    </p>
                `;
                return;
            }
            
            let detailsHTML = `
                <div style="margin-bottom: 1rem;">
                    <h5 style="color: var(--accent); margin-bottom: 0.5rem;">${getImplantName(implantType)}</h5>
                    <p style="color: var(--muted); font-size: 0.9rem;">${getImplantDescription(implantType)}</p>
                </div>
            `;
            
            // Если указана конкретная часть, показываем только её
            if (partName) {
                const partData = implant.parts[partName];
                if (!partData || !partData.slots) {
                    detailsContainer.innerHTML = `
                        <p style="color: var(--danger); text-align: center; padding: 2rem;">
                            Эта часть импланта не куплена!
                        </p>
                    `;
                    return;
                }
                
                const partDisplayName = getPartDisplayName(implantType, partName);
                detailsHTML += `
                    <div style="background: rgba(0,0,0,0.3); border-radius: 8px; padding: 1rem; margin-bottom: 1rem; border: 1px solid var(--border);">
                        <h6 style="color: var(--accent); margin-bottom: 0.5rem;">${partDisplayName}</h6>
                        <div style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem;">
                            ${Array.from({length: partData.slots}, (_, i) => `
                                <div class="implant-slot" style="width: 40px; height: 40px; background: ${partData.modules[i] ? 'rgba(125, 244, 198, 0.3)' : 'rgba(182, 103, 255, 0.2)'}; border: 2px solid ${partData.modules[i] ? 'var(--success)' : 'var(--border)'}; border-radius: 6px; display: flex; align-items: center; justify-content: center; cursor: pointer;" onclick="manageSlot('${implantType}', '${partName}', ${i})">
                                    ${partData.modules[i] ? '✓' : '○'}
                                </div>
                            `).join('')}
                        </div>
                        <p style="color: var(--muted); font-size: 0.8rem;">Слотов: ${partData.modules.filter(m => m).length}/${partData.slots}</p>
                        ${partData.modules.filter(m => m).length > 0 ? `
                            <div style="margin-top: 0.5rem;">
                                <h7 style="color: var(--success); font-size: 0.8rem;">Установленные модули:</h7>
                                ${partData.modules.map((module, i) => module ? `
                                    <div style="background: rgba(125, 244, 198, 0.1); border: 1px solid var(--success); border-radius: 6px; padding: 0.5rem; margin-top: 0.25rem;">
                                        <div style="color: var(--success); font-weight: bold; font-size: 0.8rem;">${module.name}</div>
                                        <div style="color: var(--muted); font-size: 0.7rem;">${module.description}</div>
                                    </div>
                                ` : '').join('')}
                            </div>
                        ` : ''}
                    </div>
                `;
            } else {
                // Показываем все части импланта
                for (const [partName, partData] of Object.entries(implant.parts)) {
                    if (!partData || !partData.slots) continue; // Пропускаем не установленные части
                    
                    const partDisplayName = getPartDisplayName(implantType, partName);
                    detailsHTML += `
                        <div style="background: rgba(0,0,0,0.3); border-radius: 8px; padding: 1rem; margin-bottom: 1rem; border: 1px solid var(--border);">
                            <h6 style="color: var(--accent); margin-bottom: 0.5rem;">${partDisplayName}</h6>
                            <div style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem;">
                                ${Array.from({length: partData.slots}, (_, i) => `
                                    <div class="implant-slot" style="width: 40px; height: 40px; background: ${partData.modules[i] ? 'rgba(125, 244, 198, 0.3)' : 'rgba(182, 103, 255, 0.2)'}; border: 2px solid ${partData.modules[i] ? 'var(--success)' : 'var(--border)'}; border-radius: 6px; display: flex; align-items: center; justify-content: center; cursor: pointer;" onclick="manageSlot('${implantType}', '${partName}', ${i})">
                                        ${partData.modules[i] ? '✓' : '○'}
                                    </div>
                                `).join('')}
                            </div>
                            <p style="color: var(--muted); font-size: 0.8rem;">Слотов: ${partData.modules.filter(m => m).length}/${partData.slots}</p>
                            ${partData.modules.filter(m => m).length > 0 ? `
                                <div style="margin-top: 0.5rem;">
                                    <h7 style="color: var(--success); font-size: 0.8rem;">Установленные модули:</h7>
                                    ${partData.modules.map((module, i) => module ? `
                                        <div style="background: rgba(125, 244, 198, 0.1); border: 1px solid var(--success); border-radius: 6px; padding: 0.5rem; margin-top: 0.25rem;">
                                            <div style="color: var(--success); font-weight: bold; font-size: 0.8rem;">${module.name}</div>
                                            <div style="color: var(--muted); font-size: 0.7rem;">${module.description}</div>
                                        </div>
                                    ` : '').join('')}
                                </div>
                            ` : ''}
                        </div>
                    `;
                }
            }
            
            detailsContainer.innerHTML = detailsHTML;
        }

        function showUnpurchasedError() {
            showModal('Часть не куплена', `
                <div style="text-align: center; padding: 1rem;">
                    <p style="color: var(--danger); font-size: 1.1rem; margin-bottom: 1rem;">❌ Эта часть импланта не куплена!</p>
                    <p style="color: var(--muted); margin-bottom: 1rem;">Купите её в магазине частей имплантов.</p>
                    <button class="pill-button" onclick="closeModal(this)">Закрыть</button>
                </div>
            `);
        }

        // Вспомогательные функции для имплантов
        function getImplantName(type) {
            const names = {
                head: 'Кибер-голова',
                arms: 'Кибер-руки', 
                legs: 'Кибер-ноги',
                spine: 'Кибер-спина',
                organs: 'Кибер-внутренности',
                neuromodule: 'Нейромодуль'
            };
            return names[type] || type;
        }

        function getImplantDescription(type) {
            const descriptions = {
                head: 'Замена головы с сохранением мозга, слуха и зрения',
                arms: 'Замена рук с независимыми частями',
                legs: 'Замена ног с независимыми частями', 
                spine: 'Замена мышечного каркаса спины и тела',
                organs: 'Замена или дублирование внутренних органов',
                neuromodule: 'Нейросеть для передачи информации в мозг'
            };
            return descriptions[type] || '';
        }

        function getPartDisplayName(implantType, partName) {
            const partNames = {
                head: { 
                    main: 'Полная замена головы'
                },
                arms: { 
                    wristLeft: 'Кисть левая', 
                    wristRight: 'Кисть правая',
                    forearmLeft: 'Предплечье левое', 
                    forearmRight: 'Предплечье правое',
                    shoulderLeft: 'Плечо левое', 
                    shoulderRight: 'Плечо правое'
                },
                legs: { 
                    footLeft: 'Стопа левая', 
                    footRight: 'Стопа правая',
                    shinLeft: 'Голень левая', 
                    shinRight: 'Голень правая',
                    thighLeft: 'Бедро левое', 
                    thighRight: 'Бедро правое'
                },
                spine: { cervical: 'Шейная', thoracicLeft: 'Грудная левая', thoracicRight: 'Грудная правая', lumbar: 'Поясничная', sacral: 'Крестцовая' },
                organs: { main: 'Внутренние органы' },
                neuromodule: { main: 'Нейронная сеть' }
            };
            return partNames[implantType]?.[partName] || partName;
        }

        function manageSlot(implantType, partName, slotIndex) {
            // Показываем модал для управления слотом
            showSlotManagement(implantType, partName, slotIndex);
        }

        function showSlotManagement(implantType, partName, slotIndex) {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            const existingModals = document.querySelectorAll('.modal-overlay');
            modal.style.zIndex = 1000 + (existingModals.length * 100);
            
            const implant = state.implants[implantType];
            const part = implant.parts[partName];
            
            // Проверяем, куплена ли эта конкретная часть
            if (!part || !part.slots) {
                modal.innerHTML = `
                    <div class="modal" style="max-width: 600px;">
                        <div class="modal-header">
                            <h3>Ошибка</h3>
                            <button class="icon-button" onclick="closeModal(this)">×</button>
                        </div>
                        <div class="modal-body">
                            <p style="color: var(--danger); text-align: center; padding: 2rem;">
                                Эта часть импланта не куплена!<br>
                                Купите "${getPartDisplayName(implantType, partName)}" в магазине частей имплантов.
                            </p>
                        </div>
                        <div class="modal-footer">
                            <button class="pill-button" onclick="closeModal(this)">Закрыть</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
                return;
            }
            
            const currentModule = part.modules[slotIndex];
            
            let slotHTML = `
                <div class="modal" style="max-width: 600px;">
                    <div class="modal-header">
                        <h3>Управление слотом</h3>
                        <button class="icon-button" onclick="closeModal(this)">×</button>
                    </div>
                    <div class="modal-body">
                        <p style="color: var(--muted); margin-bottom: 1rem;">
                            ${getImplantName(implantType)} → ${getPartDisplayName(implantType, partName)} → Слот ${slotIndex + 1}
                        </p>
            `;
            
            if (currentModule) {
                slotHTML += `
                    <div style="background: rgba(125, 244, 198, 0.1); border: 1px solid var(--success); border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
                        <h5 style="color: var(--success); margin-bottom: 0.5rem;">Установленный модуль:</h5>
                        <p style="color: var(--text); font-weight: 600;">${currentModule.name}</p>
                        <p style="color: var(--muted); font-size: 0.9rem;">${currentModule.description}</p>
                        <button class="pill-button danger-button" onclick="removeModuleFromSlot('${implantType}', '${partName}', ${slotIndex}); closeModal(this);" style="margin-top: 0.5rem;">Удалить модуль</button>
                    </div>
                `;
            } else {
                slotHTML += `
                    <div style="background: rgba(182, 103, 255, 0.1); border: 1px solid var(--border); border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
                        <h5 style="color: var(--accent); margin-bottom: 0.5rem;">Свободный слот</h5>
                        <div class="drop-zone" data-implant-type="${implantType}" data-part-name="${partName}" data-slot-index="${slotIndex}" style="background: rgba(125, 244, 198, 0.1); border: 2px dashed var(--success); border-radius: 8px; padding: 2rem; text-align: center; margin-bottom: 1rem; min-height: 80px; display: flex; align-items: center; justify-content: center;">
                            <p style="color: var(--success); font-weight: 600; margin: 0;">Перетащите модуль сюда</p>
                        </div>
                        <p style="color: var(--muted);">Или выберите модуль для установки:</p>
                        <div id="availableModules" style="max-height: 300px; overflow-y: auto;">
                            <!-- Модули из снаряжения будут загружены здесь -->
                        </div>
                    </div>
                `;
            }
            
            slotHTML += `
                    </div>
                    <div class="modal-footer">
                        <button class="pill-button" onclick="closeModal(this)">Закрыть</button>
                    </div>
                </div>
            `;
            
            modal.innerHTML = slotHTML;
            document.body.appendChild(modal);
            
            // Загружаем доступные модули
            loadAvailableModules(implantType, partName, slotIndex);
            
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closeModal(modal.querySelector('.icon-button'));
                }
            });
        }

        function loadAvailableModules(implantType, partName, slotIndex) {
            const container = document.getElementById('availableModules');
            if (!container) return;
            
            // Ищем модули в снаряжении
            const availableModules = state.gear.filter(item => item.type === 'implant');
            
            if (availableModules.length === 0) {
                container.innerHTML = '<p style="color: var(--muted); text-align: center; padding: 1rem;">Нет доступных модулей в снаряжении</p>';
                return;
            }
            
            container.innerHTML = availableModules.map((module, index) => `
                <div class="draggable-module" draggable="true" data-module-index="${state.gear.findIndex(item => item === module)}" style="background: rgba(0,0,0,0.3); border: 1px solid var(--border); border-radius: 8px; padding: 0.75rem; margin-bottom: 0.5rem; cursor: grab;">
                    <div style="color: var(--text); font-weight: 600;">${module.implantData.name}</div>
                    <div style="color: var(--muted); font-size: 0.8rem;">${module.implantData.description}</div>
                    <div style="margin-top: 0.5rem;">
                        <button class="pill-button success-button" onclick="installModuleInSlot('${implantType}', '${partName}', ${slotIndex}, ${state.gear.findIndex(item => item === module)}); closeModal(this);" style="font-size: 0.8rem; padding: 0.3rem 0.6rem;">
                            Установить
                        </button>
                    </div>
                </div>
            `).join('');
            
            // Добавляем обработчики drag & drop
            addDragAndDropHandlers(implantType, partName, slotIndex);
        }

        function addDragAndDropHandlers(implantType, partName, slotIndex) {
            // Обработчики для перетаскиваемых модулей
            const draggableModules = document.querySelectorAll('.draggable-module');
            draggableModules.forEach(module => {
                module.addEventListener('dragstart', (e) => {
                    e.dataTransfer.setData('text/plain', module.dataset.moduleIndex);
                    module.style.opacity = '0.5';
                });
                
                module.addEventListener('dragend', (e) => {
                    module.style.opacity = '1';
                });
            });
            
            // Обработчики для drop zone
            const dropZone = document.querySelector('.drop-zone');
            if (dropZone) {
                dropZone.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    dropZone.style.background = 'rgba(125, 244, 198, 0.3)';
                    dropZone.style.borderColor = 'var(--success)';
                });
                
                dropZone.addEventListener('dragleave', (e) => {
                    dropZone.style.background = 'rgba(125, 244, 198, 0.1)';
                    dropZone.style.borderColor = 'var(--success)';
                });
                
                dropZone.addEventListener('drop', (e) => {
                    e.preventDefault();
                    dropZone.style.background = 'rgba(125, 244, 198, 0.1)';
                    dropZone.style.borderColor = 'var(--success)';
                    
                    const moduleIndex = e.dataTransfer.getData('text/plain');
                    if (moduleIndex) {
                        installModuleInSlot(implantType, partName, slotIndex, parseInt(moduleIndex));
                        closeModal(document.querySelector('.modal-overlay .icon-button'));
                    }
                });
            }
        }

        function installModuleInSlot(implantType, partName, slotIndex, gearIndex) {
            const module = state.gear[gearIndex];
            if (!module) return;
            
            // Устанавливаем модуль в слот
            state.implants[implantType].parts[partName].modules[slotIndex] = module.implantData;
            
            // Удаляем модуль из снаряжения
            state.gear.splice(gearIndex, 1);
            
            // Обновляем отображение
            renderGear();
            renderImplants();
            scheduleSave();
            
            // Обновляем слот в DOM
            const slotElement = document.querySelector(`[data-implant-type="${implantType}"][data-part-name="${partName}"][data-slot-index="${slotIndex}"]`);
            if (slotElement) {
                slotElement.style.background = 'rgba(125, 244, 198, 0.3)';
                slotElement.style.borderColor = 'var(--success)';
                slotElement.innerHTML = '✓';
            }
            
            showModal('Модуль установлен', `✅ ${module.implantData.name} установлен в слот!`);
        }

        function removeModuleFromSlot(implantType, partName, slotIndex) {
            const module = state.implants[implantType].parts[partName].modules[slotIndex];
            if (!module) return;
            
            // Возвращаем модуль в снаряжение
            state.gear.push({
                name: module.name,
                description: `${module.description} | Потеря осознанности: ${module.awarenessLoss}`,
                price: module.price,
                load: 1,
                type: 'implant',
                implantData: module
            });
            
            // Удаляем модуль из слота
            state.implants[implantType].parts[partName].modules[slotIndex] = null;
            
            // Обновляем отображение
            renderGear();
            renderImplants();
            scheduleSave();
            
            showModal('Модуль удален', `✅ ${module.name} возвращен в снаряжение!`);
        }

        // Магазин частей имплантов
        function showImplantPartsShop() {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            const existingModals = document.querySelectorAll('.modal-overlay');
            modal.style.zIndex = 1000 + (existingModals.length * 100);
            
            const implantParts = [
                {
                    category: 'head',
                    name: 'Кибер-Голова',
                    description: 'Сложнейшая операция заменяет на имплант голову, сохраняя мозг, слуховой и зрительный каналы. Имеет 4 слота для зрения, 4 для слуха и 2 для лица.',
                    price: 1000,
                    awarenessLoss: '2d6',
                    parts: [
                        { name: 'main', displayName: 'Полная замена головы', slots: 10 }
                    ]
                },
                {
                    category: 'arms',
                    name: 'Кибер-Рука',
                    description: 'Замена человеческой руки. Состоит из 3х частей: кисть, предплечье и плечо, каждое можно устанавливать отдельно.',
                    price: 100,
                    awarenessLoss: '1d6',
                    parts: [
                        { name: 'wristLeft', displayName: 'Кисть левая', slots: 2 },
                        { name: 'wristRight', displayName: 'Кисть правая', slots: 2 },
                        { name: 'forearmLeft', displayName: 'Предплечье левое', slots: 2 },
                        { name: 'forearmRight', displayName: 'Предплечье правое', slots: 2 },
                        { name: 'shoulderLeft', displayName: 'Плечо левое', slots: 2 },
                        { name: 'shoulderRight', displayName: 'Плечо правое', slots: 2 }
                    ]
                },
                {
                    category: 'legs',
                    name: 'Кибер-Нога',
                    description: 'Замена человеческой ноги. Состоит из 3х частей: стопа, голень и бедро, каждое можно устанавливать отдельно.',
                    price: 100,
                    awarenessLoss: '1d6',
                    parts: [
                        { name: 'footLeft', displayName: 'Стопа левая', slots: 2 },
                        { name: 'footRight', displayName: 'Стопа правая', slots: 2 },
                        { name: 'shinLeft', displayName: 'Голень левая', slots: 2 },
                        { name: 'shinRight', displayName: 'Голень правая', slots: 2 },
                        { name: 'thighLeft', displayName: 'Бедро левое', slots: 2 },
                        { name: 'thighRight', displayName: 'Бедро правое', slots: 2 }
                    ]
                },
                {
                    category: 'spine',
                    name: 'Кибер-Спина',
                    description: 'Имплант, заменяющий мышечный каркас спины и тела. Состоит из 5 частей: шейная, грудная левая и правая, поясничная, крестцовая.',
                    price: 500,
                    awarenessLoss: '1d6',
                    parts: [
                        { name: 'cervical', displayName: 'Шейная', slots: 3 },
                        { name: 'thoracicLeft', displayName: 'Грудная левая', slots: 3 },
                        { name: 'thoracicRight', displayName: 'Грудная правая', slots: 3 },
                        { name: 'lumbar', displayName: 'Поясничная', slots: 3 },
                        { name: 'sacral', displayName: 'Крестцовая', slots: 3 }
                    ]
                },
                {
                    category: 'organs',
                    name: 'Кибер-Внутренности',
                    description: 'Имплант, замещающий внутренние органы, или дублирующий их. Возможно заменить вообще все органы кибернетическими.',
                    price: 1000,
                    awarenessLoss: '4d6',
                    parts: [{ name: 'main', displayName: 'Внутренние органы', slots: 2 }]
                },
                {
                    category: 'neuromodule',
                    name: 'Нейро-модуль',
                    description: 'Модуль нейронной сети, находящийся в шее на сочленении спинного и головного мозга. Позволяет передавать в мозг информацию.',
                    price: 500,
                    awarenessLoss: '1d6',
                    parts: [{ name: 'main', displayName: 'Нейронная сеть', slots: 7 }]
                }
            ];
            
            let shopHTML = `
                <div class="modal" style="max-width: 800px;">
                    <div class="modal-header">
                        <h3>🦾 Магазин частей имплантов</h3>
                        <button class="icon-button" onclick="closeModal(this)">×</button>
                    </div>
                    <div class="modal-body">
                        <p style="color: var(--muted); margin-bottom: 1.5rem;">
                            Выберите часть импланта для покупки. Каждая часть может быть установлена отдельно.
                        </p>
                        <div style="display: grid; gap: 1rem;">
            `;
            
            implantParts.forEach(implant => {
                shopHTML += `
                    <div style="background: rgba(182, 103, 255, 0.1); border: 1px solid var(--border); border-radius: 12px; padding: 1rem;">
                        <h4 style="color: var(--accent); margin-bottom: 0.5rem;">${implant.name}</h4>
                        <p style="color: var(--muted); font-size: 0.9rem; margin-bottom: 1rem;">${implant.description}</p>
                        <div style="display: grid; gap: 0.5rem;">
                `;
                
                implant.parts.forEach(part => {
                    const partData = state.implants[implant.category].parts[part.name];
                    const isPurchased = partData !== null && partData !== undefined;
                    const purchasedText = isPurchased ? ' (куплена)' : '';
                    
                    shopHTML += `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem; background: rgba(0, 0, 0, 0.2); border-radius: 8px;">
                            <div>
                                <strong>${part.displayName}${purchasedText}</strong>
                                <div style="color: var(--muted); font-size: 0.8rem;">
                                    ${part.slots} слотов | Цена: ${implant.price} уе | ПО: ${implant.awarenessLoss}
                                </div>
                            </div>
                            ${isPurchased ? 
                                '<button class="pill-button" disabled style="font-size: 0.8rem; padding: 0.3rem 0.6rem; opacity: 0.6; cursor: not-allowed;">Куплено</button>' :
                                `<button class="pill-button primary-button" onclick="buyImplantPart('${implant.category}', '${part.name}', '${implant.name}', '${part.displayName}', ${implant.price}, '${implant.awarenessLoss}', '${implant.description.replace(/'/g, "\\'")}', ${part.slots})" style="font-size: 0.8rem; padding: 0.3rem 0.6rem;">Купить</button>`
                            }
                        </div>
                    `;
                });
                
                shopHTML += `
                        </div>
                    </div>
                `;
            });
            
            shopHTML += `
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="pill-button" onclick="closeModal(this)">Закрыть</button>
                    </div>
                </div>
            `;
            
            modal.innerHTML = shopHTML;
            document.body.appendChild(modal);
            
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closeModal(modal.querySelector('.icon-button'));
                }
            });
        }

        function buyImplantPart(category, partName, implantName, partDisplayName, price, awarenessLoss, description, slots) {
            const currentMoney = parseInt(state.money) || 0;
            
            if (currentMoney < price) {
                showModal('Недостаточно денег', `
                    <div style="text-align: center; padding: 1rem;">
                        <p style="color: var(--danger); font-size: 1.1rem; margin-bottom: 1rem;">Ха-ха, не так быстро, нищюк!</p>
                        <button class="pill-button" onclick="closeModal(this)">
                            Закрыть
                        </button>
                    </div>
                `);
                return;
            }
            
            // Бросаем кубики для потери осознанности
            const lossRoll = rollDiceForAwarenessLoss(awarenessLoss);
            
            // Списываем деньги
            state.money = currentMoney - price;
            updateMoneyDisplay();
            
            // Вычитаем из текущей осознанности
            let currentAwareness;
            if (typeof state.awareness === 'object') {
                currentAwareness = parseInt(state.awareness.current) || 50;
                state.awareness.current = Math.max(0, currentAwareness - lossRoll);
            } else {
                // Для старых сохранений где awareness - число
                currentAwareness = parseInt(state.awareness) || 50;
                state.awareness = {
                    current: Math.max(0, currentAwareness - lossRoll),
                    max: parseInt(state.stats.INT || 5) * 10
                };
            }
            
            const awarenessEl = document.getElementById('awarenessCurrent');
            if (awarenessEl) awarenessEl.value = state.awareness.current;
            
            // Устанавливаем часть импланта
            state.implants[category].installed = true;
            state.implants[category].parts[partName] = {
                slots: slots,
                modules: new Array(slots).fill(null)
            };
            
            scheduleSave();
            
            closeModal(document.querySelector('.modal-overlay .icon-button'));
            
            showModal('Часть импланта установлена', `
                <div style="text-align: center; padding: 1rem;">
                    <p style="color: var(--success); font-size: 1.1rem; margin-bottom: 1rem;">✅ ${partDisplayName} установлена!</p>
                    <p style="color: var(--danger); margin-bottom: 1rem;">Потеря осознанности: ${lossRoll}</p>
                    <p style="color: var(--muted);">Текущая осознанность: ${typeof state.awareness === 'object' ? state.awareness.current : state.awareness}</p>
                    <p style="color: var(--muted);">Теперь вы можете установить модули через "Управление имплантами"</p>
                    <button class="pill-button" onclick="closeModal(this)">
                        Закрыть
                    </button>
                </div>
            `);
        }

        // Функции для работы с оружием
        function renderWeapons() {
            const container = document.getElementById('weaponsContainer');
            if (!container) return;
            
            if (state.weapons.length === 0) {
                container.innerHTML = '<p style="color: var(--muted); text-align: center; padding: 2rem;">Оружие не добавлено</p>';
                return;
            }
            
            container.innerHTML = state.weapons.map((weapon, index) => `
                <div class="weapon-item">
                    <div class="weapon-header">
                        <div class="weapon-name">${weapon.name}</div>
                        <button class="pill-button danger-button" onclick="removeWeapon(${index})" style="font-size: 0.8rem; padding: 0.3rem 0.6rem;">Удалить</button>
                    </div>
                    <div class="weapon-stats">
                        <div class="weapon-stat"><strong>Урон:</strong> ${weapon.damage}</div>
                        <div class="weapon-stat"><strong>Точность:</strong> ${weapon.accuracy}</div>
                        <div class="weapon-stat"><strong>Отдача:</strong> ${weapon.recoil}</div>
                        <div class="weapon-stat"><strong>Обойма:</strong> ${weapon.magazine}</div>
                        <div class="weapon-stat"><strong>Макс урон:</strong> ${weapon.maxDamage || 'N/A'}</div>
                    </div>
                    ${weapon.notes ? `<div class="weapon-notes">${weapon.notes}</div>` : ''}
                </div>
            `).join('');
        }

        function addWeapon() {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            const existingModals = document.querySelectorAll('.modal-overlay');
            modal.style.zIndex = 1000 + (existingModals.length * 100);
            modal.innerHTML = `
                <div class="modal" style="max-width: 600px;">
                    <div class="modal-header">
                        <h3>🔫 Добавить оружие</h3>
                        <button class="icon-button" onclick="closeModal(this)">×</button>
                    </div>
                    <div class="modal-body">
                        <div style="display: grid; gap: 1rem;">
                            <div class="input-group">
                                <label class="input-label">Название оружия</label>
                                <input type="text" class="input-field" id="weaponName" placeholder="Например: «M16A4»">
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                <div class="input-group">
                                    <label class="input-label">Урон</label>
                                    <input type="text" class="input-field" id="weaponDamage" placeholder="Например: 1d6+2">
                                </div>
                                <div class="input-group">
                                    <label class="input-label">Точность</label>
                                    <input type="number" class="input-field" id="weaponAccuracy" value="0" placeholder="+/-">
                                </div>
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                <div class="input-group">
                                    <label class="input-label">Отдача</label>
                                    <input type="number" class="input-field" id="weaponRecoil" value="0" placeholder="+/-">
                                </div>
                                <div class="input-group">
                                    <label class="input-label">Обойма</label>
                                    <input type="number" class="input-field" id="weaponMagazine" value="10" placeholder="Патронов">
                                </div>
                            </div>
                            <div class="input-group">
                                <label class="input-label">Макс урон (опционально)</label>
                                <input type="text" class="input-field" id="weaponMaxDamage" placeholder="Например: 1d8">
                            </div>
                            <div class="input-group">
                                <label class="input-label">Заметки</label>
                                <textarea class="input-field" id="weaponNotes" rows="3" placeholder="Дополнительные заметки об оружии"></textarea>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="pill-button primary-button" onclick="saveWeapon()">
                            Добавить
                        </button>
                        <button class="pill-button" onclick="closeModal(this)">
                            Отмена
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closeModal(modal.querySelector('.icon-button'));
                }
            });
        }

        function saveWeapon() {
            const name = document.getElementById('weaponName').value;
            const damage = document.getElementById('weaponDamage').value;
            const accuracy = document.getElementById('weaponAccuracy').value;
            const recoil = document.getElementById('weaponRecoil').value;
            const magazine = document.getElementById('weaponMagazine').value;
            const maxDamage = document.getElementById('weaponMaxDamage').value;
            const notes = document.getElementById('weaponNotes').value;
            
            if (!name || !damage) {
                showModal('Ошибка', `
                    <div style="text-align: center; padding: 1rem;">
                        <p style="color: var(--danger);">Заполните обязательные поля (Название и Урон)!</p>
                        <button class="pill-button" onclick="closeModal(this)">Закрыть</button>
                    </div>
                `);
                return;
            }
            
            const newWeapon = {
                id: generateId('weapon'),
                name: name,
                damage: damage,
                accuracy: accuracy,
                recoil: recoil,
                magazine: magazine,
                maxDamage: maxDamage,
                notes: notes
            };
            
            state.weapons.push(newWeapon);
            renderWeapons();
            scheduleSave();
            
            closeModal(document.querySelector('.modal-overlay .icon-button'));
            
            showModal('Оружие добавлено', `
                <div style="text-align: center; padding: 1rem;">
                    <p style="color: var(--success); font-size: 1.1rem; margin-bottom: 1rem;">✅ ${name} добавлено!</p>
                    <button class="pill-button" onclick="closeModal(this)">Закрыть</button>
                </div>
            `);
        }

        function removeWeapon(index) {
            if (confirm('Удалить оружие?')) {
                state.weapons.splice(index, 1);
                renderWeapons();
                scheduleSave();
            }
        }

        // Функции для работы с собственностью
        function renderHousing() {
            const container = document.getElementById('housingContainer');
            if (!container) return;
            
            if (state.property.housing.length === 0) {
                container.innerHTML = '<p style="color: var(--muted); text-align: center; padding: 1rem;">Жилье не добавлено</p>';
                return;
            }
            
            container.innerHTML = state.property.housing.map((house, index) => `
                <div class="property-item">
                    <div class="property-header">
                        <div class="property-name">${house.name}</div>
                        <button class="pill-button danger-button" onclick="removeHousing(${index})" style="font-size: 0.8rem; padding: 0.3rem 0.6rem;">Удалить</button>
                    </div>
                    ${house.description ? `<div class="property-description">${house.description}</div>` : ''}
                </div>
            `).join('');
        }

        function renderVehicles() {
            const container = document.getElementById('vehiclesContainer');
            if (!container) return;
            
            if (state.property.vehicles.length === 0) {
                container.innerHTML = '<p style="color: var(--muted); text-align: center; padding: 1rem;">Транспорт не добавлен</p>';
                return;
            }
            
            container.innerHTML = state.property.vehicles.map((vehicle, index) => `
                <div class="property-item">
                    <div class="property-header">
                        <div class="property-name">${vehicle.name}</div>
                        <button class="pill-button danger-button" onclick="removeVehicle(${index})" style="font-size: 0.8rem; padding: 0.3rem 0.6rem;">Удалить</button>
                    </div>
                    ${vehicle.description ? `<div class="property-description">${vehicle.description}</div>` : ''}
                    ${vehicle.image ? `
                        <div class="vehicle-image-wrapper">
                            <div class="vehicle-image">
                                <img src="${vehicle.image}" alt="${vehicle.name}" />
                            </div>
                            <div class="vehicle-image-actions">
                                <button class="pill-button danger-button" onclick="removeVehicleImage(${index})" style="font-size: 0.8rem; padding: 0.3rem 0.6rem;">🗑️ Удалить фото</button>
                            </div>
                        </div>
                    ` : `
                        <div class="vehicle-image-wrapper">
                            <div class="vehicle-image">
                                <div class="vehicle-image-placeholder">🚗</div>
                            </div>
                            <div class="vehicle-image-actions">
                                <label class="pill-button muted-button" style="cursor: pointer; font-size: 0.8rem; padding: 0.3rem 0.6rem;">
                                    📷 Загрузить фото
                                    <input type="file" accept="image/*" onchange="uploadVehicleImage(${index}, this)" style="display: none;" />
                                </label>
                            </div>
                        </div>
                    `}
                </div>
            `).join('');
        }

        function addHousing() {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            const existingModals = document.querySelectorAll('.modal-overlay');
            modal.style.zIndex = 1000 + (existingModals.length * 100);
            modal.innerHTML = `
                <div class="modal" style="max-width: 500px;">
                    <div class="modal-header">
                        <h3>🏠 Добавить жилье</h3>
                        <button class="icon-button" onclick="closeModal(this)">×</button>
                    </div>
                    <div class="modal-body">
                        <div style="display: grid; gap: 1rem;">
                            <div class="input-group">
                                <label class="input-label">Название</label>
                                <input type="text" class="input-field" id="housingName" placeholder="Например: «Квартира на окраине»">
                            </div>
                            <div class="input-group">
                                <label class="input-label">Описание</label>
                                <textarea class="input-field" id="housingDescription" rows="3" placeholder="Описание жилья"></textarea>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="pill-button primary-button" onclick="saveHousing()">Добавить</button>
                        <button class="pill-button" onclick="closeModal(this)">Отмена</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closeModal(modal.querySelector('.icon-button'));
                }
            });
        }

        function saveHousing() {
            const name = document.getElementById('housingName').value;
            const description = document.getElementById('housingDescription').value;
            
            if (!name) {
                showModal('Ошибка', `
                    <div style="text-align: center; padding: 1rem;">
                        <p style="color: var(--danger);">Введите название жилья!</p>
                        <button class="pill-button" onclick="closeModal(this)">Закрыть</button>
                    </div>
                `);
                return;
            }
            
            const newHousing = {
                id: generateId('housing'),
                name: name,
                description: description
            };
            
            state.property.housing.push(newHousing);
            renderHousing();
            scheduleSave();
            
            closeModal(document.querySelector('.modal-overlay .icon-button'));
        }

        function removeHousing(index) {
            if (confirm('Удалить жилье?')) {
                state.property.housing.splice(index, 1);
                renderHousing();
                scheduleSave();
            }
        }

        function addVehicle() {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            const existingModals = document.querySelectorAll('.modal-overlay');
            modal.style.zIndex = 1000 + (existingModals.length * 100);
            modal.innerHTML = `
                <div class="modal" style="max-width: 500px;">
                    <div class="modal-header">
                        <h3>🚗 Добавить транспорт</h3>
                        <button class="icon-button" onclick="closeModal(this)">×</button>
                    </div>
                    <div class="modal-body">
                        <div style="display: grid; gap: 1rem;">
                            <div class="input-group">
                                <label class="input-label">Название</label>
                                <input type="text" class="input-field" id="vehicleName" placeholder="Например: «Harley-Davidson»">
                            </div>
                            <div class="input-group">
                                <label class="input-label">Описание</label>
                                <textarea class="input-field" id="vehicleDescription" rows="3" placeholder="Описание транспорта"></textarea>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="pill-button primary-button" onclick="saveVehicle()">Добавить</button>
                        <button class="pill-button" onclick="closeModal(this)">Отмена</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closeModal(modal.querySelector('.icon-button'));
                }
            });
        }

        function saveVehicle() {
            const name = document.getElementById('vehicleName').value;
            const description = document.getElementById('vehicleDescription').value;
            
            if (!name) {
                showModal('Ошибка', `
                    <div style="text-align: center; padding: 1rem;">
                        <p style="color: var(--danger);">Введите название транспорта!</p>
                        <button class="pill-button" onclick="closeModal(this)">Закрыть</button>
                    </div>
                `);
                return;
            }
            
            const newVehicle = {
                id: generateId('vehicle'),
                name: name,
                description: description,
                image: null
            };
            
            state.property.vehicles.push(newVehicle);
            renderVehicles();
            scheduleSave();
            
            closeModal(document.querySelector('.modal-overlay .icon-button'));
        }

        function removeVehicle(index) {
            if (confirm('Удалить транспорт?')) {
                state.property.vehicles.splice(index, 1);
                renderVehicles();
                scheduleSave();
            }
        }

        function uploadVehicleImage(index, input) {
            const file = input.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    state.property.vehicles[index].image = e.target.result;
                    renderVehicles();
                    scheduleSave();
                };
                reader.readAsDataURL(file);
            }
        }

        function removeVehicleImage(index) {
            if (confirm('Удалить изображение транспорта?')) {
                state.property.vehicles[index].image = null;
                renderVehicles();
                scheduleSave();
            }
        }

        // Функции для работы со снаряжением
        function renderGear() {
            const container = document.getElementById('gearContainer');
            if (!container) return;
            
            if (state.gear.length === 0) {
                container.innerHTML = '<p style="color: var(--muted); text-align: center; padding: 2rem;">Снаряжение не добавлено</p>';
                return;
            }
            
            container.innerHTML = state.gear.map((item, index) => `
                <div class="property-item">
                    <div class="property-header">
                        <div class="property-name">${item.name}</div>
                        <div style="display: flex; gap: 0.5rem; align-items: center;">
                            <span style="color: var(--muted); font-size: 0.9rem;">Нагрузка: ${item.load}</span>
                            <button class="pill-button danger-button" onclick="removeGear(${index})" style="font-size: 0.8rem; padding: 0.3rem 0.6rem;">Удалить</button>
                        </div>
                    </div>
                    ${item.description ? `<div class="property-description">${item.description}</div>` : ''}
                </div>
            `).join('');
            
            updateLoadDisplay();
        }

        // Перенос оружия из Снаряжения в блок "Оружие"
        function takeWeaponFromGear(gearIndex) {
            const item = state.gear[gearIndex];
            if (!item || item.type !== 'weapon') return;
            const weaponData = item.weaponData;
            if (!weaponData) {
                showModal('Ошибка', 'Нет данных оружия для переноса.');
                return;
            }

            // Гарантируем id и слоты
            const weaponToAdd = Object.assign({}, weaponData);
            weaponToAdd.id = generateId('weapon');
            if (weaponToAdd.type === 'ranged') {
                if (typeof weaponToAdd.slots !== 'number') {
                    weaponToAdd.slots = getRangedWeaponSlots(item.name || '');
                }
                if (!Array.isArray(weaponToAdd.modules)) {
                    weaponToAdd.modules = [];
                }
            } else {
                // ближний бой: 1 слот по правилам
                weaponToAdd.slots = 1;
                if (!Array.isArray(weaponToAdd.modules)) {
                    weaponToAdd.modules = [];
                }
            }

            state.weapons.push(weaponToAdd);
            state.gear.splice(gearIndex, 1);
            renderGear();
            renderWeapons();
            scheduleSave();
            showModal('Оружие взято', `✅ ${item.name} перенесено в блок Оружие!`);
        }

        function updateLoadDisplay() {
            // Обновляем отображение нагрузки
            const currentLoadEl = document.getElementById('currentLoad');
            const maxLoadEl = document.getElementById('maxLoad');
            
            if (currentLoadEl) currentLoadEl.textContent = state.load.current;
            if (maxLoadEl) maxLoadEl.textContent = state.load.max;
            
            // Показываем штраф под "Скорость перемещения" только если нагрузка меньше 0
            const speedWarningEl = document.getElementById('speedWarning');
            
            if (state.load.current < 0) {
                const penalty = Math.ceil(Math.abs(state.load.current) / 5);
                
                if (speedWarningEl) {
                    speedWarningEl.textContent = `Штраф ${penalty} от перегрузки!`;
                    speedWarningEl.style.display = 'block';
                    speedWarningEl.style.color = 'var(--danger)';
                    speedWarningEl.style.fontSize = '0.8rem';
                    speedWarningEl.style.fontWeight = '600';
                    speedWarningEl.style.marginTop = '0.25rem';
                }
            } else if (speedWarningEl) {
                speedWarningEl.style.display = 'none';
            }
        }

        function resetLoad() {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            const existingModals = document.querySelectorAll('.modal-overlay');
            modal.style.zIndex = 1000 + (existingModals.length * 100);
            modal.innerHTML = `
                <div class="modal" style="max-width: 400px;">
                    <div class="modal-header">
                        <h3>⚖️ Сброс нагрузки</h3>
                        <button class="icon-button" onclick="closeModal(this)">×</button>
                    </div>
                    <div class="modal-body">
                        <div style="margin-bottom: 1rem;">
                            <p style="color: var(--muted); font-size: 0.9rem; margin-bottom: 1rem;">
                                Текущая нагрузка: <strong style="color: var(--accent);">${state.load.current}</strong> / ${state.load.max}
                            </p>
                            <p style="color: var(--muted); font-size: 0.9rem; margin-bottom: 1rem;">
                                Общая нагрузка предметов: <strong style="color: var(--success);">${state.gear.reduce((sum, item) => sum + (item.load || 0), 0)}</strong>
                            </p>
                        </div>
                        
                        <div style="display: grid; gap: 0.75rem;">
                            <label class="field">
                                Новая текущая нагрузка
                                <input type="number" class="input-field" id="newLoadValue" value="${state.load.current}" min="0" max="${state.load.max}">
                            </label>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="pill-button primary-button" onclick="applyLoadReset()">
                            Применить
                        </button>
                        <button class="pill-button" onclick="closeModal(this)">
                            Отмена
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closeModal(modal.querySelector('.icon-button'));
                }
            });
        }

        function applyLoadReset() {
            const newLoad = parseInt(document.getElementById('newLoadValue').value);
            
            if (isNaN(newLoad) || newLoad < 0 || newLoad > state.load.max) {
                showModal('Ошибка', `
                    <div style="text-align: center; padding: 1rem;">
                        <p style="color: var(--danger);">Введите корректное значение нагрузки!</p>
                        <p style="color: var(--muted); font-size: 0.9rem;">Значение должно быть от 0 до ${state.load.max}</p>
                        <button class="pill-button" onclick="closeModal(this)">Закрыть</button>
                    </div>
                `);
                return;
            }
            
            state.load.current = newLoad;
            updateLoadDisplay();
            scheduleSave();
            
            closeModal(document.querySelector('.modal-overlay .icon-button'));
            showModal('Нагрузка обновлена', `✅ Текущая нагрузка установлена: ${newLoad}`);
        }

        function showGearShop() {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            const existingModals = document.querySelectorAll('.modal-overlay');
            modal.style.zIndex = 1000 + (existingModals.length * 100);
            modal.innerHTML = `
                <div class="modal" style="max-width: 800px; max-height: 90vh; overflow-y: auto;">
                    <div class="modal-header">
                        <h3>🎒 Магазин снаряжения</h3>
                        <button class="icon-button" onclick="closeModal(this)">×</button>
                    </div>
                    <div class="modal-body">
                        <div style="margin-bottom: 1rem;">
                            <input type="text" id="gearSearchInput" placeholder="🔍 Поиск по названию..." style="width: 100%; padding: 0.75rem; background: var(--panel); border: 1px solid var(--border); border-radius: 8px; color: var(--text); font-size: 1rem;" onkeyup="filterGear(this.value)">
                        </div>
                        <div style="display: grid; gap: 1rem;">
                            ${GEAR_LIBRARY.map((item) => `
                                <div class="property-item gear-item" data-name="${item.name.toLowerCase()}" data-description="${item.description.toLowerCase()}">
                                    <div class="property-header">
                                        <div class="property-name">${item.name}</div>
                                        <div style="display: flex; gap: 0.5rem; align-items: center;">
                                            <span style="color: var(--muted); font-size: 0.9rem;">Цена: ${item.price} уе | Нагрузка: ${item.load}</span>
                                            <button class="pill-button primary-button" onclick="buyGear('${item.name}', ${item.price}, ${item.load}, '${item.description.replace(/'/g, "\\'")}')" style="font-size: 0.8rem; padding: 0.3rem 0.6rem;">Купить</button>
                                        </div>
                                    </div>
                                    <div class="property-description">${item.description}</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closeModal(modal.querySelector('.icon-button'));
                }
            });
        }

        function filterGear(searchTerm) {
            const searchLower = searchTerm.toLowerCase();
            const gearItems = document.querySelectorAll('.gear-item');
            
            gearItems.forEach(item => {
                const name = item.dataset.name || '';
                const description = item.dataset.description || '';
                
                if (name.includes(searchLower) || description.includes(searchLower)) {
                    item.style.display = 'block';
                } else {
                    item.style.display = 'none';
                }
            });
        }

        function buyGear(name, price, load, description) {
            const currentMoney = parseInt(state.money) || 0;
            
            if (currentMoney < price) {
                showModal('Недостаточно денег', `
                    <div style="text-align: center; padding: 1rem;">
                        <p style="color: var(--danger); font-size: 1.1rem; margin-bottom: 1rem;">Не хватает денег!</p>
                    </div>
                `);
                return;
            }
            
            // Списываем деньги
            state.money = currentMoney - price;
            updateMoneyDisplay();
            
            // Уменьшаем доступную нагрузку
            state.load.current -= load;
            
            // Добавляем в снаряжение
            const newGear = {
                id: generateId('gear'),
                name: name,
                description: description,
                price: price,
                load: load
            };
            
            state.gear.push(newGear);
            renderGear();
            updateLoadDisplay();
            scheduleSave();
            
            closeModal(document.querySelector('.modal-overlay .icon-button'));
            
            showModal('Снаряжение куплено', `
                <div style="text-align: center; padding: 1rem;">
                    <p style="color: var(--success); font-size: 1.1rem; margin-bottom: 1rem;">✅ ${name} добавлено в снаряжение!</p>
                    <p style="color: var(--muted); font-size: 0.9rem;">Осталось нагрузки: ${state.load.current}</p>
                    <button class="pill-button" onclick="closeModal(this)">Закрыть</button>
                </div>
            `);
        }

        function forceBuyGear(name, price, load, description) {
            const currentMoney = parseInt(state.money) || 0;
            
            // Списываем деньги
            state.money = currentMoney - price;
            updateMoneyDisplay();
            
            // Уменьшаем доступную нагрузку (даже при перегрузке)
            state.load.current -= load;
            
            // Добавляем в снаряжение
            const newGear = {
                id: generateId('gear'),
                name: name,
                description: description,
                price: price,
                load: load
            };
            
            state.gear.push(newGear);
            renderGear();
            updateLoadDisplay();
            scheduleSave();
        }

        function pickupGear() {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            const existingModals = document.querySelectorAll('.modal-overlay');
            modal.style.zIndex = 1000 + (existingModals.length * 100);
            modal.innerHTML = `
                <div class="modal" style="max-width: 500px;">
                    <div class="modal-header">
                        <h3>📦 Подобрать снаряжение</h3>
                        <button class="icon-button" onclick="closeModal(this)">×</button>
                    </div>
                    <div class="modal-body">
                        <div style="display: grid; gap: 1rem;">
                            <div class="input-group">
                                <label class="input-label">Название</label>
                                <input type="text" class="input-field" id="pickedGearName" placeholder="Например: «Старый фонарик»">
                            </div>
                            <div class="input-group">
                                <label class="input-label">Нагрузка</label>
                                <input type="number" class="input-field" id="pickedGearLoad" value="1" min="0">
                            </div>
                            <div class="input-group">
                                <label class="input-label">Описание</label>
                                <textarea class="input-field" id="pickedGearDescription" rows="3" placeholder="Описание предмета"></textarea>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="pill-button primary-button" onclick="savePickedGear()">Подобрать</button>
                        <button class="pill-button" onclick="closeModal(this)">Отмена</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closeModal(modal.querySelector('.icon-button'));
                }
            });
        }

        function savePickedGear() {
            const name = document.getElementById('pickedGearName').value;
            const load = parseInt(document.getElementById('pickedGearLoad').value) || 0;
            const description = document.getElementById('pickedGearDescription').value;
            
            if (!name) {
                showModal('Ошибка', `
                    <div style="text-align: center; padding: 1rem;">
                        <p style="color: var(--danger);">Введите название предмета!</p>
                        <button class="pill-button" onclick="closeModal(this)">Закрыть</button>
                    </div>
                `);
                return;
            }
            
            
            // Уменьшаем доступную нагрузку
            state.load.current -= load;
            
            const newGear = {
                id: generateId('gear'),
                name: name,
                description: description,
                price: 0,
                load: load
            };
            
            state.gear.push(newGear);
            renderGear();
            updateLoadDisplay();
            scheduleSave();
            
            closeModal(document.querySelector('.modal-overlay .icon-button'));
        }

        function removeGear(index) {
            if (confirm('Удалить снаряжение?')) {
                const item = state.gear[index];
                if (item) {
                    // Возвращаем нагрузку
                    state.load.current += item.load || 0;
                    
                    // Удаляем предмет
                    state.gear.splice(index, 1);
                    
                    // Обновляем отображение
                    renderGear();
                    updateLoadDisplay();
                    scheduleSave();
                }
            }
        }

        // Функции для работы с оружием
        function showWeaponShop() {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            const existingModals = document.querySelectorAll('.modal-overlay');
            modal.style.zIndex = 1000 + (existingModals.length * 100);
            modal.innerHTML = `
                <div class="modal" style="max-width: 600px;">
                    <div class="modal-header">
                        <h3>🔫 Какое оружие ищешь?</h3>
                        <button class="icon-button" onclick="closeModal(this)">×</button>
                    </div>
                    <div class="modal-body">
                        <div style="display: grid; gap: 1rem;">
                            <button class="pill-button primary-button" onclick="closeModal(this); setTimeout(() => showMeleeWeaponsShop(), 100);" style="font-size: 1rem; padding: 1rem;">
                                ⚔️ Для ближнего боя
                            </button>
                            <button class="pill-button primary-button" onclick="closeModal(this); setTimeout(() => showRangedWeaponsShop(), 100);" style="font-size: 1rem; padding: 1rem;">
                                🔫 Для дальнего боя
                            </button>
                            <button class="pill-button success-button" onclick="closeModal(this); setTimeout(() => showCustomWeaponCreator(), 100);" style="font-size: 1rem; padding: 1rem;">
                                🔧 Создам своё!
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closeModal(modal.querySelector('.icon-button'));
                }
            });
        }

        function showMeleeWeaponsShop() {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            const existingModals = document.querySelectorAll('.modal-overlay');
            modal.style.zIndex = 1000 + (existingModals.length * 100);
            modal.innerHTML = `
                <div class="modal" style="max-width: 800px; max-height: 90vh; overflow-y: auto;">
                    <div class="modal-header">
                        <h3>⚔️ Оружие ближнего боя</h3>
                        <button class="icon-button" onclick="closeModal(this)">×</button>
                    </div>
                    <div class="modal-body">
                        <div style="display: grid; gap: 1rem;">
                            ${MELEE_WEAPONS.map((weapon) => `
                                <div class="property-item">
                                    <div class="property-header">
                                        <div class="property-name">${weapon.type}</div>
                                        <div style="display: flex; gap: 0.5rem; align-items: center;">
                                            <span style="color: var(--muted); font-size: 0.9rem;">Цена: ${weapon.price} уе | Нагрузка: ${weapon.load}</span>
                                            <button class="pill-button primary-button" onclick="buyMeleeWeapon('${weapon.type}', ${weapon.price}, ${weapon.load}, '${weapon.damage}', ${weapon.concealable}, '${weapon.stealthPenalty}', '${weapon.examples}')" style="font-size: 0.8rem; padding: 0.3rem 0.6rem;">Купить</button>
                                            <button class="pill-button success-button" onclick="buyMeleeWeaponToGear('${weapon.type}', ${weapon.price}, ${weapon.load}, '${weapon.damage}', ${weapon.concealable}, '${weapon.stealthPenalty}', '${weapon.examples}')" style="font-size: 0.8rem; padding: 0.3rem 0.6rem;">В сумку</button>
                                            <button class="pill-button muted-button" onclick="getMeleeWeaponFree('${weapon.type}', ${weapon.load}, '${weapon.damage}', ${weapon.concealable}, '${weapon.stealthPenalty}', '${weapon.examples}')" style="font-size: 0.8rem; padding: 0.3rem 0.6rem;">Бесплатно</button>
                                        </div>
                                    </div>
                                    <div class="property-description">
                                        <div style="font-family: monospace; font-size: 0.8rem; color: var(--muted); margin-bottom: 0.5rem;">
                                            Урон: ${weapon.damage} | Можно скрыть: ${formatYesNo(weapon.concealable)} | Штраф к СКА: ${weapon.stealthPenalty}
                                        </div>
                                        <div style="font-size: 0.9rem;">
                                            <strong>Примеры:</strong> ${weapon.examples}
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closeModal(modal.querySelector('.icon-button'));
                }
            });
        }

        function showRangedWeaponsShop() {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            const existingModals = document.querySelectorAll('.modal-overlay');
            modal.style.zIndex = 1000 + (existingModals.length * 100);
            modal.innerHTML = `
                <div class="modal" style="max-width: 800px; max-height: 90vh; overflow-y: auto;">
                    <div class="modal-header">
                        <h3>🔫 Оружие дальнего боя</h3>
                        <button class="icon-button" onclick="closeModal(this)">×</button>
                    </div>
                    <div class="modal-body">
                        <div style="display: grid; gap: 1rem;">
                            ${RANGED_WEAPONS.map((weapon) => `
                                <div class="property-item">
                                    <div class="property-header">
                                        <div class="property-name">${weapon.type}</div>
                                        <div style="display: flex; gap: 0.5rem; align-items: center;">
                                            <span style="color: var(--muted); font-size: 0.9rem;">Цена: ${weapon.price} уе | Нагрузка: ${weapon.load}</span>
                                            <button class="pill-button primary-button" onclick="buyRangedWeapon('${weapon.type}', ${weapon.price}, ${weapon.load}, '${weapon.primaryDamage}', '${weapon.altDamage}', ${weapon.concealable}, ${weapon.hands}, ${weapon.stealth}, '${weapon.magazine}')" style="font-size: 0.8rem; padding: 0.3rem 0.6rem;">Купить</button>
                                            <button class="pill-button success-button" onclick="buyRangedWeaponToGear('${weapon.type}', ${weapon.price}, ${weapon.load}, '${weapon.primaryDamage}', '${weapon.altDamage}', ${weapon.concealable}, ${weapon.hands}, ${weapon.stealth}, '${weapon.magazine}')" style="font-size: 0.8rem; padding: 0.3rem 0.6rem;">В сумку</button>
                                            <button class="pill-button muted-button" onclick="getRangedWeaponFree('${weapon.type}', ${weapon.load}, '${weapon.primaryDamage}', '${weapon.altDamage}', ${weapon.concealable}, ${weapon.hands}, ${weapon.stealth}, '${weapon.magazine}')" style="font-size: 0.8rem; padding: 0.3rem 0.6rem;">Бесплатно</button>
                                        </div>
                                    </div>
                                    <div class="property-description">
                                        <div style="font-family: monospace; font-size: 0.8rem; color: var(--muted); margin-bottom: 0.5rem;">
                                            Урон основной: ${weapon.primaryDamage} | Урон альтернативный: ${weapon.altDamage} | Можно скрыть: ${formatYesNo(weapon.concealable)} | # рук: ${weapon.hands} | СКА: ${weapon.stealth} | Патронов в магазине: ${weapon.magazine}
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closeModal(modal.querySelector('.icon-button'));
                }
            });
        }

        function showCustomWeaponCreator() {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            const existingModals = document.querySelectorAll('.modal-overlay');
            modal.style.zIndex = 1000 + (existingModals.length * 100);
            modal.innerHTML = `
                <div class="modal" style="max-width: 600px;">
                    <div class="modal-header">
                        <h3>🔧 Создание собственного оружия</h3>
                        <button class="icon-button" onclick="closeModal(this)">×</button>
                    </div>
                    <div class="modal-body">
                        <div style="display: grid; gap: 1rem;">
                            <button class="pill-button primary-button" onclick="showCustomMeleeWeaponForm(); closeModal(this);" style="font-size: 1rem; padding: 1rem;">
                                ⚔️ Оружие ближнего боя
                            </button>
                            <button class="pill-button primary-button" onclick="showCustomRangedWeaponForm(); closeModal(this);" style="font-size: 1rem; padding: 1rem;">
                                🔫 Оружие дальнего боя
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closeModal(modal.querySelector('.icon-button'));
                }
            });
        }

        function showCustomMeleeWeaponForm() {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            const existingModals = document.querySelectorAll('.modal-overlay');
            modal.style.zIndex = 1000 + (existingModals.length * 100);
            modal.innerHTML = `
                <div class="modal" style="max-width: 600px;">
                    <div class="modal-header">
                        <h3>⚔️ Создание оружия ближнего боя</h3>
                        <button class="icon-button" onclick="closeModal(this)">×</button>
                    </div>
                    <div class="modal-body">
                        <div style="display: grid; gap: 1rem;">
                            <div class="input-group">
                                <label class="input-label">Тип</label>
                                <input type="text" class="input-field" id="customMeleeType" placeholder="Например: Кастомный меч">
                            </div>
                            <div class="input-group">
                                <label class="input-label">Внешний вид</label>
                                <input type="text" class="input-field" id="customMeleeAppearance" placeholder="Описание внешнего вида">
                            </div>
                            <div class="input-group">
                                <label class="input-label">Урон (например: 2d6)</label>
                                <input type="text" class="input-field" id="customMeleeDamage" placeholder="2d6">
                            </div>
                            <div class="input-group">
                                <label class="input-label">Можно скрыть?</label>
                                <select class="input-field" id="customMeleeConcealable">
                                    <option value="true">Да</option>
                                    <option value="false">Нет</option>
                                </select>
                            </div>
                            <div class="input-group">
                                <label class="input-label">Штраф к СКА</label>
                                <input type="text" class="input-field" id="customMeleeStealthPenalty" placeholder="+1, 0, -1, -2">
                            </div>
                            <div class="input-group">
                                <label class="input-label">Цена</label>
                                <input type="number" class="input-field" id="customMeleePrice" placeholder="100" min="0">
                            </div>
                            <div class="input-group">
                                <label class="input-label">Нагрузка</label>
                                <input type="number" class="input-field" id="customMeleeLoad" placeholder="2" min="0">
                            </div>
                            <div class="input-group">
                                <label class="input-label">Описание</label>
                                <textarea class="input-field" id="customMeleeDescription" rows="3" placeholder="Подробное описание оружия"></textarea>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="pill-button primary-button" onclick="createCustomMeleeWeapon()">Создать</button>
                        <button class="pill-button" onclick="closeModal(this)">Отмена</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closeModal(modal.querySelector('.icon-button'));
                }
            });
        }

        function showCustomRangedWeaponForm() {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            const existingModals = document.querySelectorAll('.modal-overlay');
            modal.style.zIndex = 1000 + (existingModals.length * 100);
            modal.innerHTML = `
                <div class="modal" style="max-width: 600px;">
                    <div class="modal-header">
                        <h3>🔫 Создание оружия дальнего боя</h3>
                        <button class="icon-button" onclick="closeModal(this)">×</button>
                    </div>
                    <div class="modal-body">
                        <div style="display: grid; gap: 1rem;">
                            <div class="input-group">
                                <label class="input-label">Тип</label>
                                <input type="text" class="input-field" id="customRangedType" placeholder="Например: Кастомный пистолет">
                            </div>
                            <div class="input-group">
                                <label class="input-label">Урон основной (например: 5d4)</label>
                                <input type="text" class="input-field" id="customRangedPrimaryDamage" placeholder="5d4">
                            </div>
                            <div class="input-group">
                                <label class="input-label">Урон альтернативный (например: 3d6)</label>
                                <input type="text" class="input-field" id="customRangedAltDamage" placeholder="3d6">
                            </div>
                            <div class="input-group">
                                <label class="input-label">Можно скрыть?</label>
                                <select class="input-field" id="customRangedConcealable">
                                    <option value="true">Да</option>
                                    <option value="false">Нет</option>
                                </select>
                            </div>
                            <div class="input-group">
                                <label class="input-label"># рук</label>
                                <input type="number" class="input-field" id="customRangedHands" placeholder="1" min="1" max="2">
                            </div>
                            <div class="input-group">
                                <label class="input-label">СКА</label>
                                <input type="number" class="input-field" id="customRangedStealth" placeholder="2" min="1" max="2">
                            </div>
                            <div class="input-group">
                                <label class="input-label">Патронов в магазине</label>
                                <input type="text" class="input-field" id="customRangedMagazine" placeholder="9">
                            </div>
                            <div class="input-group">
                                <label class="input-label">Цена</label>
                                <input type="number" class="input-field" id="customRangedPrice" placeholder="200" min="0">
                            </div>
                            <div class="input-group">
                                <label class="input-label">Нагрузка</label>
                                <input type="number" class="input-field" id="customRangedLoad" placeholder="3" min="0">
                            </div>
                            <div class="input-group">
                                <label class="input-label">Описание</label>
                                <textarea class="input-field" id="customRangedDescription" rows="3" placeholder="Подробное описание оружия"></textarea>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="pill-button primary-button" onclick="createCustomRangedWeapon()">Создать</button>
                        <button class="pill-button" onclick="closeModal(this)">Отмена</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closeModal(modal.querySelector('.icon-button'));
                }
            });
        }

        // Функции покупки оружия ближнего боя
        function buyMeleeWeapon(type, price, load, damage, concealable, stealthPenalty, examples) {
            const currentMoney = parseInt(state.money) || 0;
            
            if (currentMoney < price) {
                showModal('Ошибка', `
                    <div style="text-align: center; padding: 1rem; background: var(--danger); color: white; border-radius: 8px;">
                        <p style="font-size: 1.1rem; margin-bottom: 1rem;">Нищим не продаём. Вали отсюда!</p>
                        <button class="pill-button" onclick="closeModal(this)">Понятно</button>
                    </div>
                `);
                return;
            }
            
          
            
            // Списываем деньги
            state.money = currentMoney - price;
            updateMoneyDisplay();
            
            // Уменьшаем доступную нагрузку
            state.load.current -= load;
            
            // Добавляем оружие
            const newWeapon = {
                id: generateId('weapon'),
                name: type,
                type: 'melee',
                damage: damage,
                concealable: concealable,
                stealthPenalty: stealthPenalty,
                examples: examples,
                price: price,
                load: load,
                modules: [],
                slots: 1 // У ОББ всегда 1 слот
            };
            
            state.weapons.push(newWeapon);
            renderWeapons();
            updateLoadDisplay();
            scheduleSave();
            
            showModal('Оружие куплено', `✅ ${type} добавлено в блок Оружие!`);
        }

        function buyMeleeWeaponToGear(type, price, load, damage, concealable, stealthPenalty, examples) {
            const currentMoney = parseInt(state.money) || 0;
            
            if (currentMoney < price) {
                showModal('Ошибка', `
                    <div style="text-align: center; padding: 1rem; background: var(--danger); color: white; border-radius: 8px;">
                        <p style="font-size: 1.1rem; margin-bottom: 1rem;">Нищим не продаём. Вали отсюда!</p>
                        <button class="pill-button" onclick="closeModal(this)">Понятно</button>
                    </div>
                `);
                return;
            }
            
         
            
            // Списываем деньги
            state.money = currentMoney - price;
            updateMoneyDisplay();
            
            // Уменьшаем доступную нагрузку
            state.load.current -= load;
            
            // Добавляем в снаряжение
            const newGear = {
                id: generateId('gear'),
                name: type,
                description: `Урон: ${damage} | Можно скрыть: ${concealable} | Штраф к СКА: ${stealthPenalty} | Примеры: ${examples}`,
                price: price,
                load: load,
                type: 'weapon',
                weaponData: {
                    type: 'melee',
                    damage: damage,
                    concealable: concealable,
                    stealthPenalty: stealthPenalty,
                    examples: examples
                }
            };
            
            state.gear.push(newGear);
            renderGear();
            updateLoadDisplay();
            scheduleSave();
            
            showModal('Оружие куплено', `✅ ${type} добавлено в Снаряжение!`);
        }

        function getMeleeWeaponFree(type, load, damage, concealable, stealthPenalty, examples) {

            // Уменьшаем доступную нагрузку
            state.load.current -= load;
            
            // Добавляем в снаряжение бесплатно
            const newGear = {
                id: generateId('gear'),
                name: type,
                description: `Урон: ${damage} | Можно скрыть: ${concealable} | Штраф к СКА: ${stealthPenalty} | Примеры: ${examples}`,
                price: 0,
                load: load,
                type: 'weapon',
                weaponData: {
                    type: 'melee',
                    damage: damage,
                    concealable: concealable,
                    stealthPenalty: stealthPenalty,
                    examples: examples
                }
            };
            
            state.gear.push(newGear);
            renderGear();
            updateLoadDisplay();
            scheduleSave();
            
            showModal('Оружие получено', `✅ ${type} добавлено в Снаряжение бесплатно!`);
        }

        // Функции покупки оружия дальнего боя
        function buyRangedWeapon(type, price, load, primaryDamage, altDamage, concealable, hands, stealth, magazine) {
            const currentMoney = parseInt(state.money) || 0;
            
            if (currentMoney < price) {
                showModal('Ошибка', `
                    <div style="text-align: center; padding: 1rem; background: var(--danger); color: white; border-radius: 8px;">
                        <p style="font-size: 1.1rem; margin-bottom: 1rem;">Нищим не продаём. Вали отсюда!</p>
                        <button class="pill-button" onclick="closeModal(this)">Понятно</button>
                    </div>
                `);
                return;
            }
            
        
          
            
            // Списываем деньги
            state.money = currentMoney - price;
            updateMoneyDisplay();
            
            // Уменьшаем доступную нагрузку
            state.load.current -= load;
            
            // Определяем количество слотов для модулей
            const slots = getRangedWeaponSlots(type);
            
            // Добавляем оружие
            const newWeapon = {
                id: generateId('weapon'),
                name: type,
                type: 'ranged',
                primaryDamage: primaryDamage,
                altDamage: altDamage,
                concealable: concealable,
                hands: hands,
                stealth: stealth,
                magazine: magazine,
                price: price,
                load: load,
                modules: [],
                slots: slots,
                // Система магазина
                maxAmmo: parseInt(magazine),
                currentAmmo: 0,
                loadedAmmoType: null,
                // Особая система для дробовиков
                isShotgun: type.includes('Дробовик'),
                shotgunAmmo1: { type: null, count: 0 }, // Первый тип патронов (до 3 шт)
                shotgunAmmo2: { type: null, count: 0 }  // Второй тип патронов (до 3 шт)
            };
            
            state.weapons.push(newWeapon);
            renderWeapons();
            updateLoadDisplay();
            scheduleSave();
            
            showModal('Оружие куплено', `✅ ${type} добавлено в блок Оружие!`);
        }

        function buyRangedWeaponToGear(type, price, load, primaryDamage, altDamage, concealable, hands, stealth, magazine) {
            const currentMoney = parseInt(state.money) || 0;
            
            if (currentMoney < price) {
                showModal('Ошибка', `
                    <div style="text-align: center; padding: 1rem; background: var(--danger); color: white; border-radius: 8px;">
                        <p style="font-size: 1.1rem; margin-bottom: 1rem;">Нищим не продаём. Вали отсюда!</p>
                        <button class="pill-button" onclick="closeModal(this)">Понятно</button>
                    </div>
                `);
                return;
            }
            
          
            
            // Списываем деньги
            state.money = currentMoney - price;
            updateMoneyDisplay();
            
            // Уменьшаем доступную нагрузку
            state.load.current -= load;
            
            // Добавляем в снаряжение
            const newGear = {
                id: generateId('gear'),
                name: type,
                description: `Урон основной: ${primaryDamage} | Урон альтернативный: ${altDamage} | Можно скрыть: ${concealable} | # рук: ${hands} | СКА: ${stealth} | Патронов в магазине: ${magazine}`,
                price: price,
                load: load,
                type: 'weapon',
                weaponData: {
                    type: 'ranged',
                    primaryDamage: primaryDamage,
                    altDamage: altDamage,
                    concealable: concealable,
                    hands: hands,
                    stealth: stealth,
                    magazine: magazine
                }
            };
            
            state.gear.push(newGear);
            renderGear();
            updateLoadDisplay();
            scheduleSave();
            
            showModal('Оружие куплено', `✅ ${type} добавлено в Снаряжение!`);
        }

        function getRangedWeaponFree(type, load, primaryDamage, altDamage, concealable, hands, stealth, magazine) {
         
            
            // Уменьшаем доступную нагрузку
            state.load.current -= load;
            
            // Добавляем в снаряжение бесплатно
            const newGear = {
                id: generateId('gear'),
                name: type,
                description: `Урон основной: ${primaryDamage} | Урон альтернативный: ${altDamage} | Можно скрыть: ${concealable} | # рук: ${hands} | СКА: ${stealth} | Патронов в магазине: ${magazine}`,
                price: 0,
                load: load,
                type: 'weapon',
                weaponData: {
                    type: 'ranged',
                    primaryDamage: primaryDamage,
                    altDamage: altDamage,
                    concealable: concealable,
                    hands: hands,
                    stealth: stealth,
                    magazine: magazine
                }
            };
            
            state.gear.push(newGear);
            renderGear();
            updateLoadDisplay();
            scheduleSave();
            
            showModal('Оружие получено', `✅ ${type} добавлено в Снаряжение бесплатно!`);
        }

        // Функция определения количества слотов для оружия дальнего боя
        function getRangedWeaponSlots(type) {
            const slotMap = {
                'Лёгкие пистолеты': 1,
                'Обычные пистолеты': 2,
                'Крупнокалиберные пистолеты': 3,
                'Пистолеты-пулемёты': 2,
                'Тяжёлые пистолеты-пулемёты': 3,
                'Штурмовые винтовки': 4,
                'Снайперские винтовки': 1,
                'Пулемёты': 3,
                'Дробовики': 2,
                'Гранатомёты': 1,
                'Ракетомёты': 1,
                'Оружие с самонаведением': 1
            };
            return slotMap[type] || 1;
        }

        // Функции создания собственного оружия
        function createCustomMeleeWeapon() {
            const type = document.getElementById('customMeleeType').value;
            const appearance = document.getElementById('customMeleeAppearance').value;
            const damage = document.getElementById('customMeleeDamage').value;
            const concealable = document.getElementById('customMeleeConcealable').value === 'true';
            const stealthPenalty = document.getElementById('customMeleeStealthPenalty').value;
            const price = parseInt(document.getElementById('customMeleePrice').value) || 0;
            const load = parseInt(document.getElementById('customMeleeLoad').value) || 0;
            const description = document.getElementById('customMeleeDescription').value;
            
            if (!type || !damage || !stealthPenalty || !load) {
                showModal('Ошибка', `
                    <div style="text-align: center; padding: 1rem;">
                        <p style="color: var(--danger);">Заполните все обязательные поля!</p>
                        <button class="pill-button" onclick="closeModal(this)">Закрыть</button>
                    </div>
                `);
                return;
            }
            
            // Добавляем в снаряжение
            const newGear = {
                id: generateId('gear'),
                name: type,
                description: `Внешний вид: ${appearance} | Урон: ${damage} | Можно скрыть: ${concealable} | Штраф к СКА: ${stealthPenalty} | ${description}`,
                price: price,
                load: load,
                type: 'weapon',
                weaponData: {
                    type: 'melee',
                    damage: damage,
                    concealable: concealable,
                    stealthPenalty: stealthPenalty,
                    appearance: appearance,
                    customDescription: description
                }
            };
            
            state.gear.push(newGear);
            renderGear();
            scheduleSave();
            
            closeModal(document.querySelector('.modal-overlay .icon-button'));
            showModal('Оружие создано', `✅ ${type} добавлено в Снаряжение!`);
        }

        function createCustomRangedWeapon() {
            const type = document.getElementById('customRangedType').value;
            const primaryDamage = document.getElementById('customRangedPrimaryDamage').value;
            const altDamage = document.getElementById('customRangedAltDamage').value;
            const concealable = document.getElementById('customRangedConcealable').value === 'true';
            const hands = parseInt(document.getElementById('customRangedHands').value) || 1;
            const stealth = parseInt(document.getElementById('customRangedStealth').value) || 2;
            const magazine = document.getElementById('customRangedMagazine').value;
            const price = parseInt(document.getElementById('customRangedPrice').value) || 0;
            const load = parseInt(document.getElementById('customRangedLoad').value) || 0;
            const description = document.getElementById('customRangedDescription').value;
            
            if (!type || !primaryDamage || !hands || !stealth || !magazine || !load) {
                showModal('Ошибка', `
                    <div style="text-align: center; padding: 1rem;">
                        <p style="color: var(--danger);">Заполните все обязательные поля!</p>
                        <button class="pill-button" onclick="closeModal(this)">Закрыть</button>
                    </div>
                `);
                return;
            }
            
            // Добавляем в снаряжение
            const newGear = {
                id: generateId('gear'),
                name: type,
                description: `Урон основной: ${primaryDamage} | Урон альтернативный: ${altDamage} | Можно скрыть: ${concealable} | # рук: ${hands} | СКА: ${stealth} | Патронов в магазине: ${magazine} | ${description}`,
                price: price,
                load: load,
                type: 'weapon',
                weaponData: {
                    type: 'ranged',
                    primaryDamage: primaryDamage,
                    altDamage: altDamage,
                    concealable: concealable,
                    hands: hands,
                    stealth: stealth,
                    magazine: magazine,
                    customDescription: description
                }
            };
            
            state.gear.push(newGear);
            renderGear();
            scheduleSave();
            
            closeModal(document.querySelector('.modal-overlay .icon-button'));
            showModal('Оружие создано', `✅ ${type} добавлено в Снаряжение!`);
        }

        // Функция отображения оружия
        function renderWeapons() {
            const container = document.getElementById('weaponsContainer');
            if (!container) return;
            
            if (state.weapons.length === 0) {
                container.innerHTML = '<p style="color: var(--muted); text-align: center; padding: 1rem; font-size: 0.8rem;">Оружие не добавлено</p>';
                return;
            }
            
            container.innerHTML = state.weapons.map((weapon, index) => `
                <div class="weapon-item" style="background: rgba(0,0,0,0.2); border: 1px solid rgba(182, 103, 255, 0.2); border-radius: 8px; padding: 0.75rem; margin-bottom: 0.75rem;">
                    <div class="weapon-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                        <h4 style="color: var(--accent); font-size: 0.95rem; margin: 0;">${weapon.name}</h4>
                        <button class="pill-button success-button" onclick="moveWeaponToGear(${index})" style="font-size: 0.7rem; padding: 0.25rem 0.5rem;">Сложить в сумку</button>
                    </div>
                    
                    <div class="weapon-damage" style="margin-bottom: 0.5rem;">
                        ${weapon.type === 'melee' ? `
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <span style="color: var(--text); font-weight: 600; font-size: 0.85rem;">Урон:</span>
                                <button class="pill-button primary-button" onclick="rollWeaponDamage('${weapon.damage}', '${weapon.name}', '${weapon.type}', '${weapon.id}')" style="font-size: 0.8rem; padding: 0.3rem 0.6rem;">${weapon.damage}</button>
                            </div>
                        ` : `
                            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.25rem;">
                                <span style="color: var(--text); font-weight: 600; font-size: 0.85rem;">Урон основной:</span>
                                <button class="pill-button primary-button" onclick="rollWeaponDamage('${weapon.primaryDamage}', '${weapon.name}', '${weapon.type}', '${weapon.id}', 'primary')" style="font-size: 0.8rem; padding: 0.3rem 0.6rem;">${weapon.primaryDamage}</button>
                            </div>
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <span style="color: var(--text); font-weight: 600; font-size: 0.85rem;">Урон альтернативный:</span>
                                <button class="pill-button primary-button" onclick="rollWeaponDamage('${weapon.altDamage}', '${weapon.name}', '${weapon.type}', '${weapon.id}', 'alt')" style="font-size: 0.8rem; padding: 0.3rem 0.6rem;">${weapon.altDamage}</button>
                            </div>
                        `}
                    </div>
                    
                    <div class="weapon-stats" style="font-family: monospace; font-size: 0.7rem; color: var(--muted); margin-bottom: 0.5rem;">
                        ${weapon.type === 'melee' ? `
                            Можно скрыть: ${formatYesNo(weapon.concealable)} | Штраф к СКА: ${weapon.stealthPenalty}
                        ` : `
                            Можно скрыть: ${formatYesNo(weapon.concealable)} | # рук: ${weapon.hands} | СКА: ${weapon.stealth} | Патронов в магазине: ${weapon.magazine}
                        `}
                    </div>
                    
                    ${weapon.type === 'ranged' ? `
                        ${weapon.isShotgun ? `
                            <!-- Особая система для дробовиков -->
                            <div class="weapon-magazine" style="margin-bottom: 0.5rem;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.35rem;">
                                    <span style="color: var(--accent); font-weight: 600; font-size: 0.85rem;">Патроны в дробовике:</span>
                                    <button class="pill-button success-button" onclick="reloadShotgun('${weapon.id}')" style="font-size: 0.7rem; padding: 0.25rem 0.5rem;">🔄 Перезарядить</button>
                                </div>
                                <div style="display: grid; gap: 0.25rem;">
                                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                                        <div style="background: rgba(182, 103, 255, 0.1); border: 1px solid var(--accent); border-radius: 4px; padding: 0.2rem 0.4rem; font-size: 0.75rem; min-width: 50px; text-align: center;">
                                            <span style="color: var(--accent); font-weight: 600;">${weapon.shotgunAmmo1.count}/3</span>
                                        </div>
                                        ${weapon.shotgunAmmo1.type ? `
                                            <div style="font-size: 0.7rem; color: var(--success); font-family: monospace;">
                                                ${weapon.shotgunAmmo1.type}
                                            </div>
                                        ` : `
                                            <div style="font-size: 0.7rem; color: var(--muted); font-style: italic;">
                                                Не заряжено
                                            </div>
                                        `}
                                    </div>
                                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                                        <div style="background: rgba(182, 103, 255, 0.1); border: 1px solid var(--accent); border-radius: 4px; padding: 0.2rem 0.4rem; font-size: 0.75rem; min-width: 50px; text-align: center;">
                                            <span style="color: var(--accent); font-weight: 600;">${weapon.shotgunAmmo2.count}/3</span>
                                        </div>
                                        ${weapon.shotgunAmmo2.type ? `
                                            <div style="font-size: 0.7rem; color: var(--success); font-family: monospace;">
                                                ${weapon.shotgunAmmo2.type}
                                            </div>
                                        ` : `
                                            <div style="font-size: 0.7rem; color: var(--muted); font-style: italic;">
                                                Не заряжено
                                            </div>
                                        `}
                                    </div>
                                </div>
                            </div>
                        ` : `
                            <!-- Обычная система для остального оружия -->
                            <div class="weapon-magazine" style="margin-bottom: 0.5rem;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.35rem;">
                                    <span style="color: var(--accent); font-weight: 600; font-size: 0.85rem;">Патроны в магазине:</span>
                                    <button class="pill-button success-button" onclick="reloadWeapon('${weapon.id}')" style="font-size: 0.7rem; padding: 0.25rem 0.5rem;">&#x1F504; Перезарядить</button>
                                </div>
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <div style="background: rgba(182, 103, 255, 0.1); border: 1px solid var(--accent); border-radius: 4px; padding: 0.25rem 0.5rem; font-size: 0.8rem;">
                                        <span style="color: var(--accent); font-weight: 600;">${weapon.currentAmmo || 0}</span>
                                        <span style="color: var(--muted);">/</span>
                                        <span style="color: var(--text);">${weapon.maxAmmo || weapon.magazine}</span>
                                    </div>
                                    ${weapon.loadedAmmoType ? `
                                        <div style="font-size: 0.75rem; color: var(--success); font-family: monospace;">
                                            ${weapon.loadedAmmoType}
                                        </div>
                                    ` : `
                                        <div style="font-size: 0.75rem; color: var(--muted); font-style: italic;">
                                            Не заряжено
                                        </div>
                                    `}
                                </div>
                            </div>
                        `}
                    ` : ''}
                    
                    ${weapon.examples ? `<div class="weapon-examples" style="font-size: 0.75rem; color: var(--muted); margin-bottom: 0.5rem;"><strong>Примеры:</strong> ${weapon.examples}</div>` : ''}
                    
                    <div class="weapon-modules">
                        <div style="color: var(--accent); font-weight: 600; margin-bottom: 0.35rem; font-size: 0.85rem;">Слоты для модулей:</div>
                        <div style="display: flex; gap: 0.35rem; margin-bottom: 0.35rem;">
                            ${Array.from({length: weapon.slots}, (_, i) => `
                                <div class="weapon-slot" data-weapon-id="${weapon.id}" data-slot-index="${i}" style="width: 26px; height: 26px; border: 2px solid ${weapon.modules[i] ? 'var(--success)' : 'var(--border)'}; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; background: ${weapon.modules[i] ? 'rgba(125, 244, 198, 0.3)' : 'transparent'}; font-size: 0.75rem;" onclick="manageWeaponModule('${weapon.id}', ${i})">
                                    ${weapon.modules[i] ? '✓' : '○'}
                                </div>
                            `).join('')}
                        </div>
                        ${weapon.modules.filter(m => m).map(module => `
                            <div style="font-size: 0.7rem; color: var(--muted); margin-left: 0.75rem;">
                                • ${module.name}: ${module.description}
                            </div>
                        `).join('')}
                    </div>
                </div>
            `).join('');
        }

        // Функция перемещения оружия в снаряжение
        function moveWeaponToGear(weaponIndex) {
            const weapon = state.weapons[weaponIndex];
            if (!weapon) return;
            
            // Создаем описание для снаряжения
            let description = '';
            if (weapon.type === 'melee') {
                description = `Урон: ${weapon.damage} | Можно скрыть: ${weapon.concealable ? 'да' : 'нет'} | Штраф к СКА: ${weapon.stealthPenalty}`;
                if (weapon.examples) description += ` | Примеры: ${weapon.examples}`;
            } else {
                description = `Урон основной: ${weapon.primaryDamage} | Урон альтернативный: ${weapon.altDamage} | Можно скрыть: ${weapon.concealable ? 'да' : 'нет'} | # рук: ${weapon.hands} | СКА: ${weapon.stealth} | Патронов в магазине: ${weapon.magazine}`;
            }
            
            // Добавляем информацию об установленных модулях
            if (weapon.modules.filter(m => m).length > 0) {
                description += ` | Установлено: ${weapon.modules.filter(m => m).map(m => m.name).join(', ')}`;
            }
            
            // Добавляем в снаряжение
            const newGear = {
                id: generateId('gear'),
                name: weapon.name,
                description: description,
                price: weapon.price,
                load: weapon.load,
                type: 'weapon',
                weaponData: weapon
            };
            
            state.gear.push(newGear);
            
            // Удаляем из оружия
            state.weapons.splice(weaponIndex, 1);
            
            renderWeapons();
            renderGear();
            scheduleSave();
            
            showModal('Оружие перемещено', `&#x2705; ${weapon.name} перемещено в Снаряжение!`);
        }

        // Функция броска урона оружия
        function rollWeaponDamage(damageFormula, weaponName, weaponType, weaponId, damageType) {
            // Если это оружие ближнего боя, сразу показываем стандартный бросок
            if (weaponType === 'melee') {
                showStandardDamageRoll(damageFormula, weaponName, weaponId);
                return;
            }
            
            // Для огнестрельного оружия показываем выбор боеприпасов
            showAmmoSelectionModal(damageFormula, weaponName, weaponId, damageType);
        }

        function showStandardDamageRoll(damageFormula, weaponName, weaponId) {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.id = 'weaponDamageModal';
            const existingModals = document.querySelectorAll('.modal-overlay');
            modal.style.zIndex = 1000 + (existingModals.length * 100);
            modal.innerHTML = `
                <div class="modal" style="max-width: 600px;">
                    <div class="modal-header">
                        <h3>&#x2694;&#xFE0F; Атака: ${weaponName}</h3>
                        <button class="icon-button" onclick="closeModal(this)">×</button>
                    </div>
                    <div class="modal-body" id="weaponDamageModalBody">
                        <div id="weaponSetupSection">
                            <div style="margin-bottom: 1rem;">
                                <p style="margin-bottom: 0.75rem;"><strong>${weaponName}</strong></p>
                                <p style="color: var(--muted); font-size: 0.9rem; margin-bottom: 1rem;">
                                    Формула урона: <strong style="color: var(--accent);">${damageFormula}</strong>
                                </p>
                            </div>
                            
                            <div style="display: grid; gap: 0.75rem;">
                                <label class="field">
                                    Модификатор урона
                                    <input type="text" class="input-field" id="damageModifier" value="0" placeholder="0">
                                </label>
                            </div>
                        </div>
                        
                        <!-- Секция анимации и результатов -->
                        <div id="weaponDamageAnimation" style="display: none;">
                            <div style="text-align: center; padding: 2rem 0;">
                                <div id="weaponDiceDisplay" style="display: flex; justify-content: center; gap: 1rem; flex-wrap: wrap; margin-bottom: 1rem;"></div>
                                <div id="weaponDamageTotal" style="font-size: 2rem; font-weight: 700; color: var(--accent); margin-bottom: 0.5rem;"></div>
                                <div id="weaponDamageFormula" style="font-size: 0.9rem; color: var(--muted);"></div>
                                <div id="weaponCriticalMessage" style="display: none; margin-top: 1rem; padding: 1rem; background: rgba(255, 0, 0, 0.2); border: 2px solid #ff0000; border-radius: 8px;">
                                    <p style="color: #ff0000; font-size: 1.2rem; font-weight: 700; margin-bottom: 0.5rem;">🩸 КРИТИЧЕСКАЯ ТРАВМА! 🩸</p>
                                    <p style="color: var(--text); font-size: 0.9rem;">Ты нанёс Критическую травму! Сообщи Мастеру!</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer" id="weaponDamageFooter">
                        <button class="pill-button primary-button" id="weaponShootButton" onclick="executeMeleeDamageRoll('${damageFormula}', '${weaponName}', '${weaponId}')">
                            ⚔️ Атаковать!
                        </button>
                        <button class="pill-button" onclick="closeModal(this)">
                            Отмена
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closeModal(modal.querySelector('.icon-button'));
                }
            });
        }
        
        function executeMeleeDamageRoll(damageFormula, weaponName, weaponId) {
            const modifier = parseInt(document.getElementById('damageModifier').value) || 0;
            
            // Скрываем секцию настройки и показываем анимацию
            document.getElementById('weaponSetupSection').style.display = 'none';
            document.getElementById('weaponDamageAnimation').style.display = 'block';
            document.getElementById('weaponShootButton').style.display = 'none';
            
            // Выполняем бросок урона с анимацией
            performWeaponDamageRoll(damageFormula, weaponName, modifier, null, null, null, weaponId, null, false, 'single');
        }

        function showAmmoSelectionModal(damageFormula, weaponName, weaponId, damageType) {
            // Получаем информацию об оружии
            const weapon = state.weapons.find(w => w.id === weaponId);
            if (!weapon) {
                showModal('Ошибка', 'Оружие не найдено!');
                return;
            }
            
            // Особая обработка для дробовиков
            if (weapon.isShotgun) {
                showShotgunShootingModal(damageFormula, weaponName, weaponId);
                return;
            }
            
            // Проверяем, есть ли патроны в магазине
            if (!weapon.currentAmmo || weapon.currentAmmo <= 0 || !weapon.loadedAmmoType) {
                showModal('Магазин пуст', `
                    <div style="text-align: center; padding: 1rem;">
                        <p style="color: var(--danger); font-size: 1.1rem; margin-bottom: 1rem;">Магазин пуст!</p>
                        <p style="color: var(--muted); margin-bottom: 1rem;">Сначала перезарядите оружие</p>
                        <button class="pill-button primary-button" onclick="closeModal(this); setTimeout(() => reloadWeapon('${weaponId}'), 100)">Перезарядить</button>
                        <button class="pill-button" onclick="closeModal(this)">Закрыть</button>
                    </div>
                `);
                return;
            }
            
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.id = 'weaponDamageModal';
            const existingModals = document.querySelectorAll('.modal-overlay');
            modal.style.zIndex = 1000 + (existingModals.length * 100);
            // Определяем тип оружия для автоматического огня
            const weaponTypeForAmmo = getWeaponTypeForAmmo(weaponName);
            
            modal.innerHTML = `
                <div class="modal" style="max-width: 600px;">
                    <div class="modal-header">
                        <h3>🔫 Стрельба: ${weaponName}</h3>
                        <button class="icon-button" onclick="closeModal(this)">×</button>
                    </div>
                    <div class="modal-body" id="weaponDamageModalBody">
                        <div id="weaponSetupSection">
                            <div style="margin-bottom: 1rem;">
                                <p style="margin-bottom: 0.75rem;"><strong>${weaponName}</strong></p>
                                <p style="color: var(--muted); font-size: 0.9rem; margin-bottom: 1rem;">
                                    Формула урона: <strong style="color: var(--accent);">${damageFormula}</strong>
                                </p>
                            </div>
                            
                            <!-- Информация о заряженных боеприпасах -->
                            <div style="margin-bottom: 1rem; padding: 0.75rem; background: rgba(125, 244, 198, 0.1); border: 1px solid var(--success); border-radius: 8px;">
                                <p style="color: var(--success); font-weight: 600; margin-bottom: 0.5rem;">Заряженные боеприпасы:</p>
                                <p style="color: var(--text); font-size: 0.9rem;">
                                    Тип: <strong>${weapon.loadedAmmoType}</strong> | 
                                    Патронов: <strong>${weapon.currentAmmo}/${weapon.maxAmmo}</strong>
                                </p>
                            </div>
                            
                            <!-- Режим огня для автоматического оружия -->
                            ${isAutomaticWeapon(weaponTypeForAmmo) ? `
                                <div style="margin-bottom: 1rem;">
                                    <label class="input-label">Режим огня</label>
                                    <div style="display: grid; gap: 0.5rem;">
                                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                            <input type="radio" name="fireMode" value="single" checked style="margin: 0;">
                                            <span>Одиночный выстрел (1 патрон)</span>
                                        </label>
                                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                            <input type="radio" name="fireMode" value="auto" ${getMinAmmoForAuto(weaponTypeForAmmo) > weapon.currentAmmo ? 'disabled' : ''} style="margin: 0;">
                                            <span style="color: ${getMinAmmoForAuto(weaponTypeForAmmo) > weapon.currentAmmo ? 'var(--muted)' : 'var(--text)'};">Автоматический огонь (${getMinAmmoForAuto(weaponTypeForAmmo)} патронов)</span>
                                        </label>
                                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                            <input type="radio" name="fireMode" value="suppression" ${getMinAmmoForAuto(weaponTypeForAmmo) > weapon.currentAmmo ? 'disabled' : ''} style="margin: 0;">
                                            <span style="color: ${getMinAmmoForAuto(weaponTypeForAmmo) > weapon.currentAmmo ? 'var(--muted)' : 'var(--text)'};">Огонь на подавление (${getMinAmmoForAuto(weaponTypeForAmmo)} патронов)</span>
                                        </label>
                                    </div>
                                </div>
                            ` : ''}
                            
                            <div style="display: grid; gap: 0.75rem;">
                                <label class="field">
                                    Модификатор урона
                                    <input type="text" class="input-field" id="damageModifier" value="0" placeholder="0">
                                </label>
                            </div>
                        </div>
                        
                        <!-- Секция анимации и результатов -->
                        <div id="weaponDamageAnimation" style="display: none;">
                            <div style="text-align: center; padding: 2rem 0;">
                                <div id="weaponDiceDisplay" style="display: flex; justify-content: center; gap: 1rem; flex-wrap: wrap; margin-bottom: 1rem;"></div>
                                <div id="weaponDamageTotal" style="font-size: 2rem; font-weight: 700; color: var(--accent); margin-bottom: 0.5rem;"></div>
                                <div id="weaponDamageFormula" style="font-size: 0.9rem; color: var(--muted);"></div>
                                <div id="weaponCriticalMessage" style="display: none; margin-top: 1rem; padding: 1rem; background: rgba(255, 0, 0, 0.2); border: 2px solid #ff0000; border-radius: 8px;">
                                    <p style="color: #ff0000; font-size: 1.2rem; font-weight: 700; margin-bottom: 0.5rem;">🩸 КРИТИЧЕСКАЯ ТРАВМА! 🩸</p>
                                    <p style="color: var(--text); font-size: 0.9rem;">Ты нанёс Критическую травму! Сообщи Мастеру!</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer" id="weaponDamageFooter">
                        <button class="pill-button primary-button" id="weaponShootButton" onclick="executeRangedWeaponDamageRoll('${damageFormula}', '${weaponName}', '${weaponId}', '${weaponTypeForAmmo}')">
                            🔫 Стрелять!
                        </button>
                        <button class="pill-button" onclick="closeModal(this)">
                            Отмена
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closeModal(modal.querySelector('.icon-button'));
                }
            });
        }

        // Вспомогательные функции для механики стрельбы
        function getWeaponTypeForAmmo(weaponName) {
            // Определяем тип оружия по названию для поиска боеприпасов
            const weaponTypeMappings = {
                'Лёгкие пистолеты': 'Лёгкий пистолет',
                'Обычные пистолеты': 'Обычный пистолет',
                'Пистолеты-пулемёты': 'Пистолет-пулемёт',
                'Тяжёлые пистолеты-пулемёты': 'Тяжёлый пистолет-пулемёт',
                'Штурмовые винтовки': 'Штурмовая винтовка',
                'Крупнокалиберные пистолеты': 'Крупнокалиберный пистолет',
                'Пулемёты': 'Пулемёт',
                'Снайперские винтовки': 'Снайперская винтовка',
                'Дробовики': 'Дробовик',
                'Оружие с самонаведением': 'Оружие с самонаведением'
            };
            
            for (const [key, value] of Object.entries(weaponTypeMappings)) {
                if (weaponName.includes(key) || weaponName.includes(value)) {
                    return value;
                }
            }
            
            // По умолчанию возвращаем обычный пистолет
            return 'Обычный пистолет';
        }

        function isAutomaticWeapon(weaponType) {
            const automaticTypes = [
                'Пистолет-пулемёт',
                'Тяжёлый пистолет-пулемёт', 
                'Пулемёт',
                'Штурмовая винтовка'
            ];
            return automaticTypes.includes(weaponType);
        }

        function getMinAmmoForAuto(weaponType) {
            return weaponType === 'Пулемёт' ? 50 : 10;
        }

        function executeRangedWeaponDamageRoll(damageFormula, weaponName, weaponId, weaponType) {
            const weapon = state.weapons.find(w => w.id === weaponId);
            if (!weapon) return;
            
            const modifier = parseInt(document.getElementById('damageModifier').value) || 0;
            
            // Определяем режим огня
            const fireModeRadios = document.querySelectorAll('input[name="fireMode"]');
            let fireMode = 'single';
            for (const radio of fireModeRadios) {
                if (radio.checked) {
                    fireMode = radio.value;
                    break;
                }
            }
            
            // Определяем количество патронов для списания
            let ammoToConsume = 1;
            let fireModeText = 'Одиночный выстрел';
            
            if (fireMode === 'auto') {
                ammoToConsume = weaponType === 'Пулемёт' ? 50 : 10;
                fireModeText = 'Автоматический огонь';
            } else if (fireMode === 'suppression') {
                ammoToConsume = weaponType === 'Пулемёт' ? 50 : 10;
                fireModeText = 'Огонь на подавление';
            }
            
            // Проверяем достаточность патронов в магазине оружия
            if (weapon.currentAmmo < ammoToConsume) {
                showModal('Недостаточно патронов', `
                    <div style="text-align: center; padding: 1rem;">
                        <p style="color: var(--danger);">Недостаточно патронов в магазине!</p>
                        <p style="color: var(--muted);">Требуется: ${ammoToConsume} | В магазине: ${weapon.currentAmmo}</p>
                        <button class="pill-button primary-button" onclick="closeModal(this); setTimeout(() => reloadWeapon('${weaponId}'), 100)">Перезарядить</button>
                    </div>
                `);
                return;
            }
            
            // Списываем патроны из магазина оружия
            weapon.currentAmmo -= ammoToConsume;
            renderWeapons();
            scheduleSave();
            
            // Скрываем секцию настройки и показываем анимацию
            document.getElementById('weaponSetupSection').style.display = 'none';
            document.getElementById('weaponDamageAnimation').style.display = 'block';
            document.getElementById('weaponShootButton').style.display = 'none';
            
            // Определяем формулу урона в зависимости от режима огня
            let actualDamageFormula = damageFormula;
            if (fireMode === 'auto' || fireMode === 'suppression') {
                actualDamageFormula = '2d6'; // Для автоматического огня и огня на подавление всегда 2d6
            }
            
            // Выполняем бросок урона с анимацией
            performWeaponDamageRoll(actualDamageFormula, weaponName, modifier, weapon.loadedAmmoType, fireModeText, ammoToConsume, weaponId, weaponType, true, fireMode);
        }

        // Универсальная функция для броска урона с анимацией
        function performWeaponDamageRoll(damageFormula, weaponName, modifier, ammoType, fireModeText, ammoConsumed, weaponId, weaponType, isRanged, fireMode) {
            // Парсим формулу урона
            const match = damageFormula.match(/(\d+)d(\d+)/);
            if (!match) {
                showModal('Ошибка', 'Неверная формула урона!');
                return;
            }
            
            const diceCount = parseInt(match[1]);
            const diceSides = parseInt(match[2]);
            
            const diceDisplay = document.getElementById('weaponDiceDisplay');
            const totalDiv = document.getElementById('weaponDamageTotal');
            const formulaDiv = document.getElementById('weaponDamageFormula');
            const criticalMessage = document.getElementById('weaponCriticalMessage');
            const footer = document.getElementById('weaponDamageFooter');
            
            // Очищаем предыдущие результаты
            diceDisplay.innerHTML = '';
            totalDiv.textContent = '';
            formulaDiv.textContent = '';
            criticalMessage.style.display = 'none';
            
            // Создаем кубики
            const diceElements = [];
            for (let i = 0; i < diceCount; i++) {
                const wrapper = document.createElement('div');
                wrapper.style.display = 'flex';
                wrapper.style.flexDirection = 'column';
                wrapper.style.alignItems = 'center';
                
                const die = document.createElement('div');
                die.className = 'die';
                die.style.cssText = `
                    width: 60px;
                    height: 60px;
                    background: var(--accent);
                    border-radius: 8px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    font-size: 1.5rem;
                    font-weight: 700;
                    color: white;
                    animation: spin 1.2s ease-in-out;
                `;
                die.textContent = '?';
                
                wrapper.appendChild(die);
                diceDisplay.appendChild(wrapper);
                diceElements.push(die);
            }
            
            // Анимация броска
            let animationStep = 0;
            const animationInterval = 100;
            const animationDuration = 1200;
            const steps = animationDuration / animationInterval;
            
            const interval = setInterval(() => {
                animationStep++;
                
                diceElements.forEach(die => {
                    die.textContent = Math.floor(Math.random() * diceSides) + 1;
                });
                
                if (animationStep >= steps) {
                    clearInterval(interval);
                    
                    // Финальные результаты
                    const finalResults = [];
                    for (let i = 0; i < diceCount; i++) {
                        finalResults.push(Math.floor(Math.random() * diceSides) + 1);
                    }
                    
                    // Отображаем результаты
                    diceElements.forEach((die, index) => {
                        die.textContent = finalResults[index];
                        die.style.animation = 'none';
                    });
                    
                    // Проверка критической травмы (2+ кубика с результатом >= 6)
                    const criticalDice = finalResults.filter(result => result >= 6);
                    const isCritical = criticalDice.length >= 2;
                    
                    // Рассчитываем сумму
                    const sum = finalResults.reduce((a, b) => a + b, 0);
                    const total = sum + modifier;
                    
                    // Отображаем результаты
                    totalDiv.textContent = `Σ ${total}`;
                    
                    let formulaText = `Кости: ${finalResults.join(' + ')}`;
                    if (modifier !== 0) {
                        formulaText += ` ${modifier >= 0 ? '+' : ''} ${modifier}`;
                    }
                    formulaText += ` = ${total}`;
                    
                    if (isRanged) {
                        formulaText += `\nБоеприпасы: ${ammoType} | Режим: ${fireModeText} | Потрачено: ${ammoConsumed}`;
                    }
                    
                    formulaDiv.textContent = formulaText;
                    
                    // Показываем критическую травму
                    if (isCritical) {
                        criticalMessage.style.display = 'block';
                        // Красное конфетти
                        createBloodConfetti();
                    }
                    
                    // Меняем кнопки - для автоматического огня и огня на подавление убираем кнопку "Атаковать еще раз"
                    const canRepeatAttack = !isRanged || (fireMode !== 'auto' && fireMode !== 'suppression');
                    
                    footer.innerHTML = `
                        ${canRepeatAttack ? `
                            <button class="pill-button primary-button" onclick="${isRanged ? `repeatRangedAttack('${damageFormula}', '${weaponName}', '${weaponId}', '${weaponType}')` : `repeatMeleeAttack('${damageFormula}', '${weaponName}', '${weaponId}')`}">
                                🔄 Атаковать еще раз
                            </button>
                        ` : ''}
                    `;
                    
                    // Добавляем в лог
                    addToRollLog('weapon_damage', {
                        weaponName: weaponName,
                        formula: `${diceCount}d${diceSides}(${finalResults.join(', ')})${modifier !== 0 ? ` + ${modifier}` : ''}`,
                        dice: finalResults,
                        modifier: modifier,
                        total: total,
                        isCritical: isCritical,
                        ammoType: isRanged ? ammoType : null,
                        fireMode: isRanged ? fireModeText : null
                    });
                }
            }, animationInterval);
        }
        
        // Функция создания красного конфетти
        function createBloodConfetti() {
            const colors = ['#ff0000', '#cc0000', '#990000', '#ff3333', '#cc3333'];
            const confettiCount = 50;
            
            for (let i = 0; i < confettiCount; i++) {
                const confetti = document.createElement('div');
                confetti.style.cssText = `
                    position: fixed;
                    width: 10px;
                    height: 10px;
                    background: ${colors[Math.floor(Math.random() * colors.length)]};
                    left: 50%;
                    top: 50%;
                    opacity: 1;
                    pointer-events: none;
                    z-index: 10000;
                    border-radius: 50%;
                `;
                
                document.body.appendChild(confetti);
                
                const angle = Math.random() * Math.PI * 2;
                const velocity = 200 + Math.random() * 200;
                const vx = Math.cos(angle) * velocity;
                const vy = Math.sin(angle) * velocity;
                
                const duration = 1000 + Math.random() * 500;
                const startTime = Date.now();
                
                const animate = () => {
                    const elapsed = Date.now() - startTime;
                    const progress = elapsed / duration;
                    
                    if (progress < 1) {
                        const x = vx * progress;
                        const y = vy * progress + (progress * progress * 500);
                        confetti.style.transform = `translate(${x}px, ${y}px) rotate(${progress * 720}deg)`;
                        confetti.style.opacity = 1 - progress;
                        requestAnimationFrame(animate);
                    } else {
                        confetti.remove();
                    }
                };
                
                animate();
            }
        }
        
        // Функция повторной атаки для дальнего боя
        function repeatRangedAttack(damageFormula, weaponName, weaponId, weaponType) {
            // Закрываем текущий модал
            closeModal(document.querySelector('.modal-overlay .icon-button'));
            // Открываем новый
            setTimeout(() => {
                rollWeaponDamage(damageFormula, weaponName, 'ranged', weaponId);
            }, 100);
        }
        
        // Функция повторной атаки для ближнего боя
        function repeatMeleeAttack(damageFormula, weaponName, weaponId) {
            // Закрываем текущий модал
            closeModal(document.querySelector('.modal-overlay .icon-button'));
            // Открываем новый
            setTimeout(() => {
                rollWeaponDamage(damageFormula, weaponName, 'melee', weaponId);
            }, 100);
        }

        function showRangedDamageRoll(damageFormula, weaponName, ammoType, fireModeText, ammoConsumed) {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            const existingModals = document.querySelectorAll('.modal-overlay');
            modal.style.zIndex = 1000 + (existingModals.length * 100);
            modal.innerHTML = `
                <div class="modal" style="max-width: 500px;">
                    <div class="modal-header">
                        <h3>🔫 Стрельба: ${weaponName}</h3>
                        <button class="icon-button" onclick="closeModal(this)">×</button>
                    </div>
                    <div class="modal-body">
                        <div style="margin-bottom: 1rem;">
                            <p style="margin-bottom: 0.5rem;"><strong>${weaponName}</strong></p>
                            <p style="color: var(--success); font-size: 0.9rem; margin-bottom: 0.5rem;">
                                Боеприпасы: <strong>${ammoType}</strong>
                            </p>
                            <p style="color: var(--accent); font-size: 0.9rem; margin-bottom: 0.5rem;">
                                Режим: <strong>${fireModeText}</strong>
                            </p>
                            <p style="color: var(--muted); font-size: 0.9rem; margin-bottom: 1rem;">
                                Потрачено патронов: <strong>${ammoConsumed}</strong>
                            </p>
                            <p style="color: var(--muted); font-size: 0.9rem; margin-bottom: 1rem;">
                                Формула урона: <strong style="color: var(--accent);">${damageFormula}</strong>
                            </p>
                        </div>
                        
                        <div style="display: grid; gap: 0.75rem;">
                            <label class="field">
                                Модификатор урона
                                <input type="text" class="input-field" id="damageModifier" value="0" placeholder="0">
                            </label>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="pill-button primary-button" onclick="executeWeaponDamageRoll('${damageFormula}', '${weaponName}')">
                            🎲 Бросить урон
                        </button>
                        <button class="pill-button" onclick="closeModal(this)">
                            Отмена
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closeModal(modal.querySelector('.icon-button'));
                }
            });
        }

        function executeWeaponDamageRoll(damageFormula, weaponName) {
            const modifier = parseInt(document.getElementById('damageModifier').value) || 0;
            
            // Парсим формулу урона (например, "2d6" или "3d10")
            const match = damageFormula.match(/(\d+)d(\d+)/);
            if (!match) {
                showModal('Ошибка', 'Неверная формула урона!');
                return;
            }
            
            const diceCount = parseInt(match[1]);
            const diceSides = parseInt(match[2]);
            
            // Бросаем кости
            const dice = [];
            for (let i = 0; i < diceCount; i++) {
                dice.push(Math.floor(Math.random() * diceSides) + 1);
            }
            
            const total = dice.reduce((sum, d) => sum + d, 0) + modifier;
            
            // Показываем результат
            showModal('Результат броска', `
                <div style="text-align: center; padding: 1rem;">
                    <p style="color: var(--accent); font-size: 1.2rem; margin-bottom: 1rem;">${weaponName}</p>
                    <p style="color: var(--text); font-size: 1.1rem; margin-bottom: 0.5rem;">Урон: ${damageFormula}${modifier !== 0 ? (modifier > 0 ? '+' : '') + modifier : ''}</p>
                    <p style="color: var(--success); font-size: 1.5rem; font-weight: bold; margin-bottom: 0.5rem;">${total}</p>
                    <p style="color: var(--muted); font-size: 0.9rem;">Кости: [${dice.join(', ')}]${modifier !== 0 ? ` + ${modifier}` : ''}</p>
                </div>
            `);
            
            closeModal(document.querySelector('.modal-overlay .icon-button'));
        }

        // Функция управления модулями оружия
        function manageWeaponModule(weaponId, slotIndex) {
            const weapon = state.weapons.find(w => w.id === weaponId);
            if (!weapon) return;
            
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            const existingModals = document.querySelectorAll('.modal-overlay');
            modal.style.zIndex = 1000 + (existingModals.length * 100);
            
            const currentModule = weapon.modules[slotIndex];
            
            let slotHTML = `
                <div class="modal" style="max-width: 600px;">
                    <div class="modal-header">
                        <h3>Управление модулем оружия</h3>
                        <button class="icon-button" onclick="closeModal(this)">×</button>
                    </div>
                    <div class="modal-body">
                        <p style="color: var(--muted); margin-bottom: 1rem;">
                            ${weapon.name} → Слот ${slotIndex + 1}
                        </p>
            `;
            
            if (currentModule) {
                slotHTML += `
                    <div style="background: rgba(125, 244, 198, 0.1); border: 1px solid var(--success); border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
                        <h5 style="color: var(--success); margin-bottom: 0.5rem;">Установленный модуль:</h5>
                        <p style="color: var(--text); font-weight: 600;">${currentModule.name}</p>
                        <p style="color: var(--muted); font-size: 0.9rem;">${currentModule.description}</p>
                        <button class="pill-button danger-button" onclick="removeWeaponModule('${weaponId}', ${slotIndex}); closeModal(this);" style="margin-top: 0.5rem;">Снять модуль</button>
                    </div>
                `;
            } else {
                slotHTML += `
                    <div style="background: rgba(182, 103, 255, 0.1); border: 1px solid var(--border); border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
                        <h5 style="color: var(--accent); margin-bottom: 0.5rem;">Свободный слот</h5>
                        <p style="color: var(--muted);">Выберите модуль для установки:</p>
                        <div id="availableWeaponModules" style="max-height: 300px; overflow-y: auto;">
                            <!-- Модули из снаряжения будут загружены здесь -->
                        </div>
                    </div>
                `;
            }
            
            slotHTML += `
                    </div>
                    <div class="modal-footer">
                        <button class="pill-button" onclick="closeModal(this)">Закрыть</button>
                    </div>
                </div>
            `;
            
            modal.innerHTML = slotHTML;
            document.body.appendChild(modal);
            
            // Загружаем доступные модули
            loadAvailableWeaponModules(weaponId, slotIndex);
            
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closeModal(modal.querySelector('.icon-button'));
                }
            });
        }

        function loadAvailableWeaponModules(weaponId, slotIndex) {
            const container = document.getElementById('availableWeaponModules');
            if (!container) return;
            
            // Ищем модули в снаряжении
            const availableModules = state.gear.filter(item => item.type === 'weaponModule');
            
            if (availableModules.length === 0) {
                container.innerHTML = '<p style="color: var(--muted); text-align: center; padding: 1rem;">Нет доступных модулей в снаряжении</p>';
                return;
            }
            
            container.innerHTML = availableModules.map((module, index) => `
                <div style="background: rgba(0,0,0,0.3); border: 1px solid var(--border); border-radius: 8px; padding: 0.75rem; margin-bottom: 0.5rem;">
                    <div style="color: var(--text); font-weight: 600;">${module.name}</div>
                    <div style="color: var(--muted); font-size: 0.8rem;">${module.description}</div>
                    <div style="margin-top: 0.5rem;">
                        <button class="pill-button success-button" onclick="installWeaponModule('${weaponId}', ${slotIndex}, ${state.gear.findIndex(item => item === module)}); closeModal(this);" style="font-size: 0.8rem; padding: 0.3rem 0.6rem;">
                            Установить
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function installWeaponModule(weaponId, slotIndex, gearIndex) {
            const module = state.gear[gearIndex];
            if (!module) return;
            const weapon = state.weapons.find(w => w.id === weaponId);
            if (!weapon) return;

            const data = module.weaponModuleData || {};
            const slotsRequired = parseInt(data.slotsRequired || 1);

            // Вспомогательные функции сопоставления сокращений к типам оружия
            function getWeaponAbbrevFromName(name) {
                const n = (name || '').toLowerCase();
                if (n.includes('лёгкие пистолет') || n.includes('легкие пистолет')) return 'ЛП';
                if (n.includes('обычные пистолет')) return 'ОП';
                if (n.includes('крупнокалиберные пистолет')) return 'КП';
                if (n.includes('пистолеты-пулем') || n.includes('пистолет-пулем')) return 'ПП';
                if (n.includes('тяжёлые пистолеты-пулем') || n.includes('тяжелые пистолеты-пулем')) return 'ТПП';
                if (n.includes('штурмовые винтов')) return 'ШВ';
                if (n.includes('снайперские винтов')) return 'СВ';
                if (n.includes('пулемёты') || n.includes('пулеметы')) return 'ПУЛ';
                if (n.includes('дробовик') || n.includes('дробовики')) return 'ДР';
                if (n.includes('оружие с самонавед')) return 'ОСМ';
                return '';
            }

            function isModuleCompatible(weapon, moduleData) {
                // Категория ближнее/дальнее
                if (moduleData.category && moduleData.category !== weapon.type) {
                    return false;
                }
                // Список сокращений (ЛП, ОП, ПП, ...)
                if (!moduleData.compatible) return true;
                const set = new Set(moduleData.compatible.split(',').map(s => s.trim().toUpperCase()).filter(Boolean));
                const weaponAbbrev = getWeaponAbbrevFromName(weapon.name);
                if (!weaponAbbrev) return true; // если не смогли распознать — не блокируем
                return set.has(weaponAbbrev);
            }

            // Проверка категории (melee/ranged)
            if (!isModuleCompatible(weapon, data)) {
                showModal('Несовместимо', 'Модуль не подходит для этого оружия.');
                return;
            }

            if (slotsRequired === 2) {
                if (slotIndex + 1 >= weapon.slots) {
                    showModal('Нет места', 'Для этого модуля нужно 2 соседних слота.');
                    return;
                }
                if (weapon.modules[slotIndex] || weapon.modules[slotIndex + 1]) {
                    showModal('Занято', 'Один из требуемых слотов уже занят.');
                    return;
                }
                // Сохраняем метку о двухслотном модуле: якорь + связанный слот
                const anchor = Object.assign({}, data, { anchor: true, slotsRequired: 2 });
                const linked = { linked: true, anchorIndex: slotIndex };
                weapon.modules[slotIndex] = anchor;
                weapon.modules[slotIndex + 1] = linked;
            } else {
                if (weapon.modules[slotIndex]) {
                    showModal('Занято', 'Слот уже занят.');
                    return;
                }
                weapon.modules[slotIndex] = data;
            }

            // Удаляем модуль из снаряжения
            state.gear.splice(gearIndex, 1);

            // Обновляем максимум патронов для модулей магазина
            updateWeaponMagazineCapacity(weapon);

            renderGear();
            renderWeapons();
            scheduleSave();
            showModal('Модуль установлен', `✅ ${module.name} установлен в оружие!`);
        }

        function removeWeaponModule(weaponId, slotIndex) {
            const weapon = state.weapons.find(w => w.id === weaponId);
            if (!weapon) return;
            let module = weapon.modules[slotIndex];
            if (!module) return;

            // Если кликнули по связанному слоту двухслотного модуля — переключаемся на якорь
            if (module.linked) {
                slotIndex = module.anchorIndex;
                module = weapon.modules[slotIndex];
            }

            const payload = module.anchor ? Object.assign({}, module) : module;

            // Возвращаем модуль в снаряжение (только один предмет)
            state.gear.push({
                id: generateId('gear'),
                name: payload.name,
                description: payload.description,
                price: payload.price,
                load: payload.load,
                type: 'weaponModule',
                weaponModuleData: Object.assign({}, payload, { anchor: undefined })
            });

            // Очищаем слоты
            if (payload.anchor && payload.slotsRequired === 2) {
                weapon.modules[slotIndex] = null;
                if (weapon.modules[slotIndex + 1] && weapon.modules[slotIndex + 1].linked) {
                    weapon.modules[slotIndex + 1] = null;
                }
            } else {
                weapon.modules[slotIndex] = null;
            }

            // Обновляем максимум патронов для модулей магазина
            updateWeaponMagazineCapacity(weapon);

            renderGear();
            renderWeapons();
            scheduleSave();
            showModal('Модуль снят', `✅ ${payload.name} возвращен в снаряжение!`);
        }

        // Функция обновления вместимости магазина оружия
        function updateWeaponMagazineCapacity(weapon) {
            if (weapon.type !== 'ranged') return;
            
            // Базовая вместимость магазина
            const baseMagazine = parseInt(weapon.magazine);
            let multiplier = 1;
            
            // Проверяем установленные модули
            const installedModules = weapon.modules.filter(m => m && !m.linked);
            
            for (const module of installedModules) {
                if (module.name === 'Барабанный магазин' || module.name === 'Увеличенный магазин') {
                    multiplier *= 4; // Каждый модуль умножает на 4
                }
            }
            
            // Обновляем максимум патронов
            weapon.maxAmmo = baseMagazine * multiplier;
            
            // Если текущее количество патронов превышает новый максимум, обрезаем
            if (weapon.currentAmmo > weapon.maxAmmo) {
                const excessAmmo = weapon.currentAmmo - weapon.maxAmmo;
                weapon.currentAmmo = weapon.maxAmmo;
                
                // Возвращаем лишние патроны в блок Боеприпасы
                if (weapon.loadedAmmoType && excessAmmo > 0) {
                    const weaponTypeForAmmo = getWeaponTypeForAmmo(weapon.name);
                    const existingAmmoIndex = state.ammo.findIndex(a => 
                        a.type === weapon.loadedAmmoType && a.weaponType === weaponTypeForAmmo
                    );
                    
                    if (existingAmmoIndex !== -1) {
                        state.ammo[existingAmmoIndex].quantity += excessAmmo;
                    } else {
                        // Создаем новый тип боеприпасов
                        const newAmmo = {
                            id: generateId('ammo'),
                            type: weapon.loadedAmmoType,
                            weaponType: weaponTypeForAmmo,
                            quantity: excessAmmo,
                            price: 0
                        };
                        state.ammo.push(newAmmo);
                    }
                    renderAmmo();
                }
            }
        }

        // Функция магазина модулей оружия
        function showWeaponModulesShop() {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            const existingModals = document.querySelectorAll('.modal-overlay');
            modal.style.zIndex = 1000 + (existingModals.length * 100);
            modal.innerHTML = `
                <div class="modal" style="max-width: 800px; max-height: 90vh; overflow-y: auto;">
                    <div class="modal-header">
                        <h3>🔧 Магазин модулей оружия</h3>
                        <button class="icon-button" onclick="closeModal(this)">×</button>
                    </div>
                    <div class="modal-body">
                        <div style="display: grid; gap: 2rem;">
                            <!-- Модули для оружия ближнего боя -->
                            <div>
                                <h4 style="color: var(--accent); margin-bottom: 1rem;">⚔️ Для оружия ближнего боя</h4>
                                <div style="display: grid; gap: 1rem;">
                                    ${WEAPON_MODULES.melee.map((module) => `
                                        <div class="property-item">
                                            <div class="property-header">
                                                <div class="property-name">${module.name}</div>
                                                <div style="display: flex; gap: 0.5rem; align-items: center;">
                                                    <span style="color: var(--muted); font-size: 0.9rem;">Цена: ${module.price} уе | Нагрузка: ${module.load}</span>
                                                    <button class="pill-button primary-button" onclick="buyWeaponModule('melee', '${module.name}', ${module.price}, ${module.load}, '${module.compatible}', '${module.description.replace(/'/g, "\\'")}')" style="font-size: 0.8rem; padding: 0.3rem 0.6rem;">Купить</button>
                                                    <button class="pill-button muted-button" onclick="getWeaponModuleFree('melee', '${module.name}', ${module.load}, '${module.compatible}', '${module.description.replace(/'/g, "\\'")}')" style="font-size: 0.8rem; padding: 0.3rem 0.6rem;">Бесплатно</button>
                                                </div>
                                            </div>
                                            <div class="property-description">
                                                <div style="font-family: monospace; font-size: 0.8rem; color: var(--muted); margin-bottom: 0.5rem;">
                                                    Для чего подходит: ${module.compatible}
                                                </div>
                                                <div style="font-size: 0.9rem;">
                                                    ${module.description}
                                                </div>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                            
                            <!-- Модули для оружия дальнего боя -->
                            <div>
                                <h4 style="color: var(--accent); margin-bottom: 1rem;">🔫 Для оружия дальнего боя</h4>
                                <div style="display: grid; gap: 1rem;">
                                    ${WEAPON_MODULES.ranged.map((module) => `
                                        <div class="property-item">
                                            <div class="property-header">
                                                <div class="property-name">${module.name}${module.slotsRequired ? ` (ТРЕБУЕТ ${module.slotsRequired} СЛОТА)` : ''}</div>
                                                <div style="display: flex; gap: 0.5rem; align-items: center;">
                                                    <span style="color: var(--muted); font-size: 0.9rem;">Цена: ${module.price} уе | Нагрузка: ${module.load}</span>
                                                    <button class="pill-button primary-button" onclick="buyWeaponModule('ranged', '${module.name}', ${module.price}, ${module.load}, '${module.compatible}', '${module.description.replace(/'/g, "\\'")}', ${module.slotsRequired || 1})" style="font-size: 0.8rem; padding: 0.3rem 0.6rem;">Купить</button>
                                                    <button class="pill-button muted-button" onclick="getWeaponModuleFree('ranged', '${module.name}', ${module.load}, '${module.compatible}', '${module.description.replace(/'/g, "\\'")}', ${module.slotsRequired || 1})" style="font-size: 0.8rem; padding: 0.3rem 0.6rem;">Бесплатно</button>
                                                </div>
                                            </div>
                                            <div class="property-description">
                                                <div style="font-family: monospace; font-size: 0.8rem; color: var(--muted); margin-bottom: 0.5rem;">
                                                    Для чего подходит: ${module.compatible}
                                                </div>
                                                <div style="font-size: 0.9rem;">
                                                    ${module.description}
                                                </div>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closeModal(modal.querySelector('.icon-button'));
                }
            });
        }

        // Функции покупки модулей оружия
        function buyWeaponModule(category, name, price, load, compatible, description, slotsRequired = 1) {
            const currentMoney = parseInt(state.money) || 0;
            
            if (currentMoney < price) {
                showModal('Ошибка', `
                    <div style="text-align: center; padding: 1rem; background: var(--danger); color: white; border-radius: 8px;">
                        <p style="font-size: 1.1rem; margin-bottom: 1rem;">Нищим не продаём. Вали отсюда!</p>
                        <button class="pill-button" onclick="closeModal(this)">Понятно</button>
                    </div>
                `);
                return;
            }
            
            // Списываем деньги
            state.money = currentMoney - price;
            updateMoneyDisplay();
            
            // Добавляем модуль в снаряжение
            const newModule = {
                id: generateId('gear'),
                name: name,
                description: description,
                price: price,
                load: load,
                type: 'weaponModule',
                weaponModuleData: {
                    name: name,
                    description: description,
                    price: price,
                    load: load,
                    compatible: compatible,
                    category: category,
                    slotsRequired: slotsRequired
                }
            };
            
            state.gear.push(newModule);
            renderGear();
            scheduleSave();
            
            showModal('Модуль куплен', `✅ ${name} добавлен в Снаряжение!`);
        }

        function getWeaponModuleFree(category, name, load, compatible, description, slotsRequired = 1) {
            // Добавляем модуль в снаряжение бесплатно
            const newModule = {
                id: generateId('gear'),
                name: name,
                description: description,
                price: 0,
                load: load,
                type: 'weaponModule',
                weaponModuleData: {
                    name: name,
                    description: description,
                    price: 0,
                    load: load,
                    compatible: compatible,
                    category: category,
                    slotsRequired: slotsRequired
                }
            };
            
            state.gear.push(newModule);
            renderGear();
            scheduleSave();
            
            showModal('Модуль получен', `✅ ${name} добавлен в Снаряжение бесплатно!`);
        }


        function renderGear() {
            const container = document.getElementById('gearContainer');
            if (!container) return;
            
            if (state.gear.length === 0) {
                container.innerHTML = '<p style="color: var(--muted); text-align: center; padding: 1rem;">Снаряжение не добавлено</p>';
                return;
            }
            
            container.innerHTML = state.gear.map((item, index) => `
                <div class="gear-item" style="display: flex; align-items: center; gap: 1rem; padding: 0.75rem; background: rgba(0,0,0,0.2); border: 1px solid rgba(182, 103, 255, 0.2); border-radius: 8px; margin-bottom: 0.5rem;">
                    <div style="flex: 1;">
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <span style="color: var(--accent); font-weight: 600;">${item.name}</span>
                            <span style="color: var(--muted); font-size: 0.8rem; background: rgba(59, 130, 246, 0.2); padding: 0.2rem 0.4rem; border-radius: 4px;">Нагрузка: ${item.load}</span>
                        </div>
                        ${item.description ? `<div style=\"color: var(--muted); font-size: 0.8rem; margin-top: 0.25rem;\">${item.description}</div>` : ''}
                    </div>
                    <div style=\"display:flex; flex-direction:column; gap:0.25rem; align-items:flex-end;\">
                        ${item.type === 'weapon' ? `<button title=\"Взять в руки\" onclick=\"takeWeaponFromGear(${index})\" style=\"background: transparent; border: none; color: #ffffff; font-size: 1.25rem; line-height:1; padding: 0.2rem; cursor: pointer;\">✋</button>` : ''}
                        <button title=\"Удалить\" onclick=\"removeGear(${index})\" style=\"background: transparent; border: none; color: #ffffff; font-size: 1.25rem; line-height:1; padding: 0.2rem; cursor: pointer;\">🗑️</button>
                    </div>
                </div>
            `).join('');
        }

        function installImplantFromGear(gearIndex) {
            const gear = state.gear[gearIndex];
            if (!gear || !gear.implantData) return;
            
            const implantData = gear.implantData;
            const lossRoll = rollDiceForAwarenessLoss(implantData.awarenessLoss);
            
            // Вычитаем из текущей осознанности
            let currentAwareness;
            if (typeof state.awareness === 'object') {
                currentAwareness = parseInt(state.awareness.current) || 50;
                state.awareness.current = Math.max(0, currentAwareness - lossRoll);
            } else {
                // Для старых сохранений где awareness - число
                currentAwareness = parseInt(state.awareness) || 50;
                state.awareness = {
                    current: Math.max(0, currentAwareness - lossRoll),
                    max: parseInt(state.stats.INT || 5) * 10
                };
            }
            
            const awarenessEl = document.getElementById('awarenessCurrent');
            if (awarenessEl) awarenessEl.value = state.awareness.current;
            
            // Удаляем из снаряжения
            state.gear.splice(gearIndex, 1);
            
            // Обновляем отображение
            renderGear();
            scheduleSave();
            
            showModal('Имплант установлен', `
                <div style="text-align: center; padding: 1rem;">
                    <p style="color: var(--success); font-size: 1.1rem; margin-bottom: 1rem;">✅ ${implantData.name} успешно установлен!</p>
                    <p style="color: var(--danger); margin-bottom: 1rem;">Потеря осознанности: ${lossRoll}</p>
                    <p style="color: var(--muted);">Текущая осознанность: ${typeof state.awareness === 'object' ? state.awareness.current : state.awareness}</p>
                    <button class="pill-button" onclick="closeModal(this)">Закрыть</button>
                </div>
            `);
        }

        function removeGear(index) {
            if (confirm('Удалить предмет из снаряжения?')) {
                const item = state.gear[index];
                if (item) {
                    // Возвращаем нагрузку
                    state.load.current += item.load || 0;
                    // Удаляем предмет
                    state.gear.splice(index, 1);
                    // Обновляем UI и сохраняем
                    renderGear();
                    updateLoadDisplay();
                    scheduleSave();
                }
            }
        }

        function takeWeaponFromGear(gearIndex) {
            const gearItem = state.gear[gearIndex];
            if (!gearItem || gearItem.type !== 'weapon') {
                console.error('Предмет не является оружием или не найден');
                return;
            }
            
            // Создаем объект оружия на основе данных из снаряжения
            const weaponData = gearItem.weaponData || {};
            
            const newWeapon = {
                id: generateId('weapon'),
                name: gearItem.name,
                type: weaponData.type || 'melee', // melee или ranged
                load: gearItem.load || 1,
                slots: 3, // Стандартное количество слотов
                modules: [null, null, null], // Пустые слоты для модулей
                
                // Для оружия ближнего боя
                damage: weaponData.damage || '1d6',
                concealable: weaponData.concealable !== undefined ? (weaponData.concealable ? 'да' : 'нет') : 'нет',
                stealthPenalty: weaponData.stealthPenalty || '0',
                examples: weaponData.examples || '',
                
                // Для оружия дальнего боя
                primaryDamage: weaponData.primaryDamage || weaponData.damage || '1d6',
                altDamage: weaponData.altDamage || weaponData.damage || '1d6',
                hands: weaponData.hands || 1,
                stealth: weaponData.stealth || 0,
                magazine: weaponData.magazine || 10,
                
                // Дополнительные данные
                appearance: weaponData.appearance || '',
                customDescription: weaponData.customDescription || gearItem.description || '',
                
                // Система магазина (только для дальнего боя)
                maxAmmo: weaponData.type === 'ranged' ? parseInt(weaponData.magazine || 10) : 0,
                currentAmmo: 0,
                loadedAmmoType: null,
                // Особая система для дробовиков
                isShotgun: gearItem.name.includes('Дробовик'),
                shotgunAmmo1: { type: null, count: 0 }, // Первый тип патронов (до 3 шт)
                shotgunAmmo2: { type: null, count: 0 }  // Второй тип патронов (до 3 шт)
            };
            
            // Добавляем оружие в блок "Оружие"
            state.weapons.push(newWeapon);
            
            // Удаляем из снаряжения
            state.gear.splice(gearIndex, 1);
            
            // Обновляем интерфейс
            renderWeapons();
            renderGear();
            scheduleSave();
            
            showModal('Оружие взято в руки', `✅ ${newWeapon.name} перемещено в блок "Оружие"!`);
        }

        // Функции для работы с боеприпасами
        function renderAmmo() {
            const container = document.getElementById('ammoContainer');
            if (!container) return;
            
            if (state.ammo.length === 0) {
                container.innerHTML = '<p style="color: var(--muted); text-align: center; padding: 1rem; font-size: 0.8rem;">Боеприпасы не добавлены</p>';
                return;
            }
            
            container.innerHTML = state.ammo.map((ammo, index) => `
                <div style="background: rgba(182, 103, 255, 0.1); border: 1px solid var(--accent); border-radius: 6px; padding: 0.5rem 0.75rem; margin-bottom: 0.5rem; display: flex; justify-content: space-between; align-items: center;">
                    <div style="flex: 1;">
                        <div style="color: var(--accent); font-weight: 600; font-size: 0.85rem;">${ammo.type}</div>
                        <div style="color: var(--muted); font-size: 0.7rem; font-family: monospace; margin-top: 0.1rem;">${ammo.weaponType}</div>
                    </div>
                    <div style="display: flex; gap: 0.5rem; align-items: center;">
                        <div style="display: flex; align-items: center; gap: 0.25rem;">
                            <button onclick="changeAmmoQuantity(${index}, -1)" style="font-size: 0.75rem; padding: 0.2rem 0.4rem; min-width: 24px; background: transparent; border: none; color: var(--text); cursor: pointer;">−</button>
                            <span style="color: var(--accent); font-weight: 600; min-width: 35px; text-align: center; font-size: 0.85rem;">${ammo.quantity}</span>
                        </div>
                        <button class="pill-button danger-button" onclick="removeAmmo(${index})" style="font-size: 0.7rem; padding: 0.25rem 0.5rem;">Удалить</button>
                    </div>
                </div>
            `).join('');
        }

        function showAmmoShop() {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            const existingModals = document.querySelectorAll('.modal-overlay');
            modal.style.zIndex = 1000 + (existingModals.length * 100);
            
            let shopHTML = `
                <div class="modal" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
                    <div class="modal-header">
                        <h3>🔫 Магазин боеприпасов</h3>
                        <button class="icon-button" onclick="closeModal(this)">×</button>
                    </div>
                    <div class="modal-body">
                        <div style="margin-bottom: 1rem; padding: 1rem; background: rgba(125, 244, 198, 0.1); border: 1px solid var(--success); border-radius: 8px;">
                            <p style="color: var(--success); font-weight: 600; margin-bottom: 0.5rem;">ℹ️ Информация о боеприпасах:</p>
                            <p style="color: var(--muted); font-size: 0.9rem; margin-bottom: 0.25rem;">• 1 пачка патронов = 10 патронов</p>
                            <p style="color: var(--muted); font-size: 0.9rem; margin-bottom: 0.25rem;">• Гранаты и ракеты продаются по 1 штуке</p>
                            <p style="color: var(--muted); font-size: 0.9rem;">• Все боеприпасы имеют нагрузку = 1</p>
                        </div>
                        <div style="display: grid; gap: 2rem;">
            `;
            
            // Проходим по каждому типу боеприпасов
            for (const ammoType of AMMO_DATA.types) {
                shopHTML += `
                    <div>
                        <h4 style="color: var(--accent); margin-bottom: 1rem;">${ammoType}</h4>
                        <div style="display: grid; gap: 0.75rem;">
                `;
                
                // Проходим по каждому типу оружия
                for (const [weaponTypeFull, weaponTypeShort] of Object.entries(AMMO_DATA.weaponTypes)) {
                    const price = AMMO_DATA.prices[ammoType][weaponTypeShort];
                    
                    if (price !== null) {
                        shopHTML += `
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; background: rgba(255, 255, 255, 0.05); border-radius: 6px;">
                                <div>
                                    <span style="color: var(--text); font-weight: 600;">${weaponTypeFull}</span>
                                </div>
                                <div style="display: flex; gap: 0.5rem; align-items: center;">
                                    <span style="color: var(--accent); font-size: 0.9rem;">${price} уе</span>
                                    <button class="pill-button primary-button" onclick="showAmmoQuantityModal('${ammoType}', '${weaponTypeFull}', ${price})" style="font-size: 0.8rem; padding: 0.3rem 0.6rem;">Купить</button>
                                </div>
                            </div>
                        `;
                    }
                }
                
                shopHTML += `
                        </div>
                    </div>
                `;
            }
            
            shopHTML += `
                        </div>
                    </div>
                </div>
            `;
            
            modal.innerHTML = shopHTML;
            document.body.appendChild(modal);
            
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closeModal(modal.querySelector('.icon-button'));
                }
            });
        }

        function showAmmoQuantityModal(ammoType, weaponType, price) {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            const existingModals = document.querySelectorAll('.modal-overlay');
            modal.style.zIndex = 1000 + (existingModals.length * 100);
            
            const isGrenadeOrRocket = weaponType === 'Гранаты' || weaponType === 'Ракеты';
            const unitText = isGrenadeOrRocket ? 'шт.' : 'пачек';
            const contentText = isGrenadeOrRocket ? 'штук' : 'пачек (по 10 патронов)';
            
            modal.innerHTML = `
                <div class="modal" style="max-width: 500px;">
                    <div class="modal-header">
                        <h3>🛒 Покупка боеприпасов</h3>
                        <button class="icon-button" onclick="closeModal(this)">×</button>
                    </div>
                    <div class="modal-body">
                        <div style="margin-bottom: 1rem;">
                            <p style="margin-bottom: 0.5rem;"><strong>${ammoType}</strong></p>
                            <p style="color: var(--muted); font-size: 0.9rem; margin-bottom: 1rem;">
                                Для: <strong style="color: var(--accent);">${weaponType}</strong>
                            </p>
                            <p style="color: var(--muted); font-size: 0.9rem; margin-bottom: 1rem;">
                                Цена за ${isGrenadeOrRocket ? '1 штуку' : '1 пачку'}: <strong style="color: var(--success);">${price} уе</strong>
                            </p>
                        </div>
                        
                        <div class="input-group">
                            <label class="input-label">Количество ${contentText}</label>
                            <input type="number" class="input-field" id="ammoQuantity" value="1" min="1" max="99" onchange="updateAmmoTotal(${price})">
                        </div>
                        
                        <div style="margin-top: 1rem; padding: 0.75rem; background: rgba(182, 103, 255, 0.1); border: 1px solid var(--accent); border-radius: 8px; text-align: center;">
                            <div style="color: var(--accent); font-weight: 600;">Итого: <span id="ammoTotalPrice">${price}</span> уе</div>
                            ${!isGrenadeOrRocket ? '<div style="color: var(--muted); font-size: 0.8rem; margin-top: 0.25rem;">Патронов: <span id="ammoTotalBullets">10</span> шт.</div>' : ''}
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="pill-button primary-button" onclick="buyAmmoWithQuantity('${ammoType}', '${weaponType}', ${price})">Купить</button>
                        <button class="pill-button" onclick="closeModal(this)">Отмена</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closeModal(modal.querySelector('.icon-button'));
                }
            });
            
            // Фокусируемся на поле количества
            setTimeout(() => {
                const input = document.getElementById('ammoQuantity');
                if (input) input.focus();
            }, 100);
        }

        function updateAmmoTotal(pricePerUnit) {
            const quantity = parseInt(document.getElementById('ammoQuantity').value) || 1;
            const totalPrice = quantity * pricePerUnit;
            
            const totalPriceEl = document.getElementById('ammoTotalPrice');
            const totalBulletsEl = document.getElementById('ammoTotalBullets');
            
            if (totalPriceEl) {
                totalPriceEl.textContent = totalPrice;
            }
            
            if (totalBulletsEl) {
                totalBulletsEl.textContent = quantity * 10;
            }
        }

        function buyAmmoWithQuantity(ammoType, weaponType, pricePerUnit) {
            const quantity = parseInt(document.getElementById('ammoQuantity').value) || 1;
            const totalPrice = quantity * pricePerUnit;
            const currentMoney = parseInt(state.money) || 0;
            
            if (currentMoney < totalPrice) {
                showModal('Ошибка', `
                    <div style="text-align: center; padding: 1rem; background: var(--danger); color: white; border-radius: 8px;">
                        <p style="font-size: 1.1rem; margin-bottom: 1rem;">Недостаточно денег!</p>
                        <p style="margin-bottom: 1rem;">Требуется: ${totalPrice} уе | Доступно: ${currentMoney} уе</p>
                        <button class="pill-button" onclick="closeModal(this)">Понятно</button>
                    </div>
                `);
                return;
            }
            
            // Списываем деньги
            state.money = currentMoney - totalPrice;
            updateMoneyDisplay();
            
            // Определяем количество добавляемых единиц
            const addQuantity = (weaponType === 'Гранаты' || weaponType === 'Ракеты') ? quantity : quantity * 10;
            
            // Рассчитываем нагрузку (каждые 10 патронов/гранат/ракет = 1 нагрузка)
            const loadToDeduct = (weaponType === 'Гранаты' || weaponType === 'Ракеты') ? quantity : quantity;
            
            // Вычитаем нагрузку (без проверок)
            state.load.current -= loadToDeduct;
            updateLoadDisplay();
            
            // Проверяем, есть ли уже такой тип боеприпасов
            const existingAmmoIndex = state.ammo.findIndex(a => a.type === ammoType && a.weaponType === weaponType);
            
            if (existingAmmoIndex !== -1) {
                // Увеличиваем количество
                state.ammo[existingAmmoIndex].quantity += addQuantity;
            } else {
                // Добавляем новый тип боеприпасов
                const newAmmo = {
                    id: generateId('ammo'),
                    type: ammoType,
                    weaponType: weaponType,
                    quantity: addQuantity,
                    price: pricePerUnit
                };
                state.ammo.push(newAmmo);
            }
            
            renderAmmo();
            scheduleSave();
            
            const quantityText = (weaponType === 'Гранаты' || weaponType === 'Ракеты') 
                ? `${quantity} шт.` 
                : `${addQuantity} патронов (${quantity} пачек)`;
            
            closeModal(document.querySelector('.modal-overlay .icon-button'));
            
            showModal('Боеприпасы куплены', `
                <div style="text-align: center; padding: 1rem;">
                    <p style="color: var(--success); font-size: 1.1rem; margin-bottom: 1rem;">✅ Боеприпасы куплены!</p>
                    <p style="color: var(--text); margin-bottom: 0.5rem;"><strong>${ammoType}</strong></p>
                    <p style="color: var(--muted); margin-bottom: 1rem;">Для: ${weaponType}</p>
                    <p style="color: var(--accent); margin-bottom: 1rem;">Получено: ${quantityText}</p>
                    <p style="color: var(--muted);">Потрачено: ${totalPrice} уе</p>
                </div>
            `);
        }

        function buyAmmo(ammoType, weaponType, price) {
            const currentMoney = parseInt(state.money) || 0;
            
            if (currentMoney < price) {
                showModal('Ошибка', `
                    <div style="text-align: center; padding: 1rem; background: var(--danger); color: white; border-radius: 8px;">
                        <p style="font-size: 1.1rem; margin-bottom: 1rem;">Недостаточно денег!</p>
                        <button class="pill-button" onclick="closeModal(this)">Понятно</button>
                    </div>
                `);
                return;
            }
            
            // Списываем деньги
            state.money = currentMoney - price;
            updateMoneyDisplay();
            
            // Проверяем, есть ли уже такой тип боеприпасов
            const existingAmmoIndex = state.ammo.findIndex(a => a.type === ammoType && a.weaponType === weaponType);
            
            // Определяем количество добавляемых единиц
            const addQuantity = (weaponType === 'Гранаты' || weaponType === 'Ракеты') ? 1 : 10;
            
            if (existingAmmoIndex !== -1) {
                // Увеличиваем количество
                state.ammo[existingAmmoIndex].quantity += addQuantity;
            } else {
                // Добавляем новый тип боеприпасов
                const newAmmo = {
                    id: generateId('ammo'),
                    type: ammoType,
                    weaponType: weaponType,
                    quantity: addQuantity,
                    price: price
                };
                state.ammo.push(newAmmo);
            }
            
            renderAmmo();
            scheduleSave();
            
            const quantityText = (weaponType === 'Гранаты' || weaponType === 'Ракеты') 
                ? '1 шт.' 
                : '10 патронов';
            
            showModal('Боеприпасы куплены', `
                <div style="text-align: center; padding: 1rem;">
                    <p style="color: var(--success); font-size: 1.1rem; margin-bottom: 1rem;">✅ ${ammoType} (${weaponType}) куплены!</p>
                    <p style="color: var(--muted); font-size: 0.9rem;">Куплено: ${quantityText}</p>
                </div>
            `);
        }

        function changeAmmoQuantity(index, delta) {
            if (!state.ammo[index]) return;
            
            const ammo = state.ammo[index];
            const oldQuantity = ammo.quantity;
            const newQuantity = oldQuantity + delta;
            
            if (newQuantity < 0) {
                showModal('Ошибка', 'Количество не может быть отрицательным!');
                return;
            }
            
            // Рассчитываем изменение нагрузки
            const isGrenadeOrRocket = (ammo.weaponType === 'Гранаты' || ammo.weaponType === 'Ракеты');
            
            if (delta < 0) { // Уменьшаем количество
                const quantityReduced = Math.abs(delta);
                let loadToReturn = 0;
                
                if (isGrenadeOrRocket) {
                    // Для гранат и ракет: каждая штука = 1 нагрузка
                    loadToReturn = quantityReduced;
                } else {
                    // Для патронов: каждые 10 патронов = 1 нагрузка
                    const oldLoadUnits = Math.ceil(oldQuantity / 10);
                    const newLoadUnits = Math.ceil(newQuantity / 10);
                    loadToReturn = oldLoadUnits - newLoadUnits;
                }
                
                // Возвращаем нагрузку
                state.load.current += loadToReturn;
                updateLoadDisplay();
            }
            
            ammo.quantity = newQuantity;
            renderAmmo();
            scheduleSave();
        }

        function removeAmmo(index) {
            if (confirm('Удалить этот тип боеприпасов?')) {
                const ammo = state.ammo[index];
                if (ammo) {
                    // Возвращаем нагрузку
                    const isGrenadeOrRocket = (ammo.weaponType === 'Гранаты' || ammo.weaponType === 'Ракеты');
                    const loadToReturn = isGrenadeOrRocket ? ammo.quantity : Math.ceil(ammo.quantity / 10);
                    
                    state.load.current += loadToReturn;
                    updateLoadDisplay();
                }
                
                state.ammo.splice(index, 1);
                renderAmmo();
                scheduleSave();
            }
        }

        // Функция перезарядки оружия
        function reloadWeapon(weaponId) {
            const weapon = state.weapons.find(w => w.id === weaponId);
            if (!weapon || weapon.type !== 'ranged') {
                showModal('Ошибка', 'Оружие не найдено или не является дальним!');
                return;
            }
            
            // Определяем тип оружия для поиска подходящих боеприпасов
            const weaponTypeForAmmo = getWeaponTypeForAmmo(weapon.name);
            
            // Находим подходящие боеприпасы
            const compatibleAmmo = state.ammo.filter(ammo => 
                ammo.weaponType === weaponTypeForAmmo && ammo.quantity > 0
            );
            
            if (compatibleAmmo.length === 0) {
                showModal('Нет боеприпасов', `
                    <div style="text-align: center; padding: 1rem;">
                        <p style="color: var(--danger); font-size: 1.1rem; margin-bottom: 1rem;">У вас нет подходящих боеприпасов!</p>
                        <p style="color: var(--muted); margin-bottom: 1rem;">Купите боеприпасы для ${weaponTypeForAmmo}</p>
                        <button class="pill-button" onclick="closeModal(this)">Закрыть</button>
                    </div>
                `);
                return;
            }
            
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            const existingModals = document.querySelectorAll('.modal-overlay');
            modal.style.zIndex = 1000 + (existingModals.length * 100);
            modal.innerHTML = `
                <div class="modal" style="max-width: 500px;">
                    <div class="modal-header">
                        <h3>🔄 Перезарядка: ${weapon.name}</h3>
                        <button class="icon-button" onclick="closeModal(this)">×</button>
                    </div>
                    <div class="modal-body">
                        <div style="margin-bottom: 1rem;">
                            <p style="color: var(--text); margin-bottom: 0.5rem;"><strong>Текущее состояние:</strong></p>
                            <p style="color: var(--muted); font-size: 0.9rem;">
                                Патронов: ${weapon.currentAmmo}/${weapon.maxAmmo}
                                ${weapon.loadedAmmoType ? ` | Тип: ${weapon.loadedAmmoType}` : ' | Не заряжено'}
                            </p>
                        </div>
                        
                        <div style="margin-bottom: 1rem;">
                            <label class="input-label">Выберите тип боеприпасов</label>
                            <select class="input-field" id="reloadAmmoType">
                                ${compatibleAmmo.map((ammo, index) => `
                                    <option value="${index}">${ammo.type} (${ammo.quantity} шт.)</option>
                                `).join('')}
                            </select>
                        </div>
                        
                        <div id="reloadWarning" style="margin-bottom: 1rem; padding: 0.75rem; background: rgba(255, 165, 0, 0.1); border: 1px solid orange; border-radius: 8px; display: none;">
                            <p style="color: orange; font-size: 0.9rem; margin-bottom: 0.5rem;">⚠️ Внимание!</p>
                            <p style="color: var(--text); font-size: 0.8rem;" id="reloadWarningText">
                                В магазине есть патроны другого типа. При перезарядке они будут возвращены в блок Боеприпасы.
                            </p>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="pill-button primary-button" onclick="executeReload('${weaponId}')">
                            🔄 Перезарядить
                        </button>
                        <button class="pill-button" onclick="closeModal(this)">
                            Отмена
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Добавляем обработчик изменения типа боеприпасов
            setTimeout(() => {
                const ammoSelect = document.getElementById('reloadAmmoType');
                const warningDiv = document.getElementById('reloadWarning');
                const warningText = document.getElementById('reloadWarningText');
                
                function checkAmmoTypeChange() {
                    const selectedIndex = parseInt(ammoSelect.value);
                    const selectedAmmo = compatibleAmmo[selectedIndex];
                    
                    if (weapon.currentAmmo > 0 && weapon.loadedAmmoType && weapon.loadedAmmoType !== selectedAmmo.type) {
                        warningDiv.style.display = 'block';
                        warningText.textContent = `В магазине есть патроны типа "${weapon.loadedAmmoType}" (${weapon.currentAmmo} шт.). При перезарядке они будут возвращены в блок Боеприпасы.`;
                    } else {
                        warningDiv.style.display = 'none';
                    }
                }
                
                ammoSelect.addEventListener('change', checkAmmoTypeChange);
                checkAmmoTypeChange(); // Проверяем при открытии
            }, 100);
            
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closeModal(modal.querySelector('.icon-button'));
                }
            });
        }

        function executeReload(weaponId) {
            const weapon = state.weapons.find(w => w.id === weaponId);
            if (!weapon) return;
            
            const selectedAmmoIndex = parseInt(document.getElementById('reloadAmmoType').value);
            const weaponTypeForAmmo = getWeaponTypeForAmmo(weapon.name);
            const compatibleAmmo = state.ammo.filter(ammo => 
                ammo.weaponType === weaponTypeForAmmo && ammo.quantity > 0
            );
            const selectedAmmo = compatibleAmmo[selectedAmmoIndex];
            
            if (!selectedAmmo) {
                showModal('Ошибка', 'Выбранные боеприпасы не найдены!');
                return;
            }
            
            // Если в магазине есть патроны другого типа, возвращаем их в блок Боеприпасы
            if (weapon.currentAmmo > 0 && weapon.loadedAmmoType && weapon.loadedAmmoType !== selectedAmmo.type) {
                const existingAmmoIndex = state.ammo.findIndex(a => 
                    a.type === weapon.loadedAmmoType && a.weaponType === weaponTypeForAmmo
                );
                
                if (existingAmmoIndex !== -1) {
                    state.ammo[existingAmmoIndex].quantity += weapon.currentAmmo;
                } else {
                    // Создаем новый тип боеприпасов
                    const newAmmo = {
                        id: generateId('ammo'),
                        type: weapon.loadedAmmoType,
                        weaponType: weaponTypeForAmmo,
                        quantity: weapon.currentAmmo,
                        price: 0
                    };
                    state.ammo.push(newAmmo);
                }
            }
            
            // Рассчитываем сколько патронов нужно для полной перезарядки
            const ammoNeeded = weapon.maxAmmo - (weapon.loadedAmmoType === selectedAmmo.type ? weapon.currentAmmo : 0);
            const ammoToTake = Math.min(ammoNeeded, selectedAmmo.quantity);
            
            // Находим индекс в основном массиве боеприпасов
            const realAmmoIndex = state.ammo.findIndex(ammo => ammo.id === selectedAmmo.id);
            
            if (realAmmoIndex !== -1) {
                // Вычитаем патроны из блока Боеприпасы
                state.ammo[realAmmoIndex].quantity -= ammoToTake;
                
                // Заряжаем оружие
                weapon.currentAmmo = (weapon.loadedAmmoType === selectedAmmo.type ? weapon.currentAmmo : 0) + ammoToTake;
                weapon.loadedAmmoType = selectedAmmo.type;
                
                renderAmmo();
                renderWeapons();
                scheduleSave();
                
                closeModal(document.querySelector('.modal-overlay .icon-button'));
                
                const reloadMessage = ammoToTake === ammoNeeded ? 
                    'Магазин полностью заряжен!' : 
                    `Заряжено ${ammoToTake} из ${ammoNeeded} патронов (не хватило боеприпасов)`;
                
                showModal('Перезарядка завершена', `
                    <div style="text-align: center; padding: 1rem;">
                        <p style="color: var(--success); font-size: 1.1rem; margin-bottom: 1rem;">✅ ${weapon.name}</p>
                        <p style="color: var(--text); margin-bottom: 0.5rem;">${reloadMessage}</p>
                        <p style="color: var(--muted); font-size: 0.9rem;">Тип: ${selectedAmmo.type} | Патронов: ${weapon.currentAmmo}/${weapon.maxAmmo}</p>
                        <button class="pill-button" onclick="closeModal(this)">Закрыть</button>
                    </div>
                `);
            }
        }

        function reloadShotgun(weaponId) {
            const weapon = state.weapons.find(w => w.id === weaponId);
            if (!weapon || !weapon.isShotgun) {
                showModal('Ошибка', 'Оружие не найдено или не является дробовиком!');
                return;
            }
            
            // Находим подходящие боеприпасы для дробовика
            const compatibleAmmo = state.ammo.filter(ammo => 
                ammo.weaponType === 'Дробовик' && ammo.quantity > 0
            );
            
            if (compatibleAmmo.length === 0) {
                showModal('Нет боеприпасов', `
                    <div style="text-align: center; padding: 1rem;">
                        <p style="color: var(--danger); font-size: 1.1rem; margin-bottom: 1rem;">У вас нет патронов для дробовика!</p>
                        <button class="pill-button" onclick="closeModal(this)">Закрыть</button>
                    </div>
                `);
                return;
            }
            
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            const existingModals = document.querySelectorAll('.modal-overlay');
            modal.style.zIndex = 1000 + (existingModals.length * 100);
            modal.innerHTML = `
                <div class="modal" style="max-width: 600px;">
                    <div class="modal-header">
                        <h3>🔄 Перезарядка дробовика: ${weapon.name}</h3>
                        <button class="icon-button" onclick="closeModal(this)">×</button>
                    </div>
                    <div class="modal-body">
                        <div style="margin-bottom: 1rem;">
                            <p style="color: var(--text); margin-bottom: 0.5rem;"><strong>Текущее состояние:</strong></p>
                            <div style="display: grid; gap: 0.5rem; margin-bottom: 1rem;">
                                <p style="color: var(--muted); font-size: 0.9rem;">
                                    Слот 1: ${weapon.shotgunAmmo1.count}/3 ${weapon.shotgunAmmo1.type ? `(${weapon.shotgunAmmo1.type})` : '(пусто)'}
                                </p>
                                <p style="color: var(--muted); font-size: 0.9rem;">
                                    Слот 2: ${weapon.shotgunAmmo2.count}/3 ${weapon.shotgunAmmo2.type ? `(${weapon.shotgunAmmo2.type})` : '(пусто)'}
                                </p>
                            </div>
                        </div>
                        
                        <div style="margin-bottom: 1rem;">
                            <label class="input-label">Выберите слот для перезарядки</label>
                            <select class="input-field" id="shotgunSlot">
                                <option value="1">Слот 1 (${weapon.shotgunAmmo1.count}/3)</option>
                                <option value="2">Слот 2 (${weapon.shotgunAmmo2.count}/3)</option>
                            </select>
                        </div>
                        
                        <div style="margin-bottom: 1rem;">
                            <label class="input-label">Выберите тип боеприпасов</label>
                            <select class="input-field" id="shotgunAmmoType">
                                ${compatibleAmmo.map((ammo, index) => `
                                    <option value="${index}">${ammo.type} (${ammo.quantity} шт.)</option>
                                `).join('')}
                            </select>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="pill-button primary-button" onclick="executeShotgunReload('${weaponId}')">
                            🔄 Перезарядить
                        </button>
                        <button class="pill-button" onclick="closeModal(this)">
                            Отмена
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closeModal(modal.querySelector('.icon-button'));
                }
            });
        }

        function executeShotgunReload(weaponId) {
            const weapon = state.weapons.find(w => w.id === weaponId);
            if (!weapon) return;
            
            const selectedSlot = parseInt(document.getElementById('shotgunSlot').value);
            const selectedAmmoIndex = parseInt(document.getElementById('shotgunAmmoType').value);
            
            const compatibleAmmo = state.ammo.filter(ammo => 
                ammo.weaponType === 'Дробовик' && ammo.quantity > 0
            );
            const selectedAmmo = compatibleAmmo[selectedAmmoIndex];
            
            if (!selectedAmmo) {
                showModal('Ошибка', 'Выбранные боеприпасы не найдены!');
                return;
            }
            
            const slotData = selectedSlot === 1 ? weapon.shotgunAmmo1 : weapon.shotgunAmmo2;
            
            // Если в слоте есть патроны другого типа, возвращаем их в блок Боеприпасы
            if (slotData.count > 0 && slotData.type && slotData.type !== selectedAmmo.type) {
                const existingAmmoIndex = state.ammo.findIndex(a => 
                    a.type === slotData.type && a.weaponType === 'Дробовик'
                );
                
                if (existingAmmoIndex !== -1) {
                    state.ammo[existingAmmoIndex].quantity += slotData.count;
                } else {
                    const newAmmo = {
                        id: generateId('ammo'),
                        type: slotData.type,
                        weaponType: 'Дробовик',
                        quantity: slotData.count,
                        price: 0
                    };
                    state.ammo.push(newAmmo);
                }
            }
            
            // Рассчитываем сколько патронов нужно для полной перезарядки слота
            const ammoNeeded = 3 - (slotData.type === selectedAmmo.type ? slotData.count : 0);
            const ammoToTake = Math.min(ammoNeeded, selectedAmmo.quantity);
            
            // Находим индекс в основном массиве боеприпасов
            const realAmmoIndex = state.ammo.findIndex(ammo => ammo.id === selectedAmmo.id);
            
            if (realAmmoIndex !== -1) {
                // Вычитаем патроны из блока Боеприпасы
                state.ammo[realAmmoIndex].quantity -= ammoToTake;
                
                // Заряжаем слот дробовика
                slotData.count = (slotData.type === selectedAmmo.type ? slotData.count : 0) + ammoToTake;
                slotData.type = selectedAmmo.type;
                
                renderAmmo();
                renderWeapons();
                scheduleSave();
                
                closeModal(document.querySelector('.modal-overlay .icon-button'));
                
                const reloadMessage = ammoToTake === ammoNeeded ? 
                    `Слот ${selectedSlot} полностью заряжен!` : 
                    `В слот ${selectedSlot} заряжено ${ammoToTake} из ${ammoNeeded} патронов`;
                
                showModal('Перезарядка завершена', `
                    <div style="text-align: center; padding: 1rem;">
                        <p style="color: var(--success); font-size: 1.1rem; margin-bottom: 1rem;">✅ ${weapon.name}</p>
                        <p style="color: var(--text); margin-bottom: 0.5rem;">${reloadMessage}</p>
                        <p style="color: var(--muted); font-size: 0.9rem;">Тип: ${selectedAmmo.type} | Патронов: ${slotData.count}/3</p>
                        <button class="pill-button" onclick="closeModal(this)">Закрыть</button>
                    </div>
                `);
            }
        }

        // Особая механика стрельбы для дробовиков
        function showShotgunShootingModal(damageFormula, weaponName, weaponId) {
            const weapon = state.weapons.find(w => w.id === weaponId);
            if (!weapon || !weapon.isShotgun) return;
            
            // Проверяем, есть ли патроны в дробовике
            const totalAmmo = weapon.shotgunAmmo1.count + weapon.shotgunAmmo2.count;
            if (totalAmmo <= 0) {
                showModal('Дробовик пуст', `
                    <div style="text-align: center; padding: 1rem;">
                        <p style="color: var(--danger); font-size: 1.1rem; margin-bottom: 1rem;">Дробовик не заряжен!</p>
                        <p style="color: var(--muted); margin-bottom: 1rem;">Сначала перезарядите дробовик</p>
                        <button class="pill-button primary-button" onclick="closeModal(this); setTimeout(() => reloadShotgun('${weaponId}'), 100)">Перезарядить</button>
                        <button class="pill-button" onclick="closeModal(this)">Закрыть</button>
                    </div>
                `);
                return;
            }
            
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.id = 'weaponDamageModal';
            const existingModals = document.querySelectorAll('.modal-overlay');
            modal.style.zIndex = 1000 + (existingModals.length * 100);
            modal.innerHTML = `
                <div class="modal" style="max-width: 600px;">
                    <div class="modal-header">
                        <h3>🔫 Стрельба из дробовика: ${weaponName}</h3>
                        <button class="icon-button" onclick="closeModal(this)">×</button>
                    </div>
                    <div class="modal-body" id="weaponDamageModalBody">
                        <div id="weaponSetupSection">
                            <div style="margin-bottom: 1rem;">
                                <p style="margin-bottom: 0.75rem;"><strong>${weaponName}</strong></p>
                            </div>
                            
                            <!-- Информация о заряженных патронах -->
                            <div style="margin-bottom: 1rem; padding: 0.75rem; background: rgba(125, 244, 198, 0.1); border: 1px solid var(--success); border-radius: 8px;">
                                <p style="color: var(--success); font-weight: 600; margin-bottom: 0.5rem;">Заряженные патроны:</p>
                                <div style="display: grid; gap: 0.25rem;">
                                    ${weapon.shotgunAmmo1.count > 0 ? `
                                        <p style="color: var(--text); font-size: 0.9rem;">
                                            Слот 1: <strong>${weapon.shotgunAmmo1.type}</strong> (${weapon.shotgunAmmo1.count}/3)
                                        </p>
                                    ` : ''}
                                    ${weapon.shotgunAmmo2.count > 0 ? `
                                        <p style="color: var(--text); font-size: 0.9rem;">
                                            Слот 2: <strong>${weapon.shotgunAmmo2.type}</strong> (${weapon.shotgunAmmo2.count}/3)
                                        </p>
                                    ` : ''}
                                </div>
                            </div>
                            
                            <!-- Выбор слота для стрельбы -->
                            <div style="margin-bottom: 1rem;">
                                <label class="input-label">Выберите слот для стрельбы</label>
                                <select class="input-field" id="shotgunShootSlot">
                                    ${weapon.shotgunAmmo1.count > 0 ? `<option value="1">Слот 1: ${weapon.shotgunAmmo1.type} (${weapon.shotgunAmmo1.count}/3)</option>` : ''}
                                    ${weapon.shotgunAmmo2.count > 0 ? `<option value="2">Слот 2: ${weapon.shotgunAmmo2.type} (${weapon.shotgunAmmo2.count}/3)</option>` : ''}
                                </select>
                            </div>
                            
                            <!-- Тип стрельбы дробовика -->
                            <div style="margin-bottom: 1rem;">
                                <label class="input-label">Тип стрельбы</label>
                                <div style="display: grid; gap: 0.5rem;">
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                        <input type="radio" name="shotgunFireType" value="target" checked style="margin: 0;">
                                        <span>По цели (3d10 урона)</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                        <input type="radio" name="shotgunFireType" value="area" style="margin: 0;">
                                        <span>По площади (4d6 урона)</span>
                                    </label>
                                </div>
                            </div>
                            
                            <div style="display: grid; gap: 0.75rem;">
                                <label class="field">
                                    Модификатор урона
                                    <input type="text" class="input-field" id="damageModifier" value="0" placeholder="0">
                                </label>
                            </div>
                        </div>
                        
                        <!-- Секция анимации и результатов -->
                        <div id="weaponDamageAnimation" style="display: none;">
                            <div style="text-align: center; padding: 2rem 0;">
                                <div id="weaponDiceDisplay" style="display: flex; justify-content: center; gap: 1rem; flex-wrap: wrap; margin-bottom: 1rem;"></div>
                                <div id="weaponDamageTotal" style="font-size: 2rem; font-weight: 700; color: var(--accent); margin-bottom: 0.5rem;"></div>
                                <div id="weaponDamageFormula" style="font-size: 0.9rem; color: var(--muted);"></div>
                                <div id="weaponCriticalMessage" style="display: none; margin-top: 1rem; padding: 1rem; background: rgba(255, 0, 0, 0.2); border: 2px solid #ff0000; border-radius: 8px;">
                                    <p style="color: #ff0000; font-size: 1.2rem; font-weight: 700; margin-bottom: 0.5rem;">🩸 КРИТИЧЕСКАЯ ТРАВМА! 🩸</p>
                                    <p style="color: var(--text); font-size: 0.9rem;">Ты нанёс Критическую травму! Сообщи Мастеру!</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer" id="weaponDamageFooter">
                        <button class="pill-button primary-button" id="weaponShootButton" onclick="executeShotgunShoot('${weaponId}')">
                            🔫 Стрелять!
                        </button>
                        <button class="pill-button" onclick="closeModal(this)">
                            Отмена
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closeModal(modal.querySelector('.icon-button'));
                }
            });
        }
        
        function executeShotgunShoot(weaponId) {
            const weapon = state.weapons.find(w => w.id === weaponId);
            if (!weapon) return;
            
            const selectedSlot = parseInt(document.getElementById('shotgunShootSlot').value);
            const fireTypeRadios = document.querySelectorAll('input[name="shotgunFireType"]');
            const modifier = parseInt(document.getElementById('damageModifier').value) || 0;
            
            let fireType = 'target';
            for (const radio of fireTypeRadios) {
                if (radio.checked) {
                    fireType = radio.value;
                    break;
                }
            }
            
            const slotData = selectedSlot === 1 ? weapon.shotgunAmmo1 : weapon.shotgunAmmo2;
            
            if (slotData.count <= 0) {
                showModal('Ошибка', 'В выбранном слоте нет патронов!');
                return;
            }
            
            // Списываем 1 патрон из выбранного слота
            slotData.count -= 1;
            
            // Определяем формулу урона в зависимости от типа стрельбы
            const actualDamageFormula = fireType === 'target' ? '3d10' : '4d6';
            const fireTypeText = fireType === 'target' ? 'По цели' : 'По площади';
            
            renderWeapons();
            scheduleSave();
            
            // Скрываем секцию настройки и показываем анимацию
            document.getElementById('weaponSetupSection').style.display = 'none';
            document.getElementById('weaponDamageAnimation').style.display = 'block';
            document.getElementById('weaponShootButton').style.display = 'none';
            
            // Выполняем бросок урона с анимацией
            performWeaponDamageRoll(actualDamageFormula, weaponName, modifier, slotData.type, fireTypeText, 1, weaponId, 'Дробовик', true, 'shotgun');
        }

        // Функции для работы с профессиональными навыками
        function addProfessionalSkill() {
            const name = prompt('Введите название профессионального навыка:');
            if (!name) return;
            
            const description = prompt('Введите описание навыка:');
            if (!description) return;
            
            const level = prompt('Введите уровень навыка (0-10):');
            const skillLevel = Math.max(0, Math.min(10, parseInt(level) || 0));
            
            // Проверяем, не добавлен ли уже этот навык
            if (state.professionalSkills.find(s => s.name === name)) {
                showModal('Ошибка', 'Этот профессиональный навык уже добавлен!');
                return;
            }
            
            const newSkill = {
                id: generateId('proSkill'),
                name: name,
                description: description,
                level: skillLevel
            };
            
            state.professionalSkills.push(newSkill);
            renderProfessionalSkills();
            scheduleSave();
        }

        function updateProfessionalSkillLevel(skillId, newLevel) {
            const skill = state.professionalSkills.find(s => s.id === skillId);
            if (skill) {
                skill.level = Math.max(0, Math.min(10, parseInt(newLevel)));
                renderProfessionalSkills();
                scheduleSave();
            }
        }

        function removeProfessionalSkill(skillId) {
            state.professionalSkills = state.professionalSkills.filter(s => s.id !== skillId);
            renderProfessionalSkills();
            scheduleSave();
        }

        function renderProfessionalSkills() {
            const container = document.getElementById('professionalSkillsContainer');
            if (!container) return;
            
            if (state.professionalSkills.length === 0) {
                container.innerHTML = '<p style="color: var(--muted); text-align: center; padding: 2rem;">Профессиональные навыки не добавлены</p>';
                return;
            }
            
            container.innerHTML = state.professionalSkills.map(skill => `
                <div class="card" style="margin-bottom: 1rem;">
                    <div class="card-header">
                        <div class="card-title">${skill.name}</div>
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <input type="number" class="stat-input" value="${skill.level}" min="0" max="10" onchange="updateProfessionalSkillLevel('${skill.id}', this.value)" style="width: 50px;">
                            <button class="pill-button danger-button" onclick="removeProfessionalSkill('${skill.id}')" style="font-size: 0.8rem; padding: 0.3rem 0.6rem;">🗑️</button>
                        </div>
                    </div>
                    <div class="card-content">
                        ${skill.description}
                    </div>
                </div>
            `).join('');
        }

        function showAddProfessionalSkillModal() {
            const modal = createModal('Добавить профессиональный навык', `
                <div class="modal-content">
                    <div class="input-group">
                        <label class="input-label">Название навыка</label>
                        <input type="text" class="input-field" id="proSkillName" placeholder="Например: Киберхирургия">
                    </div>
                    <div class="input-group">
                        <label class="input-label">Описание</label>
                        <textarea class="input-field" id="proSkillDescription" rows="3" placeholder="Подробное описание навыка..."></textarea>
                    </div>
                    <div class="input-group">
                        <label class="input-label">Уровень (0-10)</label>
                        <input type="number" class="input-field" id="proSkillLevel" value="0" min="0" max="10">
                    </div>
                    <div class="modal-actions">
                        <button class="pill-button" onclick="closeModal(this)">Отмена</button>
                        <button class="pill-button primary-button" onclick="addProfessionalSkillFromModal(); closeModal(this);">Добавить</button>
                    </div>
                </div>
            `);
        }

        function addProfessionalSkillFromModal() {
            const name = document.getElementById('proSkillName').value;
            const description = document.getElementById('proSkillDescription').value;
            const level = parseInt(document.getElementById('proSkillLevel').value) || 0;
            
            if (!name || !description) {
                showModal('Ошибка', 'Заполните все поля!');
                return;
            }
            
            // Проверяем, не добавлен ли уже этот навык
            if (state.professionalSkills.find(s => s.name === name)) {
                showModal('Ошибка', 'Этот профессиональный навык уже добавлен!');
                return;
            }
            
            const newSkill = {
                id: generateId('proSkill'),
                name: name,
                description: description,
                level: Math.max(0, Math.min(10, level))
            };
            
            state.professionalSkills.push(newSkill);
            renderProfessionalSkills();
            scheduleSave();
        }

        // Функции для работы с критическими травмами
        function addCriticalInjury() {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            const existingModals = document.querySelectorAll('.modal-overlay');
            modal.style.zIndex = 1000 + (existingModals.length * 100);
            modal.innerHTML = `
                <div class="modal" style="max-width: 500px;">
                    <div class="modal-header">
                        <h3>💔 Добавить критическую травму</h3>
                        <button class="icon-button" onclick="closeModal(this)">×</button>
                    </div>
                    <div class="modal-body">
                        <div class="input-group">
                            <label class="input-label">Описание травмы</label>
                            <textarea class="input-field" id="injuryDescription" rows="3" placeholder="Опишите критическую травму..."></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="pill-button primary-button" onclick="saveCriticalInjury()">Добавить</button>
                        <button class="pill-button" onclick="closeModal(this)">Отмена</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closeModal(modal.querySelector('.icon-button'));
                }
            });
            
            // Фокусируемся на поле ввода
            setTimeout(() => {
                const input = document.getElementById('injuryDescription');
                if (input) input.focus();
            }, 100);
        }

        function saveCriticalInjury() {
            const description = document.getElementById('injuryDescription').value.trim();
            
            if (!description) {
                showModal('Ошибка', `
                    <div style="text-align: center; padding: 1rem;">
                        <p style="color: var(--danger);">Введите описание травмы!</p>
                        <button class="pill-button" onclick="closeModal(this)">Закрыть</button>
                    </div>
                `);
                return;
            }
            
            const newInjury = {
                id: generateId('injury'),
                description: description,
                date: new Date().toLocaleDateString('ru-RU')
            };
            
            state.criticalInjuries.push(newInjury);
            renderCriticalInjuries();
            scheduleSave();
            
            closeModal(document.querySelector('.modal-overlay .icon-button'));
        }

        function removeCriticalInjury(injuryId) {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            const existingModals = document.querySelectorAll('.modal-overlay');
            modal.style.zIndex = 1000 + (existingModals.length * 100);
            modal.innerHTML = `
                <div class="modal" style="max-width: 400px;">
                    <div class="modal-header">
                        <h3>Подтверждение</h3>
                        <button class="icon-button" onclick="closeModal(this)">×</button>
                    </div>
                    <div class="modal-body">
                        <p style="text-align: center; color: var(--text); font-size: 1rem;">Удалить эту критическую травму?</p>
                    </div>
                    <div class="modal-footer">
                        <button class="pill-button danger-button" onclick="confirmRemoveCriticalInjury('${injuryId}')">Удалить</button>
                        <button class="pill-button" onclick="closeModal(this)">Отмена</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closeModal(modal.querySelector('.icon-button'));
                }
            });
        }

        function confirmRemoveCriticalInjury(injuryId) {
            state.criticalInjuries = state.criticalInjuries.filter(injury => injury.id !== injuryId);
            renderCriticalInjuries();
            scheduleSave();
            closeModal(document.querySelector('.modal-overlay .icon-button'));
        }

        function renderCriticalInjuries() {
            const container = document.getElementById('injuriesList');
            if (!container) return;
            
            if (state.criticalInjuries.length === 0) {
                container.innerHTML = '<p style="color: var(--muted); font-size: 0.9rem; margin-top: 0.5rem;">Травмы не добавлены</p>';
                return;
            }
            
            container.innerHTML = state.criticalInjuries.map(injury => `
                <div class="injury-item" style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem; background: rgba(0,0,0,0.2); border: 1px solid rgba(182, 103, 255, 0.2); border-radius: 6px; margin-bottom: 0.5rem;">
                    <div style="flex: 1;">
                        <div style="color: var(--text); font-size: 0.9rem;">${injury.description}</div>
                        <div style="color: var(--muted); font-size: 0.8rem;">${injury.date}</div>
                    </div>
                    <button class="pill-button danger-button" onclick="removeCriticalInjury('${injury.id}')" style="font-size: 0.8rem; padding: 0.3rem 0.6rem;">🗑️</button>
                </div>
            `).join('');
        }

        // Функции для работы с препаратами
        function showDrugsShop() {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            const existingModals = document.querySelectorAll('.modal-overlay');
            modal.style.zIndex = 1000 + (existingModals.length * 100);
            
            let shopHTML = `
                <div class="modal" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
                    <div class="modal-header">
                        <h3>💊 Магазин препаратов</h3>
                        <button class="icon-button" onclick="closeModal(this)">×</button>
                    </div>
                    <div class="modal-body">
            `;
            
            // Проходим по всем категориям препаратов
            for (const [category, drugs] of Object.entries(DRUGS_LIBRARY)) {
                shopHTML += `
                    <div class="category-section" style="margin-bottom: 2rem;">
                        <div class="category-title" style="color: var(--accent); font-size: 1.1rem; font-weight: 600; margin-bottom: 1rem; border-bottom: 1px solid var(--border); padding-bottom: 0.5rem;">${category}</div>
                        <div style="display: grid; gap: 1rem;">
                            ${drugs.map((drug) => `
                                <div class="property-item">
                                    <div class="property-header">
                                        <div class="property-name">${drug.name}</div>
                                        <div style="display: flex; gap: 0.5rem; align-items: center;">
                                            <span style="color: var(--muted); font-size: 0.9rem;">Цена: ${drug.price} уе</span>
                                            <button class="pill-button primary-button" onclick="buyDrug('${drug.name}', ${drug.price}, '${drug.description.replace(/'/g, "\\'")}', '${drug.effect ? drug.effect.replace(/'/g, "\\'") : ''}', '${drug.category}', ${drug.difficulty || 0}, '${drug.secondaryEffect ? drug.secondaryEffect.replace(/'/g, "\\'") : ''}')" style="font-size: 0.8rem; padding: 0.3rem 0.6rem;">Купить</button>
                                            <button class="pill-button muted-button" onclick="getDrugFree('${drug.name}', '${drug.description.replace(/'/g, "\\'")}', '${drug.effect ? drug.effect.replace(/'/g, "\\'") : ''}', '${drug.category}', ${drug.difficulty || 0}, '${drug.secondaryEffect ? drug.secondaryEffect.replace(/'/g, "\\'") : ''}')" style="font-size: 0.8rem; padding: 0.3rem 0.6rem;">Бесплатно</button>
                                        </div>
                                    </div>
                                    <div class="property-description">
                                        <div style="font-size: 0.9rem; margin-bottom: 0.5rem;">
                                            <strong>Описание:</strong> ${drug.description}
                                        </div>
                                        <div style="font-size: 0.9rem; color: var(--success); margin-bottom: 0.5rem;">
                                            <strong>Эффект:</strong> ${drug.effect || drug.description}
                                        </div>
                                        ${drug.difficulty ? `<div style="font-size: 0.9rem; color: var(--accent); margin-bottom: 0.5rem;"><strong>СЛ:</strong> ${drug.difficulty}</div>` : ''}
                                        ${drug.secondaryEffect ? `<div style="font-size: 0.9rem; color: var(--danger);"><strong>Вторичный эффект:</strong> ${drug.secondaryEffect}</div>` : ''}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
            
            shopHTML += `
                    </div>
                </div>
            `;
            
            modal.innerHTML = shopHTML;
            document.body.appendChild(modal);
            
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closeModal(modal.querySelector('.icon-button'));
                }
            });
        }

        function buyDrug(name, price, description, effect, category, difficulty, secondaryEffect) {
            const currentMoney = parseInt(state.money) || 0;
            
            if (currentMoney < price) {
                showModal('Недостаточно денег', `
                    <div style="text-align: center; padding: 1rem;">
                        <p style="color: var(--danger); font-size: 1.1rem; margin-bottom: 1rem;">Не хватает денег!</p>
                        <button class="pill-button" onclick="closeModal(this)">Закрыть</button>
                    </div>
                `);
                return;
            }
            
            // Списываем деньги
            state.money = currentMoney - price;
            updateMoneyDisplay();
            
            // Добавляем препарат
            const newDrug = {
                id: generateId('drug'),
                name: name,
                description: description,
                effect: effect,
                category: category,
                difficulty: difficulty,
                secondaryEffect: secondaryEffect,
                price: price,
                purchaseDate: new Date().toLocaleDateString('ru-RU')
            };
            
            state.drugs.push(newDrug);
            renderDrugs();
            scheduleSave();
            
            showModal('Препарат куплен', `✅ ${name} добавлен в коллекцию препаратов!`);
        }

        function getDrugFree(name, description, effect, category, difficulty, secondaryEffect) {
            // Добавляем препарат бесплатно
            const newDrug = {
                id: generateId('drug'),
                name: name,
                description: description,
                effect: effect,
                category: category,
                difficulty: difficulty,
                secondaryEffect: secondaryEffect,
                price: 0,
                purchaseDate: new Date().toLocaleDateString('ru-RU')
            };
            
            state.drugs.push(newDrug);
            renderDrugs();
            scheduleSave();
            
            showModal('Препарат получен', `✅ ${name} добавлен в коллекцию препаратов бесплатно!`);
        }

        function removeDrug(drugId) {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            const existingModals = document.querySelectorAll('.modal-overlay');
            modal.style.zIndex = 1000 + (existingModals.length * 100);
            modal.innerHTML = `
                <div class="modal" style="max-width: 400px;">
                    <div class="modal-header">
                        <h3>Подтверждение</h3>
                        <button class="icon-button" onclick="closeModal(this)">×</button>
                    </div>
                    <div class="modal-body">
                        <p style="text-align: center; color: var(--text); font-size: 1rem;">Принять этот препарат (удалить из списка)?</p>
                    </div>
                    <div class="modal-footer">
                        <button class="pill-button primary-button" onclick="confirmRemoveDrug('${drugId}')">Принять</button>
                        <button class="pill-button" onclick="closeModal(this)">Отмена</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closeModal(modal.querySelector('.icon-button'));
                }
            });
        }

        function confirmRemoveDrug(drugId) {
            state.drugs = state.drugs.filter(drug => drug.id !== drugId);
            renderDrugs();
            scheduleSave();
            closeModal(document.querySelector('.modal-overlay .icon-button'));
        }

        function renderDrugs() {
            const container = document.getElementById('drugsContainer');
            if (!container) return;
            
            if (state.drugs.length === 0) {
                container.innerHTML = '<p style="color: var(--muted); text-align: center; padding: 2rem;">Препараты не добавлены</p>';
                return;
            }
            
            // Группируем препараты по категориям и названиям
            const drugsByCategory = {
                'street': {},
                'clinical': {},
                'drugs': {}
            };
            
            state.drugs.forEach(drug => {
                if (!drugsByCategory[drug.category][drug.name]) {
                    drugsByCategory[drug.category][drug.name] = [];
                }
                drugsByCategory[drug.category][drug.name].push(drug);
            });
            
            const categoryNames = {
                'street': 'Уличные препараты',
                'clinical': 'Клинические препараты', 
                'drugs': 'Уличные наркотики'
            };
            
            let html = '';
            
            for (const [category, drugGroups] of Object.entries(drugsByCategory)) {
                if (Object.keys(drugGroups).length === 0) continue;
                
                html += `
                    <div style="margin-bottom: 1.5rem;">
                        <h4 style="color: var(--accent); font-size: 0.9rem; font-weight: 600; margin-bottom: 0.75rem; border-bottom: 1px solid var(--border); padding-bottom: 0.25rem;">${categoryNames[category]}</h4>
                `;
                
                for (const [drugName, drugList] of Object.entries(drugGroups)) {
                    const firstDrug = drugList[0]; // Берем первый экземпляр для отображения
                    const count = drugList.length;
                    const drugId = `drug_${category}_${drugName.replace(/\s+/g, '_')}`;
                    
                    html += `
                        <div style="background: rgba(182, 103, 255, 0.1); border: 1px solid var(--accent); border-radius: 8px; padding: 0.75rem; margin-bottom: 0.5rem; position: relative;">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; padding-right: 2rem;">
                                <div style="flex: 1;">
                                    <div style="color: var(--accent); font-weight: 600; font-size: 0.9rem; margin-bottom: 0.25rem; cursor: pointer; user-select: none;" onclick="toggleDrugDescription('${drugId}')">
                                        ${firstDrug.name} <span style="color: var(--muted); font-size: 0.8rem;">${count > 1 ? `(${count} шт.)` : ''}</span>
                                    </div>
                                    <div id="${drugId}_description" style="display: block;">
                                        <div style="color: var(--text); font-size: 0.75rem; margin-bottom: 0.25rem; line-height: 1.3;">
                                            <strong>Описание:</strong> ${firstDrug.description}
                                        </div>
                                        <div style="color: var(--success); font-size: 0.75rem; margin-bottom: 0.25rem; line-height: 1.3;">
                                            <strong>Эффект:</strong> ${firstDrug.effect}
                                        </div>
                                        ${firstDrug.difficulty > 0 ? `<div style="color: var(--accent); font-size: 0.75rem; margin-bottom: 0.25rem;"><strong>СЛ:</strong> ${firstDrug.difficulty}</div>` : ''}
                                        ${firstDrug.secondaryEffect ? `<div style="color: var(--danger); font-size: 0.75rem; margin-bottom: 0.25rem; line-height: 1.3;"><strong>Вторичный эффект:</strong> ${firstDrug.secondaryEffect}</div>` : ''}
                                        <div style="color: var(--muted); font-size: 0.75rem; margin-top: 0.25rem;">
                                            Куплено: ${firstDrug.purchaseDate} | Цена: ${firstDrug.price} уе
                                        </div>
                                    </div>
                                </div>
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    ${count > 1 ? `<span style="color: var(--muted); font-size: 0.8rem; font-weight: 600;">×${count} шт.</span>` : ''}
                                    <button onclick="removeDrug('${firstDrug.id}')" style="font-size: 0.9rem; background: transparent; border: none; color: var(--text); cursor: pointer;" title="Принять препарат">💊</button>
                                </div>
                            </div>
                        </div>
                    `;
                }
                
                html += `</div>`;
            }
            
            container.innerHTML = html;
        }
        
        function toggleDrugDescription(drugId) {
            const description = document.getElementById(`${drugId}_description`);
            if (description) {
                if (description.style.display === 'none') {
                    description.style.display = 'block';
                } else {
                    description.style.display = 'none';
                }
            }
        }

        // Функции для работы с транспортом
        function renderVehicles() {
            const container = document.getElementById('vehiclesContainer');
            if (!container) return;
            
            if (state.property.vehicles.length === 0) {
                container.innerHTML = '<p style="color: var(--muted); text-align: center; padding: 2rem;">Транспорт не добавлен</p>';
                return;
            }
            
            container.innerHTML = state.property.vehicles.map(vehicle => `
                <div style="background: rgba(182, 103, 255, 0.1); border: 1px solid var(--accent); border-radius: 8px; padding: 0.75rem; margin-bottom: 0.5rem; position: relative;">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; padding-right: 2rem;">
                        <div style="flex: 1;">
                            <div style="color: var(--accent); font-weight: 600; font-size: 0.9rem; margin-bottom: 0.25rem;">
                                ${vehicle.name}
                            </div>
                            <div style="color: var(--text); font-size: 0.75rem; margin-bottom: 0.25rem; line-height: 1.3;">
                                <strong>Описание:</strong> ${vehicle.description}
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; font-size: 0.7rem; color: var(--muted);">
                                <div><strong>ПЗ:</strong> ${vehicle.currentHp}/${vehicle.hp}</div>
                                <div><strong>Места:</strong> ${vehicle.seats}</div>
                                <div><strong>Скорость:</strong> ${vehicle.mechanicalSpeed}</div>
                                <div><strong>Макс. скорость:</strong> ${vehicle.narrativeSpeed}</div>
                            </div>
                            ${vehicle.modules.length > 0 ? `
                                <div style="margin-top: 0.5rem;">
                                    <div style="color: var(--accent); font-size: 0.7rem; font-weight: 600; margin-bottom: 0.25rem;">Установленные модули:</div>
                                    <div style="font-size: 0.7rem; color: var(--muted);">
                                        ${vehicle.modules.map(module => module.name).join(', ')}
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            ${!vehicle.isDefault ? `
                                <button onclick="sellVehicle('${vehicle.id}')" style="font-size: 0.8rem; background: transparent; border: none; color: var(--danger); cursor: pointer;" title="Продать транспорт">💰</button>
                            ` : ''}
                            <button onclick="manageVehicleModules('${vehicle.id}')" style="font-size: 0.8rem; background: transparent; border: none; color: var(--accent); cursor: pointer;" title="Управление модулями">⚙️</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function showVehicleShop() {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            const existingModals = document.querySelectorAll('.modal-overlay');
            modal.style.zIndex = 1000 + (existingModals.length * 100);
            
            let shopHTML = `
                <div class="modal" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
                    <div class="modal-header">
                        <h3>🚗 Магазин транспорта</h3>
                        <button class="icon-button" onclick="closeModal(this)">×</button>
                    </div>
                    <div class="modal-body">
            `;
            
            // Проходим по всем категориям транспорта
            for (const [category, vehicles] of Object.entries(VEHICLES_LIBRARY)) {
                shopHTML += `
                    <div style="margin-bottom: 2rem;">
                        <h4 style="color: var(--accent); font-size: 1rem; font-weight: 600; margin-bottom: 1rem; border-bottom: 1px solid var(--border); padding-bottom: 0.5rem;">${category}</h4>
                        <div style="display: grid; gap: 1rem;">
                            ${vehicles.map((vehicle) => `
                                <div style="background: rgba(182, 103, 255, 0.1); border: 1px solid var(--accent); border-radius: 8px; padding: 1rem;">
                                    <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                                        <div style="flex: 1;">
                                            <div style="color: var(--accent); font-weight: 600; font-size: 1rem; margin-bottom: 0.5rem;">${vehicle.name}</div>
                                            <div style="color: var(--muted); font-size: 0.85rem; margin-bottom: 0.75rem;">${vehicle.description}</div>
                                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.5rem; font-size: 0.8rem; color: var(--text); margin-bottom: 0.75rem;">
                                                <div><strong>ПЗ:</strong> ${vehicle.hp}</div>
                                                <div><strong>Места:</strong> ${vehicle.seats}</div>
                                                <div><strong>Скорость:</strong> ${vehicle.mechanicalSpeed}</div>
                                                <div><strong>Макс. скорость:</strong> ${vehicle.narrativeSpeed}</div>
                                            </div>
                                            <div style="color: var(--success); font-weight: 600; font-size: 1rem;">Цена: ${vehicle.price} уе</div>
                                        </div>
                                        <div style="margin-left: 1rem;">
                                            <button class="pill-button primary-button" onclick="buyVehicle('${vehicle.name.replace(/'/g, "\\'")}', '${vehicle.description.replace(/'/g, "\\'")}', ${vehicle.hp}, ${vehicle.seats}, ${vehicle.mechanicalSpeed}, '${vehicle.narrativeSpeed}', ${vehicle.price}, '${vehicle.category}')" style="font-size: 0.85rem; padding: 0.5rem 1rem;">Купить</button>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
            
            shopHTML += `
                    </div>
                </div>
            `;
            
            modal.innerHTML = shopHTML;
            document.body.appendChild(modal);
            
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closeModal(modal.querySelector('.icon-button'));
                }
            });
        }

        function buyVehicle(name, description, hp, seats, mechanicalSpeed, narrativeSpeed, price, category) {
            const currentMoney = parseInt(state.money) || 0;
            
            // Проверяем навык "Транспорт" для скидки
            const transportSkill = state.skills.find(s => s.name === 'Транспорт' || s.customName?.includes('Транспорт'));
            const skillLevel = transportSkill ? transportSkill.level : 0;
            const discount = skillLevel >= 4 ? 0.1 : 0; // 10% скидка при навыке 4+
            const finalPrice = Math.floor(price * (1 - discount));
            
            if (currentMoney < finalPrice) {
                showModal('Недостаточно денег', `
                    <div style="text-align: center; padding: 1rem;">
                        <p style="color: var(--danger); font-size: 1.1rem; margin-bottom: 1rem;">Не хватает Еши!</p>
                        <p style="color: var(--muted);">Нужно: ${finalPrice} уе</p>
                        <p style="color: var(--muted);">Доступно: ${currentMoney} уе</p>
                    </div>
                `);
                return;
            }
            
            // Списываем деньги
            state.money = currentMoney - finalPrice;
            updateMoneyDisplay();
            
            // Добавляем транспорт
            const newVehicle = {
                id: generateId('vehicle'),
                name: name,
                description: description,
                hp: hp,
                currentHp: hp,
                seats: seats,
                mechanicalSpeed: mechanicalSpeed,
                narrativeSpeed: narrativeSpeed,
                price: price,
                category: category,
                modules: [],
                isDefault: false
            };
            
            state.property.vehicles.push(newVehicle);
            renderVehicles();
            scheduleSave();
            
            closeModal(document.querySelector('.modal-overlay .icon-button'));
            
            const discountText = discount > 0 ? `<p style="color: var(--success); margin-bottom: 0.5rem;">Скидка ${discount * 100}% благодаря навыку "Транспорт"!</p>` : '';
            
            showModal('Транспорт куплен', `
                <div style="text-align: center; padding: 1rem;">
                    <p style="color: var(--success); font-size: 1.1rem; margin-bottom: 1rem;">✅ ${name} куплен!</p>
                    ${discountText}
                    <p style="color: var(--muted);">Списано: ${finalPrice} уе</p>
                </div>
            `);
        }

        function sellVehicle(vehicleId) {
            const vehicle = state.property.vehicles.find(v => v.id === vehicleId);
            if (!vehicle) return;
            
            const sellPrice = Math.floor(vehicle.price * 0.5);
            
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            const existingModals = document.querySelectorAll('.modal-overlay');
            modal.style.zIndex = 1000 + (existingModals.length * 100);
            modal.innerHTML = `
                <div class="modal" style="max-width: 500px;">
                    <div class="modal-header">
                        <h3>Продать транспорт</h3>
                        <button class="icon-button" onclick="closeModal(this)">×</button>
                    </div>
                    <div class="modal-body">
                        <p style="text-align: center; color: var(--text); font-size: 1rem; margin-bottom: 1rem;">
                            Продать <strong>${vehicle.name}</strong> за <span style="color: var(--success);">${sellPrice} уе</span>?
                        </p>
                        <p style="text-align: center; color: var(--muted); font-size: 0.85rem;">
                            (50% от стоимости покупки)
                        </p>
                    </div>
                    <div class="modal-footer">
                        <button class="pill-button primary-button" onclick="confirmSellVehicle('${vehicleId}', ${sellPrice})">Продать</button>
                        <button class="pill-button" onclick="closeModal(this)">Отмена</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closeModal(modal.querySelector('.icon-button'));
                }
            });
        }

        function confirmSellVehicle(vehicleId, sellPrice) {
            state.property.vehicles = state.property.vehicles.filter(v => v.id !== vehicleId);
            state.money = parseInt(state.money) + sellPrice;
            updateMoneyDisplay();
            renderVehicles();
            scheduleSave();
            
            closeModal(document.querySelector('.modal-overlay .icon-button'));
            
            showModal('Транспорт продан', `
                <div style="text-align: center; padding: 1rem;">
                    <p style="color: var(--success); font-size: 1.1rem; margin-bottom: 1rem;">✅ Транспорт продан!</p>
                    <p style="color: var(--muted);">Получено: ${sellPrice} уе</p>
                </div>
            `);
        }

        function showVehicleModulesShop() {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            const existingModals = document.querySelectorAll('.modal-overlay');
            modal.style.zIndex = 1000 + (existingModals.length * 100);
            
            let shopHTML = `
                <div class="modal" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
                    <div class="modal-header">
                        <h3>⚙️ Магазин модулей транспорта</h3>
                        <button class="icon-button" onclick="closeModal(this)">×</button>
                    </div>
                    <div class="modal-body">
            `;
            
            // Проходим по всем категориям модулей
            const categories = {
                'ground': 'Модули для наземного транспорта',
                'air': 'Модули для воздушного транспорта',
                'water': 'Модули для водного транспорта'
            };
            
            for (const [category, categoryName] of Object.entries(categories)) {
                const modules = VEHICLE_MODULES_LIBRARY[category] || [];
                if (modules.length === 0) continue;
                
                shopHTML += `
                    <div style="margin-bottom: 2rem;">
                        <h4 style="color: var(--accent); font-size: 1rem; font-weight: 600; margin-bottom: 1rem; border-bottom: 1px solid var(--border); padding-bottom: 0.5rem;">${categoryName}</h4>
                        <div style="display: grid; gap: 1rem;">
                            ${modules.map((module) => `
                                <div style="background: rgba(182, 103, 255, 0.1); border: 1px solid var(--accent); border-radius: 8px; padding: 1rem;">
                                    <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                                        <div style="flex: 1;">
                                            <div style="color: var(--accent); font-weight: 600; font-size: 1rem; margin-bottom: 0.5rem;">${module.name}</div>
                                            <div style="color: var(--muted); font-size: 0.85rem; margin-bottom: 0.75rem;">${module.description}</div>
                                            ${module.requirements && module.requirements.length > 0 ? `
                                                <div style="color: var(--danger); font-size: 0.8rem; margin-bottom: 0.5rem;">
                                                    <strong>Требования:</strong> ${module.requirements.join(', ')}
                                                </div>
                                            ` : ''}
                                            <div style="color: var(--success); font-weight: 600; font-size: 1rem;">Цена: ${module.price} уе</div>
                                        </div>
                                        <div style="margin-left: 1rem;">
                                            <button class="pill-button primary-button" onclick="buyVehicleModule('${module.name.replace(/'/g, "\\'")}', '${module.description.replace(/'/g, "\\'")}', ${module.price}, '${module.category}', '${JSON.stringify(module.requirements || []).replace(/'/g, "\\'")}' )" style="font-size: 0.85rem; padding: 0.5rem 1rem;">Купить</button>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
            
            shopHTML += `
                    </div>
                </div>
            `;
            
            modal.innerHTML = shopHTML;
            document.body.appendChild(modal);
            
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closeModal(modal.querySelector('.icon-button'));
                }
            });
        }

        function buyVehicleModule(name, description, price, category, requirementsStr) {
            const currentMoney = parseInt(state.money) || 0;
            const requirements = JSON.parse(requirementsStr);
            
            if (currentMoney < price) {
                showModal('Недостаточно денег', `
                    <div style="text-align: center; padding: 1rem;">
                        <p style="color: var(--danger); font-size: 1.1rem; margin-bottom: 1rem;">Не хватает Еши!</p>
                        <p style="color: var(--muted);">Нужно: ${price} уе</p>
                        <p style="color: var(--muted);">Доступно: ${currentMoney} уе</p>
                    </div>
                `);
                return;
            }
            
            // Списываем деньги
            state.money = currentMoney - price;
            updateMoneyDisplay();
            
            // Добавляем модуль в снаряжение
            const newGear = {
                id: generateId('gear'),
                name: name,
                description: description,
                price: price,
                load: 5,
                type: 'vehicle_module',
                moduleData: {
                    category: category,
                    requirements: requirements
                }
            };
            
            state.gear.push(newGear);
            renderGear();
            scheduleSave();
            
            closeModal(document.querySelector('.modal-overlay .icon-button'));
            
            showModal('Модуль куплен', `
                <div style="text-align: center; padding: 1rem;">
                    <p style="color: var(--success); font-size: 1.1rem; margin-bottom: 1rem;">✅ ${name} куплен!</p>
                    <p style="color: var(--muted); margin-bottom: 0.5rem;">Модуль добавлен в снаряжение.</p>
                    <p style="color: var(--muted);">Установите его через меню управления модулями транспорта.</p>
                </div>
            `);
        }

        function manageVehicleModules(vehicleId) {
            const vehicle = state.property.vehicles.find(v => v.id === vehicleId);
            if (!vehicle) return;
            
            // Получаем доступные модули из снаряжения
            const availableModules = state.gear.filter(item => 
                item.type === 'vehicle_module' && 
                item.moduleData.category === vehicle.category
            );
            
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            const existingModals = document.querySelectorAll('.modal-overlay');
            modal.style.zIndex = 1000 + (existingModals.length * 100);
            modal.innerHTML = `
                <div class="modal" style="max-width: 700px;">
                    <div class="modal-header">
                        <h3>⚙️ Управление модулями: ${vehicle.name}</h3>
                        <button class="icon-button" onclick="closeModal(this)">×</button>
                    </div>
                    <div class="modal-body">
                        <div style="margin-bottom: 1.5rem;">
                            <h4 style="color: var(--accent); font-size: 0.95rem; margin-bottom: 0.75rem;">Установленные модули:</h4>
                            ${vehicle.modules.length > 0 ? `
                                <div style="display: grid; gap: 0.75rem;">
                                    ${vehicle.modules.map((module, index) => `
                                        <div style="background: rgba(125, 244, 198, 0.1); border: 1px solid var(--success); border-radius: 8px; padding: 0.75rem; display: flex; justify-content: space-between; align-items: center;">
                                            <div>
                                                <div style="color: var(--success); font-weight: 600; font-size: 0.9rem;">${module.name}</div>
                                                <div style="color: var(--muted); font-size: 0.75rem;">${module.description}</div>
                                            </div>
                                            <button class="pill-button danger-button" onclick="removeVehicleModule('${vehicleId}', ${index})" style="font-size: 0.8rem; padding: 0.3rem 0.6rem;">Удалить</button>
                                        </div>
                                    `).join('')}
                                </div>
                            ` : '<p style="color: var(--muted); text-align: center; padding: 1rem;">Модули не установлены</p>'}
                        </div>
                        
                        <div>
                            <h4 style="color: var(--accent); font-size: 0.95rem; margin-bottom: 0.75rem;">Доступные модули в снаряжении:</h4>
                            ${availableModules.length > 0 ? `
                                <div style="display: grid; gap: 0.75rem;">
                                    ${availableModules.map(module => `
                                        <div style="background: rgba(182, 103, 255, 0.1); border: 1px solid var(--accent); border-radius: 8px; padding: 0.75rem; display: flex; justify-content: space-between; align-items: center;">
                                            <div>
                                                <div style="color: var(--accent); font-weight: 600; font-size: 0.9rem;">${module.name}</div>
                                                <div style="color: var(--muted); font-size: 0.75rem;">${module.description}</div>
                                                ${module.moduleData.requirements && module.moduleData.requirements.length > 0 ? `
                                                    <div style="color: var(--danger); font-size: 0.7rem; margin-top: 0.25rem;">
                                                        Требует: ${module.moduleData.requirements.join(', ')}
                                                    </div>
                                                ` : ''}
                                            </div>
                                            <button class="pill-button primary-button" onclick="installVehicleModule('${vehicleId}', '${module.id}')" style="font-size: 0.8rem; padding: 0.3rem 0.6rem;">Установить</button>
                                        </div>
                                    `).join('')}
                                </div>
                            ` : '<p style="color: var(--muted); text-align: center; padding: 1rem;">Нет доступных модулей для этого типа транспорта</p>'}
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closeModal(modal.querySelector('.icon-button'));
                }
            });
        }

        function installVehicleModule(vehicleId, moduleId) {
            const vehicle = state.property.vehicles.find(v => v.id === vehicleId);
            const moduleItem = state.gear.find(g => g.id === moduleId);
            
            if (!vehicle || !moduleItem) return;
            
            // Проверяем требования модуля сначала
            const requirements = moduleItem.moduleData.requirements || [];
            if (requirements.length > 0) {
                const hasRequiredModules = requirements.every(req => 
                    vehicle.modules.some(m => m.name === req)
                );
                
                if (!hasRequiredModules) {
                    showModal('Требования не выполнены', `
                        <div style="text-align: center; padding: 1rem;">
                            <p style="color: var(--danger); font-size: 1.1rem; margin-bottom: 1rem;">Не выполнены требования!</p>
                            <p style="color: var(--muted);">Для установки требуется: ${requirements.join(', ')}</p>
                        </div>
                    `);
                    return;
                }
            }
            
            // Проверяем навык "Транспорт"
            const transportSkill = state.skills.find(s => s.name === 'Транспорт' || s.customName?.includes('Транспорт'));
            const skillLevel = transportSkill ? transportSkill.level : 0;
            
            if (skillLevel < 4) {
                // Нужно заплатить 500 уе за установку - показываем окно подтверждения
                const installCost = 500;
                const currentMoney = parseInt(state.money) || 0;
                
                if (currentMoney < installCost) {
                    showModal('Недостаточно денег', `
                        <div style="text-align: center; padding: 1rem;">
                            <p style="color: var(--danger); font-size: 1.1rem; margin-bottom: 1rem;">Недостаточно средств для установки!</p>
                            <p style="color: var(--muted);">У вас навык "Транспорт" < 4, поэтому установка стоит ${installCost} уе</p>
                            <p style="color: var(--muted);">Доступно: ${currentMoney} уе</p>
                        </div>
                    `);
                    return;
                }
                
                // Показываем окно подтверждения оплаты
                const modal = document.createElement('div');
                modal.className = 'modal-overlay';
                const existingModals = document.querySelectorAll('.modal-overlay');
                modal.style.zIndex = 1000 + (existingModals.length * 100);
                modal.innerHTML = `
                    <div class="modal" style="max-width: 500px;">
                        <div class="modal-header">
                            <h3>Оплата установки</h3>
                            <button class="icon-button" onclick="closeModal(this)">×</button>
                        </div>
                        <div class="modal-body">
                            <p style="text-align: center; color: var(--text); font-size: 1rem; margin-bottom: 1rem;">
                                Установить <strong>${moduleItem.name}</strong>?
                            </p>
                            <p style="text-align: center; color: var(--muted); font-size: 0.9rem; margin-bottom: 0.5rem;">
                                У вас навык "Транспорт" < 4
                            </p>
                            <p style="text-align: center; color: var(--danger); font-size: 1.1rem; font-weight: 600; margin-bottom: 1rem;">
                                Стоимость установки: ${installCost} уе
                            </p>
                            <p style="text-align: center; color: var(--muted); font-size: 0.85rem;">
                                Доступно: ${currentMoney} уе
                            </p>
                        </div>
                        <div class="modal-footer">
                            <button class="pill-button primary-button" onclick="confirmInstallVehicleModule('${vehicleId}', '${moduleId}', ${installCost})">Оплатить и установить</button>
                            <button class="pill-button" onclick="closeModal(this)">Отмена</button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        closeModal(modal.querySelector('.icon-button'));
                    }
                });
                
                return;
            }
            
            // Если навык >= 4, устанавливаем бесплатно
            confirmInstallVehicleModule(vehicleId, moduleId, 0);
        }
        
        function confirmInstallVehicleModule(vehicleId, moduleId, installCost) {
            const vehicle = state.property.vehicles.find(v => v.id === vehicleId);
            const moduleItem = state.gear.find(g => g.id === moduleId);
            
            if (!vehicle || !moduleItem) return;
            
            // Списываем деньги если нужно
            if (installCost > 0) {
                state.money = parseInt(state.money) - installCost;
                updateMoneyDisplay();
            }
            
            // Устанавливаем модуль
            vehicle.modules.push({
                name: moduleItem.name,
                description: moduleItem.description,
                price: moduleItem.price
            });
            
            // Удаляем модуль из снаряжения
            state.gear = state.gear.filter(g => g.id !== moduleId);
            
            renderVehicles();
            renderGear();
            scheduleSave();
            
            closeModal(document.querySelector('.modal-overlay .icon-button'));
            
            const installText = installCost > 0 ? 
                `<p style="color: var(--muted);">Списано: ${installCost} уе за установку</p>` : 
                '<p style="color: var(--success);">Установка бесплатна благодаря навыку "Транспорт" ≥ 4</p>';
            
            showModal('Модуль установлен', `
                <div style="text-align: center; padding: 1rem;">
                    <p style="color: var(--success); font-size: 1.1rem; margin-bottom: 1rem;">✅ ${moduleItem.name} установлен!</p>
                    ${installText}
                </div>
            `);
        }

        function removeVehicleModule(vehicleId, moduleIndex) {
            const vehicle = state.property.vehicles.find(v => v.id === vehicleId);
            if (!vehicle) return;
            
            const module = vehicle.modules[moduleIndex];
            if (!module) return;
            
            // Возвращаем модуль в снаряжение
            state.gear.push({
                id: generateId('gear'),
                name: module.name,
                description: module.description,
                price: module.price,
                load: 5,
                type: 'vehicle_module',
                moduleData: {
                    category: vehicle.category,
                    requirements: []
                }
            });
            
            // Удаляем модуль из транспорта
            vehicle.modules.splice(moduleIndex, 1);
            
            renderVehicles();
            renderGear();
            scheduleSave();
            
            closeModal(document.querySelector('.modal-overlay .icon-button'));
            
            showModal('Модуль удалён', `
                <div style="text-align: center; padding: 1rem;">
                    <p style="color: var(--success); font-size: 1.1rem; margin-bottom: 1rem;">✅ ${module.name} возвращён в снаряжение!</p>
                </div>
            `);
        }

        // Генератор предыстории
        function generateBackstory() {
            const backstoryTables = {
                birth: {
                    title: "Ты родился",
                    options: [
                        "Среди бедняков (+1 предмет)",
                        "Среди военных (+1 Навык ОДБ)",
                        "На улице (+1 Навык ОББ)",
                        "С вольным народом (+1 Вождение)",
                        "Беспризорник (+1 к Поиску)",
                        "Тебя нашли на улице (+1 Выживание)",
                        "Тебя подкинули богатой семье (+1 Бюрократия)",
                        "Тебя украли из лаборатории (+1 Техническое чудо)",
                        "Среди Технолибертарианцев",
                        "Ты не помнишь (+1 Удача)",
                        "В богатой обеспеченной семье (+1 Внешний вид)",
                        "Во время войны (+1 Уклонение)"
                    ]
                },
                childhood: {
                    title: "Ты рос",
                    options: [
                        "С дворовыми пацанами",
                        "В гиперзаботе и гиперопеке",
                        "Спокойно и без приключений",
                        "Постоянно расшибал коленки и всем было плевать",
                        "Почему-то был голоден и воровал еду",
                        "В постоянных разъездах или командировках",
                        "В тире, среди бородатых мужиков с ружьями",
                        "Где-то в дикой природе в палатке",
                        "В дорогой престижной школе, смотря на мир из окон небоскрёба",
                        "Сколотил подростковую банду",
                        "Избивал бомжей на видео и выкладывал это в Сеть",
                        "Был нелюдимым ребенком, смотрел мультики, избегал других детей"
                    ]
                },
                teenEvent: {
                    title: "Что-то важное случилось в подростковом возрасте",
                    options: [
                        "Нет, не случилось (+1 ЛВК)",
                        "Нашёл кучу денег (+1 УДАЧА)",
                        "Потерял важного человека (+1 ВОЛЯ)",
                        "Крайне неудачная первая любовь (+1 ХАР)",
                        "Угнал не ту тачку (+1 ТЕХ)",
                        "Связался с плохими людьми (+1 ТЕЛО)",
                        "Подсел на наркоту (+1 зависимость)",
                        "Любовь изменила твою жизнь (+1 ХАР)",
                        "Потерял доверенное тебе (-1 репутация)",
                        "Случайно кого-то убил (+1 РЕА)",
                        "Познакомился с важной шишкой (+1000уе в крипте)",
                        "Пытался сделать бизнес и прогорел (10 000уе долга перед инвесторами)"
                    ]
                },
                love: {
                    title: "История любви с... (выбери или придумай персонажа)",
                    options: [
                        "Всегда по-настоящему любил только себя",
                        "Были знакомы с самого детства",
                        "Случайно пересеклись в толпе",
                        "Познакомились на работе",
                        "Какая-то фанатка бегает за мной много лет",
                        "Бегал за ней много лет, и она сжалилась",
                        "Вечная френдзона, но я добьюсь",
                        "Отбил у друга",
                        "Отбил у врага",
                        "Зашел в магазин, а там он/-а на кассе",
                        "Светлая любовь с первого взгляда",
                        "Меня никто не любит"
                    ]
                },
                enemy: {
                    title: "История вражды с... (выбери или придумай персонажа)",
                    options: [
                        "С детства ненавидим друг друга",
                        "...задел плечом в топле",
                        "...увёл любовь",
                        "...украл что-то",
                        "...враг семьи",
                        "...убил кого-то важного",
                        "...забрал себе работу",
                        "...подставил перед законом",
                        "\"Срёт в кашу сколько его помню\"",
                        "Просто лицо у ... слишком мерзкое/милое",
                        "...подставил перед бандитами",
                        "У меня нет врагов"
                    ]
                },
                guilt: {
                    title: "Кто на самом деле виноват в вашей вражде",
                    options: [
                        "Конечно он",
                        "Какое-то третье лицо",
                        "Его друг",
                        "Мой друг",
                        "Случайность",
                        "Конечно я"
                    ]
                },
                revenge: {
                    title: "Как произойдет месть обидчику",
                    options: [
                        "Придёт толпа народу с битами",
                        "Унизит в Сети",
                        "Постарается подставить в тяжком преступлении",
                        "Один на один на ножах",
                        "Ждёт серьёзный разговор",
                        "Периодически появляется и делает мелкие пакости",
                        "Наймёт киллера. Или двух…или сколько потребуется",
                        "Будет пытаться сорвать работу",
                        "Будет шпионить и предупреждать врагов… если они его не пристрелят",
                        "Постарается убить в самый неподходящий момент (задавить машиной/застрелить/прислать вирус через Сеть и пр.)",
                        "Простит и продолжить жить дальше",
                        "Не станет марать руки, но не простит"
                    ]
                },
                reason: {
                    title: "Почему ты здесь",
                    options: [
                        "Нужна работа",
                        "Дома скучно",
                        "Долги напоминают о себе",
                        "Хочу купить что-то дорогое",
                        "Устал жить терпилой",
                        "Потому что я — БЕЗУМЕЦ",
                        "Позвали в приложении знакомств сюда",
                        "Потому что я должен быть тут",
                        "Это моя работа",
                        "Хочу показать себя для (указать персонажа)",
                        "Долг зовёт (это важно для тебя с моральной точки зрения)",
                        "Я до сих пор сам не понимаю"
                    ]
                },
                meeting: {
                    title: "Как ты познакомился с… (Выбери одного из группы и укажи отношения с ним)",
                    options: [
                        "Я должен доказать, что я лучше, чем…",
                        "…требуется моя защита.",
                        "Отдаю … долг.",
                        "Я поклялся себе защищать …",
                        "Я хочу затащить в постель …",
                        "Я хочу помочь с работой … а потом удрать с его бабками.",
                        "Я просто не могу отпустить … одну/одного.",
                        "Почувствовал, что … грозит опасность.",
                        "У меня заказ на голову … Но это должен выглядеть, как несчастный случаей.",
                        "Узнал, что за голову … награда и должен защитить.",
                        "Однажды Эрнест Хэмингуэй поспорил...",
                        "Да я плевал на всех них. Работа есть работа, если они все помрут, я и глазом не моргну."
                    ]
                },
                moneyAttitude: {
                    title: "Твоё отношение к деньгам",
                    options: [
                        "Мусор",
                        "Инструмент",
                        "Цель в жизни",
                        "Необходимость",
                        "У меня их, как грязи",
                        "Готов убить за них",
                        "Честь превыше денег",
                        "За разумную цену могу всё",
                        "Хочу все деньги мира",
                        "Ненавижу их, из-за них все проблемы",
                        "Деньги, как деньги. Без них нельзя, но они не сама цель",
                        "Деньги нужно уничтожить!"
                    ]
                },
                peopleAttitude: {
                    title: "Твоё отношение к людям",
                    options: [
                        "Мусор",
                        "Инструмент",
                        "Хочу нравиться всем",
                        "Общение с людьми не более чем необходимость",
                        "Я душа кампании",
                        "Готов на всё, если человек в опасности",
                        "Моя жизнь важнее",
                        "Если человек выгоден мне – я выгоден ему",
                        "Хочу известности на весь мир",
                        "Ненавижу их, из-за них все проблемы",
                        "Люди, как люди. Без них нельзя, но мне на них плевать",
                        "Они не знают, но сам не человек. Я не знаю как сюда попал. Нельзя, чтобы они узнали мою тайну."
                    ]
                },
                recentEvent: {
                    title: "Внезапное событие на прошлой неделе",
                    options: [
                        "Потерял состояние (у тебя нет стартовых денег)",
                        "Убили близкого (выбери персонажа/человека из предыстории, который по твоему мнению сейчас мёртв)",
                        "Украли любимую вещь (выбери любую вещь стоимостью до 5000 уе, которую у тебя украли и ты можешь её вернуть)",
                        "Угнали любимую машину (твою стартовую машину угнали)",
                        "Убили любимую собаку (ты получаешь бесплатный дробовик, пачку зажигательных и ненависть)",
                        "Обнесли жилье (в твоей квартире ничего не осталось, кроме 1 комплекта одежды, в котором ты сейчас, и компьютера, вмонтированного в стену)",
                        "Нашел труп корпората в мусорке (получи корпоративную ID-карточку и самонаводящйся пистолет, являющийся собственностью этой корпорации)",
                        "Нашёл загадочный чип (получи щепку с ИИ, этот ИИ может использоваться Мастер, как еще 1 персонаж)",
                        "Жёстко проебался на деле, но вынес \"трофей\" (пропиши себе любой нарративный предмет стоимость 5000уе, за владельца этой вещи — тебя — назначена награда, но никто не знает у кого она)",
                        "Нашел загадочный чемодан с ДНК замком, который Сёрфер не смог открыть (у тебя есть закрытый ДНК-замком противоударный кейс. Все попытки его взломать или открыть — проваливаются. Что внутри не ясно, кто владелец — тоже, на ящике может быть логотип корпорации или узнаваемого человека)",
                        "Нашёл чип с крупной суммой денег (если ты его вставишь себе в порт, то получи бонусные 20.000 уе на старте, но после перевода твоя ЦНС как-то странно барахлит)"
                    ]
                }
            };
            
            // Генерируем случайные результаты
            let backstoryText = "";
            
            for (const [key, table] of Object.entries(backstoryTables)) {
                const randomIndex = Math.floor(Math.random() * table.options.length);
                const selectedOption = table.options[randomIndex];
                backstoryText += `${table.title}: ${selectedOption}\n\n`;
            }
            
            // Записываем в textarea
            const textarea = document.getElementById('backstoryText');
            if (textarea) {
                textarea.value = backstoryText.trim();
                state.backstory = backstoryText.trim();
                scheduleSave();
            }
        }

        // Функции для работы с аватаром
        function initAvatarUpload() {
            console.log('initAvatarUpload called');
            const avatarInput = document.getElementById('avatarInput');
            const removeAvatarButton = document.getElementById('removeAvatarButton');
            
            if (avatarInput) {
                avatarInput.addEventListener('change', handleAvatarUpload);
                console.log('Avatar input listener attached');
            }
            
            if (removeAvatarButton) {
                removeAvatarButton.addEventListener('click', handleAvatarRemove);
                console.log('Remove avatar button listener attached');
            }
            
            // Загружаем существующий аватар при инициализации
            console.log('Current state.avatar:', state.avatar ? state.avatar.substring(0, 50) + '...' : 'empty');
            loadAvatarFromState();
        }
        
        function handleAvatarUpload(event) {
            console.log('handleAvatarUpload called');
            const file = event.target.files[0];
            if (!file) {
                console.log('No file selected');
                return;
            }
            
            console.log('File selected:', file.name, 'Original size:', file.size, 'bytes');
            
            // Создаем временный Image для сжатия
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    console.log('Original image dimensions:', img.width, 'x', img.height);
                    
                    // Создаем canvas для ресайза
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    
                    // Максимальные размеры (сохраняем пропорции)
                    const MAX_WIDTH = 800;
                    const MAX_HEIGHT = 800;
                    
                    let width = img.width;
                    let height = img.height;
                    
                    // Рассчитываем новые размеры с сохранением пропорций
                    if (width > height) {
                        if (width > MAX_WIDTH) {
                            height = height * (MAX_WIDTH / width);
                            width = MAX_WIDTH;
                        }
                    } else {
                        if (height > MAX_HEIGHT) {
                            width = width * (MAX_HEIGHT / height);
                            height = MAX_HEIGHT;
                        }
                    }
                    
                    canvas.width = width;
                    canvas.height = height;
                    
                    // Рисуем изображение на canvas
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    // Конвертируем в Base64 с качеством 0.7
                    const compressedBase64 = canvas.toDataURL('image/jpeg', 0.7);
                    
                    console.log('Compressed image dimensions:', width, 'x', height);
                    console.log('Compressed size:', Math.round(compressedBase64.length * 0.75), 'bytes');
                    
                    // Сохраняем сжатое изображение
                    state.avatar = compressedBase64;
                    displayAvatar(compressedBase64);
                    saveState();
                    console.log('Avatar saved to state and localStorage');
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }
        
        function handleAvatarRemove() {
            console.log('handleAvatarRemove called');
            state.avatar = '';
            displayAvatar('');
            saveState();
            console.log('Avatar removed from state and localStorage');
        }
        
        function loadAvatarFromState() {
            console.log('loadAvatarFromState called, state.avatar:', state.avatar ? 'exists' : 'empty');
            if (state.avatar) {
                displayAvatar(state.avatar);
            } else {
                displayAvatar('');
            }
        }
        
        function displayAvatar(imageData) {
            console.log('displayAvatar called with:', imageData ? 'image data' : 'no data');
            const avatarDisplay = document.getElementById('avatarDisplay');
            if (!avatarDisplay) {
                console.error('avatarDisplay element not found!');
                return;
            }
            
            if (imageData) {
                avatarDisplay.innerHTML = `<img src="${imageData}" alt="Аватар персонажа" style="width: 100%; height: 100%; object-fit: cover; border-radius: 8px;" />`;
                console.log('Avatar displayed');
            } else {
                avatarDisplay.innerHTML = '🤖';
                console.log('Default avatar icon displayed');
            }
        }

        // Функция для обновления UI из состояния
        function updateUIFromState() {
            // Обновляем все поля из state
            if (document.getElementById('characterName')) {
                document.getElementById('characterName').value = state.characterName || '';
            }
            if (document.getElementById('experiencePoints')) {
                document.getElementById('experiencePoints').value = state.experiencePoints || 0;
            }
            if (document.getElementById('roleplayPoints')) {
                document.getElementById('roleplayPoints').value = state.roleplayPoints || 0;
            }
            
            // Обновляем характеристики
            Object.keys(state.stats).forEach(stat => {
                const element = document.getElementById(`stat${stat}`);
                if (element) {
                    element.value = state.stats[stat] || 5;
                }
            });
            
            // Обновляем удачу
            if (document.getElementById('luckCurrent')) {
                document.getElementById('luckCurrent').value = state.luck.current || 1;
            }
            if (document.getElementById('luckMax')) {
                document.getElementById('luckMax').value = state.luck.max || 1;
            }
            
            // Обновляем осознанность
            if (document.getElementById('awarenessCurrent')) {
                document.getElementById('awarenessCurrent').value = state.awareness?.current || 50;
            }
            if (document.getElementById('awarenessMax')) {
                document.getElementById('awarenessMax').value = state.awareness?.max || 50;
            }
            
            // Обновляем максимальную осознанность на основе УМ
            updateAwarenessMax();
            
            // Обновляем здоровье
            if (document.getElementById('healthCurrent')) {
                document.getElementById('healthCurrent').value = state.health.current || 25;
            }
            if (document.getElementById('healthMax')) {
                document.getElementById('healthMax').value = state.health.max || 25;
            }
            
            // Обновляем деньги
            updateMoneyDisplay();
            
            // Обновляем репутацию
            if (document.getElementById('reputationSlider')) {
                document.getElementById('reputationSlider').value = state.reputation || 0;
            }
            if (document.getElementById('reputationValue')) {
                document.getElementById('reputationValue').textContent = state.reputation || 0;
                updateReputationColor();
            }
            
            // Обновляем предысторию
            if (document.getElementById('backstoryText')) {
                document.getElementById('backstoryText').value = state.backstory || '';
            }
            
            // Обновляем данные деки
            if (document.getElementById('deckName')) {
                document.getElementById('deckName').value = state.deck.name || '';
            }
            if (document.getElementById('deckOperative')) {
                document.getElementById('deckOperative').value = state.deck.operative || '';
            }
            if (document.getElementById('deckGrid')) {
                document.getElementById('deckGrid').value = state.deck.grid || '';
            }
            if (document.getElementById('deckMemory')) {
                document.getElementById('deckMemory').value = state.deck.memory || '';
            }
            if (document.getElementById('deckVersion')) {
                document.getElementById('deckVersion').value = state.deck.version || '';
            }
            
            // Обновляем производные характеристики
            updateDerivedStats();
            
            // Обновляем отображение имплантов
            renderImplants();
            
            // Обновляем критические травмы
            renderCriticalInjuries();
            
            // Обновляем счетчики деки
            updateDeckCounters();
            
            // Обновляем препараты
            renderDrugs();
        }

        // Функция проверки размера экрана
        function checkScreenSize() {
            const screenWidth = window.innerWidth;
            const mobileWarning = document.getElementById('mobileWarning');
            const screenWidthSpan = document.getElementById('screenWidth');
            
            if (screenWidthSpan) {
                screenWidthSpan.textContent = screenWidth;
            }
            
            if (screenWidth < 1024) {
                if (mobileWarning) {
                    mobileWarning.style.display = 'flex';
                }
                return false; // Экран слишком мал
            } else {
                if (mobileWarning) {
                    mobileWarning.style.display = 'none';
                }
                return true; // Экран подходящего размера
            }
        }

        // Инициализация при загрузке страницы
        document.addEventListener('DOMContentLoaded', () => {
            // Проверяем размер экрана
            if (checkScreenSize()) {
                initLoadingScreen();
                initNumericInputs();
                renderWeapons();
            }
            
            // Отслеживаем изменения размера окна
            window.addEventListener('resize', checkScreenSize);
        });
        
        function initNumericInputs() {
            // Находим все поля, которые должны быть числовыми
            const numericInputs = document.querySelectorAll('input[data-numeric="true"], .stat-value, .professional-skill-level, input[type="number"]');
            
            numericInputs.forEach(input => {
                // Меняем тип на text для идеального центрирования
                input.type = 'text';
                input.inputMode = 'numeric';
                
                // Устанавливаем центрирование
                input.style.textAlign = 'center';
                
                // Добавляем валидацию только цифр
                setupNumericValidation(input);
            });
        }
        
        function setupNumericValidation(input) {
            // Получаем ограничения из атрибутов
            const min = parseInt(input.getAttribute('min')) || 0;
            const max = parseInt(input.getAttribute('max')) || 999;
            
            // Блокируем ввод нечисловых символов
            input.addEventListener('keypress', function(e) {
                // Разрешаем: цифры, Backspace, Delete, Tab, Enter, стрелки
                if (!/[0-9]/.test(e.key) && 
                    !['Backspace', 'Delete', 'Tab', 'Enter', 'ArrowLeft', 'ArrowRight', 'ArrowUp', 'ArrowDown'].includes(e.key)) {
                    e.preventDefault();
                }
            });
            
            // Очищаем нечисловые символы при вводе
            input.addEventListener('input', function(e) {
                let value = e.target.value.replace(/[^0-9]/g, '');
                
                // Применяем ограничения min/max
                if (value !== '') {
                    const numValue = parseInt(value);
                    if (numValue < min) value = min.toString();
                    if (numValue > max) value = max.toString();
                }
                
                e.target.value = value;
                
                // Принудительно центрируем
                e.target.style.textAlign = 'center';
            });
            
            // Обрабатываем вставку текста
            input.addEventListener('paste', function(e) {
                e.preventDefault();
                const paste = (e.clipboardData || window.clipboardData).getData('text');
                const numericOnly = paste.replace(/[^0-9]/g, '');
                
                if (numericOnly !== '') {
                    let numValue = parseInt(numericOnly);
                    if (numValue < min) numValue = min;
                    if (numValue > max) numValue = max;
                    e.target.value = numValue.toString();
                }
                
                // Принудительно центрируем
                e.target.style.textAlign = 'center';
                
                // Вызываем событие change для сохранения
                e.target.dispatchEvent(new Event('change', { bubbles: true }));
            });
            
            // Центрируем при фокусе
            input.addEventListener('focus', function(e) {
                e.target.style.textAlign = 'center';
            });
            
            // Проверяем значение при потере фокуса
            input.addEventListener('blur', function(e) {
                if (e.target.value === '') {
                    e.target.value = min.toString();
                }
                e.target.style.textAlign = 'center';
                
                // Вызываем событие change для сохранения
                e.target.dispatchEvent(new Event('change', { bubbles: true }));
            });
        }
        
        // Функции для профессиональных навыков
        function updateProfessionalSkill(index, name, level) {
            if (!state.professionalSkills) {
                state.professionalSkills = [];
            }
            
            if (!state.professionalSkills[index]) {
                state.professionalSkills[index] = { name: '', level: 0 };
            }
            
            state.professionalSkills[index].name = name;
            state.professionalSkills[index].level = parseInt(level) || 0;
            
            scheduleSave();
        }
        
        function loadProfessionalSkills() {
            if (!state.professionalSkills) {
                state.professionalSkills = [
                    { name: '', level: 0 },
                    { name: '', level: 0 },
                    { name: '', level: 0 },
                    { name: '', level: 0 }
                ];
            }
            
            for (let i = 0; i < 4; i++) {
                const nameInput = document.getElementById(`professionalSkillName${i}`);
                const levelInput = document.getElementById(`professionalSkillLevel${i}`);
                
                if (nameInput && levelInput && state.professionalSkills[i]) {
                    nameInput.value = state.professionalSkills[i].name || '';
                    levelInput.value = state.professionalSkills[i].level || 0;
                }
            }
        }
        
        // Система заметок
        let notes = [];
        let noteWindows = [];
        let noteZIndex = 3000;
        
        function showNotesModal() {
            const modal = document.createElement('div');
            modal.className = 'notes-modal-overlay';
            modal.innerHTML = `
                <div class="notes-modal">
                    <div class="notes-modal-header">
                        <h3 class="notes-modal-title">📝 Заметки</h3>
                        <button class="pill-button" onclick="closeNotesModal(this)">Закрыть</button>
                    </div>
                    <div class="notes-modal-content">
                        <div class="notes-list" id="notesList">
                            ${notes.length > 0 ? notes.map((note, index) => `
                                <div class="note-item">
                                    <div class="note-item-info">
                                        <div class="note-item-title">${note.title || 'Без названия'}</div>
                                        <div class="note-item-preview">${note.content.substring(0, 50)}${note.content.length > 50 ? '...' : ''}</div>
                                    </div>
                                    <div class="note-item-actions">
                                        <button class="pill-button primary-button" onclick="openNoteWindow(${index})" style="font-size: 0.7rem; padding: 0.2rem 0.4rem;">Открыть</button>
                                        <button class="pill-button danger-button" onclick="deleteNote(${index})" style="font-size: 0.7rem; padding: 0.2rem 0.4rem;">Удалить</button>
                                    </div>
                                </div>
                            `).join('') : '<p style="color: var(--muted); text-align: center; padding: 2rem;">Заметки не созданы</p>'}
                        </div>
                        <div class="notes-actions">
                            <button class="pill-button primary-button" onclick="createNewNote()">+ Создать заметку</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        function closeNotesModal(button) {
            const modal = button.closest('.notes-modal-overlay');
            if (modal) {
                modal.remove();
            }
        }
        
        function createNewNote() {
            const newNote = {
                id: Date.now(),
                title: 'Новая заметка',
                content: '',
                x: 100 + (notes.length * 20),
                y: 100 + (notes.length * 20),
                width: 400,
                height: 300
            };
            
            notes.push(newNote);
            openNoteWindow(notes.length - 1);
            saveNotes();
        }
        
        function openNoteWindow(noteIndex) {
            const note = notes[noteIndex];
            if (!note) return;
            
            // Проверяем, не открыта ли уже эта заметка
            const existingWindow = noteWindows.find(w => w.dataset.noteId === note.id.toString());
            if (existingWindow) {
                existingWindow.style.zIndex = noteZIndex++;
                return;
            }
            
            // Закрываем модал заметок
            const modal = document.querySelector('.notes-modal-overlay');
            if (modal) {
                modal.remove();
            }
            
            const noteWindow = document.createElement('div');
            noteWindow.className = 'note-window';
            noteWindow.dataset.noteId = note.id;
            noteWindow.style.left = note.x + 'px';
            noteWindow.style.top = note.y + 'px';
            noteWindow.style.width = note.width + 'px';
            noteWindow.style.height = note.height + 'px';
            noteWindow.style.zIndex = noteZIndex++;
            
            noteWindow.innerHTML = `
                <div class="note-header" onmousedown="startDrag(event, this.parentElement)">
                    <input type="text" class="note-title-input" value="${note.title}" onchange="updateNoteTitle(${note.id}, this.value)" placeholder="Название заметки">
                    <div class="note-controls">
                        <button class="note-control-btn note-minimize" onclick="minimizeNoteToTaskbar(${note.id})" title="Свернуть">−</button>
                        <button class="note-control-btn note-close" onclick="closeNoteWindow(this.closest('.note-window'))" title="Закрыть">×</button>
                    </div>
                </div>
                <div class="note-content">
                    <textarea class="note-textarea" placeholder="Введите текст заметки..." onchange="updateNoteContent(${note.id}, this.value)">${note.content}</textarea>
                </div>
            `;
            
            document.body.appendChild(noteWindow);
            noteWindows.push(noteWindow);
            
            // Добавляем обработчики для изменения размера
            makeResizable(noteWindow);
        }
        
        function updateNoteTitle(noteId, title) {
            const note = notes.find(n => n.id === noteId);
            if (note) {
                note.title = title;
                saveNotes();
                
                // Обновляем заголовок в трее, если заметка свернута
                const minimizedNote = document.querySelector(`[data-note-id="${noteId}"] .minimized-note-title`);
                if (minimizedNote) {
                    minimizedNote.textContent = title || 'Без названия';
                }
            }
        }
        
        function updateNoteContent(noteId, content) {
            const note = notes.find(n => n.id === noteId);
            if (note) {
                note.content = content;
                saveNotes();
            }
        }
        
        function deleteNote(noteIndex) {
            if (confirm('Удалить эту заметку навсегда?')) {
                const note = notes[noteIndex];
                if (!note) return;
                
                // Удаляем из трея, если она там есть
                removeFromMinimizedPanel(note.id);
                
                // Находим и удаляем окно, если оно открыто
                const noteWindow = noteWindows.find(w => w.dataset.noteId === note.id.toString());
                if (noteWindow) {
                    noteWindow.remove();
                    const windowIndex = noteWindows.indexOf(noteWindow);
                    if (windowIndex > -1) {
                        noteWindows.splice(windowIndex, 1);
                    }
                }
                
                // Удаляем из массива заметок
                notes.splice(noteIndex, 1);
                saveNotes();
                
                // Обновляем модал
                const modal = document.querySelector('.notes-modal-overlay');
                if (modal) {
                    modal.remove();
                    showNotesModal();
                }
            }
        }
        
        function closeNoteWindow(noteWindow) {
            const noteId = parseInt(noteWindow.dataset.noteId);
            const note = notes.find(n => n.id === noteId);
            if (!note) return;
            
            // Сохраняем текущие размеры и позицию перед закрытием
            note.x = parseInt(noteWindow.style.left);
            note.y = parseInt(noteWindow.style.top);
            note.width = parseInt(noteWindow.style.width);
            note.height = parseInt(noteWindow.style.height);
            note.minimized = false; // Помечаем как закрытую, но не свернутую
            
            // Удаляем окно, но НЕ удаляем заметку из массива
            noteWindow.remove();
            const windowIndex = noteWindows.indexOf(noteWindow);
            if (windowIndex > -1) {
                noteWindows.splice(windowIndex, 1);
            }
            
            // Сохраняем изменения
            saveNotes();
        }
        
        function minimizeNoteToTaskbar(noteId) {
            const noteWindow = noteWindows.find(w => w.dataset.noteId === noteId.toString());
            if (!noteWindow) return;
            
            const note = notes.find(n => n.id === noteId);
            if (!note) return;
            
            // Сохраняем текущие размеры и позицию
            note.x = parseInt(noteWindow.style.left);
            note.y = parseInt(noteWindow.style.top);
            note.width = parseInt(noteWindow.style.width);
            note.height = parseInt(noteWindow.style.height);
            note.minimized = true;
            
            // Скрываем окно
            noteWindow.style.display = 'none';
            
            // Добавляем в трей
            addToMinimizedPanel(noteId);
            
            saveNotes();
        }
        
        function addToMinimizedPanel(noteId) {
            const note = notes.find(n => n.id === noteId);
            if (!note) return;
            
            const panel = document.getElementById('minimizedNotesPanel');
            if (!panel) return;
            
            // Проверяем, нет ли уже такой заметки в трее
            const existing = panel.querySelector(`[data-note-id="${noteId}"]`);
            if (existing) return;
            
            const minimizedNote = document.createElement('div');
            minimizedNote.className = 'minimized-note';
            minimizedNote.dataset.noteId = noteId;
            
            minimizedNote.innerHTML = `
                <div class="minimized-note-title" onclick="restoreNoteFromTaskbar(${noteId})">${note.title || 'Без названия'}</div>
                <button class="minimized-note-close" onclick="event.stopPropagation(); closeNoteFromTaskbar(${noteId})" title="Закрыть">×</button>
            `;
            
            panel.appendChild(minimizedNote);
        }
        
        function removeFromMinimizedPanel(noteId) {
            const panel = document.getElementById('minimizedNotesPanel');
            if (!panel) return;
            
            const minimizedNote = panel.querySelector(`[data-note-id="${noteId}"]`);
            if (minimizedNote) {
                minimizedNote.remove();
            }
        }
        
        function restoreNoteFromTaskbar(noteId) {
            const note = notes.find(n => n.id === noteId);
            if (!note) return;
            
            // Проверяем, не открыто ли уже окно этой заметки
            const existingWindow = noteWindows.find(w => w.dataset.noteId === noteId.toString());
            if (existingWindow && existingWindow.style.display !== 'none') {
                // Если окно уже открыто и видимо, просто поднимаем его наверх
                existingWindow.style.zIndex = noteZIndex++;
                return;
            }
            
            // Убираем флаг свернутости
            note.minimized = false;
            
            // Удаляем из трея
            removeFromMinimizedPanel(noteId);
            
            if (existingWindow) {
                // Если окно существует, но скрыто - показываем его
                existingWindow.style.display = 'block';
                existingWindow.style.zIndex = noteZIndex++;
            } else {
                // Если окна нет - создаем новое
                const noteIndex = notes.findIndex(n => n.id === noteId);
                openNoteWindow(noteIndex);
            }
            
            saveNotes();
        }
        
        function closeNoteFromTaskbar(noteId) {
            const note = notes.find(n => n.id === noteId);
            if (!note) return;
            
            // Убираем из трея
            removeFromMinimizedPanel(noteId);
            
            // Помечаем как закрытую, но НЕ удаляем заметку
            note.minimized = false;
            
            // Находим и удаляем окно, если оно есть
            const noteWindow = noteWindows.find(w => w.dataset.noteId === noteId.toString());
            if (noteWindow) {
                noteWindow.remove();
                const windowIndex = noteWindows.indexOf(noteWindow);
                if (windowIndex > -1) {
                    noteWindows.splice(windowIndex, 1);
                }
            }
            
            // Сохраняем изменения
            saveNotes();
        }
        
        // Функции для перетаскивания
        let isDragging = false;
        let dragElement = null;
        let dragOffset = { x: 0, y: 0 };
        
        function startDrag(event, element) {
            if (event.target.tagName === 'INPUT') return;
            
            isDragging = true;
            dragElement = element;
            dragOffset.x = event.clientX - element.offsetLeft;
            dragOffset.y = event.clientY - element.offsetTop;
            
            element.style.zIndex = noteZIndex++;
            
            document.addEventListener('mousemove', drag);
            document.addEventListener('mouseup', stopDrag);
            
            event.preventDefault();
        }
        
        function drag(event) {
            if (!isDragging || !dragElement) return;
            
            dragElement.style.left = (event.clientX - dragOffset.x) + 'px';
            dragElement.style.top = (event.clientY - dragOffset.y) + 'px';
        }
        
        function stopDrag() {
            isDragging = false;
            dragElement = null;
            
            document.removeEventListener('mousemove', drag);
            document.removeEventListener('mouseup', stopDrag);
        }
        
        // Функции для изменения размера
        function makeResizable(element) {
            const resizeHandle = document.createElement('div');
            resizeHandle.style.position = 'absolute';
            resizeHandle.style.bottom = '0';
            resizeHandle.style.right = '0';
            resizeHandle.style.width = '20px';
            resizeHandle.style.height = '20px';
            resizeHandle.style.background = '#2a3d4f';
            resizeHandle.style.cursor = 'se-resize';
            resizeHandle.style.borderRadius = '0 0 8px 0';
            
            element.appendChild(resizeHandle);
            
            let isResizing = false;
            let startX, startY, startWidth, startHeight;
            
            resizeHandle.addEventListener('mousedown', function(e) {
                isResizing = true;
                startX = e.clientX;
                startY = e.clientY;
                startWidth = parseInt(window.getComputedStyle(element).width);
                startHeight = parseInt(window.getComputedStyle(element).height);
                
                document.addEventListener('mousemove', resize);
                document.addEventListener('mouseup', stopResize);
                e.preventDefault();
            });
            
            function resize(e) {
                if (!isResizing) return;
                
                const newWidth = startWidth + e.clientX - startX;
                const newHeight = startHeight + e.clientY - startY;
                
                element.style.width = Math.max(200, newWidth) + 'px';
                element.style.height = Math.max(100, newHeight) + 'px';
            }
            
            function stopResize() {
                isResizing = false;
                document.removeEventListener('mousemove', resize);
                document.removeEventListener('mouseup', stopResize);
            }
        }
        
        function saveNotes() {
            localStorage.setItem('ezyCyberNotes', JSON.stringify(notes));
        }
        
        function loadNotes() {
            const saved = localStorage.getItem('ezyCyberNotes');
            if (saved) {
                notes = JSON.parse(saved);
                
                // Восстанавливаем свернутые заметки в трей
                notes.forEach((note) => {
                    if (note.minimized) {
                        addToMinimizedPanel(note.id);
                    }
                });
            }
        }

        // Функции для работы с броней
        function decreaseArmorOS(part) {
            const input = document.getElementById(`armor${part.charAt(0).toUpperCase() + part.slice(1)}OS`);
            if (input) {
                const currentValue = parseInt(input.value) || 0;
                const newValue = Math.max(0, currentValue - 1);
                input.value = newValue;
                state.armor[part].os = newValue;
                updateArmorPenalty();
                scheduleSave();
            }
        }

        function updateArmorPenalty() {
            const penaltyText = document.getElementById('armorPenaltyText');
            if (!penaltyText) return;

            // Определяем максимальный тип брони
            const armorTypes = ['Лёгкая', 'Средняя', 'Тяжёлая', 'Титаническая'];
            const armorLevels = {
                'Лёгкая': 0,
                'Средняя': 1,
                'Тяжёлая': 2,
                'Титаническая': 3
            };

            let maxLevel = 0;
            let maxType = 'Лёгкая';

            // Проверяем все части тела
            for (const part of ['head', 'body', 'arms', 'legs']) {
                const type = state.armor[part].type || 'Лёгкая';
                const level = armorLevels[type] || 0;
                if (level > maxLevel) {
                    maxLevel = level;
                    maxType = type;
                }
            }

            // Определяем штрафы
            let penaltyText_content = '';
            switch (maxType) {
                case 'Лёгкая':
                    penaltyText_content = 'Без штрафа';
                    break;
                case 'Средняя':
                    penaltyText_content = '-1 СКО, РЕА и ЛВК (не влияет на СКО)';
                    break;
                case 'Тяжёлая':
                    penaltyText_content = '-3 РЕА и ЛВК (не влияет на СКО) до минимум 1; -3 СКО, если ТЕЛО менее 8 до минимум 1';
                    break;
                case 'Титаническая':
                    penaltyText_content = '-6 СКО, РЕА и ЛВК (не влияет на СКО)';
                    break;
            }

            penaltyText.textContent = penaltyText_content;
        }
    </script>
    
    <!-- Закрепленная кнопка заметок -->
    <div class="notes-button" id="notesButton" onclick="showNotesModal()" style="position: fixed; bottom: 20px; left: 20px; width: 60px; height: 60px; background: linear-gradient(135deg, #131f2a, #1a2633); border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 4px 20px rgba(19, 31, 42, 0.6); z-index: 1000; transition: all 0.3s ease; border: 2px solid #2a3d4f;">
        <span style="font-size: 1.5rem; color: var(--bg); font-weight: bold;">📝</span>
    </div>
    
    <!-- Панель свернутых заметок -->
    <div class="minimized-notes-panel" id="minimizedNotesPanel"></div>
    
    <!-- Стили для кнопки заметок -->
    <style>
        .notes-button:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 25px rgba(19, 31, 42, 0.8);
        }

        .dice-button:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 25px rgba(19, 31, 42, 0.8);
        }
        
        .notes-button:active {
            transform: scale(0.95);
        }
        
        /* Стили для заметок */
        .note-window {
            position: fixed;
            background: linear-gradient(135deg, #131f2a, #1a2633);
            border: 2px solid #2a3d4f;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(19, 31, 42, 0.6);
            z-index: 2000;
            min-width: 300px;
            min-height: 200px;
            resize: both;
            overflow: hidden;
        }
        
        .note-header {
            background: rgba(19, 31, 42, 0.8);
            padding: 0.5rem;
            border-bottom: 1px solid #2a3d4f;
            cursor: move;
            display: flex;
            justify-content: space-between;
            align-items: center;
            user-select: none;
        }
        
        .note-title {
            color: var(--accent);
            font-weight: 600;
            font-size: 0.9rem;
            flex: 1;
            margin-right: 0.5rem;
        }
        
        .note-title-input {
            background: transparent;
            border: none;
            color: #ffffff;
            font-weight: 600;
            font-size: 0.9rem;
            width: 100%;
            outline: none;
        }
        
        .note-controls {
            display: flex;
            gap: 0.25rem;
        }
        
        .note-control-btn {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: none;
            background: transparent;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;  
            font-weight: bold;
            transition: all 0.2s ease;
            color: #ffffff;
        }
        
        .note-minimize {
            color: #ffffff;
        }
        
        .note-close {
            color: #ffffff;
        }
        
        .note-control-btn:hover {
            transform: scale(1.1);
        }
        
        .note-content {
            padding: 1rem;
            height: calc(100% - 50px);
            overflow: auto;
            background: #131f2a;
        }
        
        .note-textarea {
            width: 100%;
            height: 100%;
            background: #131f2a;
            border: none;
            color: var(--text);
            font-family: inherit;
            font-size: 0.9rem;
            line-height: 1.4;
            resize: none;
            outline: none;
        }
        
        .note-textarea::placeholder {
            color: var(--muted);
        }
        
        .notes-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1500;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .notes-modal {
            background: linear-gradient(135deg, var(--panel), var(--panel-alt));
            border: 2px solid var(--accent);
            border-radius: 18px;
            padding: 2rem;
            max-width: 90vw;
            max-height: 90vh;
            width: 800px;
            box-shadow: 0 8px 32px rgba(182, 103, 255, 0.3);
        }
        
        .notes-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border);
        }
        
        .notes-modal-title {
            color: var(--accent);
            font-size: 1.5rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.08em;
        }
        
        .notes-modal-content {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        
        .notes-list {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1rem;
        }
        
        .note-item {
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(182, 103, 255, 0.2);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 0.75rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .note-item:last-child {
            margin-bottom: 0;
        }
        
        .note-item-info {
            flex: 1;
        }
        
        .note-item-title {
            color: var(--accent);
            font-weight: 600;
            margin-bottom: 0.25rem;
        }
        
        .note-item-preview {
            color: var(--muted);
            font-size: 0.85rem;
            max-width: 300px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .note-item-actions {
            display: flex;
            gap: 0.5rem;
        }
        
        .notes-actions {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin-top: 1rem;
        }
        
        /* Стили для панели свернутых заметок */
        .minimized-notes-panel {
            position: fixed;
            bottom: 20px;
            left: 100px; /* 20px от края + 60px ширина кнопки заметок + 20px отступ */
            right: 20px;
            height: auto;
            z-index: 1500;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-content: flex-end;
            pointer-events: none;
        }
        
        .minimized-note {
            background: linear-gradient(135deg, #131f2a, #1a2633);
            border: 1px solid #2a3d4f;
            border-radius: 8px;
            padding: 0.5rem 1rem;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(19, 31, 42, 0.6);
            transition: all 0.3s ease;
            max-width: 200px;
            pointer-events: auto;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .minimized-note:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(19, 31, 42, 0.8);
        }
        
        .minimized-note-title {
            color: #ffffff;
            font-weight: 600;
            font-size: 0.8rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            flex: 1;
        }
        
        .minimized-note-close {
            background: transparent;
            color: #ffffff;
            border: none;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            font-size: 0.7rem;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }
        
        .minimized-note-close:hover {
            transform: scale(1.2);
        }

        /* Стили для выпадающих списков */
        select.input-field {
            background: linear-gradient(135deg, var(--panel), var(--panel-alt));
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text);
            font-family: inherit;
            font-size: 0.9rem;
            padding: 0.75rem;
            transition: all 0.3s ease;
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23b667ff' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6,9 12,15 18,9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            background-size: 16px;
            padding-right: 2.5rem;
        }

        select.input-field:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 15px rgba(182, 103, 255, 0.3);
        }

        select.input-field:hover {
            border-color: var(--accent);
        }

        /* Стили для опций в выпадающих списках */
        select.input-field option {
            background: var(--panel);
            color: var(--text);
            padding: 0.5rem;
        }

        select.input-field option:hover {
            background: var(--accent);
            color: var(--bg);
        }

        select.input-field option:checked {
            background: var(--accent);
            color: var(--bg);
        }
    </style>
</body>
</html>
    
